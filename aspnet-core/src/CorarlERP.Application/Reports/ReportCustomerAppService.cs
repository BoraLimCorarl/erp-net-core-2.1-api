using Abp.Application.Features;
using Abp.AspNetZeroCore.Net;
using Abp.Authorization;
using Abp.Collections.Extensions;
using Abp.Dependency;
using Abp.Domain.Repositories;
using Abp.Domain.Uow;
using Abp.Extensions;
using Abp.Linq.Extensions;
using Abp.Runtime.Session;
using Abp.UI;
using CorarlERP.AccountCycles;
using CorarlERP.AccountTransactions;
using CorarlERP.Authorization;
using CorarlERP.ChartOfAccounts;
using CorarlERP.Common.Dto;
using CorarlERP.CustomerCredits;
using CorarlERP.CustomerManager;
using CorarlERP.Customers;
using CorarlERP.Customers.Dto;
using CorarlERP.DeliverySchedules;
using CorarlERP.Dto;
using CorarlERP.Features;
using CorarlERP.FileStorages;
using CorarlERP.Formats;
using CorarlERP.Inventories;
using CorarlERP.Inventories.Data;
using CorarlERP.InventoryTransactionItems;
using CorarlERP.Invoices;
using CorarlERP.ItemIssues;
using CorarlERP.ItemReceiptCustomerCredits;
using CorarlERP.Items;
using CorarlERP.Journals;
using CorarlERP.Locations;
using CorarlERP.MultiTenancy;
using CorarlERP.PropertyValues;
using CorarlERP.ReceivePayments;
using CorarlERP.Reports.Dto;
using CorarlERP.ReportTemplates;
using CorarlERP.SaleOrders;
using CorarlERP.UserGroups;
using CorarlERP.VendorCustomerOpenBalances;
using CorarlERP.VendorHelpers.Data;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Internal;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Linq.Dynamic.Core;
using System.Threading.Tasks;
using static CorarlERP.enumStatus.EnumStatus;

namespace CorarlERP.Reports
{

    [AbpAuthorize]
    public class ReportCustomerAppService : ReportBaseClass, IReportCustomerAppService
    {
        private readonly IRepository<ReceivePayment, Guid> _receivePaymentRepository;
        private readonly IRepository<ReceivePaymentDetail, Guid> _receivePaymentItemRepository;

        private readonly IRepository<CustomerOpenBalance, Guid> _customerOpenBalanceRepository;

        private readonly ICustomerManagerHelper _customerManager;
        private readonly IRepository<Journal, Guid> _journalRepository;

        private readonly IRepository<JournalItem, Guid> _journalItemRepository;
        private readonly IRepository<ChartOfAccount, Guid> _chartOfAccountRepository;

        private readonly IRepository<AccountCycle, long> _accountCycleRepository;

        private readonly IAccountTransactionManager _accountTransactionManager;
        private readonly IAppFolders _appFolders;
        private readonly IRepository<Tenant, int> _tenantRepository;
        private readonly IRepository<MultiCurrencies.MultiCurrency, long> _multiCurrencyRepository;
        private readonly IRepository<Format, long> _formatRepository;
        private readonly IRepository<Invoice, Guid> _invoiceRepository;
        private readonly IRepository<InvoiceItem, Guid> _invoiceItemRepository;

        private readonly IRepository<Customer, Guid> _customerRepository;
        private readonly IRepository<CustomerGroup, Guid> _customerGroupRepository;
        private readonly IRepository<UserGroupMember, Guid> _userGroupMemberRepository;
        private readonly IRepository<Property, long> _propertyRepository;
        private readonly IRepository<ItemProperty, Guid> _itemPropertyRepository;
        private readonly IRepository<Item, Guid> _itemRepository;

        private readonly IRepository<CustomerCredit, Guid> _customerCreditRepository;
        private readonly IRepository<CustomerCreditDetail, Guid> _customerCreditItemRepository;

        private readonly IRepository<SaleOrder, Guid> _saleOrderRepository;
        private readonly IRepository<SaleOrderItem, Guid> _saleOrderItemRepository;
        private readonly IRepository<ItemIssue, Guid> _itemIssueRepository;
        private readonly IRepository<ItemIssueItem, Guid> _itemIssueItemRepository;
        private readonly IRepository<InventoryTransactionItem, Guid> _inventoryTrasactionItemRepository;

        private readonly IRepository<Location, long> _locationRepository;
        protected readonly IRepository<ItemReceiptItemCustomerCredit, Guid> _itemReceiptCustomerCreditItemRepository;
        private readonly IFileStorageManager _fileStorageManager;
        private readonly ICorarlRepository<DeliverySchedule, Guid> _deliverScheduleRepository;
        private readonly ICorarlRepository<DeliveryScheduleItem, Guid> _deliverScheduleItemRepository;
        public ReportCustomerAppService(
            IRepository<InventoryTransactionItem, Guid> inventoryTrasactionItemRepository,
            IRepository<CustomerGroup, Guid> customerGroupRepository,
            IRepository<UserGroupMember, Guid> userGroupMemberRepository,
            IRepository<Journal, Guid> journalRepository,
            IRepository<JournalItem, Guid> journalItemRepository,
            IRepository<AccountType, long> accountTypeRepository,
            IRepository<ChartOfAccount, Guid> chartOfAccountRepository,
            IRepository<Customer, Guid> customerRepository,
            IRepository<Tenant, int> tenantRepository,
            IRepository<AccountCycle, long> accountCycleRepository,
            IAccountTransactionManager accountTransactionManager,
            IInventoryManager inventoryManager,
            ICustomerManagerHelper customerManager,
            AppFolders appFolders,
            IFileStorageManager fileStorageManager,
            IRepository<Invoice, Guid> invoiceRepository,
            IRepository<InvoiceItem, Guid> invoiceItemRepository,
            IRepository<Format, long> formatRepository,
            IRepository<ReceivePayment, Guid> receivePaymentRepository,
            IRepository<ReceivePaymentDetail, Guid> receivePaymentItemRepository,
            IRepository<MultiCurrencies.MultiCurrency, long> multiCurrencyRepository,
            IRepository<Locations.Location, long> locationRepository,
            IRepository<CustomerOpenBalance, Guid> customerOpenBalanceRepository,
            IRepository<ItemReceiptItemCustomerCredit, Guid> itemReceiptCustomerCreditItemRepository,
            IRepository<CustomerCredit, Guid> customerCreditRepository,
            IRepository<CustomerCreditDetail, Guid> customerCreditItemRepository,
            IRepository<SaleOrder, Guid> saleOrderRepository,
            IRepository<SaleOrderItem, Guid> saleOrderItemRepository,
            IRepository<ItemIssue, Guid> itemIssueRepository,
            IRepository<ItemIssueItem, Guid> itemIssueItemRepository,
            ICorarlRepository<DeliverySchedule, Guid> deliverScheduleRepository,
            ICorarlRepository<DeliveryScheduleItem, Guid> deliverScheduleItemRepository
           ) : base(accountCycleRepository, appFolders, userGroupMemberRepository, locationRepository)
        {
            _receivePaymentRepository = receivePaymentRepository;
            _receivePaymentItemRepository = receivePaymentItemRepository;
            _userGroupMemberRepository = userGroupMemberRepository;
            _customerGroupRepository = customerGroupRepository;
            _customerManager = customerManager;
            _journalRepository = journalRepository;
            _journalItemRepository = journalItemRepository;
            _chartOfAccountRepository = chartOfAccountRepository;

            _tenantRepository = tenantRepository;
            _customerRepository = customerRepository;

            _accountTransactionManager = accountTransactionManager;
            _appFolders = appFolders;
            _fileStorageManager = fileStorageManager;

            _invoiceItemRepository = invoiceItemRepository;
            _invoiceRepository = invoiceRepository;
            _accountCycleRepository = accountCycleRepository;
            _formatRepository = formatRepository;
            _multiCurrencyRepository = multiCurrencyRepository;
            _customerOpenBalanceRepository = customerOpenBalanceRepository;
            _propertyRepository = IocManager.Instance.Resolve<IRepository<Property, long>>();
            _itemPropertyRepository = IocManager.Instance.Resolve<IRepository<ItemProperty, Guid>>();
            _itemRepository = IocManager.Instance.Resolve<IRepository<Item, Guid>>();
            _customerCreditItemRepository = customerCreditItemRepository;
            _customerCreditRepository = customerCreditRepository;
            _saleOrderRepository = saleOrderRepository;
            _saleOrderItemRepository = saleOrderItemRepository;
            _itemIssueRepository = itemIssueRepository;
            _itemIssueItemRepository = itemIssueItemRepository;
            _locationRepository = IocManager.Instance.Resolve<IRepository<Location, long>>();
            _itemReceiptCustomerCreditItemRepository = itemReceiptCustomerCreditItemRepository;
            _inventoryTrasactionItemRepository = inventoryTrasactionItemRepository;
            _deliverScheduleRepository = deliverScheduleRepository;
            _deliverScheduleItemRepository = deliverScheduleItemRepository;
        }

        private IQueryable<CustomerSummaryOutput> GetCustomerGroup(long userId)
        {
            // get user by group member
            var userGroups = _userGroupMemberRepository.GetAll()
                            .Where(x => x.MemberId == userId)
                            .AsNoTracking()
                            .Select(x => x.UserGroupId)
                            .ToList();

            var @query = _customerGroupRepository.GetAll()
                            .Include(u => u.Customer)
                            .Where(t => t.Customer.Member == Member.UserGroup)
                            .Where(t => userGroups.Contains(t.UserGroupId))
                            //.Where(p => p.Customer.IsActive == true)
                            .AsNoTracking()
                            .Select(t => t.Customer);

            var @queryAll = _customerRepository.GetAll()
                            .Where(t => t.Member == Member.All)
                            //.Where(p => p.IsActive == true)
                            .AsNoTracking();

            var result = @queryAll.Concat(query)
                        .Select(t => new CustomerSummaryOutput
                        {
                            Id = t.Id,
                            CustomerName = t.CustomerName,
                            CustomerCode = t.CustomerCode
                        })
                        .GroupBy(s => s.Id)
                        .Select(s => s.FirstOrDefault());
            return result;
        }

        #region Sale Order Rummary Report         
        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleOrder_Export_Pdf)]
        public async Task<FileDto> ExportPDFSaleOrderSummaryReport(GetSaleOrderSummaryReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                        .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                        .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }

            var rounding = await GetCurrentCycleAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            //int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;
            var user = await GetCurrentUserAsync();
            var invoices = await GetSaleOrderSummaryReport(input);

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                //var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";

                            rowHeader = $"<th width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";

                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                //multiCurrencyHeader += isMultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                var groupBy = new List<GetListSaleOrderSummaryReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = invoices.Items
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListSaleOrderSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Customer":
                            groupBy = invoices.Items
                                .GroupBy(t => t.CustomerName)
                                .Select(t => new GetListSaleOrderSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = invoices.Items
                                .GroupBy(t => t.Date.Date)
                                .Select(t => new GetListSaleOrderSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }

                // write body
                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0) //write body have group by
                {
                    var trGroup = "";
                    foreach (var k in groupBy)
                    {
                        trGroup += $"<tr style='page-break-before: auto; page-break-after: auto;'>" +
                                   $"<td style='font-weight: bold;' colspan='{reportCountColHead}'> " + k.KeyName +
                                   $" </td></tr>";
                        foreach (var row in k.Items)
                        {
                            trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                            foreach (var i in viewHeader)
                            {
                                if (i.Visible)
                                {
                                    if (i.ColumnName == "Location")
                                    {
                                        trGroup += $"<td>{row.LocationName}</td>";
                                    }
                                    else if (i.ColumnName == "OrderAmount")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderAmount, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "Date")
                                    {
                                        trGroup += $"<td>{row.Date.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "OrderNumber")
                                    {
                                        trGroup += $"<td>{row.OrderNumber}</td>";
                                    }
                                    else if (i.ColumnName == "Reference")
                                    {
                                        trGroup += $"<td>{row.Reference}</td>";
                                    }
                                    else if (i.ColumnName == "Description")
                                    {
                                        trGroup += $"<td>{row.Description}</td>";
                                    }
                                    else if (i.ColumnName == "Customer")
                                    {
                                        trGroup += $"<td>{row.CustomerName}</td>";
                                    }
                                    else if (i.ColumnName == "User")
                                    {
                                        trGroup += $"<td>{row.User}</td>";
                                    }
                                    else if (i.ColumnName == "TotalOrderNetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalOrderNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "TotalIssueNetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalIssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "TotalRemainingNetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalRemainingNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryStatus")
                                    {
                                        trGroup += $"<td>{row.DeliveryStatus.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "Status")
                                    {
                                        trGroup += $"<td>{row.Status.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "TotalIssueCount")
                                    {
                                        trGroup += $"<td style='text-align: right'>{AutoRound(row.TotalIssueCount)}</td>";
                                    }
                                    else if (i.ColumnName == "Item")
                                    {
                                        var itemList = "";
                                        var j = 0;
                                        foreach (var oi in row.Items)
                                        {
                                            if (j > 0) itemList += "<br>";
                                            itemList += $"{oi.ItemName}";
                                            j++;
                                        }
                                        trGroup += $"<td>{itemList}</td>";
                                    }
                                    else if (i.ColumnName == "Qty")
                                    {
                                        var itemList = "";
                                        var j = 0;
                                        foreach (var oi in row.Items)
                                        {
                                            if (j > 0) itemList += "<br>";
                                            itemList += $"{AutoRound(oi.OrderQty)} - {AutoRound(oi.IssueQty)} = {AutoRound(oi.OrderQty - oi.IssueQty)}";
                                            j++;
                                        }
                                        trGroup += $"<td style='text-align: right'>{itemList}</td>";
                                    }
                                    else if (i.ColumnName == "NetWeight")
                                    {
                                        var itemList = "";
                                        var j = 0;
                                        foreach (var oi in row.Items)
                                        {
                                            if (j > 0) itemList += "<br>";
                                            itemList += $"{AutoRound(oi.OrderNetWeight)} - {AutoRound(oi.IssueNetWeight)} = {AutoRound(oi.OrderNetWeight - oi.IssueNetWeight)}";
                                            j++;
                                        }
                                        trGroup += $"<td style='text-align: right'>{itemList}</td>";
                                    }
                                    else
                                    {
                                        trGroup += $"<td></td>";
                                    }
                                }
                            }
                            trGroup += "</tr>";
                        }
                        trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                                {
                                    if (i.ColumnName == "OrderAmount")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.OrderAmount), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "TotalOrderNetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.TotalOrderNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "TotalIssueNetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.TotalIssueNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "TotalRemainingNetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.TotalOrderNetWeight - t.TotalIssueNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                }
                                else //none sum
                                {
                                    trGroup += $"<td></td>";
                                }

                            }
                        }
                        trGroup += "</tr>";
                    }
                    contentBody += trGroup;
                }
                else // write body no group by
                {
                    foreach (var row in invoices.Items)
                    {
                        var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "Location")
                                {
                                    tr += $"<td>{row.LocationName}</td>";
                                }
                                else if (i.ColumnName == "OrderAmount")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderAmount, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "Date")
                                {
                                    tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "OrderNumber")
                                {
                                    tr += $"<td>{row.OrderNumber}</td>";
                                }
                                else if (i.ColumnName == "Reference")
                                {
                                    tr += $"<td>{row.Reference}</td>";
                                }
                                else if (i.ColumnName == "Description")
                                {
                                    tr += $"<td>{row.Description}</td>";
                                }
                                else if (i.ColumnName == "Customer")
                                {
                                    tr += $"<td>{row.CustomerName}</td>";
                                }
                                else if (i.ColumnName == "User")
                                {
                                    tr += $"<td>{row.User}</td>";
                                }
                                else if (i.ColumnName == "TotalOrderNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalOrderNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "TotalIssueNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalIssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "TotalRemainingNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalRemainingNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "DeliveryStatus")
                                {
                                    tr += $"<td>{row.DeliveryStatus.ToString()}</td>";
                                }
                                else if (i.ColumnName == "Status")
                                {
                                    tr += $"<td>{row.Status.ToString()}</td>";
                                }
                                else if (i.ColumnName == "TotalIssueCount")
                                {
                                    tr += $"<td style='text-align: right'>{AutoRound(row.TotalIssueCount)}</td>";
                                }

                                else if (i.ColumnName == "Item")
                                {
                                    var itemList = "";
                                    var j = 0;
                                    foreach (var oi in row.Items)
                                    {
                                        if (j > 0) itemList += "<br>";
                                        itemList += $"{oi.ItemName}";
                                        j++;
                                    }
                                    tr += $"<td>{itemList}</td>";
                                }
                                else if (i.ColumnName == "Qty")
                                {
                                    var itemList = "";
                                    var j = 0;
                                    foreach (var oi in row.Items)
                                    {
                                        if (j > 0) itemList += "<br>";
                                        itemList += $"{AutoRound(oi.OrderQty)} - {AutoRound(oi.IssueQty)} = {AutoRound(oi.OrderQty - oi.IssueQty)}";
                                        j++;
                                    }
                                    tr += $"<td style='text-align: right'>{itemList}</td>";
                                }
                                else if (i.ColumnName == "NetWeight")
                                {
                                    var itemList = "";
                                    var j = 0;
                                    foreach (var oi in row.Items)
                                    {
                                        if (j > 0) itemList += "<br>";
                                        itemList += $"{AutoRound(oi.OrderNetWeight)} - {AutoRound(oi.IssueNetWeight)} = {AutoRound(oi.OrderNetWeight - oi.IssueNetWeight)}";
                                        j++;
                                    }
                                    tr += $"<td style='text-align: right'>{itemList}</td>";
                                }
                                else
                                {
                                    tr += $"<td></td>";
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index == 0)
                            {
                                tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))
                                {
                                    if (invoices.TotalResult != null && invoices.TotalResult.ContainsKey(i.ColumnName))
                                    {
                                        tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(invoices.TotalResult[i.ColumnName], rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", "");
                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);
                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{sheetName}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleOrder)]
        [HttpPost]
        public async Task<PagedResultWithTotalColuumnsDto<GetListReportSaleOrderSummaryOutput>> GetSaleOrderSummaryReport(GetListReportSaleOrderSummaryInput input)
        {

            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
                                               previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var defaultLocationGroups = await GetUserGroupByLocation();
            var userGroupCustomers = await GetUserGroupCustomers();
            var userGroupItems = await GetUserGroupItems();

            var invoiceItemQuery = from iv in _invoiceItemRepository.GetAll()
                                            .Where(s => s.OrderItemId.HasValue)
                                            .Where(s => s.ItemIssueItemId.HasValue)
                                            .WhereIf(!input.Items.IsNullOrEmpty(), s => input.Items.Contains(s.ItemId))
                                            .AsNoTracking()
                                   join j in _journalRepository.GetAll()
                                      .Where(s => s.InvoiceId.HasValue)
                                      .Where(s => s.Status == TransactionStatus.Publish)
                                      .AsNoTracking()
                                   on iv.InvoiceId equals j.InvoiceId

                                   join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.ItemIssueSaleItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ri.ItemIssueSaleItemId
                                   into r1

                                   join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.CustomerCreditItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                   into r2

                                   let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                   let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                   select new
                                   {
                                       OrderItemId = iv.OrderItemId,
                                       Qty = iv.Qty,
                                       ReturnQty = rq1 + rq2
                                   };

            var itemIssueItemQuery = from iv in _itemIssueItemRepository.GetAll()
                                             .Where(s => s.SaleOrderItemId.HasValue)
                                             .WhereIf(!input.Items.IsNullOrEmpty(), s => input.Items.Contains(s.ItemId))
                                             .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                          .Where(s => s.ItemIssueId.HasValue)
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .AsNoTracking()
                                     on iv.ItemIssueId equals j.ItemIssueId
                                     join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.ItemIssueSaleItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ri.ItemIssueSaleItemId
                                     into r1

                                     join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.CustomerCreditItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                     into r2

                                     let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                     let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                     select new
                                     {
                                         SaleOrderItemId = iv.SaleOrderItemId,
                                         Qty = iv.Qty,
                                         ReturnQty = rq1 + rq2
                                     };

            var dinvoiceItemQuery = from iv in _invoiceItemRepository.GetAll()
                                           .Where(s => s.DeliveryScheduleItem.SaleOrderItemId.HasValue)
                                           .Where(s => s.ItemIssueItemId.HasValue)
                                           .WhereIf(!input.Items.IsNullOrEmpty(), s => input.Items.Contains(s.ItemId))
                                           .AsNoTracking()
                                   join j in _journalRepository.GetAll()
                                      .Where(s => s.InvoiceId.HasValue)
                                      .Where(s => s.Status == TransactionStatus.Publish)
                                      .AsNoTracking()
                                   on iv.InvoiceId equals j.InvoiceId

                                   join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.ItemIssueSaleItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ri.ItemIssueSaleItemId
                                   into r1

                                   join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.CustomerCreditItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                   into r2

                                   let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                   let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                   select new
                                   {
                                       OrderItemId = iv.DeliveryScheduleItem.SaleOrderItemId,
                                       Qty = iv.Qty,
                                       ReturnQty = rq1 + rq2
                                   };

            var ditemIssueItemQuery = from iv in _itemIssueItemRepository.GetAll()
                                             .Where(s => s.DeliveryScheduleItem.SaleOrderItemId.HasValue)
                                             .WhereIf(!input.Items.IsNullOrEmpty(), s => input.Items.Contains(s.ItemId))
                                             .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                          .Where(s => s.ItemIssueId.HasValue)
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .AsNoTracking()
                                     on iv.ItemIssueId equals j.ItemIssueId
                                     join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.ItemIssueSaleItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ri.ItemIssueSaleItemId
                                     into r1

                                     join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.CustomerCreditItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                     into r2

                                     let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                     let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                     select new
                                     {
                                         SaleOrderItemId = iv.DeliveryScheduleItem.SaleOrderItemId,
                                         Qty = iv.Qty,
                                         ReturnQty = rq1 + rq2
                                     };


            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();

            var customerQuery = GetCustomers(userGroupCustomers, input.Customers, input.CustomerTypes, customerTypeMemberIds);
            var locationQuery = GetLocations(null, input.Locations);
            var userQuery = GetUsers(input.Users);


            var orderQuery = from o in _saleOrderRepository.GetAll()
                                        //.Where(s => s.Status == TransactionStatus.Publish &&
                                        //                (s.ApprovalStatus == ApprovalStatus.Approved || s.ApprovalStatus == ApprovalStatus.Recorded))
                                        .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                                        .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                        .WhereIf(input.FromDate != null && input.ToDate != null,
                                                (u => (u.OrderDate.Date) >= (input.FromDate.Date) && (u.OrderDate.Date) <= (input.ToDate.Date)))
                                        .WhereIf(!input.Filter.IsNullOrEmpty(), u =>
                                                u.OrderNumber.ToLower().Contains(input.Filter.ToLower()) ||
                                                u.Reference.ToLower().Contains(input.Filter.ToLower()))
                                        .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                        .WhereIf(input.Customers != null && input.Customers.Any(), s => input.Customers.Contains(s.CustomerId))
                                        .WhereIf(input.DeliveryStatuses != null && input.DeliveryStatuses.Count > 0, u => input.DeliveryStatuses.Contains(u.ReceiveStatus))
                                        .WhereIf(input.Statuses != null && input.Statuses.Count > 0, u => input.Statuses.Contains(u.Status))
                                        .AsNoTracking()
                                        .Select(o => new
                                        {
                                            Id = o.Id,
                                            OrderNumber = o.OrderNumber,
                                            Date = o.OrderDate,
                                            LocationId = o.LocationId,
                                            CustomerId = o.CustomerId,
                                            Description = o.Memo,
                                            CreatorUserId = o.CreatorUserId,
                                            Reference = o.Reference,
                                            OrderAmount = o.Total,
                                            OrderAmountMultiCurrency = o.MultiCurrencyTotal,
                                            ReceiveStatus = o.ReceiveStatus,
                                            TotalIssueCount = o.IssueCount,
                                            o.Status
                                        })
                             join c in customerQuery
                             on o.CustomerId equals c.Id
                             join l in locationQuery
                             on o.LocationId equals l.Id
                             join u in userQuery
                             on o.CreatorUserId equals u.Id
                             select new GetListReportSaleOrderSummaryOutput
                             {
                                 Id = o.Id,
                                 OrderNumber = o.OrderNumber,
                                 Date = o.Date,
                                 LocationId = o.LocationId,
                                 CustomerId = o.CustomerId,
                                 Description = o.Description,
                                 Reference = o.Reference,
                                 OrderAmount = o.OrderAmount,
                                 OrderAmountMultiCurrency = o.OrderAmountMultiCurrency,
                                 DeliveryStatus = o.ReceiveStatus,
                                 TotalIssueCount = o.TotalIssueCount,
                                 User = u.UserName,
                                 LocationName = l.LocationName,
                                 CustomerName = c.CustomerName,
                                 Status = o.Status
                             };

            var itemOrderWithIssue = from oi in _saleOrderItemRepository.GetAll()
                                                 .AsNoTracking()
                                                 .Select(oi => new
                                                 {
                                                     OrderId = oi.SaleOrderId,
                                                     OrderItemId = oi.Id,
                                                     ItemId = oi.ItemId,
                                                     OrderQty = oi.Qty,
                                                 })

                                     join bi in invoiceItemQuery
                                     on oi.OrderItemId equals bi.OrderItemId
                                     into bItems

                                     join ri in itemIssueItemQuery
                                     on oi.OrderItemId equals ri.SaleOrderItemId
                                     into rItems

                                     join dbi in dinvoiceItemQuery
                                     on oi.OrderItemId equals dbi.OrderItemId
                                     into dbItems

                                     join dri in ditemIssueItemQuery
                                     on oi.OrderItemId equals dri.SaleOrderItemId
                                     into drItems

                                     let bQty = bItems == null || !bItems.Any() ? 0 : bItems.Sum(r => r.Qty - r.ReturnQty)
                                     let rQty = rItems == null || !rItems.Any() ? 0 : rItems.Sum(r => r.Qty - r.ReturnQty)
                                     let dbQty = dbItems == null || !dbItems.Any() ? 0 : dbItems.Sum(r => r.Qty - r.ReturnQty)
                                     let drQty = drItems == null || !drItems.Any() ? 0 : drItems.Sum(r => r.Qty - r.ReturnQty)
                                     let receiveQty = bQty + rQty + dbQty + drQty

                                     select new SaleOrderItemSummaryOutput
                                     {
                                         OrderId = oi.OrderId,
                                         OrderItemId = oi.OrderItemId,
                                         ItemId = oi.ItemId,
                                         OrderQty = oi.OrderQty,
                                         IssueQty = receiveQty,
                                     };

            var itemQuery = GetItemWithProperties(new List<Guid>(), new List<Guid>(), null);

            var orderItemWithProperty = from oi in itemOrderWithIssue

                                        join i in itemQuery
                                        on oi.ItemId equals i.Id

                                        let netWeight = !i.Properties.Any(p => p.IsUnit) ? 0 : i.Properties.Where(t => t.IsUnit).Select(t => t.NetWeight).FirstOrDefault()

                                        select new SaleOrderItemSummaryOutput
                                        {
                                            OrderId = oi.OrderId,
                                            OrderItemId = oi.OrderItemId,
                                            ItemId = oi.ItemId,
                                            ItemCode = i.ItemCode,
                                            ItemName = i.ItemName,
                                            OrderQty = oi.OrderQty,
                                            IssueQty = oi.IssueQty,
                                            OrderNetWeight = oi.OrderQty * netWeight / 1000,
                                            IssueNetWeight = oi.IssueQty * netWeight / 1000,
                                            Properties = i.Properties,
                                        };


            var query = from o in orderQuery
                        join oi in orderItemWithProperty
                        on o.Id equals oi.OrderId
                        into items

                        where (input.Items == null || input.Items.Count() == 0 || items.Any(i => input.Items.Contains(i.ItemId))) &&
                               (input.PropertyDics == null || input.PropertyDics.Count() == 0 ||
                               items.Any(p => p.Properties.Where(ip => input.PropertyDics.Any(v => v.PropertyId == ip.PropertyId) &&
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId) != null &&
                                   (input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds == null ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Count == 0 ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Contains(ip.Id)))
                                .Count() == input.PropertyDics.Count)
                               )

                        select new GetListReportSaleOrderSummaryOutput
                        {
                            Id = o.Id,
                            Date = o.Date,
                            OrderNumber = o.OrderNumber,
                            Reference = o.Reference,
                            DeliveryStatus = o.DeliveryStatus,
                            DeliveryStatusName = o.DeliveryStatus.ToString(),
                            Status = o.Status,
                            StatusName = o.Status.ToString(),
                            User = o.User,
                            Description = o.Description,
                            LocationId = o.LocationId,
                            LocationName = o.LocationName,
                            OrderAmount = o.OrderAmount,
                            OrderAmountMultiCurrency = o.OrderAmountMultiCurrency,
                            CustomerId = o.CustomerId,
                            CustomerName = o.CustomerName,
                            TotalOrderNetWeight = items.Sum(s => s.OrderNetWeight),
                            TotalIssueNetWeight = items.Sum(s => s.IssueNetWeight),
                            TotalRemainingNetWeight = items.Sum(s => s.OrderNetWeight - s.IssueNetWeight),
                            TotalIssueCount = o.TotalIssueCount,
                            RoundingDigit = currentRoundingDigit,
                            Items = items.Select(s => new SaleOrderItemSummaryOutput
                            {
                                ItemId = s.ItemId,
                                ItemCode = s.ItemCode,
                                ItemName = s.ItemName,
                                OrderQty = s.OrderQty,
                                IssueQty = s.IssueQty,
                                IssueNetWeight = s.IssueNetWeight,
                                OrderNetWeight = s.OrderNetWeight,
                                Properties = s.Properties
                            }).ToList(),
                        };


            SaleOrderColumnSummaryOutPut summary = null;
            var resultCount = await query.CountAsync();

            if (resultCount == 0) return new PagedResultWithTotalColuumnsDto<GetListReportSaleOrderSummaryOutput>(resultCount, new List<GetListReportSaleOrderSummaryOutput>(), new Dictionary<string, decimal>());

            if (input.IsLoadMore == false && input.ColumnNamesToSum != null)
            {
                summary = await query.Select(s => new
                {
                    s.OrderAmount,
                    s.OrderAmountMultiCurrency,
                    s.TotalOrderNetWeight,
                    s.TotalIssueNetWeight
                })
                .GroupBy(s => 1)
                .Select(s => new SaleOrderColumnSummaryOutPut
                {
                    TotalOrderAmount = s.Sum(t => t.OrderAmount),
                    TotalOrderAmountMultiCurrency = s.Sum(t => t.OrderAmountMultiCurrency),
                    TotalOrderNetWeight = s.Sum(t => t.TotalOrderNetWeight),
                    TotalIssueNetWeight = s.Sum(t => t.TotalIssueNetWeight)
                })
                .FirstOrDefaultAsync();

            }
            var sumOfColumns = new Dictionary<string, decimal>();

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "OrderAmount")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalOrderAmount);
                    }
                    else if (col == "TotalOrderNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalOrderNetWeight);
                    }
                    else if (col == "TotalIssueNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueNetWeight);
                    }
                    else if (col == "TotalRemainingNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalOrderNetWeight - summary.TotalIssueNetWeight);
                    }
                }
            }


            switch (input.GroupBy)
            {
                case "Date":
                    query = query.OrderBy(s => s.Date);
                    break;
                case "Location":
                    query = query.OrderBy(s => s.LocationName);
                    break;
                case "Customer":
                    query = query.OrderBy(s => s.CustomerName);
                    break;
                default:
                    query = query.OrderBy(s => s.Date);
                    break;
            }

            var @entities = new List<GetListReportSaleOrderSummaryOutput>();
            if (input.UsePagination == true)
            {
                @entities = await query.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await query.ToListAsync();
            }

            var returnResult = new PagedResultWithTotalColuumnsDto<GetListReportSaleOrderSummaryOutput>(resultCount, @entities, sumOfColumns);

            return returnResult;
        }


        public ReportOutput GetReportTemplateSaleOrderSummary()
        {
            var itemPropertyCols = _propertyRepository.GetAll().AsNoTracking()
                            .Where(t => t.IsActive == true)
                            .Select(t => new CollumnOutput
                            {
                                AllowGroupby = false,
                                AllowFilter = true,
                                ColumnName = t.Name,
                                ColumnLength = 150,
                                ColumnTitle = t.Name,
                                ColumnType = ColumnType.ItemProperty,
                                SortOrder = 11,
                                Visible = true,
                                AllowFunction = null,
                                MoreFunction = null,
                                IsDisplay = false,
                                AllowShowHideFilter = true,
                                ShowHideFilter = true,
                                DefaultValue = t.Id.ToString(),//to init the value of property
                            });

            var columnInfo = new List<CollumnOutput>() {
                     // start properties with can filter
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Search",
                        ColumnLength = 150,
                        ColumnTitle = "Search",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DateRange",
                        ColumnLength = 150,
                        ColumnTitle = "DateRange",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        DefaultValue = "thisMonth",
                        AllowFunction = null,
                        DisableDefault = false,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },

                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = false,
                        ColumnName = "Date",
                        ColumnLength = 150,
                        ColumnTitle = "Date",
                        ColumnType = ColumnType.Date,
                        SortOrder = 1,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                     },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "OrderNumber",
                        ColumnLength = 140,
                        ColumnTitle = "Order Number",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Reference",
                        ColumnLength = 140,
                        ColumnTitle = "Reference No",
                        ColumnType = ColumnType.String,
                        SortOrder = 3,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Customer",
                        ColumnLength = 150,
                        ColumnTitle = "Customer",
                        ColumnType = ColumnType.String,
                        SortOrder = 4,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Item",
                        ColumnLength = 250,
                        ColumnTitle = "Item",
                        ColumnType = ColumnType.String,
                        SortOrder = 5,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Qty",
                        ColumnLength = 120,
                        ColumnTitle = "Qty",
                        ColumnType = ColumnType.String,
                        SortOrder = 6,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                        new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "NetWeight",
                        ColumnLength = 120,
                        ColumnTitle = "Net Weight in Ton",
                        ColumnType = ColumnType.String,
                        SortOrder = 7,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Location",
                        ColumnLength = 120,
                        ColumnTitle = "Location",
                        ColumnType = ColumnType.String,
                        SortOrder = 8,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Description",
                        ColumnLength = 150,
                        ColumnTitle = "Description",
                        ColumnType = ColumnType.String,
                        SortOrder = 11,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DeliveryStatus",
                        ColumnLength = 150,
                        ColumnTitle = "Delivery Status",
                        ColumnType = ColumnType.StatusCode,
                        SortOrder = 12,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "OrderAmount",
                        ColumnLength = 110,
                        ColumnTitle = "Order Amount",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 13,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },

                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalIssueCount",
                        ColumnLength = 110,
                        ColumnTitle = "Total Issue Count",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 14,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalOrderNetWeight",
                        ColumnLength = 150,
                        ColumnTitle = "Total Order in Ton",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 15,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalIssueNetWeight",
                        ColumnLength = 150,
                        ColumnTitle = "Total Issue in Ton",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 16,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalRemainingNetWeight",
                        ColumnLength = 150,
                        ColumnTitle = "Total Remaining in Ton",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 17,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "User",
                        ColumnLength = 110,
                        ColumnTitle = "User",
                        ColumnType = ColumnType.String,
                        SortOrder = 18,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "CustomerType",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 19,
                        Visible = true,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Status",
                        ColumnLength = 150,
                        ColumnTitle = "Status",
                        ColumnType = ColumnType.StatusCode,
                        SortOrder = 20,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columnInfo.Concat(itemPropertyCols).ToList(),
                Groupby = "",
                HeaderTitle = "Sale Order Summary Report",
                Sortby = "",
            };

            //var isMultiCurrency = _multiCurrencyRepository.GetAll().Any();

            //if (isMultiCurrency)
            //{
            //    var currency = new CollumnOutput
            //    {
            //        AllowGroupby = false,
            //        AllowFilter = true,
            //        month = "Currency",
            //        ColumnLength = 140,
            //        ColumnTitle = "Currency",
            //        ColumnType = ColumnType.String,
            //        SortOrder = 3,
            //        Visible = true,
            //        IsDisplay = false,
            //        DisableDefault = false,
            //        AllowShowHideFilter = true,
            //        ShowHideFilter = true,
            //    };
            //    result.ColumnInfo.Add(currency);
            //}

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleOrder_Export_Excel)]
        public async Task<FileDto> ExportExcelSaleOrderSummaryReport(GetSaleOrderSummaryReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var reportResult = await GetSaleOrderSummaryReport(input);
            var invoiceData = reportResult.Items;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                       .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                       .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd-MM-yyyy";
            }

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                //var subCols = invoiceData == null ? null : invoiceData.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
                //var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString(formatDate);
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                    ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                    colHeaderTable += 1;
                }

                //if (isMultiCurrencies) rowTableHeader += 1;
                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                var groupBy = new List<GetListSaleOrderSummaryReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = invoiceData
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListSaleOrderSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Customer":
                            groupBy = invoiceData
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListSaleOrderSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = invoiceData
                                .GroupBy(t => t.Date.Date)
                                .Select(t => new GetListSaleOrderSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }
                // write body

                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0)
                {
                    foreach (var k in groupBy)
                    {
                        //key group by name
                        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                        rowBody += 1;
                        count = 1;
                        //list of item
                        foreach (var i in k.Items)
                        {
                            int collumnCellBody = 1;
                            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                            {

                                WriteBodySaleOrderSummary(ws, rowBody, collumnCellBody, item, i, count);
                                collumnCellBody += 1;
                            }
                            rowBody += 1;
                            count += 1;
                        }

                        //sub total of group by item
                        int collumnCellGroupBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (item.AllowFunction != null)
                            {
                                var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);
                                if (footerGroupDict.ContainsKey(item.ColumnName))
                                {
                                    footerGroupDict[item.ColumnName] += fromCell + ":" + toCell + ",";
                                }
                                else
                                {
                                    footerGroupDict.Add(item.ColumnName, fromCell + ":" + toCell + ",");
                                }
                                AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                            }
                            collumnCellGroupBody += 1;
                        }
                        rowBody += 1;
                    }
                }
                else
                {
                    foreach (var i in invoiceData)
                    {
                        int collumnCellBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            WriteBodySaleOrderSummary(ws, rowBody, collumnCellBody, item, i, count);
                            collumnCellBody += 1;
                        }
                        rowBody += 1;
                        count += 1;
                    }
                }
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (!input.GroupBy.IsNullOrWhiteSpace())
                            {
                                //sum custom range cell depend on group item
                                int rowFooter = rowTableHeader + 1;// get start row after 
                                var sumValue = "SUM(" + footerGroupDict[i.ColumnName] + ")";
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                }
                            }
                            else
                            {
                                int rowFooter = rowTableHeader + 1;// get start row after header 
                                var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }
                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"Sale_Order_Summary_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }

        #endregion


        #region Sale Order Detail Report         

        public async Task<ReportOutput> GetReportTemplateSaleOrderDetail()
        {
            var itemPropertyCols = await _propertyRepository.GetAll().AsNoTracking()
                                    .Where(t => t.IsActive == true)
                                    .Select(t => new CollumnOutput
                                    {
                                        AllowGroupby = true,
                                        AllowFilter = true,
                                        ColumnName = t.Name,
                                        ColumnLength = 150,
                                        ColumnTitle = t.Name,
                                        ColumnType = ColumnType.ItemProperty,
                                        SortOrder = 26,
                                        Visible = true,
                                        AllowFunction = null,
                                        MoreFunction = null,
                                        IsDisplay = true,
                                        AllowShowHideFilter = true,
                                        ShowHideFilter = true,
                                        DefaultValue = t.Id.ToString(),//to init the value of property
                                    })
                                    .ToListAsync();

            var columnInfo = new List<CollumnOutput>() {
                // start properties with can filter
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Search",
                    ColumnLength = 150,
                    ColumnTitle = "Search",
                    ColumnType = ColumnType.Language,
                    SortOrder = 0,
                    Visible = true,
                    AllowFunction = null,
                    MoreFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    IsDisplay = false//no need to show in col check it belong to filter option
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "DateRange",
                    ColumnLength = 150,
                    ColumnTitle = "DateRange",
                    ColumnType = ColumnType.Language,
                    SortOrder = 0,
                    Visible = true,
                    DefaultValue = "thisMonth",
                    AllowFunction = null,
                    DisableDefault = false,
                    MoreFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    IsDisplay = false//no need to show in col check it belong to filter option
                },

                new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = false,
                    ColumnName = "Date",
                    ColumnLength = 150,
                    ColumnTitle = "Date",
                    ColumnType = ColumnType.Date,
                    SortOrder = 1,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = false,
                    ColumnName = "OrderNumber",
                    ColumnLength = 140,
                    ColumnTitle = "Order Number",
                    ColumnType = ColumnType.String,
                    SortOrder = 2,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Reference",
                    ColumnLength = 140,
                    ColumnTitle = "Reference No",
                    ColumnType = ColumnType.String,
                    SortOrder = 3,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                 new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = true,
                    ColumnName = "Location",
                    ColumnLength = 120,
                    ColumnTitle = "Location",
                    ColumnType = ColumnType.String,
                    SortOrder = 4,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Memo",
                    ColumnLength = 140,
                    ColumnTitle = "Memo",
                    ColumnType = ColumnType.String,
                    SortOrder = 5,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },

                new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = true,
                    ColumnName = "Customer",
                    ColumnLength = 150,
                    ColumnTitle = "Customer",
                    ColumnType = ColumnType.String,
                    SortOrder = 6,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = true,
                    ColumnName = "Item",
                    ColumnLength = 250,
                    ColumnTitle = "Item",
                    ColumnType = ColumnType.String,
                    SortOrder = 0,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                 new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "ItemCode",
                    ColumnLength = 250,
                    ColumnTitle = "Item Code",
                    ColumnType = ColumnType.String,
                    SortOrder = 7,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "ItemName",
                    ColumnLength = 250,
                    ColumnTitle = "Item Name",
                    ColumnType = ColumnType.String,
                    SortOrder = 8,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "OrderQty",
                    ColumnLength = 120,
                    ColumnTitle = "OrderQty",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 9,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueQty",
                    ColumnLength = 120,
                    ColumnTitle = "IssueQty",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 10,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                 new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "QtyBalance",
                    ColumnLength = 120,
                    ColumnTitle = "QtyBalance",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 11,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "OrderNetWeight",
                    ColumnLength = 120,
                    ColumnTitle = "Order NetWeight",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 12,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueNetWeight",
                    ColumnLength = 120,
                    ColumnTitle = "Issue NetWeight",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 13,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "NetWeightBalance",
                    ColumnLength = 120,
                    ColumnTitle = "NetWeight Balance",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 14,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                 new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "OrderNetWeightInTon",
                    ColumnLength = 120,
                    ColumnTitle = "Order NetWeight in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 15,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueNetWeightInTon",
                    ColumnLength = 120,
                    ColumnTitle = "Issue NetWeight in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 16,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "NetWeightBalanceInTon",
                    ColumnLength = 120,
                    ColumnTitle = "NetWeight Balance in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 17,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Description",
                    ColumnLength = 150,
                    ColumnTitle = "Description",
                    ColumnType = ColumnType.String,
                    SortOrder = 18,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "UnitPrice",
                    ColumnLength = 110,
                    ColumnTitle = "UnitPrice",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 19,
                    Visible = true,
                    IsDisplay = true,
                    AllowFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "UnitPriceInTon",
                    ColumnLength = 110,
                    ColumnTitle = "Unit Price in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 20,
                    Visible = true,
                    IsDisplay = true,
                    AllowFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Total",
                    ColumnLength = 150,
                    ColumnTitle = "Total",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 21,
                    Visible = true,
                    AllowFunction = "Sum",
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                    IsDisplay = true
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "DeliveryStatus",
                    ColumnLength = 150,
                    ColumnTitle = "Delivery Status",
                    ColumnType = ColumnType.StatusCode,
                    SortOrder = 22,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "User",
                    ColumnLength = 110,
                    ColumnTitle = "User",
                    ColumnType = ColumnType.String,
                    SortOrder = 23,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "CustomerType",
                    ColumnLength = 150,
                    ColumnTitle = "Customer Type",
                    ColumnType = ColumnType.String,
                    SortOrder = 24,
                    Visible = true,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Status",
                    ColumnLength = 150,
                    ColumnTitle = "Status",
                    ColumnType = ColumnType.StatusCode,
                    SortOrder = 25,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
            };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columnInfo.Concat(itemPropertyCols).ToList(),
                Groupby = "",
                HeaderTitle = "Sale Order Detail Report",
                Sortby = "",
            };

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleOrderDetail)]
        [HttpPost]
        public async Task<PagedResultWithTotalColuumnsDto<GetListReportSaleOrderDetailOutput>> GetSaleOrderDetailReport(GetListReportSaleOrderSummaryInput input)
        {

            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
                                               previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var defaultLocationGroups = await GetUserGroupByLocation();
            var userGroupCustomers = await GetUserGroupCustomers();
            var userGroupItems = await GetUserGroupItems();

            var groupByProperty = false;
            if (!input.GroupBy.IsNullOrWhiteSpace())
            {
                var columns = await GetReportTemplateSaleOrderDetail();
                groupByProperty = columns.ColumnInfo.Any(s => s.ColumnName == input.GroupBy && s.ColumnType == ColumnType.ItemProperty);
            }

            var invoiceItemQuery = from iv in _invoiceItemRepository.GetAll()
                                            .Where(s => s.OrderItemId.HasValue)
                                            .Where(s => s.ItemIssueItemId.HasValue)
                                            .AsNoTracking()
                                   join j in _journalRepository.GetAll()
                                      .Where(s => s.InvoiceId.HasValue)
                                      .Where(s => s.Status == TransactionStatus.Publish)
                                      .AsNoTracking()
                                   on iv.InvoiceId equals j.InvoiceId

                                   join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.ItemIssueSaleItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ri.ItemIssueSaleItemId
                                   into r1

                                   join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.CustomerCreditItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                   into r2

                                   let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                   let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                   select new
                                   {
                                       OrderItemId = iv.OrderItemId,
                                       Qty = iv.Qty,
                                       ReturnQty = rq1 + rq2
                                   };

            var itemIssueItemQuery = from iv in _itemIssueItemRepository.GetAll()
                                             .Where(s => s.SaleOrderItemId.HasValue)
                                             .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                          .Where(s => s.ItemIssueId.HasValue)
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .AsNoTracking()
                                     on iv.ItemIssueId equals j.ItemIssueId
                                     join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.ItemIssueSaleItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ri.ItemIssueSaleItemId
                                     into r1

                                     join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.CustomerCreditItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                     into r2

                                     let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                     let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                     select new
                                     {
                                         SaleOrderItemId = iv.SaleOrderItemId,
                                         Qty = iv.Qty,
                                         ReturnQty = rq1 + rq2
                                     };

            var dinvoiceItemQuery = from iv in _invoiceItemRepository.GetAll()
                                          .Where(s => s.DeliveryScheduleItem.SaleOrderItemId.HasValue)
                                          .Where(s => s.ItemIssueItemId.HasValue)
                                          .AsNoTracking()
                                   join j in _journalRepository.GetAll()
                                      .Where(s => s.InvoiceId.HasValue)
                                      .Where(s => s.Status == TransactionStatus.Publish)
                                      .AsNoTracking()
                                   on iv.InvoiceId equals j.InvoiceId

                                   join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.ItemIssueSaleItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ri.ItemIssueSaleItemId
                                   into r1

                                   join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.CustomerCreditItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                   into r2

                                   let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                   let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                   select new
                                   {
                                       OrderItemId = iv.DeliveryScheduleItem.SaleOrderItemId,
                                       Qty = iv.Qty,
                                       ReturnQty = rq1 + rq2
                                   };

            var ditemIssueItemQuery = from iv in _itemIssueItemRepository.GetAll()
                                             .Where(s => s.DeliveryScheduleItem.SaleOrderItemId.HasValue)
                                             .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                          .Where(s => s.ItemIssueId.HasValue)
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .AsNoTracking()
                                     on iv.ItemIssueId equals j.ItemIssueId
                                     join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.ItemIssueSaleItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ri.ItemIssueSaleItemId
                                     into r1

                                     join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.CustomerCreditItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                     into r2

                                     let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                     let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                     select new
                                     {
                                         SaleOrderItemId = iv.DeliveryScheduleItem.SaleOrderItemId,
                                         Qty = iv.Qty,
                                         ReturnQty = rq1 + rq2
                                     };


            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();

            var customerQuery = GetCustomers(userGroupCustomers, input.Customers, input.CustomerTypes, customerTypeMemberIds);
            var locationQuery = GetLocations(null, input.Locations);
            var userQuery = GetUsers(input.Users);


            var orderQuery = from o in _saleOrderRepository.GetAll()
                                       .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                                        .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                        .WhereIf(input.FromDate != null && input.ToDate != null,
                                                (u => (u.OrderDate.Date) >= (input.FromDate.Date) && (u.OrderDate.Date) <= (input.ToDate.Date)))
                                        .WhereIf(!input.Filter.IsNullOrEmpty(), u =>
                                                u.OrderNumber.ToLower().Contains(input.Filter.ToLower()) ||
                                                u.Reference.ToLower().Contains(input.Filter.ToLower()))
                                        .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                        .WhereIf(input.Customers != null && input.Customers.Any(), s => input.Customers.Contains(s.CustomerId))
                                        .WhereIf(input.DeliveryStatuses != null && input.DeliveryStatuses.Count > 0, u => input.DeliveryStatuses.Contains(u.ReceiveStatus))
                                        .WhereIf(input.Statuses != null && input.Statuses.Count > 0, u => input.Statuses.Contains(u.Status))
                                        .AsNoTracking()
                                        .Select(o => new
                                        {
                                            Id = o.Id,
                                            OrderNumber = o.OrderNumber,
                                            Date = o.OrderDate,
                                            LocationId = o.LocationId,
                                            CustomerId = o.CustomerId,
                                            Memo = o.Memo,
                                            CreatorUserId = o.CreatorUserId,
                                            Reference = o.Reference,
                                            OrderAmount = o.Total,
                                            OrderAmountMultiCurrency = o.MultiCurrencyTotal,
                                            ReceiveStatus = o.ReceiveStatus,
                                            TotalIssueCount = o.IssueCount,
                                            o.Status
                                        })
                             join c in customerQuery
                             on o.CustomerId equals c.Id
                             join l in locationQuery
                             on o.LocationId equals l.Id
                             join u in userQuery
                             on o.CreatorUserId equals u.Id
                             select new GetListReportSaleOrderSummaryOutput
                             {
                                 Id = o.Id,
                                 OrderNumber = o.OrderNumber,
                                 Date = o.Date,
                                 LocationId = o.LocationId,
                                 CustomerId = o.CustomerId,
                                 Description = o.Memo,
                                 Reference = o.Reference,
                                 OrderAmount = o.OrderAmount,
                                 OrderAmountMultiCurrency = o.OrderAmountMultiCurrency,
                                 DeliveryStatus = o.ReceiveStatus,
                                 TotalIssueCount = o.TotalIssueCount,
                                 User = u.UserName,
                                 LocationName = l.LocationName,
                                 CustomerName = c.CustomerName,
                                 Status = o.Status
                             };

            var itemOrderWithIssue = from oi in _saleOrderItemRepository.GetAll()
                                                 .AsNoTracking()
                                                 .Select(oi => new
                                                 {
                                                     OrderId = oi.SaleOrderId,
                                                     OrderItemId = oi.Id,
                                                     ItemId = oi.ItemId,
                                                     OrderQty = oi.Qty,
                                                     oi.UnitCost,
                                                     oi.Total,
                                                     oi.Description
                                                 })

                                     join bi in invoiceItemQuery
                                     on oi.OrderItemId equals bi.OrderItemId
                                     into bItems

                                     join ri in itemIssueItemQuery
                                     on oi.OrderItemId equals ri.SaleOrderItemId
                                     into rItems

                                     join dbi in dinvoiceItemQuery
                                     on oi.OrderItemId equals dbi.OrderItemId
                                     into dbItems

                                     join dri in ditemIssueItemQuery
                                     on oi.OrderItemId equals dri.SaleOrderItemId
                                     into drItems

                                     let bQty = bItems == null || bItems.Count() == 0 ? 0 : bItems.Sum(r => r.Qty - r.ReturnQty)
                                     let rQty = rItems == null || rItems.Count() == 0 ? 0 : rItems.Sum(r => r.Qty - r.ReturnQty)
                                     let dbQty = dbItems == null || dbItems.Count() == 0 ? 0 : dbItems.Sum(r => r.Qty - r.ReturnQty)
                                     let drQty = drItems == null || drItems.Count() == 0 ? 0 : drItems.Sum(r => r.Qty - r.ReturnQty)
                                     let receiveQty = bQty + rQty + dbQty + drQty

                                     select new SaleOrderItemDetailOutput
                                     {
                                         OrderId = oi.OrderId,
                                         OrderItemId = oi.OrderItemId,
                                         ItemId = oi.ItemId,
                                         OrderQty = oi.OrderQty,
                                         IssueQty = receiveQty,
                                         UnitPrice = oi.UnitCost,
                                         Total = oi.Total,
                                         Description = oi.Description
                                     };

            var itemQuery = GetItemWithProperties(new List<Guid>(), new List<Guid>(), null);

            var orderItemWithProperty = from oi in itemOrderWithIssue

                                        join i in itemQuery
                                        on oi.ItemId equals i.Id

                                        let netWeight = !i.Properties.Any(p => p.IsUnit) ? 0 : i.Properties.Where(t => t.IsUnit).Select(t => t.NetWeight).FirstOrDefault()
                                        let propertypeGroup = groupByProperty ? i.Properties.Where(t => t.PropertyName == input.GroupBy).Select(t => t.Value).FirstOrDefault() : ""

                                        select new SaleOrderItemDetailOutput
                                        {
                                            OrderId = oi.OrderId,
                                            OrderItemId = oi.OrderItemId,
                                            ItemId = oi.ItemId,
                                            ItemCode = i.ItemCode,
                                            ItemName = i.ItemName,
                                            OrderQty = oi.OrderQty,
                                            IssueQty = oi.IssueQty,
                                            NetWeight = netWeight,
                                            UnitPrice = oi.UnitPrice,
                                            Total = oi.Total,
                                            Properties = i.Properties,
                                            Description = oi.Description,
                                            PropertyGroup = propertypeGroup
                                        };


            var query = from o in orderQuery
                        join oi in orderItemWithProperty
                        on o.Id equals oi.OrderId

                        where (input.Items == null || !input.Items.Any() || input.Items.Contains(oi.ItemId)) &&
                              (input.PropertyDics == null || !input.PropertyDics.Any() ||
                               oi.Properties.Where(ip => input.PropertyDics.Any(v => v.PropertyId == ip.PropertyId) &&
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId) != null &&
                                   (input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds == null ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Count == 0 ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Contains(ip.Id)))
                                .Count() == input.PropertyDics.Count)

                        select new GetListReportSaleOrderDetailOutput
                        {
                            Id = o.Id,
                            Date = o.Date,
                            OrderNumber = o.OrderNumber,
                            Reference = o.Reference,
                            DeliveryStatus = o.DeliveryStatus,
                            DeliveryStatusName = o.DeliveryStatus.ToString(),
                            Status = o.Status,
                            StatusName = o.Status.ToString(),
                            User = o.User,
                            Memo = o.Description,
                            LocationId = o.LocationId,
                            LocationName = o.LocationName,
                            CustomerId = o.CustomerId,
                            CustomerName = o.CustomerName,
                            Description = oi.Description,
                            ItemId = oi.ItemId,
                            ItemCode = oi.ItemCode,
                            ItemName = oi.ItemName,
                            OrderQty = oi.OrderQty,
                            IssueQty = oi.IssueQty,
                            QtyBalance = oi.OrderQty - oi.IssueQty,
                            OrderNetWeight = oi.OrderQty * oi.NetWeight,
                            IssueNetWeight = oi.IssueQty * oi.NetWeight,
                            NetWeightBalance = (oi.OrderQty - oi.IssueQty) * oi.NetWeight,
                            OrderNetWeightInTon = Math.Round(oi.OrderQty * oi.NetWeight / 1000, currentRoundingDigit),
                            IssueNetWeightInTon = Math.Round(oi.IssueQty * oi.NetWeight / 1000, currentRoundingDigit),
                            NetWeightBalanceInTon = Math.Round((oi.OrderQty - oi.IssueQty) * oi.NetWeight / 1000, currentRoundingDigit),
                            UnitPrice = oi.UnitPrice,
                            UnitPriceInTon = oi.NetWeight == 0 ? 0 : Math.Round(oi.UnitPrice / oi.NetWeight * 1000, currentRoundingDigitUnitCost),
                            Total = oi.Total,
                            Properties = oi.Properties,
                            RoundingDigit = currentRoundingDigit,
                            PropertyGroup = oi.PropertyGroup
                        };


            SaleOrderDetailColumnSummaryOutPut summary = null;
            var resultCount = await query.CountAsync();

            if (resultCount == 0) return new PagedResultWithTotalColuumnsDto<GetListReportSaleOrderDetailOutput>(resultCount, new List<GetListReportSaleOrderDetailOutput>(), new Dictionary<string, decimal>());

            if (input.IsLoadMore == false && input.ColumnNamesToSum != null)
            {
                summary = await query.Select(s => new
                {
                    s.OrderQty,
                    s.IssueQty,
                    s.QtyBalance,
                    s.OrderNetWeight,
                    s.IssueNetWeight,
                    s.NetWeightBalance,
                    s.OrderNetWeightInTon,
                    s.IssueNetWeightInTon,
                    s.NetWeightBalanceInTon,
                    s.Total
                })
                .GroupBy(s => 1)
                .Select(s => new SaleOrderDetailColumnSummaryOutPut
                {
                    TotalAmount = s.Sum(t => t.Total),
                    TotalOrderQty = s.Sum(t => t.OrderQty),
                    TotalIssueQty = s.Sum(t => t.IssueQty),
                    QtyBalance = s.Sum(t => t.QtyBalance),
                    TotalOrderNetWeight = s.Sum(t => t.OrderNetWeight),
                    TotalIssueNetWeight = s.Sum(t => t.IssueNetWeight),
                    NetWeightBalance = s.Sum(t => t.NetWeightBalance),
                    TotalOrderNetWeightInTon = s.Sum(t => t.OrderNetWeightInTon),
                    TotalIssueNetWeightInTon = s.Sum(t => t.IssueNetWeightInTon),
                    NetWeightBalanceInTon = s.Sum(t => t.NetWeightBalanceInTon),
                })
                .FirstOrDefaultAsync();

            }
            var sumOfColumns = new Dictionary<string, decimal>();

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "Total")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalAmount);
                    }
                    else if (col == "OrderQty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalOrderQty);
                    }
                    else if (col == "IssueQty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueQty);
                    }
                    else if (col == "QtyBalance")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.QtyBalance);
                    }
                    else if (col == "OrderNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalOrderNetWeight);
                    }
                    else if (col == "IssueNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueNetWeight);
                    }
                    else if (col == "NetWeightBalance")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.NetWeightBalance);
                    }
                    else if (col == "OrderNetWeightInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalOrderNetWeightInTon);
                    }
                    else if (col == "IssueNetWeightInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueNetWeightInTon);
                    }
                    else if (col == "NetWeightBalanceInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.NetWeightBalanceInTon);
                    }
                }
            }


            switch (input.GroupBy)
            {
                case "Date":
                    query = query.OrderBy(s => s.Date);
                    break;
                case "Location":
                    query = query.OrderBy(s => s.LocationName);
                    break;
                case "Customer":
                    query = query.OrderBy(s => s.CustomerName);
                    break;
                case "Item":
                    query = query.OrderBy(s => s.ItemCode);
                    break;
                case "OrderNumber":
                    query = query.OrderBy(s => s.OrderNumber);
                    break;
                default:
                    if (groupByProperty)
                    {
                        query = query.OrderBy(s => s.PropertyGroup);
                    }
                    else
                    {
                        query = query.OrderBy(s => input.Sorting);
                    }
                    break;
            }

            var @entities = new List<GetListReportSaleOrderDetailOutput>();
            if (input.UsePagination == true)
            {
                @entities = await query.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await query.ToListAsync();
            }

            var returnResult = new PagedResultWithTotalColuumnsDto<GetListReportSaleOrderDetailOutput>(resultCount, @entities, sumOfColumns);

            return returnResult;
        }


        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleOrderDetail_Export_Excel)]
        public async Task<FileDto> ExportExcelSaleOrderDetailReport(GetSaleOrderSummaryReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var reportResult = await GetSaleOrderDetailReport(input);
            var invoiceData = reportResult.Items;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                       .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                       .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd-MM-yyyy";
            }

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                //var subCols = invoiceData == null ? null : invoiceData.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
                //var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString(formatDate);
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                    ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                    colHeaderTable += 1;
                }

                //if (isMultiCurrencies) rowTableHeader += 1;
                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                var groupByProperty = false;
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    groupByProperty = report.ColumnInfo.Any(s => s.ColumnName == input.GroupBy && s.ColumnType == ColumnType.ItemProperty);
                }

                var groupBy = new List<GetListReportSaleOrderDetailGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = invoiceData
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Customer":
                            groupBy = invoiceData
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = invoiceData
                                .GroupBy(t => t.Date.Date)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Item":
                            groupBy = invoiceData
                                .GroupBy(t => t.ItemCode)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.ItemCode}-{x.ItemName}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "OrderNumber":
                            groupBy = invoiceData
                                .GroupBy(t => t.OrderNumber)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.OrderNumber}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        default:
                            if (groupByProperty)
                            {
                                groupBy = invoiceData
                                .GroupBy(t => t.PropertyGroup)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Key,
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            }
                            break;
                    }
                }
                // write body

                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0)
                {
                    foreach (var k in groupBy)
                    {
                        //key group by name
                        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                        rowBody += 1;
                        count = 1;
                        //list of item
                        foreach (var i in k.Items)
                        {
                            int collumnCellBody = 1;
                            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                            {

                                WriteBodySaleOrderDetail(ws, rowBody, collumnCellBody, item, i, count);
                                collumnCellBody += 1;
                            }
                            rowBody += 1;
                            count += 1;
                        }

                        //sub total of group by item
                        int collumnCellGroupBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (item.AllowFunction != null)
                            {
                                var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);
                                if (footerGroupDict.ContainsKey(item.ColumnName))
                                {
                                    footerGroupDict[item.ColumnName] += fromCell + ":" + toCell + ",";
                                }
                                else
                                {
                                    footerGroupDict.Add(item.ColumnName, fromCell + ":" + toCell + ",");
                                }
                                AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                            }
                            collumnCellGroupBody += 1;
                        }
                        rowBody += 1;
                    }
                }
                else
                {
                    foreach (var i in invoiceData)
                    {
                        int collumnCellBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            WriteBodySaleOrderDetail(ws, rowBody, collumnCellBody, item, i, count);
                            collumnCellBody += 1;
                        }
                        rowBody += 1;
                        count += 1;
                    }
                }
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (!input.GroupBy.IsNullOrWhiteSpace())
                            {
                                //sum custom range cell depend on group item
                                int rowFooter = rowTableHeader + 1;// get start row after 
                                var sumValue = "SUM(" + footerGroupDict[i.ColumnName] + ")";
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                }
                            }
                            else
                            {
                                int rowFooter = rowTableHeader + 1;// get start row after header 
                                var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }
                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"Sale_Order_Detail_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }


        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleOrderDetail_Export_Pdf)]
        public async Task<FileDto> ExportPDFSaleOrderDetailReport(GetSaleOrderSummaryReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                        .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                        .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }

            var rounding = await GetCurrentCycleAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            //int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;
            var user = await GetCurrentUserAsync();
            var invoices = await GetSaleOrderDetailReport(input);

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                //var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";

                            rowHeader = $"<th width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";

                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                //multiCurrencyHeader += isMultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                var groupByProperty = false;
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    groupByProperty = report.ColumnInfo.Any(s => s.ColumnName == input.GroupBy && s.ColumnType == ColumnType.ItemProperty);
                }

                var groupBy = new List<GetListReportSaleOrderDetailGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = invoices.Items
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Customer":
                            groupBy = invoices.Items
                                .GroupBy(t => t.CustomerName)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = invoices.Items
                                .GroupBy(t => t.Date.Date)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Item":
                            groupBy = invoices.Items
                                .GroupBy(t => t.ItemCode)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.ItemCode}-{x.ItemName}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "OrderNumber":
                            groupBy = invoices.Items
                                .GroupBy(t => t.ItemCode)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.OrderNumber}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        default:
                            if (groupByProperty)
                            {
                                groupBy = invoices.Items
                                .GroupBy(t => t.PropertyGroup)
                                .Select(t => new GetListReportSaleOrderDetailGroupByOutput
                                {
                                    KeyName = t.Key,
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            }
                            break;
                    }
                }

                // write body
                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0) //write body have group by
                {
                    var trGroup = "";
                    foreach (var k in groupBy)
                    {
                        trGroup += $"<tr style='page-break-before: auto; page-break-after: auto;'>" +
                                   $"<td style='font-weight: bold;' colspan='{reportCountColHead}'> " + k.KeyName +
                                   $" </td></tr>";
                        foreach (var row in k.Items)
                        {
                            trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                            foreach (var i in viewHeader)
                            {
                                if (i.Visible)
                                {
                                    if (i.ColumnName == "Location")
                                    {
                                        trGroup += $"<td>{row.LocationName}</td>";
                                    }
                                    else if (i.ColumnName == "Date")
                                    {
                                        trGroup += $"<td>{row.Date.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "OrderNumber")
                                    {
                                        trGroup += $"<td>{row.OrderNumber}</td>";
                                    }
                                    else if (i.ColumnName == "Reference")
                                    {
                                        trGroup += $"<td>{row.Reference}</td>";
                                    }
                                    else if (i.ColumnName == "Memo")
                                    {
                                        trGroup += $"<td>{row.Memo}</td>";
                                    }
                                    else if (i.ColumnName == "Description")
                                    {
                                        trGroup += $"<td>{row.Description}</td>";
                                    }
                                    else if (i.ColumnName == "Customer")
                                    {
                                        trGroup += $"<td>{row.CustomerName}</td>";
                                    }
                                    else if (i.ColumnName == "User")
                                    {
                                        trGroup += $"<td>{row.User}</td>";
                                    }
                                    else if (i.ColumnName == "OrderNetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "IssueNetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "NetWeightBalance")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "OrderNetWeightInTon")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "IssueNetWeightInTon")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "NetWeightBalanceInTon")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalanceInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryStatus")
                                    {
                                        trGroup += $"<td>{row.DeliveryStatus.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "Status")
                                    {
                                        trGroup += $"<td>{row.Status.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "ItemCode")
                                    {
                                        trGroup += $"<td>{row.ItemCode}</td>";
                                    }
                                    else if (i.ColumnName == "ItemName")
                                    {
                                        trGroup += $"<td>{row.ItemName}</td>";
                                    }
                                    else if (i.ColumnName == "OrderQty")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "IssueQty")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "QtyBalance")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.QtyBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "Total")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Total, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "UnitPrice")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPrice, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "UnitPriceInTon")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPriceInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else
                                    {
                                        var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                        if (property != null)
                                        {
                                            trGroup += $"<td>{property.Value}</td>";
                                        }
                                        else
                                        {
                                            trGroup += $"<td></td>";
                                        }
                                    }
                                }
                            }
                            trGroup += "</tr>";
                        }
                        trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                                {
                                    if (i.ColumnName == "OrderQty")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.OrderQty), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "IssueQty")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.IssueQty), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "QtyBalance")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.QtyBalance), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "OrderNetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.OrderNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "IssueNetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.IssueNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "NetWeightBalance")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.NetWeightBalance), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "OrderNetWeightInTon")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.OrderNetWeightInTon), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "IssueNetWeightInTon")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.IssueNetWeightInTon), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "NetWeightBalanceInTon")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.NetWeightBalanceInTon), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "Total")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.Total), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    trGroup += $"<td></td>";
                                }

                            }
                        }
                        trGroup += "</tr>";
                    }
                    contentBody += trGroup;
                }
                else // write body no group by
                {
                    foreach (var row in invoices.Items)
                    {
                        var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "Location")
                                {
                                    tr += $"<td>{row.LocationName}</td>";
                                }
                                else if (i.ColumnName == "Date")
                                {
                                    tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "OrderNumber")
                                {
                                    tr += $"<td>{row.OrderNumber}</td>";
                                }
                                else if (i.ColumnName == "Reference")
                                {
                                    tr += $"<td>{row.Reference}</td>";
                                }
                                else if (i.ColumnName == "Memo")
                                {
                                    tr += $"<td>{row.Memo}</td>";
                                }
                                else if (i.ColumnName == "Description")
                                {
                                    tr += $"<td>{row.Description}</td>";
                                }
                                else if (i.ColumnName == "Customer")
                                {
                                    tr += $"<td>{row.CustomerName}</td>";
                                }
                                else if (i.ColumnName == "User")
                                {
                                    tr += $"<td>{row.User}</td>";
                                }
                                else if (i.ColumnName == "OrderNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "IssueNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "NetWeightBalance")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "OrderNetWeightInTon")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "IssueNetWeightInTon")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "NetWeightBalanceInTon")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalanceInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "DeliveryStatus")
                                {
                                    tr += $"<td>{row.DeliveryStatus.ToString()}</td>";
                                }
                                else if (i.ColumnName == "Status")
                                {
                                    tr += $"<td>{row.Status.ToString()}</td>";
                                }
                                else if (i.ColumnName == "ItemCode")
                                {
                                    tr += $"<td>{row.ItemCode}</td>";
                                }
                                else if (i.ColumnName == "ItemName")
                                {
                                    tr += $"<td>{row.ItemName}</td>";
                                }
                                else if (i.ColumnName == "OrderQty")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "IssueQty")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "QtyBalance")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.QtyBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "Total")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Total, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "UnitPrice")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPrice, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "UnitPriceInTon")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPriceInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else
                                {
                                    var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                    if (property != null)
                                    {
                                        tr += $"<td>{property.Value}</td>";
                                    }
                                    else
                                    {
                                        tr += $"<td></td>";
                                    }
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index == 0)
                            {
                                tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))
                                {
                                    if (invoices.TotalResult != null && invoices.TotalResult.ContainsKey(i.ColumnName))
                                    {
                                        tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(invoices.TotalResult[i.ColumnName], rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", "");
                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);
                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{sheetName}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }
        #endregion



        #region Sale Invoice Report

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleInvoice)]
        [HttpPost]
        public async Task<PagedResultWithTotalColuumnsDto<GetListSaleInvoiceReportOutput>> GetSaleInvoiceReport(GetListReportSaleInvoiceInput input)
        {
            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
                                               previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var isFilterByAccountCurrency = input.CurrencyFilter != CurrencyFilter.MultiCurrencies;

            var defaultLocationGroups = await GetUserGroupByLocation();
            var userGroupItems = await GetUserGroupItems();
            var userGroupCustomers = await GetUserGroupCustomers();

            var itemQuery = GetItemWithProperties(userGroupItems, input.Items, input.PropertyDics);

            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();

            var customerQuery = GetCustomerWithType(userGroupCustomers, input.Customers, input.CustomerTypes, customerTypeMemberIds);

            var filterItem = (input.Items != null && input.Items.Any()) ||
                             (input.PropertyDics != null && input.PropertyDics.Any());

            var journalItemQuery = from j in _journalRepository.GetAll()
                                                .AsNoTracking()
                                                .Where(s => s.Status == TransactionStatus.Publish)
                                                .Where(u => u.JournalType == JournalType.ReceivePayment || u.JournalType == JournalType.Invoice || u.JournalType == JournalType.CustomerCredit)
                                                .WhereIf(input.JournalTypes != null && input.JournalTypes.Any(), s => input.JournalTypes.Contains(s.JournalType))
                                                .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                                                .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                                .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                                .WhereIf(input.FromDate != null && input.ToDate != null,
                                                    (u => (u.Date.Date) >= (input.FromDate.Date) && (u.Date.Date) <= (input.ToDate.Date)))
                                                .WhereIf(!input.Filter.IsNullOrEmpty(),
                                                    u => u.JournalNo.ToLower().Contains(input.Filter.ToLower()) ||
                                                            u.Reference.ToLower().Contains(input.Filter.ToLower()))
                                   join ji in _journalItemRepository.GetAll()
                                                .AsNoTracking()
                                                .Where(t => t.Identifier != null)
                                                .WhereIf(input.Accounts != null && input.Accounts.Any(), u => input.Accounts.Contains(u.AccountId))
                                                .WhereIf(!input.Accounts.IsNullOrEmpty(), s => input.Accounts.Contains(s.AccountId))
                                                .WhereIf(!input.AccountTypes.IsNullOrEmpty(), s => input.AccountTypes.Contains(s.Account.AccountTypeId))
                                   on j.Id equals ji.JournalId
                                   select new
                                   {
                                       Date = j.Date,
                                       JournalNo = j.JournalNo,
                                       Reference = j.Reference,
                                       CreationTimeIndex = j.CreationTimeIndex,
                                       CreatorUserId = j.CreatorUserId,
                                       LocationId = j.LocationId,
                                       CurrencyId = isFilterByAccountCurrency ? j.CurrencyId : j.MultiCurrencyId,
                                       CurrencyCode = isFilterByAccountCurrency ? j.Currency.Code : j.MultiCurrency.Code,
                                       UserName = j.CreatorUser.UserName,
                                       LocationName = j.Location.LocationName,
                                       Identifier = ji.Identifier,
                                       Description = ji.Description,
                                       AccountId = ji.AccountId,
                                       AccountCode = ji.Account.AccountCode,
                                       AccountName = ji.Account.AccountName
                                   };


            var paymentItemInvoiceJournalQuery = _journalRepository.GetAll()
                                                .Where(s => !filterItem)
                                                .Where(s => s.Status == TransactionStatus.Publish)
                                                .Where(s => s.JournalType == JournalType.Invoice)
                                                .Where(s => s.Date.Date < input.FromDate.Date)
                                                .Where(s => input.BillTypes == BillType.SelectAll ||
                                                            (input.BillTypes == BillType.Item && s.Invoice.IsItem) ||
                                                            (input.BillTypes == BillType.Account && !s.Invoice.IsItem))
                                                .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.Invoice.CustomerId))
                                                .WhereIf(input.SaleTypes != null && input.SaleTypes.Count > 0, u => u.Invoice.TransactionTypeSaleId.HasValue && input.SaleTypes.Contains(u.Invoice.TransactionTypeSaleId.Value))
                                                .AsNoTracking()
                                                .Select(j => new
                                                {
                                                    PayToInvoiceNo = j.JournalNo,
                                                    PayToInvoiceDate = j.Date,
                                                    PayToInvoiceId = j.InvoiceId,
                                                    CurrencyId = isFilterByAccountCurrency ? j.CurrencyId : j.MultiCurrencyId,
                                                    CurrencyCode = isFilterByAccountCurrency ? j.Currency.Code : j.MultiCurrency.Code
                                                });


            var paymentItemCreditJournalQuery = _journalRepository.GetAll()
                                                .Where(s => !filterItem)
                                                .Where(s => s.Status == TransactionStatus.Publish)
                                                .Where(s => s.JournalType == JournalType.CustomerCredit)
                                                .Where(s => s.Date.Date < input.FromDate.Date)
                                                .Where(s => input.BillTypes == BillType.SelectAll ||
                                                        (input.BillTypes == BillType.Item && s.CustomerCredit.IsItem) ||
                                                        (input.BillTypes == BillType.Account && !s.CustomerCredit.IsItem))
                                                .Where(s => input.SaleTypes == null || input.SaleTypes.Count == 0)
                                                .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerCredit.CustomerId))
                                                .AsNoTracking()
                                                .Select(j => new
                                                {
                                                    PayToInvoiceNo = j.JournalNo,
                                                    PayToInvoiceDate = j.Date,
                                                    PayToInvoiceId = j.CustomerCreditId,
                                                    CurrencyId = isFilterByAccountCurrency ? j.CurrencyId : j.MultiCurrencyId,
                                                    CurrencyCode = isFilterByAccountCurrency ? j.Currency.Code : j.MultiCurrency.Code,
                                                });


            var paymentToOldInvoiceQuery = from pi in _receivePaymentItemRepository.GetAll()
                                                        .Where(s => !filterItem)
                                                        .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                                        .AsNoTracking()
                                                        .Select(s => new
                                                        {
                                                            Id = s.Id,
                                                            PaymentId = s.ReceivePaymentId,
                                                            PayToId = s.PayToId,
                                                            CustomerId = s.CustomerId,
                                                            Payment = isFilterByAccountCurrency ? s.Payment : s.MultiCurrencyPayment,
                                                            CreationTime = s.CreationTime
                                                        })

                                           join j in _journalRepository.GetAll()
                                                        .Where(s => !filterItem)
                                                        .Where(s => s.Status == TransactionStatus.Publish)
                                                        .Where(u => u.JournalType == JournalType.ReceivePayment || u.JournalType == JournalType.Invoice || u.JournalType == JournalType.CustomerCredit)
                                                        .WhereIf(input.JournalTypes != null && input.JournalTypes.Any(), s => input.JournalTypes.Contains(s.JournalType))
                                                        .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                                                        .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                                        .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                                        .WhereIf(input.FromDate != null && input.ToDate != null,
                                                            (u => (u.Date.Date) >= (input.FromDate.Date) && (u.Date.Date) <= (input.ToDate.Date)))
                                                        .WhereIf(!input.Filter.IsNullOrEmpty(),
                                                            u => u.JournalNo.ToLower().Contains(input.Filter.ToLower()) ||
                                                                    u.Reference.ToLower().Contains(input.Filter.ToLower()))
                                                        .AsNoTracking()
                                                        .Select(s => s.ReceivePaymentId)
                                           on pi.PaymentId equals j

                                           join c in customerQuery
                                           on pi.CustomerId equals c.Id

                                           join inv in paymentItemInvoiceJournalQuery
                                           on pi.PayToId equals inv.PayToInvoiceId
                                           into invs
                                           from inv in invs.DefaultIfEmpty()

                                           join cc in paymentItemCreditJournalQuery
                                           on pi.PayToId equals cc.PayToInvoiceId
                                           into ccs
                                           from cc in ccs.DefaultIfEmpty()

                                           where inv != null || cc != null

                                           select new
                                           {
                                               Id = pi.Id,
                                               PaymentId = pi.PaymentId,
                                               PayToId = pi.PayToId,
                                               CustomerId = pi.CustomerId,
                                               Payment = inv != null ? pi.Payment : -pi.Payment,
                                               PayToInvoiceDate = inv != null ? inv.PayToInvoiceDate : cc.PayToInvoiceDate,
                                               PayToInvoiceNo = inv != null ? inv.PayToInvoiceNo : cc.PayToInvoiceNo,
                                               CurrencyId = inv != null ? inv.CurrencyId : cc.CurrencyId,
                                               CurrencyCode = inv != null ? inv.CurrencyCode : cc.CurrencyCode,
                                               CustomerName = c.CustomerName,
                                               CustomerTypeName = c.CustomerTypeName,
                                               CreationTime = pi.CreationTime
                                           };


            var iQuery = _invoiceRepository.GetAll()
                            .Where(s => input.BillTypes == BillType.SelectAll ||
                                        (input.BillTypes == BillType.Item && s.IsItem) ||
                                        (input.BillTypes == BillType.Account && !s.IsItem))
                            .WhereIf(filterItem, s => s.IsItem)
                            .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                            .WhereIf(input.SaleTypes != null && input.SaleTypes.Any(), u => input.SaleTypes.Contains(u.TransactionTypeSaleId.Value))
                            .AsNoTracking()
                            .Select(s => new
                            {
                                Id = s.Id,
                                SaleTypeName = s.TransactionTypeSale == null ? "" : s.TransactionTypeSale.TransactionTypeName,
                                CustomerId = s.CustomerId,
                                Total = isFilterByAccountCurrency ? s.Total : s.MultiCurrencyTotal
                            });

            var invoiceQuery = from i in iQuery
                               join c in customerQuery
                               on i.CustomerId equals c.Id
                               select new
                               {
                                   Id = i.Id,
                                   CustomerId = i.CustomerId,
                                   Total = i.Total,
                                   SaleTypeName = i.SaleTypeName,
                                   CustomerName = c.CustomerName,
                                   CustomerTypeName = c.CustomerTypeName
                               };


            var invoiceItemWithOrderQuery = from i in _invoiceItemRepository.GetAll()
                                               .Where(s => input.BillTypes == BillType.SelectAll ||
                                                           (input.BillTypes == BillType.Item && s.ItemId.HasValue) ||
                                                           (input.BillTypes == BillType.Account && !s.ItemId.HasValue))
                                               .WhereIf(filterItem, s => s.ItemId.HasValue)
                                               .WhereIf(input.Items != null && input.Items.Count > 0, s => input.Items.Contains(s.ItemId))
                                               .AsNoTracking()

                                            join oi in _saleOrderItemRepository.GetAll()
                                                      .AsNoTracking()
                                            on i.OrderItemId equals oi.Id
                                            into ois
                                            from oi in ois.DefaultIfEmpty()

                                            join ii in _itemIssueItemRepository.GetAll()
                                                        .Where(s => s.SaleOrderItemId.HasValue)
                                                        .AsNoTracking()
                                            on i.ItemIssueItemId equals ii.Id
                                            into iis
                                            from ii in iis.DefaultIfEmpty()

                                            join iio in _saleOrderItemRepository.GetAll()
                                                     .AsNoTracking()
                                            on ii.SaleOrderItemId equals iio.Id
                                            into iios
                                            from iio in iios.DefaultIfEmpty()

                                            select new
                                            {
                                                Id = i.Id,
                                                InvoiceId = i.InvoiceId,
                                                ItemId = i.ItemId,
                                                Qty = i.Qty,
                                                UnitCost = isFilterByAccountCurrency ? i.UnitCost : i.MultiCurrencyUnitCost,
                                                TaxId = i.TaxId,
                                                TaxName = i.Tax.TaxName,
                                                TaxRate = i.Tax.TaxRate,
                                                Total = isFilterByAccountCurrency ? i.Total : i.MultiCurrencyTotal,
                                                CreationTime = i.CreationTime,
                                                OrderItemId = i.OrderItemId,
                                                ItemIssueItemId = i.ItemIssueItemId,
                                                OrderNumber = oi != null ? oi.SaleOrder.OrderNumber : ii != null && iio != null ? iio.SaleOrder.OrderNumber : "",
                                                OrderReference = oi != null ? oi.SaleOrder.Reference : ii != null && iio != null ? iio.SaleOrder.Reference : ""
                                            };


            var invoiceItemQuery = from i in invoiceItemWithOrderQuery
                                   join ii in invoiceQuery
                                   on i.InvoiceId equals ii.Id
                                   select new
                                   {
                                       Id = i.Id,
                                       InvoiceId = i.InvoiceId,
                                       ItemId = i.ItemId,
                                       Qty = i.Qty,
                                       UnitCost = i.UnitCost,
                                       TaxId = i.TaxId,
                                       Total = i.Total,
                                       CreationTime = i.CreationTime,
                                       OrderNumber = i.OrderNumber,
                                       OrderReference = i.OrderReference,
                                       TaxName = i.TaxName,
                                       TaxRate = i.TaxRate,
                                       CustomerId = ii.CustomerId,
                                       InvoiceTotal = ii.Total,
                                       SaleTypeName = ii.SaleTypeName,
                                       CustomerName = ii.CustomerName,
                                       CustomerTypeName = ii.CustomerTypeName
                                   };


            var creditQuery = from i in _customerCreditRepository.GetAll()
                                        .Where(s => input.BillTypes == BillType.SelectAll ||
                                                    (input.BillTypes == BillType.Item && s.IsItem) ||
                                                    (input.BillTypes == BillType.Account && !s.IsItem))
                                        .WhereIf(filterItem, s => s.IsItem)
                                        .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                        .Where(s => input.SaleTypes == null || input.SaleTypes.Count == 0)
                                        .AsNoTracking()
                                        .Select(s => new
                                        {
                                            Id = s.Id,
                                            CustomerId = s.CustomerId,
                                            Total = isFilterByAccountCurrency ? -s.Total : -s.MultiCurrencyTotal
                                        })
                              join c in customerQuery
                              on i.CustomerId equals c.Id
                              select new
                              {
                                  Id = i.Id,
                                  CustomerId = i.CustomerId,
                                  Total = i.Total,
                                  CustomerName = c.CustomerName,
                                  CustomerTypeName = c.CustomerTypeName
                              };

            var creditItemQuery = from ii in _customerCreditItemRepository.GetAll()
                                            .Where(s => input.BillTypes == BillType.SelectAll ||
                                                        (input.BillTypes == BillType.Item && s.ItemId.HasValue) ||
                                                        (input.BillTypes == BillType.Account && !s.ItemId.HasValue))
                                            .WhereIf(filterItem, s => s.ItemId.HasValue)
                                            .WhereIf(input.Items != null && input.Items.Count > 0, s => input.Items.Contains(s.ItemId))
                                            .AsNoTracking()

                                  join i in creditQuery
                                  on ii.CustomerCreditId equals i.Id

                                  select new
                                  {
                                      Id = ii.Id,
                                      CustomerCreditId = ii.CustomerCreditId,
                                      ItemId = ii.ItemId,
                                      Qty = -ii.Qty,
                                      UnitCost = isFilterByAccountCurrency ? ii.UnitCost : ii.MultiCurrencyUnitCost,
                                      TaxId = ii.TaxId,
                                      TaxName = ii.Tax.TaxName,
                                      TaxRate = ii.Tax.TaxRate,
                                      Total = isFilterByAccountCurrency ? -ii.Total : -ii.MultiCurrencyTotal,
                                      CreationTime = ii.CreationTime,
                                      CustomerId = i.CustomerId,
                                      InvoiceTotal = i.Total,
                                      CustomerName = i.CustomerName,
                                      CustomerTypeName = i.CustomerTypeName
                                  };


            var queryResult = from ji in journalItemQuery

                              join ii in invoiceItemQuery
                              on ji.Identifier equals ii.Id
                              into iis
                              from ii in iis.DefaultIfEmpty()

                              join ci in creditItemQuery
                              on ji.Identifier equals ci.Id
                              into cis
                              from ci in cis.DefaultIfEmpty()

                              join pi in paymentToOldInvoiceQuery
                              on ji.Identifier equals pi.Id
                              into pis
                              from pi in pis.DefaultIfEmpty()

                              where (ii != null || ci != null || pi != null) &&
                                    (
                                         input.OrderApply == OrderApply.All ||
                                        (input.OrderApply == OrderApply.Applied && ii != null && ii.OrderNumber != "") ||
                                        (input.OrderApply == OrderApply.NotApply && ii != null && ii.OrderNumber == "")
                                    )
                              select new GetListSaleInvoiceReportOutput
                              {
                                  InvoiceId = ii != null ? ii.InvoiceId : ci != null ? ci.CustomerCreditId : pi.PaymentId,
                                  Date = ji.Date,
                                  ItemId = ii != null ? ii.ItemId : ci != null ? ci.ItemId : (Guid?)null,
                                  ItemCode = pi != null ? pi.PayToInvoiceNo : "",
                                  ItemName = pi != null ? $"{pi.PayToInvoiceDate.ToString("yyyy-MM-dd")}/{pi.PayToInvoiceNo}" : "",
                                  LocationId = ji.LocationId.Value,
                                  LocationName = ji.LocationName,
                                  Qty = ii != null ? ii.Qty : ci != null ? ci.Qty : 0,
                                  TaxId = ii != null ? ii.TaxId : ci != null ? ci.TaxId : 0,
                                  TaxName = ii != null ? ii.TaxName : ci != null ? ci.TaxName : "",
                                  TaxRate = ii != null ? ii.TaxRate : ci != null ? ci.TaxRate : 0,
                                  Total = ii != null ? ii.Total : ci != null ? ci.Total : 0,
                                  InvoiceTotal = ii != null ? ii.InvoiceTotal : ci != null ? ci.InvoiceTotal : 0,
                                  Paid = 0,
                                  Balance = 0,
                                  UnitPrice = ii != null ? ii.UnitCost : ci != null ? ci.UnitCost : 0,
                                  CustomerId = ii != null ? ii.CustomerId : ci != null ? ci.CustomerId : pi.CustomerId,
                                  CustomerName = ii != null ? ii.CustomerName : ci != null ? ci.CustomerName : pi.CustomerName,
                                  CustomerType = ii != null ? ii.CustomerTypeName : ci != null ? ci.CustomerTypeName : pi.CustomerTypeName,
                                  JournalNo = ji.JournalNo,
                                  Reference = ji.Reference,
                                  User = ji.UserName,
                                  CreationTimeIndex = ji.CreationTimeIndex,
                                  CreationTime = ii != null ? ii.CreationTime : ci != null ? ci.CreationTime : pi.CreationTime,
                                  SaleType = ii != null ? ii.SaleTypeName : "",
                                  CurrencyId = pi != null ? pi.CurrencyId : ji.CurrencyId,
                                  CurrencyCode = pi != null ? pi.CurrencyCode : ji.CurrencyCode,
                                  AccountId = ji.AccountId,
                                  AccountCode = ji.AccountCode,
                                  AccountName = ji.AccountName,
                                  ReceivePayment = pi != null ? pi.Payment : 0,
                                  TotalReceive = pi != null ? pi.Payment : 0,
                                  IsPayment = pi != null,
                                  Description = ji.Description,
                                  OrderNo = ii != null ? ii.OrderNumber : "",
                                  OrderReference = ii != null ? ii.OrderReference : ""
                              };


            if (input.BillTypes != BillType.Account)
            {
                var itemResultQuery = from ii in queryResult
                                      join i in itemQuery
                                      on ii.ItemId equals i.Id
                                      into iis
                                      from i in iis.DefaultIfEmpty()

                                      let properties = i == null ? new List<ItemPropertySummary>() : i.Properties
                                      let netWeight = i == null || i.Properties == null ? 0 : i.Properties
                                                     .Where(t => t.IsUnit).Select(t => t.NetWeight * ii.Qty).FirstOrDefault()

                                      where !filterItem || i != null

                                      select new GetListSaleInvoiceReportOutput
                                      {
                                          InvoiceId = ii.InvoiceId,
                                          Date = ii.Date,
                                          ItemId = ii.ItemId,
                                          ItemCode = ii.IsPayment ? ii.ItemCode : i == null ? ii.AccountCode : i.ItemCode,
                                          ItemName = ii.IsPayment ? ii.ItemName : i == null ? ii.AccountName : i.ItemName,
                                          LocationId = ii.LocationId,
                                          LocationName = ii.LocationName,
                                          Qty = ii.Qty,
                                          TaxId = ii.TaxId,
                                          TaxName = ii.TaxName,
                                          TaxRate = ii.TaxRate,
                                          Total = ii.Total,
                                          InvoiceTotal = ii.InvoiceTotal,
                                          Paid = ii.Paid,
                                          Balance = ii.Balance,
                                          UnitPrice = ii.UnitPrice,
                                          CustomerId = ii.CustomerId,
                                          CustomerName = ii.CustomerName,
                                          CustomerType = ii.CustomerType,
                                          JournalNo = ii.JournalNo,
                                          Reference = ii.Reference,
                                          User = ii.User,
                                          CreationTimeIndex = ii.CreationTimeIndex,
                                          CreationTime = ii.CreationTime,
                                          SaleType = ii.SaleType,
                                          CurrencyId = ii.CurrencyId,
                                          CurrencyCode = ii.CurrencyCode,
                                          AccountId = ii.AccountId,
                                          AccountCode = ii.AccountCode,
                                          AccountName = ii.AccountName,
                                          ReceivePayment = ii.ReceivePayment,
                                          TotalReceive = ii.TotalReceive,
                                          IsPayment = ii.IsPayment,
                                          Description = ii.Description,
                                          OrderNo = ii.OrderNo,
                                          OrderReference = ii.OrderReference,
                                          NetWeight = netWeight,
                                          Properties = properties
                                      };

                queryResult = itemResultQuery;
            }


            //Query 1
            var ccols = await queryResult.Select(s => new { s.CurrencyId, s.CurrencyCode }).Distinct().ToListAsync();
            var currencyColumns = ccols.OrderBy(r => r.CurrencyCode);


            if (input.GroupBy == "JournalNo")
            {
                var paymentQuery = from j in _journalRepository.GetAll()
                                                .Where(s => s.Status == TransactionStatus.Publish)
                                                .Where(u => u.JournalType == JournalType.ReceivePayment)
                                                .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                                .WhereIf(input.FromDate != null && input.ToDate != null,
                                                    (u => (u.Date.Date) >= (input.FromDate.Date) && (u.Date.Date) <= (input.ToDate.Date)))
                                                .AsNoTracking()
                                            .Select(s => new
                                            {
                                                ReceivePaymentId = s.ReceivePaymentId
                                            })
                                   join pi in _receivePaymentItemRepository.GetAll()
                                              .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                              .AsNoTracking()
                                              .Select(s => new
                                              {
                                                  PaymentId = s.ReceivePaymentId,
                                                  PayToId = s.PayToId,
                                                  Payment = isFilterByAccountCurrency ?
                                                            (s.InvoiceId.HasValue ? s.Payment : -s.Payment) :
                                                            (s.InvoiceId.HasValue ? s.MultiCurrencyPayment : -s.MultiCurrencyPayment)
                                              })
                                   on j.ReceivePaymentId equals pi.PaymentId
                                   group pi by pi.PayToId
                                   into g
                                   select new
                                   {
                                       PayToId = g.Key,
                                       Payment = g.Sum(s => s.Payment)
                                   };


                var invoicePaymentQuery = from invi in queryResult

                                          join ip in paymentQuery
                                          on invi.InvoiceId equals ip.PayToId
                                          into payment
                                          from pay in payment.DefaultIfEmpty()
                                          let totalPaid = pay != null ? pay.Payment : 0

                                          select new GetListSaleInvoiceReportOutput
                                          {
                                              InvoiceId = invi.InvoiceId,
                                              Date = invi.Date,
                                              AccountName = invi.AccountName,
                                              AccountId = invi.AccountId,
                                              AccountCode = invi.AccountCode,
                                              ItemId = invi.ItemId,
                                              ItemCode = invi.ItemCode,
                                              ItemName = invi.ItemName,
                                              LocationId = invi.LocationId,
                                              LocationName = invi.LocationName,
                                              Qty = invi.Qty,
                                              TaxId = invi.TaxId,
                                              TaxName = invi.TaxName,
                                              TaxRate = invi.TaxRate,
                                              Total = invi.Total,
                                              UnitPrice = invi.UnitPrice,
                                              CustomerId = invi.CustomerId,
                                              CustomerName = invi.CustomerName,
                                              CustomerType = invi.CustomerType,
                                              Reference = invi.Reference,
                                              JournalNo = invi.JournalNo,
                                              User = invi.User,
                                              CreationTimeIndex = invi.CreationTimeIndex,
                                              CreationTime = invi.CreationTime,
                                              SaleType = invi.SaleType,
                                              CurrencyId = invi.CurrencyId,
                                              CurrencyCode = invi.CurrencyCode,
                                              InvoiceTotal = invi.InvoiceTotal,
                                              Paid = totalPaid,
                                              Balance = invi.InvoiceTotal - totalPaid,
                                              ReceivePayment = invi.ReceivePayment,
                                              TotalReceive = invi.IsPayment ? invi.TotalReceive : totalPaid,
                                              IsPayment = invi.IsPayment,
                                              Description = invi.Description,
                                              OrderNo = invi.OrderNo,
                                              OrderReference = invi.OrderReference,
                                              NetWeight = invi.NetWeight,
                                              Properties = invi.Properties
                                          };

                queryResult = invoicePaymentQuery;

            }


            var query = from q in queryResult

                        select new GetListSaleInvoiceReportOutput
                        {
                            Date = q.Date.Date,
                            AccountName = q.AccountName,
                            AccountId = q.AccountId,
                            AccountCode = q.AccountCode,
                            ItemId = q.ItemId,

                            ItemCode = q.ItemCode,
                            ItemName = q.ItemName,

                            LocationId = q.LocationId,
                            LocationName = q.LocationName,
                            Qty = q.Qty,
                            TaxId = q.TaxId,
                            TaxName = q.TaxName,
                            TaxRate = q.TaxRate,
                            Total = q.Total,
                            InvoiceTotal = q.InvoiceTotal,
                            Paid = q.Paid,
                            Balance = q.Balance,
                            ReceivePayment = q.ReceivePayment,
                            TotalReceive = q.TotalReceive,
                            IsPayment = q.IsPayment,
                            IsItem = q.IsItem,
                            UnitPrice = q.UnitPrice,
                            CustomerId = q.CustomerId,
                            CustomerName = q.CustomerName,
                            CustomerType = q.CustomerType,
                            Reference = q.Reference,
                            JournalNo = q.JournalNo,
                            InvoiceId = q.InvoiceId,
                            User = q.User,
                            CreationTimeIndex = q.CreationTimeIndex,
                            CreationTime = q.CreationTime,
                            RoundingDigit = currentRoundingDigit,
                            RoundingDigitUnitCost = currentRoundingDigitUnitCost,
                            SaleType = q.SaleType,
                            Properties = q.Properties,
                            OrderNo = q.OrderNo,
                            OrderReference = q.OrderReference,
                            NetWeight = q.NetWeight,
                            Description = q.Description,
                            CurrencyColumnTotals = currencyColumns.Select(s => new CurrencyColumnTotal
                            {
                                CurrencyId = s.CurrencyId.Value,
                                CurrencyCode = s.CurrencyCode,
                                Total = s.CurrencyId == q.CurrencyId ? q.Total : 0,
                                Paid = s.CurrencyId == q.CurrencyId ? q.Paid : 0,
                                Balance = s.CurrencyId == q.CurrencyId ? q.Balance : 0,
                                ReceivePayment = s.CurrencyId == q.CurrencyId ? q.ReceivePayment : 0,
                                TotalReceive = s.CurrencyId == q.CurrencyId ? q.TotalReceive : 0,
                            }).ToList(),
                        };

            var resultCount = 0;
            var sumOfColumns = new Dictionary<string, decimal>();
            var multiCurrencySumOfColumns = new Dictionary<string, Dictionary<string, decimal>>();
            List<SaleSummaryOut> sumQuery = null;

            if (input.IsLoadMore == false)
            {
                //Query 2  
                if (input.ColumnNamesToSum != null)
                {
                    sumQuery = await query.Select(s => new SaleSummaryOut
                    {
                        InvoiceId = s.InvoiceId,
                        JournalNo = s.JournalNo,
                        Total = s.Total,
                        Paid = s.Paid,
                        Balance = s.Balance,
                        CurrencyColumnTotals = s.CurrencyColumnTotals,
                        Qty = s.Qty,
                        ReceivePayment = s.ReceivePayment,
                        TotalReceive = s.TotalReceive,
                        NetWeight = s.NetWeight,
                    }).ToListAsync();

                    resultCount = sumQuery.Count();
                }
                else
                {
                    resultCount = await query.CountAsync();
                }
            }


            if (resultCount == 0 && !input.IsLoadMore) return new PagedResultWithTotalColuumnsDto<GetListSaleInvoiceReportOutput>(0, new List<GetListSaleInvoiceReportOutput>(), multiCurrencySumOfColumns);


            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                var sumPaidBalanceQuery = sumQuery.GroupBy(g => g.JournalNo).Select(s => s.First()).ToList();

                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "NetWeight")
                    {
                        sumOfColumns.Add(col, sumQuery.Sum(u => u.NetWeight));
                    }
                    else if (col == "Qty")
                    {
                        sumOfColumns.Add(col, sumQuery.Sum(u => u.Qty));
                    }
                    else if (col == "Total" || col == "ReceivePayment")
                    {
                        if (!isFilterByAccountCurrency)
                        {
                            var sumList = sumQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => col == "Total" ? s.Total : s.ReceivePayment),
                            }).ToDictionary(u => u.CurrencyCode);

                            var multiSumOfColumns = new Dictionary<string, decimal>();
                            foreach (var c in currencyColumns)
                            {
                                multiSumOfColumns.Add(c.CurrencyCode, groupByCurrencyDict.ContainsKey(c.CurrencyCode) ? groupByCurrencyDict[c.CurrencyCode].Total : 0);
                            }

                            multiCurrencySumOfColumns.Add(col, multiSumOfColumns);
                        }
                        else
                        {
                            sumOfColumns.Add(col, sumQuery.Sum(u => col == "Total" ? u.Total : u.ReceivePayment));
                        }
                    }
                    else if (col == "TotalReceive")
                    {
                        if (!isFilterByAccountCurrency)
                        {
                            var sumReceivePaymentList = sumQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var receivePaymentGroupByCurrencyDict = sumReceivePaymentList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => s.ReceivePayment),
                            }).ToDictionary(u => u.CurrencyCode);

                            var sumPaidList = sumPaidBalanceQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var paidGroupByCurrencyDict = sumPaidList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => s.Paid),
                            }).ToDictionary(u => u.CurrencyCode);

                            var multiSumOfColumns = new Dictionary<string, decimal>();
                            foreach (var c in currencyColumns)
                            {
                                var totalReceive = receivePaymentGroupByCurrencyDict.ContainsKey(c.CurrencyCode) ? receivePaymentGroupByCurrencyDict[c.CurrencyCode].Total : 0;
                                var totalPaid = paidGroupByCurrencyDict.ContainsKey(c.CurrencyCode) ? paidGroupByCurrencyDict[c.CurrencyCode].Total : 0;

                                multiSumOfColumns.Add(c.CurrencyCode, totalReceive + totalPaid);
                            }

                            multiCurrencySumOfColumns.Add(col, multiSumOfColumns);
                        }
                        else
                        {
                            var total = sumQuery.Sum(u => u.ReceivePayment) + sumPaidBalanceQuery.Sum(s => s.Paid);
                            sumOfColumns.Add(col, total);
                        }
                    }
                    else
                    {
                        if (!isFilterByAccountCurrency)
                        {
                            var sumList = sumPaidBalanceQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => col == "Paid" ? s.Paid : s.Balance),
                            }).ToDictionary(u => u.CurrencyCode);

                            var multiSumOfColumns = new Dictionary<string, decimal>();
                            foreach (var c in currencyColumns)
                            {
                                multiSumOfColumns.Add(c.CurrencyCode, groupByCurrencyDict.ContainsKey(c.CurrencyCode) ? groupByCurrencyDict[c.CurrencyCode].Total : 0);
                            }

                            multiCurrencySumOfColumns.Add(col, multiSumOfColumns);
                        }
                        else
                        {
                            sumOfColumns.Add(col, sumPaidBalanceQuery.Sum(u => col == "Paid" ? u.Paid : u.Balance));
                        }
                    }
                }
            }

            switch (input.GroupBy)
            {
                case "Item":
                    query = query.OrderBy(s => s.ItemCode).ThenBy(s => s.CreationTimeIndex);
                    break;
                case "Date":
                    query = query.OrderBy(s => s.Date.Date).ThenBy(s => s.CreationTimeIndex);
                    break;
                case "Location":
                    query = query.OrderBy(s => s.LocationId).ThenBy(s => s.CreationTimeIndex);
                    break;
                case "Customer":
                    query = query.OrderBy(s => s.CustomerId).ThenBy(s => s.CreationTimeIndex);
                    break;
                case "Account":
                    query = query.OrderBy(s => s.AccountCode).ThenBy(s => s.CreationTimeIndex);
                    break;
                default:
                    query = query.OrderBy(input.Sorting).ThenBy(s => s.CreationTimeIndex);
                    break;
            }

            var @entities = new List<GetListSaleInvoiceReportOutput>();
            if (input.UsePagination == true)
            {
                @entities = await query.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await query.ToListAsync();
            }

            var returnResult = new PagedResultWithTotalColuumnsDto<GetListSaleInvoiceReportOutput>(resultCount, @entities, multiCurrencySumOfColumns);
            returnResult.TotalResult = sumOfColumns;

            return returnResult;
        }

        private async Task<PagedResultWithTotalColuumnsDto<GetListSaleInvoiceReportOutput>> GetSaleInvoiceReportOld(GetListReportSaleInvoiceInput input)
        {
            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
                                               previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var isFilterByAccountCurrency = input.CurrencyFilter != CurrencyFilter.MultiCurrencies;

            var defaultLocationGroups = await GetUserGroupByLocation();
            var userGroupItems = await GetUserGroupItems();
            var userGroupCustomers = await GetUserGroupCustomers();

            var itemQuery = GetItemWithProperties(userGroupItems, input.Items, input.PropertyDics);

            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();

            var customerQuery = GetCustomerWithType(userGroupCustomers, input.Customers, input.CustomerTypes, customerTypeMemberIds);
            var locationQuery = GetLocations(null, input.Locations);
            var userQuery = GetUsers(input.Users);
            var currencyQuery = GetCurrencies();
            var accountQuery = GetAccountWithCode(input.Accounts, input.AccountTypes);
            var taxQuery = GetTaxs();

            var filterItem = (input.Items != null && input.Items.Any()) ||
                             (input.PropertyDics != null && input.PropertyDics.Any());

            var jiQuery = from ji in _journalItemRepository.GetAll()
                                        .Where(t => t.Identifier != null)
                                        .WhereIf(input.Accounts != null && input.Accounts.Any(), u => input.Accounts.Contains(u.AccountId))
                                        .AsNoTracking()
                                        .Select(s => new
                                        {
                                            JournalId = s.JournalId,
                                            Identifier = s.Identifier,
                                            Description = s.Description,
                                            AccountId = s.AccountId
                                        })

                          join a in accountQuery
                          on ji.AccountId equals a.Id
                          select new
                          {
                              JournalId = ji.JournalId,
                              Identifier = ji.Identifier,
                              Description = ji.Description,
                              AccountId = ji.AccountId,
                              AccountCode = a.AccountCode,
                              AccountName = a.AccountName
                          };

            var journalQeury = from j in _journalRepository.GetAll()
                                        .Where(s => s.Status == TransactionStatus.Publish)
                                        .Where(u => u.JournalType == JournalType.ReceivePayment || u.JournalType == JournalType.Invoice || u.JournalType == JournalType.CustomerCredit)
                                        .WhereIf(input.JournalTypes != null && input.JournalTypes.Any(), s => input.JournalTypes.Contains(s.JournalType))
                                        .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                                        .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                        .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                        .WhereIf(input.FromDate != null && input.ToDate != null,
                                            (u => (u.Date.Date) >= (input.FromDate.Date) && (u.Date.Date) <= (input.ToDate.Date)))
                                        .WhereIf(!input.Filter.IsNullOrEmpty(),
                                            u => u.JournalNo.ToLower().Contains(input.Filter.ToLower()) ||
                                                    u.Reference.ToLower().Contains(input.Filter.ToLower()))
                                        .AsNoTracking()
                                        .Select(s => new
                                        {
                                            Id = s.Id,
                                            Date = s.Date,
                                            JournalNo = s.JournalNo,
                                            Reference = s.Reference,
                                            CreationTimeIndex = s.CreationTimeIndex,
                                            CreatorUserId = s.CreatorUserId,
                                            LocationId = s.LocationId,
                                            CurrencyId = isFilterByAccountCurrency ? s.CurrencyId : s.MultiCurrencyId
                                        })
                               join c in currencyQuery
                               on j.CurrencyId equals c.Id
                               join l in locationQuery
                               on j.LocationId equals l.Id
                               join u in userQuery
                               on j.CreatorUserId equals u.Id
                               select new
                               {
                                   Id = j.Id,
                                   Date = j.Date,
                                   JournalNo = j.JournalNo,
                                   Reference = j.Reference,
                                   CreationTimeIndex = j.CreationTimeIndex,
                                   CreatorUserId = j.CreatorUserId,
                                   LocationId = j.LocationId,
                                   CurrencyId = j.CurrencyId,
                                   CurrencyCode = c.Code,
                                   UserName = u.UserName,
                                   LocationName = l.LocationName
                               };

            var journalItemQuery = from j in journalQeury
                                   join ji in jiQuery
                                   on j.Id equals ji.JournalId
                                   select new
                                   {
                                       Date = j.Date,
                                       JournalNo = j.JournalNo,
                                       Reference = j.Reference,
                                       CreationTimeIndex = j.CreationTimeIndex,
                                       CreatorUserId = j.CreatorUserId,
                                       LocationId = j.LocationId,
                                       CurrencyId = j.CurrencyId,
                                       CurrencyCode = j.CurrencyCode,
                                       UserName = j.UserName,
                                       LocationName = j.LocationName,
                                       Identifier = ji.Identifier,
                                       Description = ji.Description,
                                       AccountId = ji.AccountId,
                                       AccountCode = ji.AccountCode,
                                       AccountName = ji.AccountName
                                   };


            var paymentItemInvoiceQuery = _invoiceRepository.GetAll()
                                          .Where(s => !filterItem)
                                          .Where(s => input.BillTypes == BillType.SelectAll ||
                                                      (input.BillTypes == BillType.Item && s.IsItem) ||
                                                      (input.BillTypes == BillType.Account && !s.IsItem))
                                          .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                          .WhereIf(input.SaleTypes != null && input.SaleTypes.Count > 0, u => input.SaleTypes.Contains(u.TransactionTypeSaleId.Value))
                                          .AsNoTracking()
                                          .Select(s => new
                                          {
                                              Id = s.Id
                                          });

            var paymentItemInvoiceJournalQuery = from j in _journalRepository.GetAll()
                                                          .Where(s => !filterItem)
                                                          .Where(s => s.Status == TransactionStatus.Publish)
                                                          .Where(s => s.JournalType == JournalType.Invoice)
                                                          .Where(s => s.Date.Date < input.FromDate.Date)
                                                          .AsNoTracking()
                                                          .Select(j => new
                                                          {
                                                              JournalNo = j.JournalNo,
                                                              Date = j.Date,
                                                              InvoiceId = j.InvoiceId,
                                                              CurrencyId = isFilterByAccountCurrency ? j.CurrencyId : j.MultiCurrencyId
                                                          })
                                                 join c in currencyQuery
                                                 on j.CurrencyId equals c.Id

                                                 join i in paymentItemInvoiceQuery
                                                 on j.InvoiceId equals i.Id

                                                 select new
                                                 {
                                                     PayToInvoiceNo = j.JournalNo,
                                                     PayToInvoiceDate = j.Date,
                                                     PayToInvoiceId = j.InvoiceId,
                                                     CurrencyId = c.Id,
                                                     CurrencyCode = c.Code
                                                 };

            var paymentItemCreditQuery = _customerCreditRepository.GetAll()
                                            .Where(s => !filterItem)
                                            .Where(s => input.BillTypes == BillType.SelectAll ||
                                                        (input.BillTypes == BillType.Item && s.IsItem) ||
                                                        (input.BillTypes == BillType.Account && !s.IsItem))
                                            .Where(s => input.SaleTypes == null || input.SaleTypes.Count == 0)
                                            .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                            .AsNoTracking()
                                            .Select(s => new
                                            {
                                                Id = s.Id
                                            });

            var paymentItemCreditJournalQuery = from j in _journalRepository.GetAll()
                                                           .Where(s => !filterItem)
                                                           .Where(s => s.Status == TransactionStatus.Publish)
                                                           .Where(s => s.JournalType == JournalType.CustomerCredit)
                                                           .Where(s => s.Date.Date < input.FromDate.Date)
                                                           .AsNoTracking()
                                                           .Select(j => new
                                                           {
                                                               PayToInvoiceNo = j.JournalNo,
                                                               PayToInvoiceDate = j.Date,
                                                               PayToInvoiceId = j.CustomerCreditId,
                                                               CurrencyId = isFilterByAccountCurrency ? j.CurrencyId : j.MultiCurrencyId
                                                           })
                                                join c in currencyQuery
                                                on j.CurrencyId equals c.Id

                                                join cc in paymentItemCreditQuery
                                                on j.PayToInvoiceId equals cc.Id

                                                select new
                                                {
                                                    PayToInvoiceNo = j.PayToInvoiceNo,
                                                    PayToInvoiceDate = j.PayToInvoiceDate,
                                                    PayToInvoiceId = j.PayToInvoiceId,
                                                    CurrencyId = c.Id,
                                                    CurrencyCode = c.Code
                                                };


            var paymentToOldInvoiceQuery = from pi in _receivePaymentItemRepository.GetAll()
                                                        .Where(s => !filterItem)
                                                        .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                                        .AsNoTracking()
                                                        .Select(s => new
                                                        {
                                                            Id = s.Id,
                                                            PaymentId = s.ReceivePaymentId,
                                                            PayToId = s.PayToId,
                                                            CustomerId = s.CustomerId,
                                                            Payment = isFilterByAccountCurrency ? s.Payment : s.MultiCurrencyPayment,
                                                            CreationTime = s.CreationTime
                                                        })

                                           join j in _journalRepository.GetAll()
                                                        .Where(s => !filterItem)
                                                        .Where(s => s.Status == TransactionStatus.Publish)
                                                        .Where(u => u.JournalType == JournalType.ReceivePayment || u.JournalType == JournalType.Invoice || u.JournalType == JournalType.CustomerCredit)
                                                        .WhereIf(input.JournalTypes != null && input.JournalTypes.Any(), s => input.JournalTypes.Contains(s.JournalType))
                                                        .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                                                        .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                                        .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                                        .WhereIf(input.FromDate != null && input.ToDate != null,
                                                            (u => (u.Date.Date) >= (input.FromDate.Date) && (u.Date.Date) <= (input.ToDate.Date)))
                                                        .WhereIf(!input.Filter.IsNullOrEmpty(),
                                                            u => u.JournalNo.ToLower().Contains(input.Filter.ToLower()) ||
                                                                    u.Reference.ToLower().Contains(input.Filter.ToLower()))
                                                        .AsNoTracking()
                                                        .Select(s => s.ReceivePaymentId)
                                           on pi.PaymentId equals j

                                           join c in customerQuery
                                           on pi.CustomerId equals c.Id

                                           join inv in paymentItemInvoiceJournalQuery
                                           on pi.PayToId equals inv.PayToInvoiceId
                                           into invs
                                           from inv in invs.DefaultIfEmpty()

                                           join cc in paymentItemCreditJournalQuery
                                           on pi.PayToId equals cc.PayToInvoiceId
                                           into ccs
                                           from cc in ccs.DefaultIfEmpty()

                                           where inv != null || cc != null

                                           select new
                                           {
                                               Id = pi.Id,
                                               PaymentId = pi.PaymentId,
                                               PayToId = pi.PayToId,
                                               CustomerId = pi.CustomerId,
                                               Payment = inv != null ? pi.Payment : -pi.Payment,
                                               PayToInvoiceDate = inv != null ? inv.PayToInvoiceDate : cc.PayToInvoiceDate,
                                               PayToInvoiceNo = inv != null ? inv.PayToInvoiceNo : cc.PayToInvoiceNo,
                                               CurrencyId = inv != null ? inv.CurrencyId : cc.CurrencyId,
                                               CurrencyCode = inv != null ? inv.CurrencyCode : cc.CurrencyCode,
                                               CustomerName = c.CustomerName,
                                               CustomerTypeName = c.CustomerTypeName,
                                               CreationTime = pi.CreationTime
                                           };


            var iQuery = _invoiceRepository.GetAll()
                            .Where(s => input.BillTypes == BillType.SelectAll ||
                                        (input.BillTypes == BillType.Item && s.IsItem) ||
                                        (input.BillTypes == BillType.Account && !s.IsItem))
                            .WhereIf(filterItem, s => s.IsItem)
                            .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                            .WhereIf(input.SaleTypes != null && input.SaleTypes.Any(), u => input.SaleTypes.Contains(u.TransactionTypeSaleId.Value))
                            .AsNoTracking()
                            .Select(s => new
                            {
                                Id = s.Id,
                                SaleTypeName = s.TransactionTypeSale == null ? "" : s.TransactionTypeSale.TransactionTypeName,
                                CustomerId = s.CustomerId,
                                Total = isFilterByAccountCurrency ? s.Total : s.MultiCurrencyTotal
                            });

            var invoiceQuery = from i in iQuery
                               join c in customerQuery
                               on i.CustomerId equals c.Id
                               select new
                               {
                                   Id = i.Id,
                                   CustomerId = i.CustomerId,
                                   Total = i.Total,
                                   SaleTypeName = i.SaleTypeName,
                                   CustomerName = c.CustomerName,
                                   CustomerTypeName = c.CustomerTypeName
                               };


            var invoiceItemWithOrderQuery = from i in _invoiceItemRepository.GetAll()
                                               .Where(s => input.BillTypes == BillType.SelectAll ||
                                                           (input.BillTypes == BillType.Item && s.ItemId.HasValue) ||
                                                           (input.BillTypes == BillType.Account && !s.ItemId.HasValue))
                                               .WhereIf(filterItem, s => s.ItemId.HasValue)
                                               .WhereIf(input.Items != null && input.Items.Count > 0, s => input.Items.Contains(s.ItemId))
                                               .AsNoTracking()

                                            join oi in _saleOrderItemRepository.GetAll()
                                                      .AsNoTracking()
                                            on i.OrderItemId equals oi.Id
                                            into ois
                                            from oi in ois.DefaultIfEmpty()

                                            join ii in _itemIssueItemRepository.GetAll()
                                                        .Where(s => s.SaleOrderItemId.HasValue)
                                                        .AsNoTracking()
                                            on i.ItemIssueItemId equals ii.Id
                                            into iis
                                            from ii in iis.DefaultIfEmpty()

                                            join iio in _saleOrderItemRepository.GetAll()
                                                     .AsNoTracking()
                                            on ii.SaleOrderItemId equals iio.Id
                                            into iios
                                            from iio in iios.DefaultIfEmpty()

                                            select new
                                            {
                                                Id = i.Id,
                                                InvoiceId = i.InvoiceId,
                                                ItemId = i.ItemId,
                                                Qty = i.Qty,
                                                UnitCost = isFilterByAccountCurrency ? i.UnitCost : i.MultiCurrencyUnitCost,
                                                TaxId = i.TaxId,
                                                Total = isFilterByAccountCurrency ? i.Total : i.MultiCurrencyTotal,
                                                CreationTime = i.CreationTime,
                                                OrderItemId = i.OrderItemId,
                                                ItemIssueItemId = i.ItemIssueItemId,
                                                OrderNumber = oi != null ? oi.SaleOrder.OrderNumber : ii != null && iio != null ? iio.SaleOrder.OrderNumber : "",
                                                OrderReference = oi != null ? oi.SaleOrder.Reference : ii != null && iio != null ? iio.SaleOrder.Reference : ""
                                            };


            var invoiceItemQuery = from i in invoiceItemWithOrderQuery
                                   join t in taxQuery
                                   on i.TaxId equals t.Id
                                   join ii in invoiceQuery
                                   on i.InvoiceId equals ii.Id
                                   select new
                                   {
                                       Id = i.Id,
                                       InvoiceId = i.InvoiceId,
                                       ItemId = i.ItemId,
                                       Qty = i.Qty,
                                       UnitCost = i.UnitCost,
                                       TaxId = i.TaxId,
                                       Total = i.Total,
                                       CreationTime = i.CreationTime,
                                       OrderNumber = i.OrderNumber,
                                       OrderReference = i.OrderReference,
                                       TaxName = t.TaxName,
                                       TaxRate = t.TaxRate,
                                       CustomerId = ii.CustomerId,
                                       InvoiceTotal = ii.Total,
                                       SaleTypeName = ii.SaleTypeName,
                                       CustomerName = ii.CustomerName,
                                       CustomerTypeName = ii.CustomerTypeName
                                   };


            var creditQuery = from i in _customerCreditRepository.GetAll()
                                        .Where(s => input.BillTypes == BillType.SelectAll ||
                                                    (input.BillTypes == BillType.Item && s.IsItem) ||
                                                    (input.BillTypes == BillType.Account && !s.IsItem))
                                        .WhereIf(filterItem, s => s.IsItem)
                                        .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                        .Where(s => input.SaleTypes == null || input.SaleTypes.Count == 0)
                                        .AsNoTracking()
                                        .Select(s => new
                                        {
                                            Id = s.Id,
                                            CustomerId = s.CustomerId,
                                            Total = isFilterByAccountCurrency ? -s.Total : -s.MultiCurrencyTotal
                                        })
                              join c in customerQuery
                              on i.CustomerId equals c.Id
                              select new
                              {
                                  Id = i.Id,
                                  CustomerId = i.CustomerId,
                                  Total = i.Total,
                                  CustomerName = c.CustomerName,
                                  CustomerTypeName = c.CustomerTypeName
                              };

            var creditItemQuery = from ii in _customerCreditItemRepository.GetAll()
                                            .Where(s => input.BillTypes == BillType.SelectAll ||
                                                        (input.BillTypes == BillType.Item && s.ItemId.HasValue) ||
                                                        (input.BillTypes == BillType.Account && !s.ItemId.HasValue))
                                            .WhereIf(filterItem, s => s.ItemId.HasValue)
                                            .WhereIf(input.Items != null && input.Items.Count > 0, s => input.Items.Contains(s.ItemId))
                                            .AsNoTracking()
                                            .Select(s => new
                                            {
                                                Id = s.Id,
                                                CustomerCreditId = s.CustomerCreditId,
                                                ItemId = s.ItemId,
                                                Qty = -s.Qty,
                                                UnitCost = isFilterByAccountCurrency ? s.UnitCost : s.MultiCurrencyUnitCost,
                                                TaxId = s.TaxId,
                                                Total = isFilterByAccountCurrency ? -s.Total : -s.MultiCurrencyTotal,
                                                CreationTime = s.CreationTime
                                            })
                                  join t in taxQuery
                                  on ii.TaxId equals t.Id

                                  join i in creditQuery
                                  on ii.CustomerCreditId equals i.Id

                                  select new
                                  {
                                      Id = ii.Id,
                                      CustomerCreditId = ii.CustomerCreditId,
                                      ItemId = ii.ItemId,
                                      Qty = ii.Qty,
                                      UnitCost = ii.UnitCost,
                                      TaxId = ii.TaxId,
                                      Total = ii.Total,
                                      CreationTime = ii.CreationTime,
                                      TaxName = t.TaxName,
                                      TaxRate = t.TaxRate,
                                      CustomerId = i.CustomerId,
                                      InvoiceTotal = i.Total,
                                      CustomerName = i.CustomerName,
                                      CustomerTypeName = i.CustomerTypeName
                                  };


            var queryResult = from ji in journalItemQuery

                              join ii in invoiceItemQuery
                              on ji.Identifier equals ii.Id
                              into iis
                              from ii in iis.DefaultIfEmpty()

                              join ci in creditItemQuery
                              on ji.Identifier equals ci.Id
                              into cis
                              from ci in cis.DefaultIfEmpty()

                              join pi in paymentToOldInvoiceQuery
                              on ji.Identifier equals pi.Id
                              into pis
                              from pi in pis.DefaultIfEmpty()

                              where (ii != null || ci != null || pi != null) &&
                                    (
                                         input.OrderApply == OrderApply.All ||
                                        (input.OrderApply == OrderApply.Applied && ii != null && ii.OrderNumber != "") ||
                                        (input.OrderApply == OrderApply.NotApply && ii != null && ii.OrderNumber == "")
                                    )
                              select new GetListSaleInvoiceReportOutput
                              {
                                  InvoiceId = ii != null ? ii.InvoiceId : ci != null ? ci.CustomerCreditId : pi.PaymentId,
                                  Date = ji.Date,
                                  ItemId = ii != null ? ii.ItemId : ci != null ? ci.ItemId : (Guid?)null,
                                  ItemCode = pi != null ? pi.PayToInvoiceNo : "",
                                  ItemName = pi != null ? $"{pi.PayToInvoiceDate.ToString("yyyy-MM-dd")}/{pi.PayToInvoiceNo}" : "",
                                  LocationId = ji.LocationId.Value,
                                  LocationName = ji.LocationName,
                                  Qty = ii != null ? ii.Qty : ci != null ? ci.Qty : 0,
                                  TaxId = ii != null ? ii.TaxId : ci != null ? ci.TaxId : 0,
                                  TaxName = ii != null ? ii.TaxName : ci != null ? ci.TaxName : "",
                                  TaxRate = ii != null ? ii.TaxRate : ci != null ? ci.TaxRate : 0,
                                  Total = ii != null ? ii.Total : ci != null ? ci.Total : 0,
                                  InvoiceTotal = ii != null ? ii.InvoiceTotal : ci != null ? ci.InvoiceTotal : 0,
                                  Paid = 0,
                                  Balance = 0,
                                  UnitPrice = ii != null ? ii.UnitCost : ci != null ? ci.UnitCost : 0,
                                  CustomerId = ii != null ? ii.CustomerId : ci != null ? ci.CustomerId : pi.CustomerId,
                                  CustomerName = ii != null ? ii.CustomerName : ci != null ? ci.CustomerName : pi.CustomerName,
                                  CustomerType = ii != null ? ii.CustomerTypeName : ci != null ? ci.CustomerTypeName : pi.CustomerTypeName,
                                  JournalNo = ji.JournalNo,
                                  Reference = ji.Reference,
                                  User = ji.UserName,
                                  CreationTimeIndex = ji.CreationTimeIndex,
                                  CreationTime = ii != null ? ii.CreationTime : ci != null ? ci.CreationTime : pi.CreationTime,
                                  SaleType = ii != null ? ii.SaleTypeName : "",
                                  CurrencyId = pi != null ? pi.CurrencyId : ji.CurrencyId,
                                  CurrencyCode = pi != null ? pi.CurrencyCode : ji.CurrencyCode,
                                  AccountId = ji.AccountId,
                                  AccountCode = ji.AccountCode,
                                  AccountName = ji.AccountName,
                                  ReceivePayment = pi != null ? pi.Payment : 0,
                                  TotalReceive = pi != null ? pi.Payment : 0,
                                  IsPayment = pi != null,
                                  Description = ji.Description,
                                  OrderNo = ii != null ? ii.OrderNumber : "",
                                  OrderReference = ii != null ? ii.OrderReference : ""
                              };


            if (input.BillTypes != BillType.Account)
            {
                var itemResultQuery = from ii in queryResult
                                      join i in itemQuery
                                      on ii.ItemId equals i.Id
                                      into iis
                                      from i in iis.DefaultIfEmpty()

                                      let properties = i == null ? new List<ItemPropertySummary>() : i.Properties
                                      let netWeight = i == null || i.Properties == null ? 0 : i.Properties
                                                     .Where(t => t.IsUnit).Select(t => t.NetWeight * ii.Qty).FirstOrDefault()

                                      where !filterItem || i != null

                                      select new GetListSaleInvoiceReportOutput
                                      {
                                          InvoiceId = ii.InvoiceId,
                                          Date = ii.Date,
                                          ItemId = ii.ItemId,
                                          ItemCode = ii.IsPayment ? ii.ItemCode : i == null ? ii.AccountCode : i.ItemCode,
                                          ItemName = ii.IsPayment ? ii.ItemName : i == null ? ii.AccountName : i.ItemName,
                                          LocationId = ii.LocationId,
                                          LocationName = ii.LocationName,
                                          Qty = ii.Qty,
                                          TaxId = ii.TaxId,
                                          TaxName = ii.TaxName,
                                          TaxRate = ii.TaxRate,
                                          Total = ii.Total,
                                          InvoiceTotal = ii.InvoiceTotal,
                                          Paid = ii.Paid,
                                          Balance = ii.Balance,
                                          UnitPrice = ii.UnitPrice,
                                          CustomerId = ii.CustomerId,
                                          CustomerName = ii.CustomerName,
                                          CustomerType = ii.CustomerType,
                                          JournalNo = ii.JournalNo,
                                          Reference = ii.Reference,
                                          User = ii.User,
                                          CreationTimeIndex = ii.CreationTimeIndex,
                                          CreationTime = ii.CreationTime,
                                          SaleType = ii.SaleType,
                                          CurrencyId = ii.CurrencyId,
                                          CurrencyCode = ii.CurrencyCode,
                                          AccountId = ii.AccountId,
                                          AccountCode = ii.AccountCode,
                                          AccountName = ii.AccountName,
                                          ReceivePayment = ii.ReceivePayment,
                                          TotalReceive = ii.TotalReceive,
                                          IsPayment = ii.IsPayment,
                                          Description = ii.Description,
                                          OrderNo = ii.OrderNo,
                                          OrderReference = ii.OrderReference,
                                          NetWeight = netWeight,
                                          Properties = properties
                                      };

                queryResult = itemResultQuery;
            }


            //Query 1
            var ccols = await queryResult.Select(s => new { s.CurrencyId, s.CurrencyCode }).Distinct().ToListAsync();
            var currencyColumns = ccols.OrderBy(r => r.CurrencyCode);


            if (input.GroupBy == "JournalNo")
            {
                var paymentQuery = from j in _journalRepository.GetAll()
                                                .Where(s => s.Status == TransactionStatus.Publish)
                                                .Where(u => u.JournalType == JournalType.ReceivePayment)
                                                .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                                .WhereIf(input.FromDate != null && input.ToDate != null,
                                                    (u => (u.Date.Date) >= (input.FromDate.Date) && (u.Date.Date) <= (input.ToDate.Date)))
                                                .AsNoTracking()
                                            .Select(s => new
                                            {
                                                ReceivePaymentId = s.ReceivePaymentId
                                            })
                                   join pi in _receivePaymentItemRepository.GetAll()
                                              .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                              .AsNoTracking()
                                              .Select(s => new
                                              {
                                                  PaymentId = s.ReceivePaymentId,
                                                  PayToId = s.PayToId,
                                                  Payment = isFilterByAccountCurrency ?
                                                            (s.InvoiceId.HasValue ? s.Payment : -s.Payment) :
                                                            (s.InvoiceId.HasValue ? s.MultiCurrencyPayment : -s.MultiCurrencyPayment)
                                              })
                                   on j.ReceivePaymentId equals pi.PaymentId
                                   group pi by pi.PayToId
                                   into g
                                   select new
                                   {
                                       PayToId = g.Key,
                                       Payment = g.Sum(s => s.Payment)
                                   };


                var invoicePaymentQuery = from invi in queryResult

                                          join ip in paymentQuery
                                          on invi.InvoiceId equals ip.PayToId
                                          into payment
                                          from pay in payment.DefaultIfEmpty()
                                          let totalPaid = pay != null ? pay.Payment : 0

                                          select new GetListSaleInvoiceReportOutput
                                          {
                                              InvoiceId = invi.InvoiceId,
                                              Date = invi.Date,
                                              AccountName = invi.AccountName,
                                              AccountId = invi.AccountId,
                                              AccountCode = invi.AccountCode,
                                              ItemId = invi.ItemId,
                                              ItemCode = invi.ItemCode,
                                              ItemName = invi.ItemName,
                                              LocationId = invi.LocationId,
                                              LocationName = invi.LocationName,
                                              Qty = invi.Qty,
                                              TaxId = invi.TaxId,
                                              TaxName = invi.TaxName,
                                              TaxRate = invi.TaxRate,
                                              Total = invi.Total,
                                              UnitPrice = invi.UnitPrice,
                                              CustomerId = invi.CustomerId,
                                              CustomerName = invi.CustomerName,
                                              CustomerType = invi.CustomerType,
                                              Reference = invi.Reference,
                                              JournalNo = invi.JournalNo,
                                              User = invi.User,
                                              CreationTimeIndex = invi.CreationTimeIndex,
                                              CreationTime = invi.CreationTime,
                                              SaleType = invi.SaleType,
                                              CurrencyId = invi.CurrencyId,
                                              CurrencyCode = invi.CurrencyCode,
                                              InvoiceTotal = invi.InvoiceTotal,
                                              Paid = totalPaid,
                                              Balance = invi.InvoiceTotal - totalPaid,
                                              ReceivePayment = invi.ReceivePayment,
                                              TotalReceive = invi.IsPayment ? invi.TotalReceive : totalPaid,
                                              IsPayment = invi.IsPayment,
                                              Description = invi.Description,
                                              OrderNo = invi.OrderNo,
                                              OrderReference = invi.OrderReference,
                                              NetWeight = invi.NetWeight,
                                              Properties = invi.Properties
                                          };

                queryResult = invoicePaymentQuery;

            }


            var query = from q in queryResult

                        select new GetListSaleInvoiceReportOutput
                        {
                            Date = q.Date,
                            AccountName = q.AccountName,
                            AccountId = q.AccountId,
                            AccountCode = q.AccountCode,
                            ItemId = q.ItemId,

                            ItemCode = q.ItemCode,
                            ItemName = q.ItemName,

                            LocationId = q.LocationId,
                            LocationName = q.LocationName,
                            Qty = q.Qty,
                            TaxId = q.TaxId,
                            TaxName = q.TaxName,
                            TaxRate = q.TaxRate,
                            Total = q.Total,
                            InvoiceTotal = q.InvoiceTotal,
                            Paid = q.Paid,
                            Balance = q.Balance,
                            ReceivePayment = q.ReceivePayment,
                            TotalReceive = q.TotalReceive,
                            IsPayment = q.IsPayment,
                            IsItem = q.IsItem,
                            UnitPrice = q.UnitPrice,
                            CustomerId = q.CustomerId,
                            CustomerName = q.CustomerName,
                            CustomerType = q.CustomerType,
                            Reference = q.Reference,
                            JournalNo = q.JournalNo,
                            InvoiceId = q.InvoiceId,
                            User = q.User,
                            CreationTimeIndex = q.CreationTimeIndex,
                            CreationTime = q.CreationTime,
                            RoundingDigit = currentRoundingDigit,
                            RoundingDigitUnitCost = currentRoundingDigitUnitCost,
                            SaleType = q.SaleType,
                            Properties = q.Properties,
                            OrderNo = q.OrderNo,
                            OrderReference = q.OrderReference,
                            NetWeight = q.NetWeight,
                            Description = q.Description,
                            CurrencyColumnTotals = currencyColumns.Select(s => new CurrencyColumnTotal
                            {
                                CurrencyId = s.CurrencyId.Value,
                                CurrencyCode = s.CurrencyCode,
                                Total = s.CurrencyId == q.CurrencyId ? q.Total : 0,
                                Paid = s.CurrencyId == q.CurrencyId ? q.Paid : 0,
                                Balance = s.CurrencyId == q.CurrencyId ? q.Balance : 0,
                                ReceivePayment = s.CurrencyId == q.CurrencyId ? q.ReceivePayment : 0,
                                TotalReceive = s.CurrencyId == q.CurrencyId ? q.TotalReceive : 0,
                            }).ToList(),
                        };

            var resultCount = 0;
            var sumOfColumns = new Dictionary<string, decimal>();
            var multiCurrencySumOfColumns = new Dictionary<string, Dictionary<string, decimal>>();
            List<SaleSummaryOut> sumQuery = null;

            if (input.IsLoadMore == false)
            {
                //Query 2  
                if (input.ColumnNamesToSum != null)
                {
                    sumQuery = await query.Select(s => new SaleSummaryOut
                    {
                        InvoiceId = s.InvoiceId,
                        JournalNo = s.JournalNo,
                        Total = s.Total,
                        Paid = s.Paid,
                        Balance = s.Balance,
                        CurrencyColumnTotals = s.CurrencyColumnTotals,
                        Qty = s.Qty,
                        ReceivePayment = s.ReceivePayment,
                        TotalReceive = s.TotalReceive,
                        NetWeight = s.NetWeight,
                    }).ToListAsync();

                    resultCount = sumQuery.Count();
                }
                else
                {
                    resultCount = await query.CountAsync();
                }
            }


            if (resultCount == 0 && !input.IsLoadMore) return new PagedResultWithTotalColuumnsDto<GetListSaleInvoiceReportOutput>(0, new List<GetListSaleInvoiceReportOutput>(), multiCurrencySumOfColumns);


            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                var sumPaidBalanceQuery = sumQuery.GroupBy(g => g.JournalNo).Select(s => s.First()).ToList();

                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "NetWeight")
                    {
                        sumOfColumns.Add(col, sumQuery.Sum(u => u.NetWeight));
                    }
                    else if (col == "Qty")
                    {
                        sumOfColumns.Add(col, sumQuery.Sum(u => u.Qty));
                    }
                    else if (col == "Total" || col == "ReceivePayment")
                    {
                        if (!isFilterByAccountCurrency)
                        {
                            var sumList = sumQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => col == "Total" ? s.Total : s.ReceivePayment),
                            }).ToDictionary(u => u.CurrencyCode);

                            var multiSumOfColumns = new Dictionary<string, decimal>();
                            foreach (var c in currencyColumns)
                            {
                                multiSumOfColumns.Add(c.CurrencyCode, groupByCurrencyDict.ContainsKey(c.CurrencyCode) ? groupByCurrencyDict[c.CurrencyCode].Total : 0);
                            }

                            multiCurrencySumOfColumns.Add(col, multiSumOfColumns);
                        }
                        else
                        {
                            sumOfColumns.Add(col, sumQuery.Sum(u => col == "Total" ? u.Total : u.ReceivePayment));
                        }
                    }
                    else if (col == "TotalReceive")
                    {
                        if (!isFilterByAccountCurrency)
                        {
                            var sumReceivePaymentList = sumQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var receivePaymentGroupByCurrencyDict = sumReceivePaymentList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => s.ReceivePayment),
                            }).ToDictionary(u => u.CurrencyCode);

                            var sumPaidList = sumPaidBalanceQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var paidGroupByCurrencyDict = sumPaidList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => s.Paid),
                            }).ToDictionary(u => u.CurrencyCode);

                            var multiSumOfColumns = new Dictionary<string, decimal>();
                            foreach (var c in currencyColumns)
                            {
                                var totalReceive = receivePaymentGroupByCurrencyDict.ContainsKey(c.CurrencyCode) ? receivePaymentGroupByCurrencyDict[c.CurrencyCode].Total : 0;
                                var totalPaid = paidGroupByCurrencyDict.ContainsKey(c.CurrencyCode) ? paidGroupByCurrencyDict[c.CurrencyCode].Total : 0;

                                multiSumOfColumns.Add(c.CurrencyCode, totalReceive + totalPaid);
                            }

                            multiCurrencySumOfColumns.Add(col, multiSumOfColumns);
                        }
                        else
                        {
                            var total = sumQuery.Sum(u => u.ReceivePayment) + sumPaidBalanceQuery.Sum(s => s.Paid);
                            sumOfColumns.Add(col, total);
                        }
                    }
                    else
                    {
                        if (!isFilterByAccountCurrency)
                        {
                            var sumList = sumPaidBalanceQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => col == "Paid" ? s.Paid : s.Balance),
                            }).ToDictionary(u => u.CurrencyCode);

                            var multiSumOfColumns = new Dictionary<string, decimal>();
                            foreach (var c in currencyColumns)
                            {
                                multiSumOfColumns.Add(c.CurrencyCode, groupByCurrencyDict.ContainsKey(c.CurrencyCode) ? groupByCurrencyDict[c.CurrencyCode].Total : 0);
                            }

                            multiCurrencySumOfColumns.Add(col, multiSumOfColumns);
                        }
                        else
                        {
                            sumOfColumns.Add(col, sumPaidBalanceQuery.Sum(u => col == "Paid" ? u.Paid : u.Balance));
                        }
                    }
                }
            }

            switch (input.GroupBy)
            {
                case "Item":
                    query = query.OrderBy(s => s.ItemCode).ThenBy(s => s.CreationTimeIndex);
                    break;
                case "Date":
                    query = query.OrderBy(s => s.Date.Date).ThenBy(s => s.CreationTimeIndex);
                    break;
                case "Location":
                    query = query.OrderBy(s => s.LocationId).ThenBy(s => s.CreationTimeIndex);
                    break;
                case "Customer":
                    query = query.OrderBy(s => s.CustomerId).ThenBy(s => s.CreationTimeIndex);
                    break;
                case "Account":
                    query = query.OrderBy(s => s.AccountCode).ThenBy(s => s.CreationTimeIndex);
                    break;
                default:
                    query = query.OrderBy(input.Sorting).ThenBy(s => s.CreationTimeIndex);
                    break;
            }

            var @entities = new List<GetListSaleInvoiceReportOutput>();
            if (input.UsePagination == true)
            {
                @entities = await query.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await query.ToListAsync();
            }

            var returnResult = new PagedResultWithTotalColuumnsDto<GetListSaleInvoiceReportOutput>(resultCount, @entities, multiCurrencySumOfColumns);
            returnResult.TotalResult = sumOfColumns;

            return returnResult;
        }

        public ReportOutput GetReportTemplateSaleInvoice()
        {
            var itemPropertyCols = _propertyRepository.GetAll().AsNoTracking()
                             .Where(t => t.IsActive == true)
                             .Select(t => new CollumnOutput
                             {
                                 AllowGroupby = false,
                                 AllowFilter = true,
                                 ColumnName = t.Name,
                                 ColumnLength = 150,
                                 ColumnTitle = t.Name,
                                 ColumnType = ColumnType.ItemProperty,
                                 SortOrder = 11,
                                 Visible = true,
                                 AllowFunction = null,
                                 MoreFunction = null,
                                 IsDisplay = true,
                                 AllowShowHideFilter = true,
                                 ShowHideFilter = true,
                                 DefaultValue = t.Id.ToString(),//to init the value of property
                             });

            var columns = new List<CollumnOutput>() {
                     // start properties with can filter
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Search",
                        ColumnLength = 150,
                        ColumnTitle = "Search",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DateRange",
                        ColumnLength = 150,
                        ColumnTitle = "DateRange",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        DefaultValue = "thisMonth",
                        AllowFunction = null,
                        DisableDefault = false,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "InvoiceType",
                        ColumnLength = 300,
                        ColumnTitle = "InvoiceType",
                        ColumnType = ColumnType.String,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "JournalType",
                        ColumnLength = 300,
                        ColumnTitle = "Journal Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Item",
                        ColumnLength = 300,
                        ColumnTitle = "Item",
                        ColumnType = ColumnType.String,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = false,
                        ColumnName = "Date",
                        ColumnLength = 100,
                        ColumnTitle = "Date",
                        ColumnType = ColumnType.Date,
                        SortOrder = 1,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                     },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = false,
                        ColumnName = "JournalNo",
                        ColumnLength = 120,
                        ColumnTitle = "Journal No",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Reference",
                        ColumnLength = 100,
                        ColumnTitle = "Reference",
                        ColumnType = ColumnType.String,
                        SortOrder = 3,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Customer",
                        ColumnLength = 120,
                        ColumnTitle = "Customer",
                        ColumnType = ColumnType.String,
                        SortOrder = 4,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                       new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "AccountType",
                        ColumnLength = 300,
                        ColumnTitle = "AccountType",
                        ColumnType = ColumnType.String,
                        SortOrder = 5,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Account",
                        ColumnLength = 120,
                        ColumnTitle = "Account",
                        ColumnType = ColumnType.String,
                        SortOrder = 6,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Location",
                        ColumnLength = 120,
                        ColumnTitle = "Location",
                        ColumnType = ColumnType.String,
                        SortOrder = 7,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Tax",
                        ColumnLength = 100,
                        ColumnTitle = "Tax Name",
                        ColumnType = ColumnType.String,
                        SortOrder = 8,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TaxRate",
                        ColumnLength = 80,
                        ColumnTitle = "Tax Rate",
                        ColumnType = ColumnType.Money,
                        SortOrder = 9,
                        Visible = true,
                        //AllowFunction = "Sum",
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ItemCode",
                        ColumnLength = 120,
                        ColumnTitle = "Item Code",
                        ColumnType = ColumnType.String,
                        SortOrder = 10,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ItemName",
                        ColumnLength = 120,
                        ColumnTitle = "Item Name",
                        ColumnType = ColumnType.String,
                        SortOrder = 11,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Description",
                        ColumnLength = 120,
                        ColumnTitle = "Description",
                        ColumnType = ColumnType.String,
                        SortOrder = 12,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "UnitPrice",
                        ColumnLength = 100,
                        ColumnTitle = "Unit Price",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 12,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Qty",
                        ColumnLength = 100,
                        ColumnTitle = "Qty",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 13,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                         AllowFunction = null,
                         MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Total",
                        ColumnLength = 150,
                        ColumnTitle = "Total",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 14,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Paid",
                        ColumnLength = 150,
                        ColumnTitle = "Paid",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 15,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Balance",
                        ColumnLength = 150,
                        ColumnTitle = "Balance",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 16,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ReceivePayment",
                        ColumnLength = 150,
                        ColumnTitle = "Receive Payment",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 17,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalReceive",
                        ColumnLength = 150,
                        ColumnTitle = "Total Receive",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 18,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "NetWeight",
                        ColumnLength = 150,
                        ColumnTitle = "Net Weight",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 19,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true
                    },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "User",
                        ColumnLength = 100,
                        ColumnTitle = "User",
                        ColumnType = ColumnType.String,
                        SortOrder = 20,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "CustomerType",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 21,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                       new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "SaleType",
                        ColumnLength = 150,
                        ColumnTitle = "SaleType",
                        ColumnType = ColumnType.String,
                        SortOrder = 22,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                       new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "OrderNo",
                        ColumnLength = 100,
                        ColumnTitle = "Order No",
                        ColumnType = ColumnType.String,
                        SortOrder = 23,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "OrderReference",
                        ColumnLength = 100,
                        ColumnTitle = "Order Ref",
                        ColumnType = ColumnType.String,
                        SortOrder = 24,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "OrderApply",
                        ColumnLength = 300,
                        ColumnTitle = "Order Apply",
                        ColumnType = ColumnType.String,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                      }
                };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columns.Concat(itemPropertyCols).ToList(),
                Groupby = "",
                HeaderTitle = "Sale Invoice",
                Sortby = "",
            };


            if (!FeatureChecker.IsEnabled(AppFeatures.AccountingFeature))
            {
                result.ColumnInfo = result.ColumnInfo.Where(s =>
                    s.ColumnName != "Account" &&
                    s.ColumnName != "AccountType").ToList();
            }


            var isMultiCurrency = _multiCurrencyRepository.GetAll().Any();

            if (isMultiCurrency)
            {
                var currency = new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Currency",
                    ColumnLength = 140,
                    ColumnTitle = "Currency",
                    ColumnType = ColumnType.String,
                    SortOrder = 3,
                    Visible = true,
                    IsDisplay = false,
                    DisableDefault = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                };
                result.ColumnInfo.Add(currency);
            }


            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleInvoice_Export_Excel)]
        public async Task<FileDto> ExportExcelSaleInvoiceReport(GetSaleInvoiceReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var saleInvoiceData = (await GetSaleInvoiceReport(input)).Items;

            if (input.GroupBy == "JournalNo")
            {
                var journalNo = string.Empty;
                saleInvoiceData = saleInvoiceData.Select(s =>
                {
                    var item = s;
                    if (journalNo == item.JournalNo)
                    {
                        item.Paid = 0;
                        item.Balance = 0;

                        if (!item.IsPayment)
                        {
                            item.ReceivePayment = 0;
                            item.TotalReceive = 0;
                        }

                        item.CurrencyColumnTotals = s.CurrencyColumnTotals.Select(m =>
                        {
                            var col = m;
                            col.Paid = 0;
                            col.Balance = 0;

                            if (!item.IsPayment)
                            {
                                col.TotalReceive = 0;
                                col.ReceivePayment = 0;
                            }

                            return col;
                        }).ToList();
                    }
                    journalNo = item.JournalNo;
                    return item;
                }).ToList();
            }

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                var subCols = saleInvoiceData == null ? null : saleInvoiceData.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
                var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString("dd-MM-yyyy");
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    if (isMultiCurrencies)
                    {
                        if (i.ColumnName == "Total" || i.ColumnName == "Paid" || i.ColumnName == "Balance" || i.ColumnName == "ReceivePayment" || i.ColumnName == "TotalReceive")
                        {
                            var colWidth = i.ColumnLength;
                            var subColWidth = i.ColumnLength / subCols.Count();

                            AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                            ws.Column(colHeaderTable).Width = ConvertPixelToInches(colWidth);
                            MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader, colHeaderTable + subCols.Count() - 1, ExcelHorizontalAlignment.Center);

                            foreach (var subCol in subCols)
                            {
                                AddTextToCell(ws, rowTableHeader + 1, colHeaderTable, subCol, true);
                                ws.Column(colHeaderTable).Width = ConvertPixelToInches(subColWidth);
                                colHeaderTable += 1;
                            }
                        }
                        else
                        {
                            AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                            ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                            MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader + 1, colHeaderTable, ExcelHorizontalAlignment.Center);
                            colHeaderTable += 1;
                        }
                    }
                    else
                    {
                        AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                        ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                        colHeaderTable += 1;
                    }

                }

                if (isMultiCurrencies) rowTableHeader += 1;
                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                var groupBy = new List<GetListSaleInvoiceReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Account":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.AccountId)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.AccountName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Customer":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.Date)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString()).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Item":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.ItemId)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.ItemCode != null ? x.ItemCode + "-" + x.ItemName : "").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "JournalNo":
                            groupBy = saleInvoiceData
                               .GroupBy(t => t.JournalNo)
                               .Select(t => new GetListSaleInvoiceReportGroupByOutput
                               {
                                   KeyName = t.Select(x => x.JournalNo).FirstOrDefault(),
                                   Items = t.Select(x => x).ToList()
                               })
                               .ToList();
                            break;
                    }
                }
                // write body

                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0)
                {
                    foreach (var k in groupBy)
                    {
                        //key group by name
                        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                        rowBody += 1;
                        count = 1;
                        //list of item
                        foreach (var i in k.Items)
                        {
                            int collumnCellBody = 1;
                            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                            {
                                if ((item.ColumnName == "Total" || item.ColumnName == "Paid" || item.ColumnName == "Balance" || item.ColumnName == "ReceivePayment" || item.ColumnName == "TotalReceive") && isMultiCurrencies)
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        var model = i.CurrencyColumnTotals.FirstOrDefault(s => s.CurrencyCode == subCol);
                                        var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);
                                        var value = cellValue ?? 0;
                                        AddCellValue(ws, rowBody, collumnCellBody, item, value, i.RoundingDigit);
                                        collumnCellBody += 1;
                                    }
                                }
                                else
                                {
                                    WriteBodySaleInvoice(ws, rowBody, collumnCellBody, item, i, count);
                                    collumnCellBody += 1;
                                }
                            }
                            rowBody += 1;
                            count += 1;
                        }

                        //sub total of group by item
                        int collumnCellGroupBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (item.AllowFunction != null)
                            {
                                if ((item.ColumnName == "Total" || item.ColumnName == "Paid" || item.ColumnName == "Balance" || item.ColumnName == "ReceivePayment" || item.ColumnName == "TotalReceive") && isMultiCurrencies)
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                        var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);

                                        var colKey = item.ColumnName + "-" + subCol;
                                        if (footerGroupDict.ContainsKey(colKey))
                                        {
                                            footerGroupDict[colKey] += fromCell + ":" + toCell + ",";
                                        }
                                        else
                                        {
                                            footerGroupDict.Add(colKey, fromCell + ":" + toCell + ",");
                                        }

                                        AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);

                                        collumnCellGroupBody++;
                                    }

                                    collumnCellGroupBody--;
                                }
                                else
                                {
                                    var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                    var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);

                                    if (footerGroupDict.ContainsKey(item.ColumnName))
                                    {
                                        footerGroupDict[item.ColumnName] += fromCell + ":" + toCell + ",";
                                    }
                                    else
                                    {
                                        footerGroupDict.Add(item.ColumnName, fromCell + ":" + toCell + ",");
                                    }

                                    AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }

                            }
                            collumnCellGroupBody += 1;
                        }
                        rowBody += 1;
                    }
                }
                else
                {
                    foreach (var i in saleInvoiceData)
                    {
                        int collumnCellBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if ((item.ColumnName == "Total" || item.ColumnName == "Paid" || item.ColumnName == "Balance" || item.ColumnName == "ReceivePayment" || item.ColumnName == "TotalReceive") && isMultiCurrencies)
                            {
                                foreach (var subCol in subCols)
                                {
                                    var model = i.CurrencyColumnTotals.FirstOrDefault(s => s.CurrencyCode == subCol);
                                    var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);
                                    var value = cellValue ?? 0;
                                    AddCellValue(ws, rowBody, collumnCellBody, item, value, i.RoundingDigit);
                                    collumnCellBody += 1;
                                }
                            }
                            else
                            {
                                WriteBodySaleInvoice(ws, rowBody, collumnCellBody, item, i, count);
                                collumnCellBody += 1;
                            }

                        }
                        rowBody += 1;
                        count += 1;
                    }
                }
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (!input.GroupBy.IsNullOrWhiteSpace())
                            {
                                if ((i.ColumnName == "Total" || i.ColumnName == "Paid" || i.ColumnName == "Balance" || i.ColumnName == "ReceivePayment" || i.ColumnName == "TotalReceive") && isMultiCurrencies)
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        var colKey = i.ColumnName + "-" + subCol;
                                        int rowFooter = rowTableHeader + 1;// get start row after 

                                        var sumValue = footerGroupDict.ContainsKey(colKey) ? "SUM(" + footerGroupDict[colKey] + ")" : "";
                                        if (i.ColumnType == ColumnType.Number)
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                        }
                                        else
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                        }

                                        footerColNumber++;
                                    }

                                    footerColNumber--;
                                }
                                else
                                {
                                    int rowFooter = rowTableHeader + 1;// get start row after 
                                    var sumValue = footerGroupDict.ContainsKey(i.ColumnName) ? "SUM(" + footerGroupDict[i.ColumnName] + ")" : "";
                                    if (i.ColumnType == ColumnType.Number)
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                    }
                                }
                            }
                            else
                            {
                                if ((i.ColumnName == "Total" || i.ColumnName == "Paid" || i.ColumnName == "Balance" || i.ColumnName == "ReceivePayment" || i.ColumnName == "TotalReceive") && isMultiCurrencies)
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        int rowFooter = rowTableHeader + 1;// get start row after header 
                                        var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                        var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                        if (i.ColumnType == ColumnType.Number)
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                        }
                                        else
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                        }

                                        footerColNumber++;
                                    }

                                    footerColNumber--;
                                }
                                else
                                {
                                    int rowFooter = rowTableHeader + 1;// get start row after header 
                                    var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                    var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                    if (i.ColumnType == ColumnType.Number)
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                    }
                                }

                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"SaleInvoice_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleInvoice_Export_Pdf)]
        public async Task<FileDto> ExportPDFSaleInvoiceReport(GetSaleInvoiceReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;
            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                            .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                            .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }
            var digit = (await GetCurrentCycleAsync()).RoundingDigit;
            var user = await GetCurrentUserAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();

            var sheetName = report.HeaderTitle;

            var saleInvoices = await GetSaleInvoiceReport(input);

            if (input.GroupBy == "JournalNo")
            {
                var journalNo = string.Empty;
                var items = saleInvoices.Items.Select(s =>
                {
                    var item = s;
                    if (journalNo == item.JournalNo)
                    {
                        item.Paid = 0;
                        item.Balance = 0;

                        if (!item.IsPayment)
                        {
                            item.ReceivePayment = 0;
                            item.TotalReceive = 0;
                        }

                        item.CurrencyColumnTotals = s.CurrencyColumnTotals.Select(m =>
                        {
                            var col = m;
                            col.Paid = 0;
                            col.Balance = 0;

                            if (!item.IsPayment)
                            {
                                col.TotalReceive = 0;
                                col.ReceivePayment = 0;
                            }

                            return col;
                        }).ToList();
                    }
                    journalNo = item.JournalNo;
                    return item;
                }).ToList();

                saleInvoices.Items = items;
            }

            var subCols = saleInvoices.Items == null ? null : saleInvoices.Items.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
            var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";
                            if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                            {
                                var index = 0;
                                var subColWidth = Convert.ToInt32(i.ColumnLength / saleInvoices.TotalResults[i.ColumnName].Count());
                                rowHeader = $"<th  colspan='{saleInvoices.TotalResults[i.ColumnName].Count()}' width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";
                                foreach (var subHeader in saleInvoices.TotalResults[i.ColumnName])
                                {
                                    if (index > 0) reportCountColHead++;
                                    multiCurrencyHeader += $"<th style='width: {subColWidth}px;'>{subHeader.Key}</th>";
                                    index++;
                                }
                            }
                            else
                            {
                                rowHeader = $"<th rowspan='2' width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";
                            }
                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                multiCurrencyHeader += isMultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                var groupBy = new List<GetListSaleInvoiceReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Account":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.AccountId)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.AccountName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Customer":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "JournalNo":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.JournalNo)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.JournalNo).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.Date)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Item":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.ItemId)
                                .Select(t => new GetListSaleInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.ItemCode != null ? x.ItemCode + "-" + x.ItemName : "").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }
                // write body
                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0) //write body have group by
                {
                    var trGroup = "";
                    foreach (var k in groupBy)
                    {
                        trGroup += $"<tr style='page-break-before: auto; page-break-after: auto;'>" +
                                   $"<td style='font-weight: bold;' colspan='{reportCountColHead}'> " + k.KeyName +
                                   $" </td></tr>";
                        foreach (var row in k.Items)
                        {
                            trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                            foreach (var i in viewHeader)
                            {
                                if (i.Visible)
                                {
                                    if (i.ColumnName == "ItemName")
                                    {
                                        trGroup += $"<td>{row.ItemName}</td>";
                                    }
                                    else if (i.ColumnName == "ItemCode")
                                    {
                                        trGroup += $"<td>{row.ItemCode}</td>";
                                    }
                                    else if (i.ColumnName == "JournalNo")
                                    {
                                        trGroup += $"<td>{row.JournalNo}</td>";
                                    }
                                    else if (i.ColumnName == "Account")
                                    {
                                        trGroup += $"<td>{row.AccountCode + " - " + row.AccountName}</td>";
                                    }
                                    else if (i.ColumnName == "Location")
                                    {
                                        trGroup += $"<td>{row.LocationName}</td>";
                                    }
                                    else if (i.ColumnName == "TaxRate")
                                    {

                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TaxRate, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "UnitPrice")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPrice, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "Qty")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Qty, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "Total")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.Total);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "Paid")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.Paid);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Paid, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "Balance")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.Balance);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Balance, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "ReceivePayment")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.ReceivePayment);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.ReceivePayment, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "TotalReceive")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.TotalReceive);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalReceive, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "Tax")

                                    {
                                        trGroup += $"<td>{row.TaxName}</td>";
                                    }
                                    else if (i.ColumnName == "Date")
                                    {
                                        trGroup += $"<td>{row.Date.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "Reference")
                                    {
                                        trGroup += $"<td>{row.Reference}</td>";
                                    }
                                    else if (i.ColumnName == "Description")
                                    {
                                        trGroup += $"<td>{row.Description}</td>";
                                    }
                                    else if (i.ColumnName == "Customer")
                                    {
                                        trGroup += $"<td>{row.CustomerName}</td>";
                                    }
                                    else if (i.ColumnName == "CustomerType")
                                    {
                                        trGroup += $"<td>{row.CustomerType}</td>";
                                    }
                                    else if (i.ColumnName == "SaleType")
                                    {
                                        trGroup += $"<td>{row.SaleType}</td>";
                                    }
                                    else if (i.ColumnName == "User")
                                    {
                                        trGroup += $"<td>{row.User}</td>";
                                    }
                                    else if (i.ColumnName == "OrderNo")
                                    {
                                        trGroup += $"<td>{row.OrderNo}</td>";
                                    }
                                    else if (i.ColumnName == "OrderReference")
                                    {
                                        trGroup += $"<td>{row.OrderReference}</td>";
                                    }
                                    else if (i.ColumnName == "NetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeight, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else
                                    {
                                        var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                        if (property != null)
                                        {
                                            trGroup += $"<td>{property.Value}</td>";
                                        }
                                        else
                                        {
                                            trGroup += $"<td></td>";
                                        }
                                    }
                                }
                            }
                            trGroup += "</tr>";
                        }
                        trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                                {
                                    if ((i.ColumnName == "Total" || i.ColumnName == "Paid" || i.ColumnName == "Balance" || i.ColumnName == "ReceivePayment" || i.ColumnName == "TotalReceive")
                                        && isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = k.Items.SelectMany(s => s.CurrencyColumnTotals.Where(r => r.CurrencyCode == subHeader))
                                                        .Sum(s => i.ColumnName == "Total" ? s.Total : i.ColumnName == "Paid" ? s.Paid : i.ColumnName == "Balance" ? s.Balance : i.ColumnName == "ReceivePayment" ? s.ReceivePayment : s.TotalReceive);
                                            trGroup += $"<td style='font-weight: bold; text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        if (i.ColumnName == "Total" || i.ColumnName == "Paid" || i.ColumnName == "Balance" || i.ColumnName == "ReceivePayment" || i.ColumnName == "TotalReceive")
                                        {
                                            trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => i.ColumnName == "Total" ? t.Total : i.ColumnName == "Paid" ? t.Paid : i.ColumnName == "Balance" ? t.Balance : i.ColumnName == "ReceivePayment" ? t.ReceivePayment : t.TotalReceive), digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                        else if (i.ColumnName == "NetWeight")
                                        {
                                            trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.NetWeight), digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                        else if (i.ColumnName == "Qty")
                                        {
                                            trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.Qty), digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                }
                                else //none sum
                                {
                                    trGroup += $"<td></td>";
                                }

                            }
                        }
                        trGroup += "</tr>";
                    }
                    contentBody += trGroup;
                }
                else // write body no group by
                {
                    foreach (var row in saleInvoices.Items)
                    {
                        var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "ItemName")
                                {
                                    tr += $"<td>{row.ItemName}</td>";
                                }
                                else if (i.ColumnName == "ItemCode")
                                {
                                    tr += $"<td>{row.ItemCode}</td>";
                                }
                                else if (i.ColumnName == "JournalNo")
                                {
                                    tr += $"<td>{row.JournalNo}</td>";
                                }
                                else if (i.ColumnName == "Account")
                                {
                                    tr += $"<td>{row.AccountCode + " - " + row.AccountName}</td>";
                                }
                                else if (i.ColumnName == "Location")
                                {
                                    tr += $"<td>{row.LocationName}</td>";
                                }
                                else if (i.ColumnName == "TaxRate")
                                {

                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TaxRate, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "UnitPrice")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPrice, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "Qty")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Qty, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "Total")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(r => r.CurrencyCode == subHeader).Sum(s => s.Total);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Total, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "Paid")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.Paid);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Paid, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "Balance")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.Balance);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Balance, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "ReceivePayment")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.ReceivePayment);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.ReceivePayment, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "TotalReceive")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.TotalReceive);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalReceive, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "Tax")

                                {
                                    tr += $"<td>{row.TaxName}</td>";
                                }
                                else if (i.ColumnName == "Date")
                                {
                                    tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "Reference")
                                {
                                    tr += $"<td>{row.Reference}</td>";
                                }
                                else if (i.ColumnName == "Description")
                                {
                                    tr += $"<td>{row.Description}</td>";
                                }
                                else if (i.ColumnName == "Customer")
                                {
                                    tr += $"<td>{row.CustomerName}</td>";
                                }
                                else if (i.ColumnName == "CustomerType")
                                {
                                    tr += $"<td>{row.CustomerType}</td>";
                                }
                                else if (i.ColumnName == "SaleType")
                                {
                                    tr += $"<td>{row.SaleType}</td>";
                                }
                                else if (i.ColumnName == "User")
                                {
                                    tr += $"<td>{row.User}</td>";
                                }
                                else if (i.ColumnName == "OrderNo")
                                {
                                    tr += $"<td>{row.OrderNo}</td>";
                                }
                                else if (i.ColumnName == "OrderReference")
                                {
                                    tr += $"<td>{row.OrderReference}</td>";
                                }
                                else if (i.ColumnName == "NetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeight, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else
                                {
                                    var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                    if (property != null)
                                    {
                                        tr += $"<td>{property.Value}</td>";
                                    }
                                    else
                                    {
                                        tr += $"<td></td>";
                                    }
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index == 0)
                            {
                                tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))
                                {
                                    if (saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subCol in subCols)
                                        {
                                            var total = saleInvoices.TotalResults[i.ColumnName].ContainsKey(subCol) ? saleInvoices.TotalResults[i.ColumnName][subCol] : 0;
                                            tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (saleInvoices.TotalResult.ContainsKey(i.ColumnName))
                                    {
                                        tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(saleInvoices.TotalResult[i.ColumnName], digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer
                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", multiCurrencyHeader);

                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);

                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{ReplaceSpecialCharacter(sheetName)}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);

                return result;

            });
        }

        #endregion

        #region Customer Aging Report


        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_Customer_CustomerAging)]
        public async Task<PagedResultWithTotalColuumnsDto<GetListCustomerAgingReportOutput>> GetCustomerAgingReport(GetListCustomerAgingInput input)
        {
            var filterByAccountingCurrency = input.CurrencyFilter != CurrencyFilter.MultiCurrencies;



            var previousCycle = await GetPreviousCloseCyleAsync(input.ToDate);
            var fromDateBeginning = previousCycle != null ? previousCycle.EndDate.Value.AddDays(1) : DateTime.MinValue;

            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();
            var customerTypes = input.CustomerTypes;
            if (customerTypeMemberIds.Any())
            {
                customerTypes = customerTypeMemberIds.WhereIf(input.CustomerTypes != null && input.CustomerTypes.Any(), s => input.CustomerTypes.Contains(s)).ToList();
            }

            // get provious 
            var previousInvoiceAndCredit = from ct in _customerOpenBalanceRepository.GetAll()
                                            //.Where(s => previousCycle != null && previousCycle.EndDate != null && s.Date.Date == previousCycle.EndDate.Value.Date)
                                            .Where(s => previousCycle != null && s.AccountCycleId == previousCycle.Id)
                                            .Where(s => s.Key == JournalType.Invoice || s.Key == JournalType.CustomerCredit)
                                            .AsNoTracking()

                                           join u in _journalItemRepository.GetAll()
                                              .Where(s => s.Journal.Status == TransactionStatus.Publish)
                                              .Where(s => s.Identifier == null)
                                              .WhereIf(input.Accounts != null && input.Accounts.Count() > 0, u => input.Accounts.Contains(u.AccountId))
                                              .WhereIf(input.AccountTypes != null && input.AccountTypes.Count() > 0, u => input.AccountTypes.Contains(u.Account.AccountTypeId))

                                              .Where(s => s.Journal.InvoiceId != null || s.Journal.CustomerCreditId != null)
                                              .WhereIf(input.JournalType != null && input.JournalType.Count() > 0, u => input.JournalType.Contains(u.Journal.JournalType))

                                              .WhereIf(customerTypes != null && customerTypes.Count() > 0, u =>
                                                   ((u.Journal.Invoice == null && u.Journal.Invoice.Customer == null) || customerTypes.Contains(u.Journal.Invoice.Customer.CustomerTypeId.Value)) &&
                                                   ((u.Journal.CustomerCredit == null && u.Journal.CustomerCredit.Customer == null) || input.CustomerTypes.Contains(u.Journal.CustomerCredit.Customer.CustomerTypeId.Value)))

                                              .WhereIf(input.Customers != null && input.Customers.Count() > 0, u =>
                                                   (u.Journal.Invoice == null || input.Customers.Contains(u.Journal.Invoice.CustomerId)) &&
                                                   (u.Journal.CustomerCredit == null || input.Customers.Contains(u.Journal.CustomerCredit.CustomerId)))
                                              .WhereIf(input.Locations != null && input.Locations.Count() > 0,
                                                   u => u.Journal.LocationId != null && input.Locations.Contains(u.Journal.LocationId.Value)).AsNoTracking()
                                              .AsNoTracking()

                                              .Select(s => new
                                              {
                                                  TransactionId = s.Journal.InvoiceId != null ? s.Journal.InvoiceId : s.Journal.CustomerCreditId,
                                                  AccountName = s.Account.AccountName,
                                                  AccountCode = s.Account.AccountCode,
                                                  AccountId = s.AccountId,
                                                  InvoiceOrCreditId = s.Journal.InvoiceId != null ? s.Journal.InvoiceId.Value : s.Journal.CustomerCreditId.Value,
                                                  JournalId = s.JournalId,
                                                  JournalDate = s.Journal.Date,
                                                  JournalMemo = s.Journal.Memo,
                                                  JournalNo = s.Journal.JournalNo,
                                                  JournalType = s.Journal.JournalType,
                                                  CustomerId = s.Journal.InvoiceId != null ? s.Journal.Invoice.CustomerId : s.Journal.CustomerCredit.CustomerId,
                                                  CustomerName = s.Journal.InvoiceId != null ? s.Journal.Invoice.Customer.CustomerName : s.Journal.CustomerCredit.Customer.CustomerName,
                                                  CustomerCode = s.Journal.InvoiceId != null ? s.Journal.Invoice.Customer.CustomerCode : s.Journal.CustomerCredit.Customer.CustomerCode,
                                                  Date = s.Journal.Date,
                                                  Aging = (int)(input.ToDate - s.Journal.Date).TotalDays,
                                                  Currency = filterByAccountingCurrency ?
                                                new CurrencyOutput
                                                {
                                                    Id = s.Journal.Currency.Id,
                                                    Code = s.Journal.Currency.Code,
                                                    Name = s.Journal.Currency.Name,
                                                    Symbol = s.Journal.Currency.Symbol,
                                                }
                                                : new CurrencyOutput
                                                {
                                                    Id = s.Journal.MultiCurrency.Id,
                                                    Code = s.Journal.MultiCurrency.Code,
                                                    Name = s.Journal.MultiCurrency.Name,
                                                    Symbol = s.Journal.MultiCurrency.Symbol,
                                                }

                                              })

                                           on ct.TransactionId equals u.TransactionId

                                           select new InvoiceAndCreditCustomerOutput
                                           {
                                               // CreationTimeIndex = u.CreationTimeIndex,
                                               InvoiceOrCreditId = ct.TransactionId,
                                               JournalId = u.JournalId,
                                               JournalDate = u.Date,
                                               JournalMemo = u.JournalMemo,
                                               JournalNo = u.JournalNo,
                                               JournalType = u.JournalType,
                                               CustomerId = u.CustomerId,
                                               CustomerName = u.CustomerName,
                                               CustomerCode = u.CustomerCode,
                                               Date = u.Date,
                                               Aging = (int)(input.ToDate - u.Date).TotalDays,
                                               InvoiceBalanceAmount = ct.Key == JournalType.CustomerCredit ? 0 : filterByAccountingCurrency ? ct.Balance : ct.MuliCurrencyBalance,
                                               InvoiceTotalAmount = ct.Key == JournalType.CustomerCredit ? 0 : filterByAccountingCurrency ? ct.Balance : ct.MuliCurrencyBalance,
                                               InvoiceTotalPaidAmount = 0,
                                               CreditBalanceAmount = ct.Key == JournalType.Invoice ? 0 : filterByAccountingCurrency ? ct.Balance : ct.MuliCurrencyBalance,
                                               CreditTotalAmount = ct.Key == JournalType.Invoice ? 0 : filterByAccountingCurrency ? ct.Balance : ct.MuliCurrencyBalance,
                                               CreditTotalPaidAmount = 0,
                                               AccountId = u.AccountId,
                                               AccountCode = u.AccountCode,
                                               AccountName = u.AccountName,
                                               Currency = new CurrencyOutput
                                               {
                                                   Id = u.Currency.Id,
                                                   Code = u.Currency.Code,
                                                   Name = u.Currency.Name,
                                                   Symbol = u.Currency.Symbol,
                                               }
                                           };

            var newInvoiceAndCreditByCustomer = _customerManager.GetInvoiceAndCreditCustomerQueryAsyn(
                                                fromDateBeginning,
                                                input.ToDate,
                                                input.Filter,
                                                input.Customers,
                                                input.Accounts,
                                                input.JournalType,
                                                input.AccountTypes,
                                                input.CurrencyFilter,
                                                input.Locations,
                                                customerTypes
                                                );


            var invoiceAndCreditByCustomer = newInvoiceAndCreditByCustomer.Concat(previousInvoiceAndCredit);


            var currencyColumns = (await invoiceAndCreditByCustomer.Select(u => new { u.Currency.Id, u.Currency.Code }).Distinct().ToListAsync()).OrderBy(r => r.Code);


            var invoicePayments = (from rpi in _receivePaymentItemRepository.GetAll()
                                  .WhereIf(input.Customers != null && input.Customers.Count() > 0, u => input.Customers.Contains(u.CustomerId))
                                  .AsNoTracking()

                                   join j in _journalRepository.GetAll()
                                   .Where(s => s.Status == TransactionStatus.Publish)
                                   .Where(u => u.ReceivePaymentId != null)
                                   .WhereIf(fromDateBeginning != null &&
                                            input.ToDate != null, (u =>
                                            (u.Date.Date) >= (fromDateBeginning.Date) &&
                                            (u.Date.Date) <= (input.ToDate.Date)))
                                    .AsNoTracking()
                                   on rpi.ReceivePaymentId equals j.ReceivePaymentId
                                   orderby j.Date descending, j.CreationTimeIndex descending
                                   select new
                                   {
                                       CreationTimeIndex = j.CreationTimeIndex,
                                       CustomerId = rpi.CustomerId,
                                       Date = j.Date,
                                       PaymentAmount = filterByAccountingCurrency ? rpi.Payment : rpi.MultiCurrencyPayment,
                                       JournalId = j.Id,
                                       InvoiceId = rpi.InvoiceId,
                                       CustomerCreditId = rpi.CustomerCreditId,
                                       Currency = filterByAccountingCurrency ? j.Currency : j.MultiCurrency,
                                   });


            //get invoice and customer credit balance by payment history
            var invoiceAndCustomerCreditBalance = from bvc in invoiceAndCreditByCustomer
                                                  join p in invoicePayments
                                                  on bvc.InvoiceOrCreditId equals p.InvoiceId into bp
                                                  where bp != null
                                                  join vp in invoicePayments
                                                  on bvc.InvoiceOrCreditId equals vp.CustomerCreditId into vcp
                                                  where vcp != null
                                                  select new InvoiceAndCreditCustomerOutput
                                                  {
                                                      CreationTimeIndex = bvc.CreationTimeIndex,
                                                      InvoiceOrCreditId = bvc.InvoiceOrCreditId,
                                                      JournalId = bvc.JournalId,
                                                      JournalDate = bvc.JournalDate,
                                                      JournalMemo = bvc.JournalMemo,
                                                      JournalNo = bvc.JournalNo,
                                                      JournalType = bvc.JournalType,
                                                      CustomerId = bvc.CustomerId,
                                                      CustomerName = bvc.CustomerName,
                                                      CustomerCode = bvc.CustomerCode,
                                                      Date = bvc.Date,

                                                      Aging = bvc.Aging,

                                                      InvoiceTotalAmount = bvc.InvoiceTotalAmount,
                                                      InvoiceTotalPaidAmount = bp != null && bp.Any() ? bp.Select(p => p.PaymentAmount).Sum() : 0,
                                                      InvoiceBalanceAmount = bp != null && bp.Any() ?
                                                                               bvc.InvoiceTotalAmount - bp.Select(p => p.PaymentAmount).Sum()
                                                                               : bvc.InvoiceTotalAmount,

                                                      CreditTotalAmount = bvc.CreditTotalAmount,
                                                      CreditTotalPaidAmount = vcp != null && vcp.Any() ? vcp.Select(p => p.PaymentAmount).Sum() : 0,
                                                      CreditBalanceAmount = vcp != null && vcp.Any() ?
                                                                              bvc.CreditTotalAmount - vcp.Select(p => p.PaymentAmount).Sum()
                                                                              : bvc.CreditTotalAmount,
                                                      AccountId = bvc.AccountId,
                                                      AccountCode = bvc.AccountCode,
                                                      AccountName = bvc.AccountName,
                                                      Currency = bvc.Currency
                                                  };

            var lastPayments = invoicePayments
                                .Where(s => s.InvoiceId.HasValue)
                                .GroupBy(u => u.CustomerId)
                                .Select(u => new
                                {
                                    CustomerId = u.Key,
                                    LastInvoicePayments = u.GroupBy(s => s.JournalId)
                                                        .OrderByDescending(t => t.First().Date)
                                                        .Select(s => s.ToList())
                                                        .FirstOrDefault(),

                                });

            var customerUserGroup = GetCustomerGroup(AbpSession.GetUserId());
            var finalList = (from c in customerUserGroup

                             join b in invoiceAndCustomerCreditBalance on c.Id equals b.CustomerId into vb
                             where vb != null && vb.Count() > 0

                             join p in lastPayments on c.Id equals p.CustomerId into vp
                             from leftPaymentCredit in vp.DefaultIfEmpty()
                                 //where vp != null

                             select new GetListCustomerAgingReportOutput
                             {
                                 CreationTimeIndex = vb.FirstOrDefault().CreationTimeIndex,
                                 CustomerId = c.Id,
                                 CustomerName = c.CustomerName,

                                 LastPaymentDate = leftPaymentCredit != null &&
                                                   leftPaymentCredit.LastInvoicePayments != null &&
                                                   leftPaymentCredit.LastInvoicePayments.FirstOrDefault() != null ?
                                                   leftPaymentCredit.LastInvoicePayments.FirstOrDefault().Date.Date :
                                                   (DateTime?)null,
                                 Aging = leftPaymentCredit != null &&
                                                   leftPaymentCredit.LastInvoicePayments != null &&
                                                   leftPaymentCredit.LastInvoicePayments.FirstOrDefault() != null ?
                                                   (int)(input.ToDate.Date.AddDays(1).AddTicks(-1) -
                                                          leftPaymentCredit.LastInvoicePayments.FirstOrDefault().Date).TotalDays : 0,

                                 ColumnTotalByCurrencies = currencyColumns.Select(c => new ColumnTotalByCurrency
                                 {
                                     CurrencyId = c.Id,
                                     CurrencyCode = c.Code,

                                     Current = vb.Where(r => r.Currency.Id == c.Id && r.Aging <= 1).Select(s => s.InvoiceBalanceAmount - s.CreditBalanceAmount).Sum(),
                                     Col30 = vb.Where(r => r.Currency.Id == c.Id && r.Aging > 1 && r.Aging <= 30).Select(s => s.InvoiceBalanceAmount - s.CreditBalanceAmount).Sum(),
                                     Col60 = vb.Where(r => r.Currency.Id == c.Id && r.Aging > 30 && r.Aging <= 60).Select(s => s.InvoiceBalanceAmount - s.CreditBalanceAmount).Sum(),
                                     Col90 = vb.Where(r => r.Currency.Id == c.Id && r.Aging > 60 && r.Aging <= 90).Select(s => s.InvoiceBalanceAmount - s.CreditBalanceAmount).Sum(),
                                     Col90Up = vb.Where(r => r.Currency.Id == c.Id && r.Aging > 90).Select(s => s.InvoiceBalanceAmount - s.CreditBalanceAmount).Sum(),
                                     Total = vb.Where(r => r.Currency.Id == c.Id).Select(s => s.InvoiceBalanceAmount - s.CreditBalanceAmount).Sum(),


                                     LastPaymentAmount = leftPaymentCredit != null &&
                                                         leftPaymentCredit.LastInvoicePayments != null ?
                                                         leftPaymentCredit.LastInvoicePayments.Where(r => r.Currency.Id == c.Id)
                                                                                           .Select(s => s.PaymentAmount).Sum() : 0,

                                 }).ToList(),

                             })
                             .WhereIf(input.OpeningBalance != OpeningBalanceStatus.All, s =>
                                (input.OpeningBalance == OpeningBalanceStatus.Opening && s.ColumnTotalByCurrencies.Any(t => t.Total != 0)) ||
                                (input.OpeningBalance == OpeningBalanceStatus.Zero && s.ColumnTotalByCurrencies.All(t => t.Total == 0))
                             );


            var resultCount = 0;
            if (input.IsLoadMore == false)
            {
                resultCount = await finalList.CountAsync();
            }
            var @entities = new List<GetListCustomerAgingReportOutput>();

            var sumOfColumns = new Dictionary<string, decimal>();
            var multiCurrencySumOfColumns = new Dictionary<string, Dictionary<string, decimal>>();

            if (resultCount == 0 && !input.IsLoadMore)
            {
                return new PagedResultWithTotalColuumnsDto<GetListCustomerAgingReportOutput>(resultCount, @entities, multiCurrencySumOfColumns);
            }


            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                var sumList = await finalList.SelectMany(u => u.ColumnTotalByCurrencies).Select(u => u).ToListAsync();
                var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyId).Select(u => new
                {

                    CurrentId = u.Key,
                    Current = u.Sum(s => s.Current),
                    Col30 = u.Sum(s => s.Col30),
                    Col60 = u.Sum(s => s.Col60),
                    Col90 = u.Sum(s => s.Col90),
                    Col90Up = u.Sum(s => s.Col90Up),
                    //Total = u.Sum(s=>s.Total),
                    LastPayment = u.Sum(s => s.LastPaymentAmount),

                }).ToDictionary(u => u.CurrentId);

                foreach (var col in input.ColumnNamesToSum)
                {
                    foreach (var c in currencyColumns)
                    {
                        //if (col == "Current") sumOfColumns.Add(c.Code, finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Current).Sum());
                        //else if (col == "Col30") sumOfColumns.Add(c.Code, finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Col30).Sum());
                        //else if (col == "Col60") sumOfColumns.Add(c.Code, finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Col60).Sum());
                        //else if (col == "Col90") sumOfColumns.Add(c.Code, finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Col90).Sum());
                        //else if (col == "Col90Up") sumOfColumns.Add(c.Code, finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Col90Up).Sum());
                        //else if (col == "Total") sumOfColumns.Add(c.Code, finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Total).Sum());
                        //else if (col == "LastPaymentAmount") sumOfColumns.Add(c.Code, finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.LastPaymentAmount).Sum());

                        if (col == "Current") sumOfColumns.Add(c.Code, groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].Current : 0);// finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Current).Sum());
                        else if (col == "Col30") sumOfColumns.Add(c.Code, groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].Col30 : 0);// finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Col30).Sum());
                        else if (col == "Col60") sumOfColumns.Add(c.Code, groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].Col60 : 0);// finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Col60).Sum());
                        else if (col == "Col90") sumOfColumns.Add(c.Code, groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].Col90 : 0);// finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Col90).Sum());
                        else if (col == "Col90Up") sumOfColumns.Add(c.Code, groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].Col90Up : 0);// finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Col90Up).Sum());
                        else if (col == "Total")
                        {
                            var current = groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].Current : 0;
                            var col30 = groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].Col30 : 0;
                            var col60 = groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].Col60 : 0;
                            var col90 = groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].Col90 : 0;
                            var col90Up = groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].Col90Up : 0;
                            var total = current + col30 + col60 + col90 + col90Up;
                            sumOfColumns.Add(c.Code, total);// finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.Total).Sum());

                        }
                        else if (col == "LastPaymentAmount") sumOfColumns.Add(c.Code, groupByCurrencyDict.ContainsKey(c.Id) ? groupByCurrencyDict[c.Id].LastPayment : 0);// finalList.SelectMany(u => u.ColumnTotalByCurrencies).Where(r => r.CurrencyId == c.Id).Select(s => s.LastPaymentAmount).Sum());

                    }

                    if (!multiCurrencySumOfColumns.ContainsKey(col))
                    {
                        multiCurrencySumOfColumns.Add(col, sumOfColumns);
                    }
                    else
                    {
                        multiCurrencySumOfColumns[col] = sumOfColumns;
                    }

                    sumOfColumns = new Dictionary<string, decimal>();

                }
            }



            if (input.UsePagination == true)
            {
                @entities = await finalList.Skip(input.SkipCount).Take(input.MaxResultCount).ToListAsync();
            }
            else
            {
                @entities = await finalList.ToListAsync();
            }
            return new PagedResultWithTotalColuumnsDto<GetListCustomerAgingReportOutput>(resultCount, @entities, multiCurrencySumOfColumns);
        }


        public ReportOutput GetReportTemplateCustomerAging()
        {

            var IsMultiCurrency = _multiCurrencyRepository.GetAll();

            var result = new ReportOutput()
            {
                ColumnInfo = new List<CollumnOutput>() {
                     // start properties with can filter
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DateRange",
                        ColumnLength = 150,
                        ColumnTitle = "DateRange",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        DefaultValue = "asOf",
                        AllowFunction = null,
                        DisableDefault = true,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "AccountType",
                        ColumnLength = 300,
                        ColumnTitle = "AccountType",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Account",
                        ColumnLength = 300,
                        ColumnTitle = "Account",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Customer",
                        ColumnLength = 300,
                        ColumnTitle = "Customer",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },

                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "JournalType",
                        ColumnLength = 300,
                        ColumnTitle = "JournalType",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },//End Of filter
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "CustomerName",
                        ColumnLength = 200,
                        ColumnTitle = "Customer",
                        ColumnType = ColumnType.String,
                        SortOrder = 1,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        DisableDefault =true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                     },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Current",
                        ColumnLength = 140,
                        ColumnTitle = "Current",
                        ColumnType = ColumnType.Money,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                         MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true,
                        DisableDefault = false
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Col30",
                        ColumnLength = 140,
                        ColumnTitle = "1-30",
                        ColumnType = ColumnType.Money,
                        SortOrder = 3,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                         MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        DisableDefault = false,
                        IsDisplay = true
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Col60",
                        ColumnLength = 140,
                        ColumnTitle = "30-60",
                        ColumnType = ColumnType.Money,
                        SortOrder = 4,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                         MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true,
                        DisableDefault = false
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Col90",
                        ColumnLength = 140,
                        ColumnTitle = "60-90",
                        ColumnType = ColumnType.Money,
                        SortOrder = 5,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                         MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true,
                        DisableDefault = false
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Col90Up",
                        ColumnLength = 140,
                        ColumnTitle = "> 90",
                        ColumnType = ColumnType.Money,
                        SortOrder = 6,
                        Visible = true,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                         AllowFunction = "Sum",
                         MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                      new CollumnOutput{
                            AllowGroupby = false,
                            AllowFilter = false,
                            ColumnName = "Total",
                            ColumnLength = 140,
                            ColumnTitle = "Total",
                            ColumnType = ColumnType.Money,
                            SortOrder = 7,
                            Visible = true,
                            AllowFunction = "Sum",
                            IsDisplay = true,
                            DisableDefault = true,
                            AllowShowHideFilter = false,
                            ShowHideFilter = false,
                            MoreFunction = new List<MoreFunction>(){
                                new MoreFunction
                                {
                                    KeyName = null
                                },
                                new MoreFunction
                                {
                                    KeyName = "Sum"
                                }
                            },
                        },
                    //  new CollumnOutput {
                    //    AllowGroupby = false,
                    //    AllowFilter = false,
                    //    month = "Group",
                    //    ColumnLength = 170,
                    //    ColumnTitle = "Last Payment",
                    //    ColumnType = ColumnType.Group,
                    //    SortOrder = 7,
                    //    Visible = true,
                    //    IsDisplay = true,
                    //    AllowFunction = null,
                    //    GroupHeader = new List<GroupHeaderList>()
                    //    {
                           
                    //    }
                    //},
                     new CollumnOutput
                    {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "LastPaymentDate",
                        ColumnLength = 140,
                        ColumnTitle = "Last Payment Date",
                        ColumnType = ColumnType.Date,
                        SortOrder = 8,
                        Visible = false,
                        AllowFunction = null,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput
                    {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "LastPaymentAmount",
                        ColumnLength = 140,
                        ColumnTitle = "Last Payment Amount",
                        ColumnType = ColumnType.Money,
                        SortOrder = 9,
                        Visible = false,
                        AllowFunction = "Sum",
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                    new CollumnOutput
                    {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Aging",
                        ColumnLength = 140,
                        ColumnTitle = "Aging",
                        ColumnType = ColumnType.Number,
                        SortOrder = 10,
                        Visible = false,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Location",
                        ColumnLength = 150,
                        ColumnTitle = "Location",
                        ColumnType = ColumnType.String,
                        SortOrder = 11,
                        Visible = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },

                     new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "CustomerType",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 12,
                        Visible = true,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                     new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "OpeningBalance",
                        ColumnLength = 300,
                        ColumnTitle = "Opening Balance",
                        ColumnType = ColumnType.Array,
                        SortOrder = 13,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = false,
                        DefaultValue = Convert.ToInt32(OpeningBalanceStatus.All).ToString(),
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                },
                Groupby = "",
                HeaderTitle = "Customer Aging",
                Sortby = "",
                DefaultTemplate = new DefaultSaveTemplateOutput
                {
                    ColumnName = "CustomerByInvoice",
                    ColumnTitle = "CustomerByInvoiceTemplate",
                    DefaultValue = ReportType.ReportType_CustomerByInvoice
                }
            };

            if (!FeatureChecker.IsEnabled(AppFeatures.AccountingFeature))
            {
                result.ColumnInfo = result.ColumnInfo.Where(s => s.ColumnName != "Account" && s.ColumnName != "AccountType").ToList();
            }

            if (IsMultiCurrency.Any())
            {
                var currency = new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Currency",
                    ColumnLength = 140,
                    ColumnTitle = "Currency",
                    ColumnType = ColumnType.String,
                    SortOrder = 3,
                    Visible = true,
                    IsDisplay = false,
                    DisableDefault = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                };
                result.ColumnInfo.Add(currency);
            }
            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_Customer_CustomerAging_Export_Excel)]
        public async Task<FileDto> ExportExcelCustomerAgingReport(GetCustomerAgingReportInput input)
        {
            input.UsePagination = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;



            var resultList = await GetCustomerAgingReport(input);
            var entity = resultList.Items;

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet


                var subCols = entity == null ? null : entity.First().ColumnTotalByCurrencies.Select(s => s.CurrencyCode).ToList();
                var sumCols = reportHasShowFooterTotal == null || subCols == null ? 0 : reportHasShowFooterTotal.Count() * (subCols.Count() - 1);

                var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead + sumCols, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString("dd-MM-yyyy");
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead + sumCols, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table



                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    if ((i.ColumnType == ColumnType.Money || i.ColumnType == ColumnType.Number) && i.AllowFunction != null && subCols != null && subCols.Any() && isMultiCurrencies)
                    {
                        var colWidth = i.ColumnLength;
                        var subColWidth = i.ColumnLength / subCols.Count();

                        AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                        ws.Column(colHeaderTable).Width = ConvertPixelToInches(colWidth);
                        MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader, colHeaderTable + subCols.Count() - 1, ExcelHorizontalAlignment.Center);

                        foreach (var subCol in subCols)
                        {
                            AddTextToCell(ws, rowTableHeader + 1, colHeaderTable, subCol, true);
                            ws.Column(colHeaderTable).Width = ConvertPixelToInches(subColWidth);

                            colHeaderTable += 1;
                        }
                    }
                    else
                    {
                        AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                        ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                        if (subCols != null && isMultiCurrencies) MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader + 1, colHeaderTable, ExcelHorizontalAlignment.Center, ExcelVerticalAlignment.Center);

                        colHeaderTable += 1;
                    }
                }

                rowTableHeader += subCols != null && subCols.Any() && isMultiCurrencies ? 1 : 0;

                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                // write body
                foreach (var i in entity)
                {
                    int collumnCellBody = 1;
                    foreach (var item in reportCollumnHeader)// map with correct key of properties 
                    {

                        if ((item.ColumnType == ColumnType.Number || item.ColumnType == ColumnType.Money) && item.AllowFunction != null && subCols != null && subCols.Any())
                        {



                            foreach (var subCol in subCols)
                            {
                                var model = (ColumnTotalByCurrency)i.ColumnTotalByCurrencies.FirstOrDefault(s => s.CurrencyCode == subCol);

                                var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);

                                var value = cellValue ?? 0;

                                AddCellValue(ws, rowBody, collumnCellBody, item, value);

                                collumnCellBody += 1;
                            }

                        }
                        else
                        {
                            var value = i.GetType().GetProperty(item.ColumnName)?.GetValue(i, null);
                            AddCellValue(ws, rowBody, collumnCellBody, item, value);

                            collumnCellBody += 1;
                        }

                    }
                    rowBody += 1;
                    count += 1;
                }
                #endregion Row Body


                #region Row Footer

                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;


                    int bodyEnd = rowBody;
                    int footerColNumber = 1;

                    //Total Label                    
                    AddTextToCell(ws, footerRow, footerColNumber, "Total", true);

                    footerColNumber++;

                    //Skip Vendor and Currency Columns
                    var columns = reportCollumnHeader.Count();
                    var sumColumns = reportCollumnHeader.Skip(1).Take(columns).ToList();


                    foreach (var i in sumColumns)
                    {
                        if (i.AllowFunction != null && subCols != null && subCols.Any())
                        {
                            foreach (var subCol in subCols)
                            {
                                int bodyStart = rowTableHeader + 1;// get start row after header 
                                var fromCell = GetAddressName(ws, bodyStart, footerColNumber);
                                var toCell = GetAddressName(ws, bodyEnd - 1, footerColNumber);


                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }

                                footerColNumber += 1;
                            }

                        }
                        else
                        {
                            footerColNumber += 1;
                        }

                    }
                }

                #endregion Row Footer


                result.FileName = $"CustomerAging_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }
        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_Customer_CustomerAging_Export_Pdf)]
        public async Task<FileDto> ExportPDFCustomerAgingReport(GetCustomerAgingReportInput input)
        {
            input.UsePagination = false;
            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                             .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                             .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }
            var user = await GetCurrentUserAsync();
            var rounding = await GetCurrentCycleAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();

            var sheetName = report.HeaderTitle;

            var entity = await GetCustomerAgingReport(input);

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;
                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                var multiCurrencyHeader = input.CurrencyFilter == CurrencyFilter.MultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";
                            if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies && entity.TotalResults.ContainsKey(i.ColumnName))
                            {
                                var index = 0;
                                var subColWidth = Convert.ToInt32(i.ColumnLength / entity.TotalResults[i.ColumnName].Count());
                                rowHeader = $"<th  colspan='{entity.TotalResults[i.ColumnName].Count()}' width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";
                                foreach (var subHeader in entity.TotalResults[i.ColumnName])
                                {
                                    if (index > 0) reportCountColHead++;
                                    multiCurrencyHeader += $"<th style='width: {subColWidth}px;'>{subHeader.Key}</th>";
                                    //rowHeader += $"<div style='margin-top: 5px;margin:1px;border-top: 1px solid #000;float: left;text-align: right;width:{Math.Round((i.ColumnLength / entity.TotalResults[i.month].Count()) - minusSubLength, 1)}px'>";
                                    //rowHeader += subHeader.Key;
                                    //rowHeader += "</div>";
                                }
                            }
                            else
                            {
                                rowHeader = $"<th rowspan='2' width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";
                            }
                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                multiCurrencyHeader += input.CurrencyFilter == CurrencyFilter.MultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              
                foreach (var row in entity.Items)
                {
                    var tr = "<tr style='page-break-inside:avoid;' valign='top'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (i.ColumnName == "CustomerName")
                            {
                                tr += $"<td>{row.CustomerName}</td>";
                            }
                            else if (i.ColumnType == ColumnType.Money)
                            {
                                if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)//Multi currency 
                                {
                                    //tr += $"<td>";
                                    if (entity.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var code in entity.TotalResults[i.ColumnName])
                                        {
                                            tr += $"<td style='text-align: right;'>";

                                            var sub = row.ColumnTotalByCurrencies.Where(t => t.CurrencyCode == code.Key).FirstOrDefault();
                                            if (i.ColumnName == "Current")
                                            {
                                                tr += $"{FormatNumberCurrency(Math.Round(sub.Current, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}";
                                            }
                                            else if (i.ColumnName == "Col30")
                                            {
                                                tr += $"{FormatNumberCurrency(Math.Round(sub.Col30, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}";
                                            }
                                            else if (i.ColumnName == "Col60")
                                            {
                                                tr += $"{FormatNumberCurrency(Math.Round(sub.Col60, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}";
                                            }
                                            else if (i.ColumnName == "Col90")
                                            {
                                                tr += $"{FormatNumberCurrency(Math.Round(sub.Col90, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}";
                                            }
                                            else if (i.ColumnName == "Col90Up")
                                            {
                                                tr += $"{FormatNumberCurrency(Math.Round(sub.Col90Up, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}";
                                            }
                                            else if (i.ColumnName == "Total")
                                            {
                                                tr += $"{FormatNumberCurrency(Math.Round(sub.Total, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}";
                                            }
                                            else if (i.ColumnName == "LastPaymentAmount")
                                            {
                                                tr += $"{FormatNumberCurrency(Math.Round(sub.LastPaymentAmount, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}";
                                            }
                                            tr += "</td>";
                                        }
                                    }
                                    //tr += "</td>";
                                }
                                else
                                {
                                    foreach (var sub in row.ColumnTotalByCurrencies)
                                    {

                                        if (i.ColumnName == "Current")
                                        {
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(sub.Current, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                        }
                                        else if (i.ColumnName == "Col30")
                                        {
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(sub.Col30, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                        }
                                        else if (i.ColumnName == "Col60")
                                        {
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(sub.Col60, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                        }
                                        else if (i.ColumnName == "Col90")
                                        {
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(sub.Col90, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                        }
                                        else if (i.ColumnName == "Col90Up")
                                        {
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(sub.Col90Up, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                        }
                                        else if (i.ColumnName == "Total")
                                        {
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(sub.Total, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                        }
                                        else if (i.ColumnName == "LastPaymentAmount")
                                        {
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(sub.LastPaymentAmount, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                        }
                                    }
                                }

                            }
                            else if (i.ColumnName == "LastPaymentDate")
                            {
                                var lastDatePayment = row.LastPaymentDate != null ? row.LastPaymentDate.Value.ToString(formatDate) : null;
                                tr += $"<td>{lastDatePayment}</td>";
                            }
                            else if (i.ColumnName == "Aging")
                            {
                                tr += $"<td style='text-align: right;'>{row.Aging}</td>";
                            }
                            else
                            {
                                tr += $"<td></td>";
                            }
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-inside:avoid;' valign='top'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (!string.IsNullOrEmpty(i.AllowFunction) && entity.TotalResults.ContainsKey(i.ColumnName))/*listSum.Contains(i.month))*/
                            {
                                if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                {
                                    //tr += $"<td>";
                                    foreach (var code in entity.TotalResults[i.ColumnName])
                                    {
                                        tr += $"<td style='text-align: right;'>";
                                        var sub = entity.TotalResults[i.ColumnName][code.Key];
                                        tr += $"{FormatNumberCurrency(Math.Round(sub, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}";
                                        tr += "</td>";
                                    }
                                    //tr += "</td>";
                                }
                                else
                                {
                                    tr += $"<td style='word-wrap:break-word;text-align: right;'>";
                                    foreach (var code in entity.TotalResults[i.ColumnName])
                                    {
                                        var sub = entity.TotalResults[i.ColumnName][code.Key];
                                        tr += $"{FormatNumberCurrency(Math.Round(sub, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}";

                                    }
                                    tr += "</td>";

                                }
                            }
                            else //none sum
                            {
                                if (index == 0)
                                {
                                    tr += $"<td style='font-weight: bold;'>{L("Total")}</td>";
                                }
                                else
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", multiCurrencyHeader);

                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);

                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{ReplaceSpecialCharacter(sheetName)}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }


        #endregion

        #region Customer By Invoice Report 
        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_Customer_CustomerByInvoice)]
        public async Task<PagedResultWithTotalColuumnsDto<GetCustomerByInvoiceReportOutput>> GetCustomerByInvoiceReport(GetListCustomerAgingInput input)
        {

            var filterByAccountingCurrency = input.CurrencyFilter != CurrencyFilter.MultiCurrencies;

            var previousDay = input.FromDate.AddDays(-1);

            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();
            var customerTypes = input.CustomerTypes;
            if (customerTypeMemberIds.Any())
            {
                customerTypes = customerTypeMemberIds.WhereIf(input.CustomerTypes != null && input.CustomerTypes.Any(), s => input.CustomerTypes.Contains(s)).ToList();
            }

            //var previousBillInvoices = _customerManager.GetInvoiceAndCreditCustomerWithBalanceQuery(AbpSession.GetUserId(),
            //                                            null, previousDay, input.Filter, input.Customers,
            //                                            input.Accounts, input.JournalType, input.AccountTypes, input.Users, input.CurrencyFilter, input.Locations, customerTypes);


            //var newPeriodBillInvoiceResult = _customerManager.GetInvoiceAndCreditCustomerWithBalanceQuery(AbpSession.GetUserId(),
            //                                                input.FromDate,
            //                                                input.ToDate, input.Filter, input.Customers,
            //                                                input.Accounts, input.JournalType,
            //                                                input.AccountTypes, input.Users, input.CurrencyFilter,
            //                                                input.Locations,
            //                                                customerTypes);

            var allQuery = _customerManager.GetInvoiceAndCreditCustomerWithBalanceQuery(AbpSession.GetUserId(),
                                                        null, input.ToDate, input.Filter, input.Customers,
                                                        input.Accounts, input.JournalType, input.AccountTypes, input.Users, input.CurrencyFilter, input.Locations, customerTypes);

            var previousBillInvoices = allQuery.Where(s => s.Date.Date < input.FromDate.Date);
            var newPeriodBillInvoiceResult = allQuery.Where(s => s.Date.Date >= input.FromDate.Date);

            //get all currencies from both query
            //var currencyCodes = (await previousBillInvoices.Concat(newPeriodBillInvoiceResult).Select(s => s.Currency.Code).GroupBy(u => u).Select(u => u.Key).ToListAsync()).OrderBy(r => r);
            var currencyCodes = (await allQuery.Select(s => s.Currency.Code).GroupBy(u => u).Select(u => u.Key).ToListAsync()).OrderBy(r => r);


            //Generate currency columns
            var newPeriodBillInvoices = newPeriodBillInvoiceResult.Select(i => new GetCustomerByInvoiceReportOutput
            {
                CreationTimeIndex = i.CreationTimeIndex,
                User = i.User,
                TransactionId = i.TransactionId,
                CustomerId = i.CustomerId,
                CustomerCode = i.CustomerCode,
                CustomerName = i.CustomerName,
                LastPaymentAmounts = i.LastPaymentAmounts,
                LastPaymentDate = i.LastPaymentDate,
                Date = i.Date,
                AccountCode = i.AccountCode,
                AccountName = i.AccountName,
                Balance = i.Balance,
                Description = i.Description,
                JournalNo = i.JournalNo,
                Reference = i.Reference,
                JournalType = i.JournalType,
                ToDate = i.ToDate,
                TotalAmount = i.TotalAmount,
                TotalPaid = i.TotalPaid,
                Currency = i.Currency,
                Location = i.Location,
                TotalColsByCurency = currencyCodes.Select(u => new GetCustomerByInvoiceReportOutputItemByCurrency()
                {
                    CurrencyCode = u,
                    TotalAmounts = u == i.Currency.Code ? i.TotalAmount : 0,
                    TotalPaids = u == i.Currency.Code ? i.TotalPaid : 0,
                    Balances = u == i.Currency.Code ? i.Balance : 0,
                    LastPaymentAmounts = u == i.Currency.Code ? i.LastPaymentAmounts : 0,

                }).ToList(),


            });

            var previousBillInvoicesGroupByVendor = previousBillInvoices.GroupBy(u => new
            {
                u.CustomerId,
                u.CustomerCode,
                u.CustomerName,
            }).
            Select(i => new GetCustomerByInvoiceReportOutput
            {
                CreationTimeIndex = null,
                CustomerId = i.Key.CustomerId,
                CustomerCode = i.Key.CustomerCode,
                CustomerName = i.Key.CustomerName,
                LastPaymentAmounts = 0,
                LastPaymentDate = (DateTime?)null,
                Date = previousDay,
                AccountCode = "",
                AccountName = "",
                Description = "",
                JournalNo = "",
                JournalType = null,
                ToDate = null,
                TotalAmount = filterByAccountingCurrency ? i.Sum(s => s.TotalAmount) : 0,
                TotalPaid = filterByAccountingCurrency ? i.Sum(s => s.TotalPaid) : 0,
                Balance = filterByAccountingCurrency ? i.Sum(s => s.Balance) : 0,
                TotalColsByCurency = currencyCodes.Select(u => new GetCustomerByInvoiceReportOutputItemByCurrency()
                {
                    CurrencyCode = u,
                    TotalAmounts = i.Where(r => r.Currency.Code == u).Select(s => s.TotalAmount).Sum(),
                    TotalPaids = i.Where(r => r.Currency.Code == u).Select(s => s.TotalPaid).Sum(),
                    Balances = i.Where(r => r.Currency.Code == u).Select(s => s.Balance).Sum(),
                    LastPaymentAmounts = i.Where(r => r.Currency.Code == u).Select(s => s.LastPaymentAmounts).Sum()
                }).ToList()
            });

            var finalList = previousBillInvoicesGroupByVendor.Concat(newPeriodBillInvoices)
                            .WhereIf(input.OpeningBalance != OpeningBalanceStatus.All, s =>
                               (input.OpeningBalance == OpeningBalanceStatus.Opening && s.Balance != 0) ||
                               (input.OpeningBalance == OpeningBalanceStatus.Zero && s.Balance == 0)
                             )
                            .OrderBy(u => u.CustomerCode).ThenBy(u => u.Date.Date).ThenBy(t => t.CreationTimeIndex);

            var resultCount = 0;
            if (input.IsLoadMore == false)
            {
                resultCount = await finalList.CountAsync();
            }
            var @entities = new List<GetCustomerByInvoiceReportOutput>();
            var sumOfColumns = new Dictionary<string, decimal>();

            var multiCurrencySumOfColumns = new Dictionary<string, Dictionary<string, decimal>>();

            if (resultCount == 0 && !input.IsLoadMore)
            {
                return new PagedResultWithTotalColuumnsDto<GetCustomerByInvoiceReportOutput>(resultCount, @entities, multiCurrencySumOfColumns);
            }

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                var sumList = await finalList.SelectMany(u => u.TotalColsByCurency).Select(u => u).ToListAsync();
                var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                {
                    CurrencyCode = u.Key,
                    TotalPaid = u.Sum(s => s.TotalPaids),
                    TotalAmount = u.Sum(s => s.TotalAmounts),
                    //Balance = u.Sum(s => s.Balances),
                    LastPaymentAmounts = u.Sum(s => s.LastPaymentAmounts)

                }).ToDictionary(u => u.CurrencyCode);

                foreach (var col in input.ColumnNamesToSum)
                {
                    foreach (var cCode in currencyCodes)
                    {
                        if (col == "TotalPaid" || col == "TotalPaids") sumOfColumns.Add(cCode, groupByCurrencyDict.ContainsKey(cCode) ? groupByCurrencyDict[cCode].TotalPaid : 0);
                        else if (col == "TotalAmount" || col == "TotalAmounts") sumOfColumns.Add(cCode,
                            groupByCurrencyDict.ContainsKey(cCode) ? groupByCurrencyDict[cCode].TotalAmount : 0);
                        else if (col == "Balance" || col == "Balances")
                        {
                            var totalAmount = groupByCurrencyDict.ContainsKey(cCode) ? groupByCurrencyDict[cCode].TotalAmount : 0;
                            var totalPaid = groupByCurrencyDict.ContainsKey(cCode) ? groupByCurrencyDict[cCode].TotalPaid : 0;
                            var balance = totalAmount - totalPaid;

                            sumOfColumns.Add(cCode, balance);

                        }
                        else if (col == "LastPaymentAmounts") sumOfColumns.Add(cCode,
                                                            groupByCurrencyDict.ContainsKey(cCode) ? groupByCurrencyDict[cCode].LastPaymentAmounts : 0);



                        //if (col == "TotalPaid") sumOfColumns.Add(cCode, finalList.SelectMany(s => s.TotalColsByCurency).Where(r => r.CurrencyCode == cCode).Select(s => s.TotalPaids).Sum());
                        //else if (col == "TotalAmount") sumOfColumns.Add(cCode, finalList.SelectMany(s => s.TotalColsByCurency).Where(r => r.CurrencyCode == cCode).Select(s => s.TotalAmounts).Sum());
                        //else if (col == "Balance") sumOfColumns.Add(cCode, finalList.SelectMany(s => s.TotalColsByCurency).Where(r => r.CurrencyCode == cCode).Select(s => s.Balances).Sum());

                        //else if (col == "TotalPaids") sumOfColumns.Add(cCode, finalList.SelectMany(s => s.TotalColsByCurency).Where(r => r.CurrencyCode == cCode).Select(s => s.TotalAmounts).Sum());
                        //else if (col == "TotalAmounts") sumOfColumns.Add(cCode, finalList.SelectMany(s => s.TotalColsByCurency).Where(r => r.CurrencyCode == cCode).Select(s => s.TotalPaids).Sum());
                        //else if (col == "Balances") sumOfColumns.Add(cCode, finalList.SelectMany(s => s.TotalColsByCurency).Where(r => r.CurrencyCode == cCode).Select(s => s.Balances).Sum());
                        //else if (col == "LastPaymentAmounts") sumOfColumns.Add(cCode, finalList.Where(u => u.Currency != null && u.Currency.Code == cCode).Select(s => s.LastPaymentAmounts).Sum());

                    }

                    if (!multiCurrencySumOfColumns.ContainsKey(col))
                    {
                        multiCurrencySumOfColumns.Add(col, sumOfColumns);
                    }
                    else
                    {
                        multiCurrencySumOfColumns[col] = sumOfColumns;
                    }

                    sumOfColumns = new Dictionary<string, decimal>();

                }
            }

            var orderKey = input.Sorting;
            if (!input.GroupBy.IsNullOrWhiteSpace())
            {
                orderKey = "CustomerCode";
            }

            if (input.UsePagination == true)
            {
                @entities = await finalList.OrderBy(orderKey).ThenBy(s => s.CreationTimeIndex).Skip(input.SkipCount).Take(input.MaxResultCount).ToListAsync();
            }
            else
            {
                @entities = await finalList.OrderBy(orderKey).ThenBy(s => s.CreationTimeIndex).ToListAsync();
            }


            return new PagedResultWithTotalColuumnsDto<GetCustomerByInvoiceReportOutput>(resultCount, @entities, multiCurrencySumOfColumns);


        }

        public ReportOutput GetReportTemplateCustomerByInvoice()
        {

            var IsMultiCurrency = _multiCurrencyRepository.GetAll();
            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = new List<CollumnOutput>() {
                     // start properties with can filter
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DateRange",
                        ColumnLength = 150,
                        ColumnTitle = "DateRange",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        DefaultValue = "thisMonth",
                        AllowFunction = null,
                        DisableDefault = false,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "AccountType",
                        ColumnLength = 300,
                        ColumnTitle = "AccountType",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Account",
                        ColumnLength = 300,
                        ColumnTitle = "Account",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Customer",
                        ColumnLength = 300,
                        ColumnTitle = "Customer",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        DefaultValue = "Customer",
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "JournalType",
                        ColumnLength = 300,
                        ColumnTitle = "JournalType",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },//End Of filter
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Date",
                        ColumnLength = 130,
                        ColumnTitle = "Date",
                        ColumnType = ColumnType.Date,
                        SortOrder = 1,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                     },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "JournalNo",
                        ColumnLength = 140,
                        ColumnTitle = "Journal No",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Reference",
                        ColumnLength = 140,
                        ColumnTitle = "Reference",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "JournalType",
                        ColumnLength = 140,
                        ColumnTitle = "Journal Type",
                        ColumnType = ColumnType.StatusCode,
                        SortOrder = 3,
                        Visible = true,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "AccountCode",
                        ColumnLength = 140,
                        ColumnTitle = "Account Code",
                        ColumnType = ColumnType.String,
                        SortOrder = 4,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "AccountName",
                        ColumnLength = 150,
                        ColumnTitle = "Account Name",
                        ColumnType = ColumnType.String,
                        SortOrder = 5,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "CustomerName",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Name",
                        ColumnType = ColumnType.String,
                        SortOrder = 5,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Description",
                        ColumnLength = 140,
                        ColumnTitle = "Description",
                        ColumnType = ColumnType.String,
                        SortOrder = 6,
                        Visible = true,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalAmount",
                        ColumnLength = 150,
                        ColumnTitle = "Total Amount",
                        ColumnType = ColumnType.Money,
                        SortOrder = 7,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                    new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalPaid",
                        ColumnLength = 150,
                        ColumnTitle = "Total Paid",
                        ColumnType = ColumnType.Money,
                        SortOrder = 8,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                    new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Balance",
                        ColumnLength = 150,
                        ColumnTitle = "Balance",
                        ColumnType = ColumnType.Money,
                        SortOrder = 9,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                    new CollumnOutput
                    {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "LastPaymentDate",
                        ColumnLength = 180,
                        ColumnTitle = "Last Payment Date",
                        ColumnType = ColumnType.Date,
                        SortOrder = 10,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput
                    {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Aging",
                        ColumnLength = 90,
                        ColumnTitle = "Aging",
                        ColumnType = ColumnType.Number,
                        SortOrder = 11,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },

                        new CollumnOutput
                    {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "LastPaymentAmounts",
                        ColumnLength = 190,
                        ColumnTitle = "Last Payment Amount",
                        ColumnType = ColumnType.Money,
                        SortOrder = 17,
                        Visible = true,
                        AllowFunction = "Sum",
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                       new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalAmounts",
                        ColumnLength = 150,
                        ColumnTitle = "Total Amounts",
                        ColumnType = ColumnType.Money,
                        SortOrder = 18,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                       new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalPaids",
                        ColumnLength = 150,
                        ColumnTitle = "Total Paids",
                        ColumnType = ColumnType.Money,
                        SortOrder =19,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                       new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Balances",
                        ColumnLength = 150,
                        ColumnTitle = "Balances",
                        ColumnType = ColumnType.Money,
                        SortOrder = 20,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },

                    new CollumnOutput
                    {
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "User",
                        ColumnLength = 140,
                        ColumnTitle = "User",
                        ColumnType = ColumnType.String,
                        SortOrder = 21,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Location",
                        ColumnLength = 150,
                        ColumnTitle = "Location",
                        ColumnType = ColumnType.String,
                        SortOrder = 12,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                     new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "CustomerType",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 13,
                        Visible = true,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                     new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "OpeningBalance",
                        ColumnLength = 300,
                        ColumnTitle = "Opening Balance",
                        ColumnType = ColumnType.Array,
                        SortOrder = 14,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = false,
                        DefaultValue = Convert.ToInt32(OpeningBalanceStatus.All).ToString(),
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                },
                Groupby = "",
                HeaderTitle = "Customer By Invoice",
                Sortby = "",
            };


            if (!FeatureChecker.IsEnabled(AppFeatures.AccountingFeature))
            {
                result.ColumnInfo = result.ColumnInfo.Where(s =>
                    s.ColumnName != "Account" &&
                    s.ColumnName != "AccountType" &&
                    s.ColumnName != "AccountCode" &&
                    s.ColumnName != "AccountName").ToList();
            }

            if (IsMultiCurrency.Any())
            {
                var currency = new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Currency",
                    ColumnLength = 140,
                    ColumnTitle = "Currency",
                    ColumnType = ColumnType.String,
                    SortOrder = 6,
                    Visible = false,
                    IsDisplay = true,
                    DisableDefault = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                };
                result.ColumnInfo.Add(currency);
            }
            result.ColumnInfo = result.ColumnInfo.OrderBy(t => t.SortOrder).ToList();
            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_Customer_CustomerByInvoice_Export_Excel)]
        public async Task<FileDto> ExportExcelCustomerByInvoiceReport(GetCustomerAgingReportInput input)
        {
            input.UsePagination = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var entity = (await GetCustomerByInvoiceReport(input)).Items;

            var result = new FileDto();


            var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies;
            var firstRow = entity.FirstOrDefault();
            var currencyCodes = firstRow == null ? new List<string>() : firstRow.TotalColsByCurency.Select(s => s.CurrencyCode).ToList();


            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString("dd-MM-yyyy");
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2


                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    if (isMultiCurrencies && i.AllowFunction != null && currencyCodes.Any())
                    {
                        AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                        ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                        MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader, colHeaderTable + currencyCodes.Count() - 1, ExcelHorizontalAlignment.Center, ExcelVerticalAlignment.Center);

                        foreach (var subCol in currencyCodes)
                        {
                            AddTextToCell(ws, rowTableHeader + 1, colHeaderTable, subCol, true);
                            ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength / currencyCodes.Count());
                            colHeaderTable += 1;
                        }
                    }
                    else
                    {
                        AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                        ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                        if (isMultiCurrencies) MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader + 1, colHeaderTable, ExcelHorizontalAlignment.Center, ExcelVerticalAlignment.Center);
                        colHeaderTable += 1;
                    }
                }

                if (isMultiCurrencies) rowTableHeader++;

                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();

                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                // write body

                var groupBy = new List<GetListCustomerByInvoiceReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Customer":
                            groupBy = entity
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListCustomerByInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                    }
                }
                // write body

                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0)
                {
                    foreach (var k in groupBy)
                    {
                        //key group by name
                        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                        rowBody += 1;
                        count = 1;
                        //list of item
                        foreach (var i in k.Items)
                        {
                            int collumnCellBody = 1;
                            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                            {
                                if (isMultiCurrencies && item.AllowFunction != null)
                                {
                                    foreach (var subCol in currencyCodes)
                                    {
                                        var model = (GetCustomerByInvoiceReportOutputItemByCurrency)i.TotalColsByCurency.FirstOrDefault(s => s.CurrencyCode == subCol);
                                        var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);
                                        var value = cellValue ?? 0;

                                        AddCellValue(ws, rowBody, collumnCellBody, item, value);

                                        collumnCellBody += 1;
                                    }
                                }
                                else
                                {

                                    var value = i.GetType().GetProperty(item.ColumnName)?.GetValue(i, null);

                                    if (value != null && value is UserDto) value = ((UserDto)value).UserName;

                                    AddCellValue(ws, rowBody, collumnCellBody, item, value);

                                    collumnCellBody += 1;
                                }

                            }
                            rowBody += 1;
                            count += 1;
                        }

                        //sub total of group by item
                        int collumnCellGroupBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (item.AllowFunction != null)
                            {
                                if (isMultiCurrencies)
                                {
                                    foreach (var subCol in currencyCodes)
                                    {
                                        var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                        var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);

                                        var keyCol = item.ColumnName + "-" + subCol;

                                        if (footerGroupDict.ContainsKey(keyCol))
                                        {
                                            footerGroupDict[keyCol] += fromCell + ":" + toCell + ",";
                                        }
                                        else
                                        {
                                            footerGroupDict.Add(keyCol, fromCell + ":" + toCell + ",");
                                        }

                                        AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);



                                        collumnCellGroupBody += 1;
                                    }


                                    collumnCellGroupBody--;
                                }
                                else
                                {
                                    var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                    var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);

                                    var subCol = currencyCodes.FirstOrDefault();

                                    var keyCol = item.ColumnName + "-" + subCol;

                                    if (footerGroupDict.ContainsKey(keyCol))
                                    {
                                        footerGroupDict[keyCol] += fromCell + ":" + toCell + ",";
                                    }
                                    else
                                    {
                                        footerGroupDict.Add(keyCol, fromCell + ":" + toCell + ",");
                                    }


                                    AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }
                            }
                            collumnCellGroupBody += 1;
                        }
                        rowBody += 1;
                    }
                }
                else
                {
                    foreach (var i in entity)
                    {
                        int collumnCellBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (isMultiCurrencies && item.AllowFunction != null)
                            {
                                foreach (var subCol in currencyCodes)
                                {
                                    var cell = i.TotalColsByCurency.FirstOrDefault(s => s.CurrencyCode == subCol);
                                    var value = cell.GetType().GetProperty(item.ColumnName).GetValue(cell, null);

                                    AddCellValue(ws, rowBody, collumnCellBody, item, value);

                                    collumnCellBody += 1;
                                }
                            }
                            else
                            {

                                var value = i.GetType().GetProperty(item.ColumnName)?.GetValue(i, null);
                                AddCellValue(ws, rowBody, collumnCellBody, item, value);

                                collumnCellBody += 1;
                            }

                        }
                        rowBody += 1;
                        count += 1;
                    }
                }
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (footerGroupDict.Any())
                            {
                                if (isMultiCurrencies)
                                {
                                    foreach (var subCol in currencyCodes)
                                    {
                                        var sumRanges = footerGroupDict[i.ColumnName + "-" + subCol];

                                        if (i.ColumnType == ColumnType.Number)
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")", true, false, true);
                                        }
                                        else
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")", true);
                                        }

                                        footerColNumber += 1;
                                    }

                                    footerColNumber--;
                                }
                                else
                                {

                                    var subCol = currencyCodes.FirstOrDefault();
                                    var sumRanges = footerGroupDict[i.ColumnName + "-" + subCol];

                                    if (i.ColumnType == ColumnType.Number)
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")", true, false, true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")", true);
                                    }
                                }
                            }
                            else
                            {
                                int rowFooter = rowTableHeader + 1;// get start row after header 
                                var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }
                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"CustomerByInvoice_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_Customer_CustomerByInvoice_Export_Pdf)]
        public async Task<FileDto> ExportPDFCustomerByInvoiceReport(GetCustomerAgingReportInput input)
        {
            input.UsePagination = false;
            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                            .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                            .Select(t => t.Web).FirstOrDefaultAsync();
            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }
            var digit = (await GetCurrentCycleAsync()).RoundingDigit;
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();

            var sheetName = report.HeaderTitle;
            var minusSubLength = 1;
            var entity = await GetCustomerByInvoiceReport(input);
            var user = await GetCurrentUserAsync();
            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;
                var contentBody = string.Empty;
                var contentHeader = string.Empty;
                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                var multiCurrencyHeader = input.CurrencyFilter == CurrencyFilter.MultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";
                            if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies && entity.TotalResults.ContainsKey(i.ColumnName))
                            {
                                var index = 0;
                                var subColWidth = Convert.ToInt32(i.ColumnLength / entity.TotalResults[i.ColumnName].Count());
                                rowHeader = $"<th colspan='{entity.TotalResults[i.ColumnName].Count()}' style='width:{i.ColumnLength}px;'>{i.ColumnTitle}</th>";
                                foreach (var subHeader in entity.TotalResults[i.ColumnName])
                                {
                                    if (index > 0) reportCountColHead++;
                                    multiCurrencyHeader += $"<th style='width: {subColWidth}px;'>{subHeader.Key}</th>";
                                    index++;
                                }
                            }
                            else
                            {
                                rowHeader = $"<th rowspan='2' width='{i.ColumnLength}'px>{i.ColumnTitle}</th>";
                            }
                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }
                multiCurrencyHeader += input.CurrencyFilter == CurrencyFilter.MultiCurrencies ? $"</tr>" : "";

                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                var groupBy = new List<GetListCustomerByInvoiceReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Customer":
                            groupBy = entity.Items
                                .GroupBy(t => t.CustomerCode)
                                .Select(t => new GetListCustomerByInvoiceReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }
                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0) //write body have group by
                {
                    var item = viewHeader;
                    foreach (var k in groupBy)
                    {
                        var headerGroup = "<tr valign='top' style='font-weight: bold; page-break-inside:avoid;'><td colspan=" + reportCountColHead + "> " + k.KeyName + " </td></tr>";
                        contentBody += headerGroup;
                        foreach (var row in k.Items)
                        {
                            var tr = "<tr style='page-break-inside:avoid;'  valign='top'>";
                            foreach (var i in viewHeader)
                            {
                                if (i.Visible)
                                {
                                    if (i.ColumnName == "Date")
                                    {
                                        tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "JournalNo")
                                    {
                                        tr += $"<td>{row.JournalNo}</td>";
                                    }
                                    else if (i.ColumnName == "Reference")
                                    {
                                        tr += $"<td>{row.Reference}</td>";
                                    }
                                    else if (i.ColumnName == "JournalType")
                                    {
                                        tr += $"<td>{row.JournalType.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "AccountCode")
                                    {
                                        tr += $"<td>{row.AccountCode}</td>";
                                    }
                                    else if (i.ColumnName == "AccountName")
                                    {
                                        tr += $"<td>{row.AccountName}</td>";
                                    }
                                    else if (i.ColumnName == "CustomerName")
                                    {
                                        tr += $"<td>{row.CustomerName}</td>";
                                    }
                                    else if (i.ColumnName == "Description")
                                    {
                                        tr += $"<td>{row.Description}</td>";
                                    }
                                    else if (i.ColumnName == "TotalAmount")
                                    {
                                        tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.TotalAmount, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "TotalPaid")
                                    {
                                        tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.TotalPaid, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "Balance")
                                    {
                                        tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.Balance, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "LastPaymentDate")
                                    {
                                        var dv = row.LastPaymentDate != null ? row.LastPaymentDate.Value.ToString(formatDate) : null;
                                        tr += $"<td>{dv}</td>";
                                    }
                                    else if (i.ColumnName == "Aging")
                                    {
                                        tr += $"<td style='text-align: right;'>{row.Aging}</td>";
                                    }
                                    else if (i.ColumnName == "LastPaymentAmount")
                                    {
                                        tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.LastPaymentAmounts, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "User")
                                    {
                                        tr += $"<td>{row.User}</td>";
                                    }
                                    else if (i.ColumnName == "Location")
                                    {
                                        tr += $"<td>{row.Location}</td>";
                                    }
                                    else if (i.ColumnName == "Currency")
                                    {
                                        tr += $"<td>{row.Currency.Code}</td>";
                                    }
                                    else if ((i.ColumnName == "LastPaymentAmounts" || i.ColumnName == "Balances"
                                            || i.ColumnName == "TotalPaids" || i.ColumnName == "TotalAmounts")
                                            && input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                    {
                                        if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)//Multi currency 
                                        {
                                            if (entity.TotalResults.ContainsKey(i.ColumnName))
                                            {
                                                var subColWidth = Convert.ToInt32(i.ColumnLength / entity.TotalResults[i.ColumnName].Count());

                                                foreach (var code in entity.TotalResults[i.ColumnName])
                                                {
                                                    tr += $"<td style='text-align: right; width: {subColWidth}px;'>";

                                                    var sub = row.TotalColsByCurency.Where(t => t.CurrencyCode == code.Key).FirstOrDefault();
                                                    if (i.ColumnName == "LastPaymentAmounts")
                                                    {
                                                        tr += $"{FormatNumberCurrency(Math.Round(sub.LastPaymentAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "Balances")
                                                    {
                                                        tr += $"{FormatNumberCurrency(Math.Round(sub.Balances, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "TotalPaids")
                                                    {
                                                        tr += $"{FormatNumberCurrency(Math.Round(sub.TotalPaids, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "TotalAmounts")
                                                    {
                                                        tr += $"{FormatNumberCurrency(Math.Round(sub.TotalAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    tr += "</td>";
                                                }

                                            }
                                        }

                                    }
                                    else
                                    {
                                        tr += $"<td></td>";
                                    }

                                }
                            }
                            tr += "</tr>";
                            contentBody += tr;
                        }
                        // sum footer 
                        var trGr = "<tr style='font-weight: bold; page-break-inside:avoid;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                                {
                                    if (i.ColumnName == "TotalAmount")
                                    {
                                        trGr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.TotalAmount), digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "TotalPaid")
                                    {
                                        trGr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.TotalPaid), digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "Balance")
                                    {
                                        trGr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.Balance), digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    //else if (i.month == "LastPaymentAmount")
                                    //{
                                    //    trGr += $"<td>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.LastPaymentAmounts), digit, MidpointRounding.ToEven),digit)}</td>";
                                    //}
                                    else if ((i.ColumnName == "LastPaymentAmounts" || i.ColumnName == "Balances"
                                            || i.ColumnName == "TotalPaids" || i.ColumnName == "TotalAmounts")
                                            && input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                    {
                                        if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)//Multi currency 
                                        {
                                            //trGr += $"<td>";
                                            if (entity.TotalResults.ContainsKey(i.ColumnName))
                                            {

                                                var sumList = k.Items.SelectMany(u => u.TotalColsByCurency).Select(u => u).ToList();
                                                var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                                                {
                                                    CurrencyCode = u.Key,
                                                    TotalPaid = u.Sum(s => s.TotalPaids),
                                                    TotalAmount = u.Sum(s => s.TotalAmounts),
                                                    Balance = u.Sum(s => s.Balances),
                                                    LastPaymentAmounts = u.Sum(s => s.LastPaymentAmounts)

                                                }).ToDictionary(u => u.CurrencyCode);

                                                foreach (var code in entity.TotalResults[i.ColumnName])
                                                {
                                                    trGr += $"<td style='text-align: right;'>";

                                                    //var sub = k.Items.Where(t => t.CurrencyCode == code.Key).FirstOrDefault();
                                                    if (i.ColumnName == "LastPaymentAmounts" && groupByCurrencyDict.ContainsKey(code.Key))
                                                    {
                                                        trGr += $"{FormatNumberCurrency(Math.Round(groupByCurrencyDict[code.Key].LastPaymentAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "Balances" && groupByCurrencyDict.ContainsKey(code.Key))
                                                    {
                                                        trGr += $"{FormatNumberCurrency(Math.Round(groupByCurrencyDict[code.Key].Balance, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "TotalPaids" && groupByCurrencyDict.ContainsKey(code.Key))
                                                    {
                                                        trGr += $"{FormatNumberCurrency(Math.Round(groupByCurrencyDict[code.Key].TotalPaid, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "TotalAmounts" && groupByCurrencyDict.ContainsKey(code.Key))
                                                    {
                                                        trGr += $"{FormatNumberCurrency(Math.Round(groupByCurrencyDict[code.Key].TotalAmount, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    trGr += "</td>";
                                                }
                                            }
                                            //trGr += "</td>";
                                        }

                                    }
                                    else
                                    {
                                        trGr += $"<td></td>";
                                    }
                                }
                                else //none sum
                                {
                                    trGr += $"<td></td>";
                                }

                            }
                        }
                        contentBody += trGr;
                    }
                }
                else // write body no group by
                {
                    foreach (var row in entity.Items)
                    {
                        var tr = "<tr style='page-break-inside:avoid;'  valign='top'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "Date")
                                {
                                    tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "JournalNo")
                                {
                                    tr += $"<td>{row.JournalNo}</td>";
                                }
                                else if (i.ColumnName == "Reference")
                                {
                                    tr += $"<td>{row.Reference}</td>";
                                }
                                else if (i.ColumnName == "JournalType")
                                {
                                    tr += $"<td>{row.JournalType.ToString()}</td>";
                                }
                                else if (i.ColumnName == "AccountCode")
                                {
                                    tr += $"<td>{row.AccountCode}</td>";
                                }
                                else if (i.ColumnName == "AccountName")
                                {
                                    tr += $"<td>{row.AccountName}</td>";
                                }
                                else if (i.ColumnName == "CustomerName")
                                {
                                    tr += $"<td>{row.CustomerName}</td>";
                                }
                                else if (i.ColumnName == "Description")
                                {
                                    tr += $"<td>{row.Description}</td>";
                                }
                                else if (i.ColumnName == "TotalAmount")
                                {
                                    tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.TotalAmount, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "TotalPaid")
                                {
                                    tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.TotalPaid, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "Balance")
                                {
                                    tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.Balance, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "LastPaymentDate")
                                {
                                    var dv = row.LastPaymentDate != null ? row.LastPaymentDate.Value.ToString(formatDate) : null;
                                    tr += $"<td>{dv}</td>";
                                }
                                else if (i.ColumnName == "Aging")
                                {
                                    tr += $"<td style='text-align: right;'>{row.Aging}</td>";
                                }
                                else if (i.ColumnName == "LastPaymentAmounts" && input.CurrencyFilter == CurrencyFilter.AccountingCurrency)
                                {
                                    tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.LastPaymentAmounts, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "User")
                                {
                                    tr += $"<td>{row.User}</td>";
                                }
                                else if (i.ColumnName == "Location")
                                {
                                    tr += $"<td>{row.Location}</td>";
                                }
                                else if (i.ColumnName == "Currency")
                                {
                                    tr += $"<td>{row.Currency.Code}</td>";
                                }
                                else if ((i.ColumnName == "LastPaymentAmounts" || i.ColumnName == "Balances"
                                        || i.ColumnName == "TotalPaids" || i.ColumnName == "TotalAmounts")
                                        && input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                {
                                    if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)//Multi currency 
                                    {
                                        //tr += $"<td>";
                                        if (entity.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var code in entity.TotalResults[i.ColumnName])
                                            {
                                                tr += $"<td style='text-align: right;'>";

                                                var sub = row.TotalColsByCurency.Where(t => t.CurrencyCode == code.Key).FirstOrDefault();
                                                if (i.ColumnName == "LastPaymentAmounts")
                                                {
                                                    tr += $"{FormatNumberCurrency(Math.Round(sub.LastPaymentAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                }
                                                else if (i.ColumnName == "Balances")
                                                {
                                                    tr += $"{FormatNumberCurrency(Math.Round(sub.Balances, digit, MidpointRounding.ToEven), digit)}";
                                                }
                                                else if (i.ColumnName == "TotalPaids")
                                                {
                                                    tr += $"{FormatNumberCurrency(Math.Round(sub.TotalPaids, digit, MidpointRounding.ToEven), digit)}";
                                                }
                                                else if (i.ColumnName == "TotalAmounts")
                                                {
                                                    tr += $"{FormatNumberCurrency(Math.Round(sub.TotalAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                }
                                                tr += "</td>";
                                            }
                                        }
                                        //tr += "</td>";
                                    }

                                }
                                else
                                {
                                    tr += $"<td></td>";
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }

                #endregion Row Body


                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr valign='top' style='page-break-inside:avoid;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (!string.IsNullOrEmpty(i.AllowFunction) && entity.TotalResults.ContainsKey(i.ColumnName))
                            {
                                if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                {
                                    //tr += $"<td>";
                                    foreach (var code in entity.TotalResults[i.ColumnName])
                                    {
                                        tr += $"<td style='text-align: right;'>";
                                        var sub = entity.TotalResults[i.ColumnName][code.Key];
                                        tr += $"{FormatNumberCurrency(Math.Round(sub, digit, MidpointRounding.ToEven), digit)}";
                                        tr += "</td>";
                                    }
                                    //tr += "</td>";
                                }
                                else
                                {
                                    tr += $"<td style='word-wrap:break-word;text-align: right;'>";
                                    foreach (var code in entity.TotalResults[i.ColumnName])
                                    {
                                        var sub = entity.TotalResults[i.ColumnName][code.Key];
                                        tr += $"{FormatNumberCurrency(Math.Round(sub, digit, MidpointRounding.ToEven), digit)}";

                                    }
                                    tr += "</td>";

                                }

                            }
                            else //none sum
                            {
                                if (index == 0)
                                {
                                    tr += $"<td style='font-weight: bold;'>{L("Total")}</td>";
                                }
                                else
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{subHeader}}", multiCurrencyHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);

                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{ReplaceSpecialCharacter(sheetName)}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });

        }


        #endregion


        #region Customer By Invoice With Payment Report 
        public ReportOutput GetReportTemplateCustomerByInvoiceWithPayment()
        {

            var IsMultiCurrency = _multiCurrencyRepository.GetAll();
            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = new List<CollumnOutput>() {
                     // start properties with can filter
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DateRange",
                        ColumnLength = 150,
                        ColumnTitle = "DateRange",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        DefaultValue = "thisMonth",
                        AllowFunction = null,
                        DisableDefault = false,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "AccountType",
                        ColumnLength = 300,
                        ColumnTitle = "AccountType",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Account",
                        ColumnLength = 300,
                        ColumnTitle = "Account",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Customer",
                        ColumnLength = 300,
                        ColumnTitle = "Customer",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        DefaultValue = "Customer",
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "JournalType",
                        ColumnLength = 300,
                        ColumnTitle = "JournalType",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },//End Of filter
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Date",
                        ColumnLength = 130,
                        ColumnTitle = "Date",
                        ColumnType = ColumnType.Date,
                        SortOrder = 1,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "JournalNo",
                        ColumnLength = 140,
                        ColumnTitle = "Journal No",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "JournalType",
                        ColumnLength = 140,
                        ColumnTitle = "Journal Type",
                        ColumnType = ColumnType.StatusCode,
                        SortOrder = 3,
                        Visible = true,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "AccountCode",
                        ColumnLength = 140,
                        ColumnTitle = "Account Code",
                        ColumnType = ColumnType.String,
                        SortOrder = 4,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "AccountName",
                        ColumnLength = 150,
                        ColumnTitle = "Account Name",
                        ColumnType = ColumnType.String,
                        SortOrder = 5,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "CustomerName",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Name",
                        ColumnType = ColumnType.String,
                        SortOrder = 5,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Description",
                        ColumnLength = 140,
                        ColumnTitle = "Description",
                        ColumnType = ColumnType.String,
                        SortOrder = 6,
                        Visible = true,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalAmount",
                        ColumnLength = 150,
                        ColumnTitle = "Total Amount",
                        ColumnType = ColumnType.Money,
                        SortOrder = 7,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                    new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalPaid",
                        ColumnLength = 150,
                        ColumnTitle = "Total Paid",
                        ColumnType = ColumnType.Money,
                        SortOrder = 8,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                    new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Balance",
                        ColumnLength = 150,
                        ColumnTitle = "Balance",
                        ColumnType = ColumnType.Money,
                        SortOrder = 9,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },

                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalAmounts",
                        ColumnLength = 150,
                        ColumnTitle = "Total Amounts",
                        ColumnType = ColumnType.Money,
                        SortOrder = 18,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                    new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalPaids",
                        ColumnLength = 150,
                        ColumnTitle = "Total Paids",
                        ColumnType = ColumnType.Money,
                        SortOrder =19,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },
                    new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Balances",
                        ColumnLength = 150,
                        ColumnTitle = "Balances",
                        ColumnType = ColumnType.Money,
                        SortOrder = 20,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                    },

                    new CollumnOutput
                    {
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "User",
                        ColumnLength = 140,
                        ColumnTitle = "User",
                        ColumnType = ColumnType.String,
                        SortOrder = 21,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Location",
                        ColumnLength = 150,
                        ColumnTitle = "Location",
                        ColumnType = ColumnType.String,
                        SortOrder = 12,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "CustomerType",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 13,
                        Visible = true,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "OpeningBalance",
                        ColumnLength = 300,
                        ColumnTitle = "Opening Balance",
                        ColumnType = ColumnType.Array,
                        SortOrder = 14,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = false,
                        DefaultValue = Convert.ToInt32(OpeningBalanceStatus.All).ToString(),
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                     new CollumnOutput
                    {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Reference",
                        ColumnLength = 200,
                        ColumnTitle = "Reference",
                        ColumnType = ColumnType.String,
                        SortOrder = 22,
                        Visible = true,
                        IsDisplay = true,
                        DisableDefault = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                },
                Groupby = "",
                HeaderTitle = "AR by Invoice with Payment",
                Sortby = "",
            };


            if (!FeatureChecker.IsEnabled(AppFeatures.AccountingFeature))
            {
                result.ColumnInfo = result.ColumnInfo.Where(s =>
                    s.ColumnName != "Account" &&
                    s.ColumnName != "AccountType" &&
                    s.ColumnName != "AccountCode" &&
                    s.ColumnName != "AccountName").ToList();
            }

            if (IsMultiCurrency.Any())
            {
                var currency = new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Currency",
                    ColumnLength = 140,
                    ColumnTitle = "Currency",
                    ColumnType = ColumnType.String,
                    SortOrder = 6,
                    Visible = false,
                    IsDisplay = true,
                    DisableDefault = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                };
                result.ColumnInfo.Add(currency);
            }
            result.ColumnInfo = result.ColumnInfo.OrderBy(t => t.SortOrder).ToList();
            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_Customer_CustomerByInvoiceWithPayment)]
        public async Task<PagedResultWithTotalColuumnsDto<GetCustomerByInvoiceWithPaymentReportOutput>> GetCustomerByInvoiceWithPaymentReport(GetListCustomerAgingInput input)
        {

            var filterByAccountingCurrency = input.CurrencyFilter != CurrencyFilter.MultiCurrencies;

            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();
            var customerTypes = input.CustomerTypes;
            if (customerTypeMemberIds.Any())
            {
                customerTypes = customerTypeMemberIds.WhereIf(input.CustomerTypes != null && input.CustomerTypes.Any(), s => input.CustomerTypes.Contains(s)).ToList();
            }

            var newPeriodBillInvoiceResult = _customerManager.GetInvoiceAndCreditBalanceWithPaymentQuery(AbpSession.GetUserId(),
                                                            input.FromDate,
                                                            input.ToDate, input.Filter, input.Customers,
                                                            input.Accounts, input.JournalType,
                                                            input.AccountTypes, input.Users, input.CurrencyFilter,
                                                            input.Locations,
                                                            customerTypes);

            //get all currencies from both query
            var currencyCodes = (await newPeriodBillInvoiceResult
                                       .Select(s => s.Currency.Code).GroupBy(u => u).Select(u => u.Key).ToListAsync()).OrderBy(r => r);


            //Generate currency columns
            var newPeriodBillInvoices = newPeriodBillInvoiceResult.Select(i => new GetCustomerByInvoiceWithPaymentReportOutput
            {
                CreationTimeIndex = i.CreationTimeIndex,
                User = i.User,
                TransactionId = i.TransactionId,
                CustomerId = i.CustomerId,
                CustomerCode = i.CustomerCode,
                CustomerName = i.CustomerName,
                Date = i.Date,
                AccountCode = i.AccountCode,
                AccountName = i.AccountName,
                Balance = i.Balance,
                Description = i.Description,
                JournalNo = i.JournalNo,
                Reference = i.Reference,
                PaymentReference = i.PaymentReference,
                JournalType = i.JournalType,
                TotalAmount = i.TotalAmount,
                TotalPaid = i.TotalPaid,
                Currency = i.Currency,
                Location = i.Location,
                TotalColsByCurency = currencyCodes.Select(u => new GetCustomerByInvoiceReportOutputItemByCurrency()
                {
                    CurrencyCode = u,
                    TotalAmounts = u == i.Currency.Code ? i.TotalAmount : 0,
                    TotalPaids = u == i.Currency.Code ? i.TotalPaid : 0,
                    Balances = u == i.Currency.Code ? i.Balance : 0,

                }).ToList(),
                PaymentItems = i.PaymentItems
            });

            var finalList = newPeriodBillInvoices
                            .WhereIf(input.OpeningBalance != OpeningBalanceStatus.All, s =>
                               (input.OpeningBalance == OpeningBalanceStatus.Opening && s.Balance != 0) ||
                               (input.OpeningBalance == OpeningBalanceStatus.Zero && s.Balance == 0)
                             )
                            .OrderBy(u => u.CustomerCode).ThenBy(u => u.Date.Date).ThenBy(t => t.CreationTimeIndex);

            var resultCount = 0;
            if (input.IsLoadMore == false)
            {
                resultCount = await finalList.CountAsync();
            }
            var @entities = new List<GetCustomerByInvoiceWithPaymentReportOutput>();
            var sumOfColumns = new Dictionary<string, decimal>();

            var multiCurrencySumOfColumns = new Dictionary<string, Dictionary<string, decimal>>();

            if (resultCount == 0 && !input.IsLoadMore)
            {
                return new PagedResultWithTotalColuumnsDto<GetCustomerByInvoiceWithPaymentReportOutput>(resultCount, @entities, multiCurrencySumOfColumns);
            }

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                var sumList = await finalList.SelectMany(u => u.TotalColsByCurency).Select(u => u).ToListAsync();
                var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                {
                    CurrencyCode = u.Key,
                    TotalPaid = u.Sum(s => s.TotalPaids),
                    TotalAmount = u.Sum(s => s.TotalAmounts),
                    //Balance = u.Sum(s => s.Balances),
                    LastPaymentAmounts = u.Sum(s => s.LastPaymentAmounts)

                }).ToDictionary(u => u.CurrencyCode);

                foreach (var col in input.ColumnNamesToSum)
                {
                    foreach (var cCode in currencyCodes)
                    {
                        if (col == "TotalPaid" || col == "TotalPaids")
                        {
                            sumOfColumns.Add(cCode, groupByCurrencyDict.ContainsKey(cCode) ? groupByCurrencyDict[cCode].TotalPaid : 0);
                        }
                        else if (col == "TotalAmount" || col == "TotalAmounts")
                        {
                            sumOfColumns.Add(cCode, groupByCurrencyDict.ContainsKey(cCode) ? groupByCurrencyDict[cCode].TotalAmount : 0);
                        }
                        else if (col == "Balance" || col == "Balances")
                        {
                            var totalAmount = groupByCurrencyDict.ContainsKey(cCode) ? groupByCurrencyDict[cCode].TotalAmount : 0;
                            var totalPaid = groupByCurrencyDict.ContainsKey(cCode) ? groupByCurrencyDict[cCode].TotalPaid : 0;
                            var balance = totalAmount - totalPaid;

                            sumOfColumns.Add(cCode, balance);

                        }
                        else if (col == "LastPaymentAmounts")
                        {
                            sumOfColumns.Add(cCode, groupByCurrencyDict.ContainsKey(cCode) ? groupByCurrencyDict[cCode].LastPaymentAmounts : 0);
                        }

                    }

                    if (!multiCurrencySumOfColumns.ContainsKey(col))
                    {
                        multiCurrencySumOfColumns.Add(col, sumOfColumns);
                    }
                    else
                    {
                        multiCurrencySumOfColumns[col] = sumOfColumns;
                    }

                    sumOfColumns = new Dictionary<string, decimal>();

                }
            }

            var orderKey = input.Sorting;
            if (!input.GroupBy.IsNullOrWhiteSpace())
            {
                orderKey = "CustomerCode";
            }

            if (input.UsePagination == true)
            {
                @entities = await finalList.OrderBy(orderKey).ThenBy(s => s.CreationTimeIndex).Skip(input.SkipCount).Take(input.MaxResultCount).ToListAsync();
            }
            else
            {
                @entities = await finalList.OrderBy(orderKey).ThenBy(s => s.CreationTimeIndex).ToListAsync();
            }


            return new PagedResultWithTotalColuumnsDto<GetCustomerByInvoiceWithPaymentReportOutput>(resultCount, @entities, multiCurrencySumOfColumns);


        }


        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_Customer_CustomerByInvoiceWithPayment_Export_Excel)]
        public async Task<FileDto> ExportExcelCustomerByInvoiceWithPaymentReport(GetCustomerAgingReportInput input)
        {
            input.UsePagination = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var entity = (await GetCustomerByInvoiceWithPaymentReport(input)).Items;

            var result = new FileDto();


            var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies;
            var firstRow = entity.FirstOrDefault();
            var currencyCodes = firstRow == null ? new List<string>() : firstRow.TotalColsByCurency.Select(s => s.CurrencyCode).ToList();


            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString("dd-MM-yyyy");
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2


                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    if (isMultiCurrencies && i.AllowFunction != null && currencyCodes.Any())
                    {
                        AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                        ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                        MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader, colHeaderTable + currencyCodes.Count() - 1, ExcelHorizontalAlignment.Center, ExcelVerticalAlignment.Center);

                        foreach (var subCol in currencyCodes)
                        {
                            AddTextToCell(ws, rowTableHeader + 1, colHeaderTable, subCol, true);
                            ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength / currencyCodes.Count());
                            colHeaderTable += 1;
                        }
                    }
                    else
                    {
                        AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                        ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                        if (isMultiCurrencies) MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader + 1, colHeaderTable, ExcelHorizontalAlignment.Center, ExcelVerticalAlignment.Center);
                        colHeaderTable += 1;
                    }
                }

                if (isMultiCurrencies) rowTableHeader++;

                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();

                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                // write body

                var groupBy = new List<GetListCustomerByInvoiceWithPaymentReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Customer":
                            groupBy = entity
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListCustomerByInvoiceWithPaymentReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                    }
                }
                // write body

                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0)
                {
                    foreach (var k in groupBy)
                    {
                        //key group by name
                        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                        rowBody += 1;
                        count = 1;
                        //list of item
                        foreach (var i in k.Items)
                        {
                            int collumnCellBody = 1;
                            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                            {
                                if (isMultiCurrencies && item.AllowFunction != null)
                                {
                                    foreach (var subCol in currencyCodes)
                                    {
                                        var model = (GetCustomerByInvoiceReportOutputItemByCurrency)i.TotalColsByCurency.FirstOrDefault(s => s.CurrencyCode == subCol);
                                        var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);
                                        var value = cellValue ?? 0;

                                        AddCellValue(ws, rowBody, collumnCellBody, item, value);

                                        collumnCellBody += 1;
                                    }
                                }
                                else
                                {

                                    var value = i.GetType().GetProperty(item.ColumnName)?.GetValue(i, null);

                                    if (value != null && value is UserDto) value = ((UserDto)value).UserName;

                                    AddCellValue(ws, rowBody, collumnCellBody, item, value);

                                    collumnCellBody += 1;
                                }

                            }
                            rowBody += 1;
                            count += 1;

                            //map payment history
                            var payments = i.PaymentItems.Where(s => s.PaymentId.HasValue).ToList();
                            if (payments.Any())
                            {
                                foreach (var pay in payments)
                                {
                                    pay.Date = pay.PaymentDate.Value;
                                    pay.TotalAmount = 0;
                                    pay.Balance = 0;
                                    pay.JournalNo = pay.PaymentNo;
                                    pay.Reference = pay.PaymentReference;
                                    pay.User = pay.PaymentUserName;
                                    pay.JournalType = JournalType.ReceivePayment;
                                    pay.TotalColsByCurency = new List<GetCustomerByInvoiceReportOutputItemByCurrency>();

                                    foreach (var c in i.TotalColsByCurency)
                                    {
                                        var tc = new GetCustomerByInvoiceReportOutputItemByCurrency
                                        {
                                            TotalAmounts = 0,
                                            TotalPaids = c.CurrencyCode == pay.Currency.Code ? pay.TotalPaid : 0,
                                            Balances = 0,
                                            CurrencyCode = c.CurrencyCode,
                                        };

                                        pay.TotalColsByCurency.Add(tc);
                                    }


                                    int pcollumnCellBody = 1;
                                    foreach (var item in reportCollumnHeader)// map with correct key of properties 
                                    {
                                        if (isMultiCurrencies && item.AllowFunction != null)
                                        {
                                            foreach (var subCol in currencyCodes)
                                            {
                                                var model = (GetCustomerByInvoiceReportOutputItemByCurrency)pay.TotalColsByCurency.FirstOrDefault(s => s.CurrencyCode == subCol);
                                                var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);
                                                var value = cellValue ?? 0;

                                                AddCellValue(ws, rowBody, pcollumnCellBody, item, value);

                                                pcollumnCellBody += 1;
                                            }
                                        }
                                        else
                                        {

                                            var value = pay.GetType().GetProperty(item.ColumnName)?.GetValue(pay, null);

                                            if (value != null && value is UserDto) value = ((UserDto)value).UserName;

                                            AddCellValue(ws, rowBody, pcollumnCellBody, item, value);

                                            pcollumnCellBody += 1;
                                        }

                                    }

                                    rowBody += 1;
                                    count += 1;
                                }

                            }
                        }

                        //sub total of group by item
                        int collumnCellGroupBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (item.AllowFunction != null)
                            {
                                if (isMultiCurrencies)
                                {
                                    foreach (var subCol in currencyCodes)
                                    {
                                        var gCount = k.Items.Count + k.Items.SelectMany(s => s.PaymentItems.Where(f => f.PaymentId.HasValue)).Count();

                                        var fromCell = GetAddressName(ws, rowBody - gCount, collumnCellGroupBody);
                                        var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);

                                        var keyCol = item.ColumnName + "-" + subCol;

                                        if (footerGroupDict.ContainsKey(keyCol))
                                        {
                                            footerGroupDict[keyCol] += fromCell + ":" + toCell + ",";
                                        }
                                        else
                                        {
                                            footerGroupDict.Add(keyCol, fromCell + ":" + toCell + ",");
                                        }

                                        if (item.ColumnName == "TotalPaid" || item.ColumnName == "TotalPaids")
                                        {
                                            AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")/2", true);
                                        }
                                        else
                                        {
                                            AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                                        }

                                        collumnCellGroupBody += 1;
                                    }


                                    collumnCellGroupBody--;
                                }
                                else
                                {
                                    var gCount = k.Items.Count + k.Items.SelectMany(s => s.PaymentItems.Where(f => f.PaymentId.HasValue)).Count();

                                    var fromCell = GetAddressName(ws, rowBody - gCount, collumnCellGroupBody);
                                    var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);

                                    var subCol = currencyCodes.FirstOrDefault();

                                    var keyCol = item.ColumnName + "-" + subCol;

                                    if (footerGroupDict.ContainsKey(keyCol))
                                    {
                                        footerGroupDict[keyCol] += fromCell + ":" + toCell + ",";
                                    }
                                    else
                                    {
                                        footerGroupDict.Add(keyCol, fromCell + ":" + toCell + ",");
                                    }

                                    if (item.ColumnName == "TotalPaid" || item.ColumnName == "TotalPaids")
                                    {
                                        AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")/2", true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                                    }
                                }
                            }
                            collumnCellGroupBody += 1;
                        }
                        rowBody += 1;
                    }
                }
                else
                {
                    foreach (var i in entity)
                    {
                        int collumnCellBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (isMultiCurrencies && item.AllowFunction != null)
                            {
                                foreach (var subCol in currencyCodes)
                                {
                                    var cell = i.TotalColsByCurency.FirstOrDefault(s => s.CurrencyCode == subCol);
                                    var value = cell.GetType().GetProperty(item.ColumnName).GetValue(cell, null);

                                    AddCellValue(ws, rowBody, collumnCellBody, item, value);

                                    collumnCellBody += 1;
                                }
                            }
                            else
                            {

                                var value = i.GetType().GetProperty(item.ColumnName)?.GetValue(i, null);
                                AddCellValue(ws, rowBody, collumnCellBody, item, value);

                                collumnCellBody += 1;
                            }

                        }
                        rowBody += 1;
                        count += 1;


                        //map payment history
                        var payments = i.PaymentItems.Where(s => s.PaymentId.HasValue).ToList();
                        if (payments.Any())
                        {
                            foreach (var pay in payments)
                            {
                                pay.Date = pay.PaymentDate.Value;
                                pay.TotalAmount = 0;
                                pay.Balance = 0;
                                pay.JournalNo = pay.PaymentNo;
                                pay.User = pay.PaymentUserName;
                                pay.JournalType = JournalType.ReceivePayment;
                                pay.TotalColsByCurency = new List<GetCustomerByInvoiceReportOutputItemByCurrency>();

                                foreach (var c in i.TotalColsByCurency)
                                {
                                    var tc = new GetCustomerByInvoiceReportOutputItemByCurrency
                                    {
                                        TotalAmounts = 0,
                                        TotalPaids = c.CurrencyCode == pay.Currency.Code ? pay.TotalPaid : 0,
                                        Balances = 0,
                                        CurrencyCode = c.CurrencyCode,
                                    };

                                    pay.TotalColsByCurency.Add(tc);
                                }


                                int pcollumnCellBody = 1;
                                foreach (var item in reportCollumnHeader)// map with correct key of properties 
                                {
                                    if (isMultiCurrencies && item.AllowFunction != null)
                                    {
                                        foreach (var subCol in currencyCodes)
                                        {
                                            var model = (GetCustomerByInvoiceReportOutputItemByCurrency)pay.TotalColsByCurency.FirstOrDefault(s => s.CurrencyCode == subCol);
                                            var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);
                                            var value = cellValue ?? 0;

                                            AddCellValue(ws, rowBody, pcollumnCellBody, item, value);

                                            pcollumnCellBody += 1;
                                        }
                                    }
                                    else
                                    {

                                        var value = pay.GetType().GetProperty(item.ColumnName)?.GetValue(pay, null);

                                        if (value != null && value is UserDto) value = ((UserDto)value).UserName;

                                        AddCellValue(ws, rowBody, pcollumnCellBody, item, value);

                                        pcollumnCellBody += 1;
                                    }

                                }

                                rowBody += 1;
                                count += 1;
                            }

                        }

                    }
                }
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (isMultiCurrencies)
                            {
                                foreach (var subCol in currencyCodes)
                                {
                                    var sumRanges = footerGroupDict[i.ColumnName + "-" + subCol];

                                    int rowFooter = rowTableHeader + 1;// get start row after header 
                                    var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                    var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                    if (i.ColumnType == ColumnType.Number)
                                    {
                                        //AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);

                                        if (i.ColumnName == "TotalPaid" || i.ColumnName == "TotalPaids")
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")/2", true, false, true);
                                        }
                                        else
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")", true, false, true);
                                        }
                                    }
                                    else
                                    {
                                        //AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                        if (i.ColumnName == "TotalPaid" || i.ColumnName == "TotalPaids")
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")/2", true);
                                        }
                                        else
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")", true);
                                        }
                                    }

                                    footerColNumber += 1;
                                }

                                footerColNumber--;
                            }
                            else
                            {

                                var subCol = currencyCodes.FirstOrDefault();
                                var sumRanges = footerGroupDict[i.ColumnName + "-" + subCol];

                                int rowFooter = rowTableHeader + 1;// get start row after header 
                                var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    //AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                    if (i.ColumnName == "TotalPaid" || i.ColumnName == "TotalPaids")
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")/2", true, false, true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")", true, false, true);
                                    }
                                }
                                else
                                {
                                    //AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                    if (i.ColumnName == "TotalPaid" || i.ColumnName == "TotalPaids")
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")/2", true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + sumRanges + ")", true);
                                    }
                                }
                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"CustomerByInvoice_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_Customer_CustomerByInvoiceWithPayment_Export_Pdf)]
        public async Task<FileDto> ExportPDFCustomerByInvoiceWithPaymentReport(GetCustomerAgingReportInput input)
        {
            input.UsePagination = false;
            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                            .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                            .Select(t => t.Web).FirstOrDefaultAsync();
            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }
            var digit = (await GetCurrentCycleAsync()).RoundingDigit;
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();

            var sheetName = report.HeaderTitle;
            var minusSubLength = 1;
            var entity = await GetCustomerByInvoiceWithPaymentReport(input);
            var user = await GetCurrentUserAsync();
            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;
                var contentBody = string.Empty;
                var contentHeader = string.Empty;
                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                var multiCurrencyHeader = input.CurrencyFilter == CurrencyFilter.MultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";
                            if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies && entity.TotalResults.ContainsKey(i.ColumnName))
                            {
                                var index = 0;
                                var subColWidth = Convert.ToInt32(i.ColumnLength / entity.TotalResults[i.ColumnName].Count());
                                rowHeader = $"<th colspan='{entity.TotalResults[i.ColumnName].Count()}' style='width:{i.ColumnLength}px;'>{i.ColumnTitle}</th>";
                                foreach (var subHeader in entity.TotalResults[i.ColumnName])
                                {
                                    if (index > 0) reportCountColHead++;
                                    multiCurrencyHeader += $"<th style='width: {subColWidth}px;'>{subHeader.Key}</th>";
                                    index++;
                                }
                            }
                            else
                            {
                                rowHeader = $"<th rowspan='2' width='{i.ColumnLength}'px>{i.ColumnTitle}</th>";
                            }
                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }
                multiCurrencyHeader += input.CurrencyFilter == CurrencyFilter.MultiCurrencies ? $"</tr>" : "";

                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                var groupBy = new List<GetListCustomerByInvoiceWithPaymentReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Customer":
                            groupBy = entity.Items
                                .GroupBy(t => t.CustomerCode)
                                .Select(t => new GetListCustomerByInvoiceWithPaymentReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }
                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0) //write body have group by
                {
                    var item = viewHeader;
                    foreach (var k in groupBy)
                    {
                        var headerGroup = "<tr valign='top' style='font-weight: bold; page-break-inside:avoid;'><td colspan=" + reportCountColHead + "> " + k.KeyName + " </td></tr>";
                        contentBody += headerGroup;
                        foreach (var row in k.Items)
                        {
                            var tr = "<tr style='page-break-inside:avoid;'  valign='top'>";
                            foreach (var i in viewHeader)
                            {
                                if (i.Visible)
                                {
                                    if (i.ColumnName == "Date")
                                    {
                                        tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "JournalNo")
                                    {
                                        tr += $"<td>{row.JournalNo}</td>";
                                    }
                                    else if (i.ColumnName == "Reference")
                                    {
                                        tr += $"<td>{row.Reference}</td>";
                                    }
                                    else if (i.ColumnName == "JournalType")
                                    {
                                        tr += $"<td>{row.JournalType.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "AccountCode")
                                    {
                                        tr += $"<td>{row.AccountCode}</td>";
                                    }
                                    else if (i.ColumnName == "AccountName")
                                    {
                                        tr += $"<td>{row.AccountName}</td>";
                                    }
                                    else if (i.ColumnName == "CustomerName")
                                    {
                                        tr += $"<td>{row.CustomerName}</td>";
                                    }
                                    else if (i.ColumnName == "Description")
                                    {
                                        tr += $"<td>{row.Description}</td>";
                                    }
                                    else if (i.ColumnName == "TotalAmount")
                                    {
                                        tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.TotalAmount, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "TotalPaid")
                                    {
                                        tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.TotalPaid, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "Balance")
                                    {
                                        tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.Balance, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "User")
                                    {
                                        tr += $"<td>{row.User}</td>";
                                    }
                                    else if (i.ColumnName == "Location")
                                    {
                                        tr += $"<td>{row.Location}</td>";
                                    }
                                    else if (i.ColumnName == "Currency")
                                    {
                                        tr += $"<td>{row.Currency.Code}</td>";
                                    }
                                    else if ((i.ColumnName == "LastPaymentAmounts" || i.ColumnName == "Balances"
                                            || i.ColumnName == "TotalPaids" || i.ColumnName == "TotalAmounts")
                                            && input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                    {
                                        if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)//Multi currency 
                                        {
                                            if (entity.TotalResults.ContainsKey(i.ColumnName))
                                            {
                                                var subColWidth = Convert.ToInt32(i.ColumnLength / entity.TotalResults[i.ColumnName].Count());

                                                foreach (var code in entity.TotalResults[i.ColumnName])
                                                {
                                                    tr += $"<td style='text-align: right; width: {subColWidth}px;'>";

                                                    var sub = row.TotalColsByCurency.Where(t => t.CurrencyCode == code.Key).FirstOrDefault();
                                                    if (i.ColumnName == "LastPaymentAmounts")
                                                    {
                                                        tr += $"{FormatNumberCurrency(Math.Round(sub.LastPaymentAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "Balances")
                                                    {
                                                        tr += $"{FormatNumberCurrency(Math.Round(sub.Balances, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "TotalPaids")
                                                    {
                                                        tr += $"{FormatNumberCurrency(Math.Round(sub.TotalPaids, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "TotalAmounts")
                                                    {
                                                        tr += $"{FormatNumberCurrency(Math.Round(sub.TotalAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    tr += "</td>";
                                                }

                                            }
                                        }

                                    }
                                    else
                                    {
                                        tr += $"<td></td>";
                                    }

                                }
                            }
                            tr += "</tr>";
                            contentBody += tr;


                            var payments = row.PaymentItems.Where(s => s.PaymentId.HasValue).ToList();
                            if (payments.Any())
                            {
                                foreach (var pay in payments)
                                {
                                    var ptr = "<tr style='page-break-inside:avoid;'  valign='top'>";
                                    foreach (var i in viewHeader)
                                    {
                                        if (i.Visible)
                                        {
                                            pay.Date = pay.PaymentDate.Value;
                                            pay.TotalAmount = 0;
                                            pay.Balance = 0;
                                            pay.JournalNo = pay.PaymentNo;
                                            pay.Reference = pay.PaymentReference;
                                            pay.User = pay.PaymentUserName;
                                            pay.JournalType = JournalType.ReceivePayment;
                                            pay.TotalColsByCurency = new List<GetCustomerByInvoiceReportOutputItemByCurrency>();

                                            foreach (var c in row.TotalColsByCurency)
                                            {
                                                var tc = new GetCustomerByInvoiceReportOutputItemByCurrency
                                                {
                                                    TotalAmounts = 0,
                                                    TotalPaids = c.CurrencyCode == pay.Currency.Code ? pay.TotalPaid : 0,
                                                    Balances = 0,
                                                    CurrencyCode = c.CurrencyCode,
                                                };

                                                pay.TotalColsByCurency.Add(tc);
                                            }


                                            if (i.ColumnName == "Date")
                                            {
                                                ptr += $"<td>{pay.Date.ToString(formatDate)}</td>";
                                            }
                                            else if (i.ColumnName == "JournalNo")
                                            {
                                                ptr += $"<td>{pay.JournalNo}</td>";
                                            }
                                            else if (i.ColumnName == "Reference")
                                            {
                                                ptr += $"<td>{pay.Reference}</td>";
                                            }
                                            else if (i.ColumnName == "JournalType")
                                            {
                                                ptr += $"<td>{pay.JournalType.ToString()}</td>";
                                            }
                                            else if (i.ColumnName == "AccountCode")
                                            {
                                                ptr += $"<td>{pay.AccountCode}</td>";
                                            }
                                            else if (i.ColumnName == "AccountName")
                                            {
                                                ptr += $"<td>{pay.AccountName}</td>";
                                            }
                                            else if (i.ColumnName == "CustomerName")
                                            {
                                                ptr += $"<td>{pay.CustomerName}</td>";
                                            }
                                            else if (i.ColumnName == "Description")
                                            {
                                                ptr += $"<td>{pay.Description}</td>";
                                            }
                                            else if (i.ColumnName == "TotalAmount")
                                            {
                                                ptr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(pay.TotalAmount, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                            else if (i.ColumnName == "TotalPaid")
                                            {
                                                ptr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(pay.TotalPaid, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                            else if (i.ColumnName == "Balance")
                                            {
                                                ptr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(pay.Balance, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                            else if (i.ColumnName == "User")
                                            {
                                                ptr += $"<td>{pay.User}</td>";
                                            }
                                            else if (i.ColumnName == "Location")
                                            {
                                                ptr += $"<td>{pay.Location}</td>";
                                            }
                                            else if (i.ColumnName == "Currency")
                                            {
                                                ptr += $"<td>{pay.Currency.Code}</td>";
                                            }
                                            else if ((i.ColumnName == "LastPaymentAmounts" || i.ColumnName == "Balances"
                                                    || i.ColumnName == "TotalPaids" || i.ColumnName == "TotalAmounts")
                                                    && input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                            {
                                                if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)//Multi currency 
                                                {
                                                    //ptr += $"<td>";
                                                    if (entity.TotalResults.ContainsKey(i.ColumnName))
                                                    {
                                                        foreach (var code in entity.TotalResults[i.ColumnName])
                                                        {
                                                            ptr += $"<td style='text-align: right;'>";

                                                            var sub = pay.TotalColsByCurency.Where(t => t.CurrencyCode == code.Key).FirstOrDefault();
                                                            if (i.ColumnName == "LastPaymentAmounts")
                                                            {
                                                                ptr += $"{FormatNumberCurrency(Math.Round(sub.LastPaymentAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                            }
                                                            else if (i.ColumnName == "Balances")
                                                            {
                                                                ptr += $"{FormatNumberCurrency(Math.Round(sub.Balances, digit, MidpointRounding.ToEven), digit)}";
                                                            }
                                                            else if (i.ColumnName == "TotalPaids")
                                                            {
                                                                ptr += $"{FormatNumberCurrency(Math.Round(sub.TotalPaids, digit, MidpointRounding.ToEven), digit)}";
                                                            }
                                                            else if (i.ColumnName == "TotalAmounts")
                                                            {
                                                                ptr += $"{FormatNumberCurrency(Math.Round(sub.TotalAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                            }
                                                            ptr += "</td>";
                                                        }
                                                    }
                                                    //ptr += "</td>";
                                                }

                                            }
                                            else
                                            {
                                                ptr += $"<td></td>";
                                            }
                                        }
                                    }
                                    ptr += "</tr>";
                                    contentBody += ptr;
                                }
                            }

                        }
                        // sum footer 
                        var trGr = "<tr style='font-weight: bold; page-break-inside:avoid;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                                {
                                    if (i.ColumnName == "TotalAmount")
                                    {
                                        trGr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.TotalAmount), digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "TotalPaid")
                                    {
                                        trGr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.TotalPaid), digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "Balance")
                                    {
                                        trGr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.Balance), digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    //else if (i.month == "LastPaymentAmount")
                                    //{
                                    //    trGr += $"<td>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.LastPaymentAmounts), digit, MidpointRounding.ToEven),digit)}</td>";
                                    //}
                                    else if ((i.ColumnName == "LastPaymentAmounts" || i.ColumnName == "Balances"
                                            || i.ColumnName == "TotalPaids" || i.ColumnName == "TotalAmounts")
                                            && input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                    {
                                        if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)//Multi currency 
                                        {
                                            //trGr += $"<td>";
                                            if (entity.TotalResults.ContainsKey(i.ColumnName))
                                            {

                                                var sumList = k.Items.SelectMany(u => u.TotalColsByCurency).Select(u => u).ToList();
                                                var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                                                {
                                                    CurrencyCode = u.Key,
                                                    TotalPaid = u.Sum(s => s.TotalPaids),
                                                    TotalAmount = u.Sum(s => s.TotalAmounts),
                                                    Balance = u.Sum(s => s.Balances),
                                                    LastPaymentAmounts = u.Sum(s => s.LastPaymentAmounts)

                                                }).ToDictionary(u => u.CurrencyCode);

                                                foreach (var code in entity.TotalResults[i.ColumnName])
                                                {
                                                    trGr += $"<td style='text-align: right;'>";

                                                    //var sub = k.Items.Where(t => t.CurrencyCode == code.Key).FirstOrDefault();
                                                    if (i.ColumnName == "LastPaymentAmounts" && groupByCurrencyDict.ContainsKey(code.Key))
                                                    {
                                                        trGr += $"{FormatNumberCurrency(Math.Round(groupByCurrencyDict[code.Key].LastPaymentAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "Balances" && groupByCurrencyDict.ContainsKey(code.Key))
                                                    {
                                                        trGr += $"{FormatNumberCurrency(Math.Round(groupByCurrencyDict[code.Key].Balance, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "TotalPaids" && groupByCurrencyDict.ContainsKey(code.Key))
                                                    {
                                                        trGr += $"{FormatNumberCurrency(Math.Round(groupByCurrencyDict[code.Key].TotalPaid, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    else if (i.ColumnName == "TotalAmounts" && groupByCurrencyDict.ContainsKey(code.Key))
                                                    {
                                                        trGr += $"{FormatNumberCurrency(Math.Round(groupByCurrencyDict[code.Key].TotalAmount, digit, MidpointRounding.ToEven), digit)}";
                                                    }
                                                    trGr += "</td>";
                                                }
                                            }
                                            //trGr += "</td>";
                                        }

                                    }
                                    else
                                    {
                                        trGr += $"<td></td>";
                                    }
                                }
                                else //none sum
                                {
                                    trGr += $"<td></td>";
                                }

                            }
                        }
                        contentBody += trGr;
                    }
                }
                else // write body no group by
                {
                    foreach (var row in entity.Items)
                    {
                        var tr = "<tr style='page-break-inside:avoid;'  valign='top'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "Date")
                                {
                                    tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "JournalNo")
                                {
                                    tr += $"<td>{row.JournalNo}</td>";
                                }
                                else if (i.ColumnName == "JournalType")
                                {
                                    tr += $"<td>{row.JournalType.ToString()}</td>";
                                }
                                else if (i.ColumnName == "AccountCode")
                                {
                                    tr += $"<td>{row.AccountCode}</td>";
                                }
                                else if (i.ColumnName == "AccountName")
                                {
                                    tr += $"<td>{row.AccountName}</td>";
                                }
                                else if (i.ColumnName == "CustomerName")
                                {
                                    tr += $"<td>{row.CustomerName}</td>";
                                }
                                else if (i.ColumnName == "Description")
                                {
                                    tr += $"<td>{row.Description}</td>";
                                }
                                else if (i.ColumnName == "TotalAmount")
                                {
                                    tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.TotalAmount, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "TotalPaid")
                                {
                                    tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.TotalPaid, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "Balance")
                                {
                                    tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(row.Balance, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "User")
                                {
                                    tr += $"<td>{row.User}</td>";
                                }
                                else if (i.ColumnName == "Location")
                                {
                                    tr += $"<td>{row.Location}</td>";
                                }
                                else if (i.ColumnName == "Currency")
                                {
                                    tr += $"<td>{row.Currency.Code}</td>";
                                }
                                else if ((i.ColumnName == "LastPaymentAmounts" || i.ColumnName == "Balances"
                                        || i.ColumnName == "TotalPaids" || i.ColumnName == "TotalAmounts")
                                        && input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                {
                                    if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)//Multi currency 
                                    {
                                        //tr += $"<td>";
                                        if (entity.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var code in entity.TotalResults[i.ColumnName])
                                            {
                                                tr += $"<td style='text-align: right;'>";

                                                var sub = row.TotalColsByCurency.Where(t => t.CurrencyCode == code.Key).FirstOrDefault();
                                                if (i.ColumnName == "LastPaymentAmounts")
                                                {
                                                    tr += $"{FormatNumberCurrency(Math.Round(sub.LastPaymentAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                }
                                                else if (i.ColumnName == "Balances")
                                                {
                                                    tr += $"{FormatNumberCurrency(Math.Round(sub.Balances, digit, MidpointRounding.ToEven), digit)}";
                                                }
                                                else if (i.ColumnName == "TotalPaids")
                                                {
                                                    tr += $"{FormatNumberCurrency(Math.Round(sub.TotalPaids, digit, MidpointRounding.ToEven), digit)}";
                                                }
                                                else if (i.ColumnName == "TotalAmounts")
                                                {
                                                    tr += $"{FormatNumberCurrency(Math.Round(sub.TotalAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                }
                                                tr += "</td>";
                                            }
                                        }
                                        //tr += "</td>";
                                    }

                                }
                                else
                                {
                                    tr += $"<td></td>";
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;


                        var payments = row.PaymentItems.Where(s => s.PaymentId.HasValue).ToList();
                        if (payments.Any())
                        {
                            foreach (var pay in payments)
                            {
                                var ptr = "<tr style='page-break-inside:avoid;'  valign='top'>";
                                foreach (var i in viewHeader)
                                {
                                    if (i.Visible)
                                    {
                                        pay.Date = pay.PaymentDate.Value;
                                        pay.TotalAmount = 0;
                                        pay.Balance = 0;
                                        pay.JournalNo = pay.PaymentNo;
                                        pay.User = pay.PaymentUserName;
                                        pay.JournalType = JournalType.ReceivePayment;
                                        pay.TotalColsByCurency = new List<GetCustomerByInvoiceReportOutputItemByCurrency>();

                                        foreach (var c in row.TotalColsByCurency)
                                        {
                                            var tc = new GetCustomerByInvoiceReportOutputItemByCurrency
                                            {
                                                TotalAmounts = 0,
                                                TotalPaids = c.CurrencyCode == pay.Currency.Code ? pay.TotalPaid : 0,
                                                Balances = 0,
                                                CurrencyCode = c.CurrencyCode,
                                            };

                                            pay.TotalColsByCurency.Add(tc);
                                        }


                                        if (i.ColumnName == "Date")
                                        {
                                            ptr += $"<td>{pay.Date.ToString(formatDate)}</td>";
                                        }
                                        else if (i.ColumnName == "JournalNo")
                                        {
                                            ptr += $"<td>{pay.JournalNo}</td>";
                                        }
                                        else if (i.ColumnName == "JournalType")
                                        {
                                            ptr += $"<td>{pay.JournalType.ToString()}</td>";
                                        }
                                        else if (i.ColumnName == "AccountCode")
                                        {
                                            ptr += $"<td>{pay.AccountCode}</td>";
                                        }
                                        else if (i.ColumnName == "AccountName")
                                        {
                                            ptr += $"<td>{pay.AccountName}</td>";
                                        }
                                        else if (i.ColumnName == "CustomerName")
                                        {
                                            ptr += $"<td>{pay.CustomerName}</td>";
                                        }
                                        else if (i.ColumnName == "Description")
                                        {
                                            ptr += $"<td>{pay.Description}</td>";
                                        }
                                        else if (i.ColumnName == "TotalAmount")
                                        {
                                            ptr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(pay.TotalAmount, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                        else if (i.ColumnName == "TotalPaid")
                                        {
                                            ptr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(pay.TotalPaid, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                        else if (i.ColumnName == "Balance")
                                        {
                                            ptr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(pay.Balance, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                        else if (i.ColumnName == "User")
                                        {
                                            ptr += $"<td>{pay.User}</td>";
                                        }
                                        else if (i.ColumnName == "Location")
                                        {
                                            ptr += $"<td>{pay.Location}</td>";
                                        }
                                        else if (i.ColumnName == "Currency")
                                        {
                                            ptr += $"<td>{pay.Currency.Code}</td>";
                                        }
                                        else if ((i.ColumnName == "LastPaymentAmounts" || i.ColumnName == "Balances"
                                                || i.ColumnName == "TotalPaids" || i.ColumnName == "TotalAmounts")
                                                && input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                        {
                                            if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)//Multi currency 
                                            {
                                                //ptr += $"<td>";
                                                if (entity.TotalResults.ContainsKey(i.ColumnName))
                                                {
                                                    foreach (var code in entity.TotalResults[i.ColumnName])
                                                    {
                                                        ptr += $"<td style='text-align: right;'>";

                                                        var sub = pay.TotalColsByCurency.Where(t => t.CurrencyCode == code.Key).FirstOrDefault();
                                                        if (i.ColumnName == "LastPaymentAmounts")
                                                        {
                                                            ptr += $"{FormatNumberCurrency(Math.Round(sub.LastPaymentAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                        }
                                                        else if (i.ColumnName == "Balances")
                                                        {
                                                            ptr += $"{FormatNumberCurrency(Math.Round(sub.Balances, digit, MidpointRounding.ToEven), digit)}";
                                                        }
                                                        else if (i.ColumnName == "TotalPaids")
                                                        {
                                                            ptr += $"{FormatNumberCurrency(Math.Round(sub.TotalPaids, digit, MidpointRounding.ToEven), digit)}";
                                                        }
                                                        else if (i.ColumnName == "TotalAmounts")
                                                        {
                                                            ptr += $"{FormatNumberCurrency(Math.Round(sub.TotalAmounts, digit, MidpointRounding.ToEven), digit)}";
                                                        }
                                                        ptr += "</td>";
                                                    }
                                                }
                                                //ptr += "</td>";
                                            }

                                        }
                                        else
                                        {
                                            ptr += $"<td></td>";
                                        }
                                    }
                                }
                                ptr += "</tr>";
                                contentBody += ptr;
                            }
                        }

                    }
                }

                #endregion Row Body


                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr valign='top' style='page-break-inside:avoid;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (!string.IsNullOrEmpty(i.AllowFunction) && entity.TotalResults.ContainsKey(i.ColumnName))
                            {
                                if (input.CurrencyFilter == CurrencyFilter.MultiCurrencies)
                                {
                                    //tr += $"<td>";
                                    foreach (var code in entity.TotalResults[i.ColumnName])
                                    {
                                        tr += $"<td style='text-align: right;'>";
                                        var sub = entity.TotalResults[i.ColumnName][code.Key];
                                        tr += $"{FormatNumberCurrency(Math.Round(sub, digit, MidpointRounding.ToEven), digit)}";
                                        tr += "</td>";
                                    }
                                    //tr += "</td>";
                                }
                                else
                                {
                                    tr += $"<td style='word-wrap:break-word;text-align: right;'>";
                                    foreach (var code in entity.TotalResults[i.ColumnName])
                                    {
                                        var sub = entity.TotalResults[i.ColumnName][code.Key];
                                        tr += $"{FormatNumberCurrency(Math.Round(sub, digit, MidpointRounding.ToEven), digit)}";

                                    }
                                    tr += "</td>";

                                }

                            }
                            else //none sum
                            {
                                if (index == 0)
                                {
                                    tr += $"<td style='font-weight: bold;'>{L("Total")}</td>";
                                }
                                else
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{subHeader}}", multiCurrencyHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);

                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{ReplaceSpecialCharacter(sheetName)}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });

        }


        #endregion

        #region Sale Return Report

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleReturn)]
        [HttpPost]
        public async Task<PagedResultWithTotalColuumnsDto<GetListSaleReturnReportOutput>> GetSaleReturnReport(GetSaleReturnReportInput input)
        {
            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
                                               previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var isFilterByAccountCurrency = input.CurrencyFilter != CurrencyFilter.MultiCurrencies;

            var customerUserGroup = GetCustomerGroup(AbpSession.GetUserId());
            var defaultLocationGroups = await GetUserGroupByLocation();
            var queryResult = (from jItem in _journalItemRepository.GetAll()
                          .Include(t => t.Account)
                           .WhereIf(input.Accounts != null && input.Accounts.Count > 0, u => input.Accounts.Contains(u.AccountId))
                           .WhereIf(input.AccountTypes != null && input.AccountTypes.Count > 0, u => u.Account != null && input.AccountTypes.Contains(u.Account.AccountTypeId))
                           .AsNoTracking()
                               join j in _journalRepository.GetAll()
                               .Include(t => t.CreatorUser)
                               .Include(t => t.Currency)
                               .Include(t => t.MultiCurrency)
                               .Where(u => u.JournalType == JournalType.CustomerCredit)
                               .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                               .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                               .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                               .WhereIf(input.FromDate != null && input.ToDate != null,
                                      (u => (u.Date.Date) >= (input.FromDate.Date) && (u.Date.Date) <= (input.ToDate.Date)))
                               .WhereIf(!input.Filter.IsNullOrEmpty(),
                                      u => u.JournalNo.ToLower().Contains(input.Filter.ToLower()) ||
                                           u.Reference.ToLower().Contains(input.Filter.ToLower()) ||
                                           u.Memo.ToLower().Contains(input.Filter.ToLower()))
                                 .AsNoTracking()
                               on jItem.JournalId equals j.Id

                               join cuscredit in _customerCreditRepository.GetAll()
                               .Include(s => s.Customer.CustomerType)
                               .WhereIf(input.CustomerTypes != null && input.CustomerTypes.Count > 0, u => input.CustomerTypes.Contains(u.Customer.CustomerTypeId.Value))
                               .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                               .AsNoTracking()
                               on j.CustomerCreditId equals cuscredit.Id
                               join cuscredititem in _customerCreditItemRepository.GetAll()
                               .Include(u => u.Item)
                               .Include(u => u.Tax)
                               .WhereIf(input.BillTypes != BillType.SelectAll, s => (input.BillTypes == BillType.Item && s.ItemId != null) || (input.BillTypes == BillType.Account && s.ItemId == null))
                               .WhereIf(input.Items != null && input.Items.Count > 0, u => input.Items.Contains(u.ItemId))
                               .WhereIf(input.PropertyDics != null && input.PropertyDics.Count > 0, p => (p.Item.Properties.Where(i => input.PropertyDics.Any(v => v.PropertyId == i.PropertyId) &&
                                                          input.PropertyDics.FirstOrDefault(v => v.PropertyId == i.PropertyId) != null &&
                                                          (input.PropertyDics.FirstOrDefault(v => v.PropertyId == i.PropertyId).PropertyValueIds == null ||
                                                          input.PropertyDics.FirstOrDefault(v => v.PropertyId == i.PropertyId).PropertyValueIds.Count == 0 ||
                                                          input.PropertyDics.FirstOrDefault(v => v.PropertyId == i.PropertyId).PropertyValueIds.Contains(i.PropertyValueId)))
                                              .Count() == input.PropertyDics.Count))
                               .AsNoTracking()
                               on cuscredit.Id equals cuscredititem.CustomerCreditId

                               join cg in customerUserGroup
                               on cuscredit.CustomerId equals cg.Id
                               group jItem by new
                               {
                                   Date = j.Date.Date,
                                   invoiceItemId = cuscredititem.Id,
                                   ItemCode = cuscredititem.Item.ItemCode,
                                   ItemId = cuscredititem.ItemId,
                                   ItemName = cuscredititem.Item.ItemName,
                                   LocationId = j.LocationId,
                                   LocationName = j.Location.LocationName,
                                   Qty = cuscredititem.Qty,
                                   TaxId = cuscredititem.TaxId,
                                   TaxName = cuscredititem.Tax.TaxName,
                                   TaxRate = cuscredititem.Tax.TaxRate,
                                   Total = isFilterByAccountCurrency ? cuscredititem.Total : cuscredititem.MultiCurrencyTotal,
                                   UnitCost = isFilterByAccountCurrency ? cuscredititem.UnitCost : cuscredititem.MultiCurrencyUnitCost,
                                   CustomerId = cuscredit.CustomerId,
                                   CustomerName = cg.CustomerName,
                                   CustomerType = cuscredit.Customer.CustomerType.CustomerTypeName,
                                   JournalNo = j.JournalNo,
                                   Reference = j.Reference,
                                   User = j.CreatorUser.UserName,
                                   CreationTimeIndex = j.CreationTimeIndex,
                                   CreationTime = cuscredititem.CreationTime,
                                   CurrencyId = isFilterByAccountCurrency ? j.CurrencyId : j.MultiCurrencyId,
                                   CurrencyCode = isFilterByAccountCurrency ? j.Currency.Code : j.MultiCurrency.Code,
                               } into u
                               select new
                               {
                                   Date = u.Key.Date,
                                   AccountName = u.Where(g => g.Identifier == u.Key.invoiceItemId).Select(t => t.Account.AccountName).FirstOrDefault(),
                                   AccountId = u.Where(g => g.Identifier == u.Key.invoiceItemId).Select(t => t.AccountId).FirstOrDefault(),
                                   AccountCode = u.Where(g => g.Identifier == u.Key.invoiceItemId).Select(t => t.Account.AccountCode).FirstOrDefault(),
                                   ItemCode = u.Key.ItemCode,
                                   ItemId = u.Key.ItemId,
                                   ItemName = u.Key.ItemName,
                                   LocationId = u.Key.LocationId.Value,
                                   LocationName = u.Key.LocationName,
                                   Qty = u.Key.Qty,
                                   TaxId = u.Key.TaxId,
                                   TaxName = u.Key.TaxName,
                                   TaxRate = u.Key.TaxRate,
                                   Total = u.Key.Total,
                                   UnitPrice = u.Key.UnitCost,
                                   CustomerId = u.Key.CustomerId,
                                   CustomerName = u.Key.CustomerName,
                                   CustomerType = u.Key.CustomerType,
                                   Reference = u.Key.Reference,
                                   JournalNo = u.Key.JournalNo,
                                   User = u.Key.User,
                                   CreationTimeIndex = u.Key.CreationTimeIndex,
                                   CreationTime = u.Key.CreationTime,
                                   RoundingDigit = currentRoundingDigit,
                                   RoundingDigitUnitCost = currentRoundingDigitUnitCost,
                                   CurrencyId = u.Key.CurrencyId,
                                   CurrencyCode = u.Key.CurrencyCode,
                               });

            var currencyColumns = queryResult.Select(u => new { u.CurrencyId, u.CurrencyCode }).Distinct().ToList();

            var query = from q in queryResult
                        join i in GetItemPropertiesQuery()
                         .WhereIf(input.Items != null && input.Items.Count() > 0, t => input.Items.Contains(t.ItemId))
                         .AsNoTracking()
                         on q.ItemId equals i.ItemId
                         into list
                        from item in list.DefaultIfEmpty()
                        where (input.BillTypes == BillType.SelectAll && (q.ItemId == null || item != null)) ||
                              (input.BillTypes == BillType.Item && (q.ItemId != null && item != null)) ||
                              (input.BillTypes == BillType.Account && q.ItemId == null)

                        let properties = item == null ? new List<Inventories.Data.ItemPropertySummary>() : item.Properties
                        let netWeight = item == null || item.Properties == null ? 0 : item.Properties
                                       .Where(t => t.IsUnit).Select(t => t.NetWeight * q.Qty).FirstOrDefault()
                        select new GetListSaleReturnReportOutput
                        {
                            Date = q.Date,
                            AccountName = q.AccountName,
                            AccountId = q.AccountId,
                            AccountCode = q.AccountCode,
                            ItemCode = q.ItemCode,
                            ItemId = q.ItemId,
                            ItemName = q.ItemName,
                            LocationId = q.LocationId,
                            LocationName = q.LocationName,
                            Qty = q.Qty,
                            TaxId = q.TaxId,
                            TaxName = q.TaxName,
                            TaxRate = q.TaxRate,
                            Total = q.Total,
                            UnitPrice = q.UnitPrice,
                            CustomerId = q.CustomerId,
                            CustomerName = q.CustomerName,
                            CustomerType = q.CustomerType,
                            Reference = q.Reference,
                            JournalNo = q.JournalNo,
                            User = q.User,
                            CreationTimeIndex = q.CreationTimeIndex,
                            CreationTime = q.CreationTime,
                            RoundingDigit = currentRoundingDigit,
                            RoundingDigitUnitCost = currentRoundingDigitUnitCost,
                            Properties = properties,
                            NetWeight = netWeight,
                            CurrencyColumnTotals = currencyColumns.Select(s => new CurrencyColumnTotal
                            {
                                CurrencyId = s.CurrencyId.Value,
                                CurrencyCode = s.CurrencyCode,
                                Total = s.CurrencyId == q.CurrencyId ? q.Total : 0,
                            }).ToList(),
                        };


            if (input.BillTypes == BillType.Item)
            {
                query = query.Where(t => t.ItemId != null);
            }
            if (input.BillTypes == BillType.Account)
            {
                query = query.Where(t => t.ItemId == null);
            }

            var resultCount = 0;
            if (input.IsLoadMore == false)
            {
                resultCount = await query.CountAsync();
            }
            var sumOfColumns = new Dictionary<string, decimal>();
            var multiCurrencySumOfColumns = new Dictionary<string, Dictionary<string, decimal>>();

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "Total")
                    {
                        if (!isFilterByAccountCurrency)
                        {
                            var sumList = await query.SelectMany(u => u.CurrencyColumnTotals).ToListAsync();
                            var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => s.Total),
                            }).ToDictionary(u => u.CurrencyCode);

                            var multiSumOfColumns = new Dictionary<string, decimal>();
                            foreach (var c in currencyColumns)
                            {
                                multiSumOfColumns.Add(c.CurrencyCode, groupByCurrencyDict.ContainsKey(c.CurrencyCode) ? groupByCurrencyDict[c.CurrencyCode].Total : 0);
                            }

                            multiCurrencySumOfColumns.Add(col, multiSumOfColumns);
                        }
                        else
                        {
                            sumOfColumns.Add(col, query.Sum(u => u.Total));
                        }
                    }
                    else if (col == "NetWeight")
                    {
                        sumOfColumns.Add(col, query.Sum(u => u.NetWeight));
                    }
                }
            }

            var key = "";
            if (!input.GroupBy.IsNullOrWhiteSpace())
            {
                switch (input.GroupBy)
                {
                    case "Item":
                        key = "ItemCode";
                        break;
                    case "Date":
                        key = "Date";
                        break;
                    case "Location":
                        key = "LocationId";
                        break;
                    case "Customer":
                        key = "CustomerId";
                        break;
                    case "Account":
                        key = "AccountCode";
                        break;
                    default:
                        key = input.GroupBy;
                        break;
                }
                query = query.OrderBy(key);
            }
            var @entities = new List<GetListSaleReturnReportOutput>();
            if (input.UsePagination == true)
            {
                @entities = await query.OrderBy(input.Sorting).ThenBy(t => t.CreationTimeIndex).ThenBy(t => t.CreationTime).PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await query.OrderBy(input.Sorting).ThenBy(t => t.CreationTimeIndex).ThenBy(t => t.CreationTime).ToListAsync();
            }

            var returnResult = new PagedResultWithTotalColuumnsDto<GetListSaleReturnReportOutput>(resultCount, @entities, multiCurrencySumOfColumns);
            returnResult.TotalResult = sumOfColumns;

            return returnResult;
        }

        public ReportOutput GetReportTemplateSaleReturn()
        {
            var itemPropertyCols = _propertyRepository.GetAll().AsNoTracking()
                             .Where(t => t.IsActive == true)
                             .Select(t => new CollumnOutput
                             {
                                 AllowGroupby = false,
                                 AllowFilter = true,
                                 ColumnName = t.Name,
                                 ColumnLength = 150,
                                 ColumnTitle = t.Name,
                                 ColumnType = ColumnType.ItemProperty,
                                 SortOrder = 11,
                                 Visible = true,
                                 AllowFunction = null,
                                 MoreFunction = null,
                                 IsDisplay = true,
                                 AllowShowHideFilter = true,
                                 ShowHideFilter = true,
                                 DefaultValue = t.Id.ToString(),//to init the value of property
                             });

            var columns = new List<CollumnOutput>() {
                     // start properties with can filter
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Search",
                        ColumnLength = 150,
                        ColumnTitle = "Search",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DateRange",
                        ColumnLength = 150,
                        ColumnTitle = "DateRange",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        DefaultValue = "thisMonth",
                        AllowFunction = null,
                        DisableDefault = false,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Type",
                        ColumnLength = 300,
                        ColumnTitle = "Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Item",
                        ColumnLength = 300,
                        ColumnTitle = "Item",
                        ColumnType = ColumnType.String,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = false,
                        ColumnName = "Date",
                        ColumnLength = 100,
                        ColumnTitle = "Date",
                        ColumnType = ColumnType.Date,
                        SortOrder = 1,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                     },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = false,
                        ColumnName = "JournalNo",
                        ColumnLength = 120,
                        ColumnTitle = "Journal No",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Reference",
                        ColumnLength = 100,
                        ColumnTitle = "Reference",
                        ColumnType = ColumnType.String,
                        SortOrder = 3,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Customer",
                        ColumnLength = 120,
                        ColumnTitle = "Customer",
                        ColumnType = ColumnType.String,
                        SortOrder = 4,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                       new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "AccountType",
                        ColumnLength = 300,
                        ColumnTitle = "AccountType",
                        ColumnType = ColumnType.String,
                        SortOrder = 5,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Account",
                        ColumnLength = 120,
                        ColumnTitle = "Account",
                        ColumnType = ColumnType.String,
                        SortOrder = 6,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Location",
                        ColumnLength = 120,
                        ColumnTitle = "Location",
                        ColumnType = ColumnType.String,
                        SortOrder = 7,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Tax",
                        ColumnLength = 100,
                        ColumnTitle = "Tax Name",
                        ColumnType = ColumnType.String,
                        SortOrder = 8,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TaxRate",
                        ColumnLength = 80,
                        ColumnTitle = "Tax Rate",
                        ColumnType = ColumnType.Money,
                        SortOrder = 9,
                        Visible = true,
                        //AllowFunction = "Sum",
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ItemCode",
                        ColumnLength = 120,
                        ColumnTitle = "Item Code",
                        ColumnType = ColumnType.String,
                        SortOrder = 10,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ItemName",
                        ColumnLength = 120,
                        ColumnTitle = "Item Name",
                        ColumnType = ColumnType.String,
                        SortOrder = 11,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "UnitPrice",
                        ColumnLength = 100,
                        ColumnTitle = "Unit Price",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 12,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Qty",
                        ColumnLength = 100,
                        ColumnTitle = "Qty",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 13,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Total",
                        ColumnLength = 150,
                        ColumnTitle = "Total",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 14,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "NetWeight",
                        ColumnLength = 150,
                        ColumnTitle = "Net Weight",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 15,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true
                    },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "User",
                        ColumnLength = 100,
                        ColumnTitle = "User",
                        ColumnType = ColumnType.String,
                        SortOrder = 16,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "CustomerType",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 17,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    }

                };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columns.Concat(itemPropertyCols).ToList(),
                Groupby = "",
                HeaderTitle = "Sale Return",
                Sortby = "",
            };

            var isMultiCurrency = _multiCurrencyRepository.GetAll().Any();

            if (isMultiCurrency)
            {
                var currency = new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Currency",
                    ColumnLength = 140,
                    ColumnTitle = "Currency",
                    ColumnType = ColumnType.String,
                    SortOrder = 3,
                    Visible = true,
                    IsDisplay = false,
                    DisableDefault = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                };
                result.ColumnInfo.Add(currency);
            }


            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleReturn_Export_Excel)]
        public async Task<FileDto> ExportExcelSaleReturnReport(GetSaleReturnReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var saleInvoiceData = (await GetSaleReturnReport(input)).Items;

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                var subCols = saleInvoiceData == null ? null : saleInvoiceData.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
                var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString("dd-MM-yyyy");
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    if (isMultiCurrencies)
                    {
                        if (i.ColumnName == "Total")
                        {
                            var colWidth = i.ColumnLength;
                            var subColWidth = i.ColumnLength / subCols.Count();

                            AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                            ws.Column(colHeaderTable).Width = ConvertPixelToInches(colWidth);
                            MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader, colHeaderTable + subCols.Count() - 1, ExcelHorizontalAlignment.Center);

                            foreach (var subCol in subCols)
                            {
                                AddTextToCell(ws, rowTableHeader + 1, colHeaderTable, subCol, true);
                                ws.Column(colHeaderTable).Width = ConvertPixelToInches(subColWidth);
                                colHeaderTable += 1;
                            }
                        }
                        else
                        {
                            AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                            ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                            MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader + 1, colHeaderTable, ExcelHorizontalAlignment.Center);
                            colHeaderTable += 1;
                        }
                    }
                    else
                    {
                        AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                        ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                        colHeaderTable += 1;
                    }

                }

                if (isMultiCurrencies) rowTableHeader += 1;
                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                var groupBy = new List<GetListSaleReturnReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Account":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.AccountId)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.AccountName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Customer":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.Date)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString()).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Item":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.ItemId)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.ItemCode != null ? x.ItemCode + "-" + x.ItemName : "").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "JournalNo":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.JournalNo)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.JournalNo).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }
                // write body

                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0)
                {
                    foreach (var k in groupBy)
                    {
                        //key group by name
                        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                        rowBody += 1;
                        count = 1;
                        //list of item
                        foreach (var i in k.Items)
                        {
                            int collumnCellBody = 1;
                            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                            {
                                if (item.ColumnName == "Total" && isMultiCurrencies)
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        var model = i.CurrencyColumnTotals.FirstOrDefault(s => s.CurrencyCode == subCol);
                                        var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);
                                        var value = cellValue ?? 0;
                                        AddCellValue(ws, rowBody, collumnCellBody, item, value, i.RoundingDigit);
                                        collumnCellBody += 1;
                                    }
                                }
                                else
                                {
                                    WriteBodySaleReturn(ws, rowBody, collumnCellBody, item, i, count);
                                    collumnCellBody += 1;
                                }
                            }
                            rowBody += 1;
                            count += 1;
                        }

                        //sub total of group by item
                        int collumnCellGroupBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (item.AllowFunction != null)
                            {
                                if (isMultiCurrencies && item.ColumnName == "Total")
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                        var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);

                                        var colKey = item.ColumnName + "-" + subCol;
                                        if (footerGroupDict.ContainsKey(colKey))
                                        {
                                            footerGroupDict[colKey] += fromCell + ":" + toCell + ",";
                                        }
                                        else
                                        {
                                            footerGroupDict.Add(colKey, fromCell + ":" + toCell + ",");
                                        }

                                        AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);

                                        collumnCellGroupBody++;
                                    }

                                    collumnCellGroupBody--;
                                }
                                else
                                {
                                    var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                    var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);

                                    if (footerGroupDict.ContainsKey(item.ColumnName))
                                    {
                                        footerGroupDict[item.ColumnName] += fromCell + ":" + toCell + ",";
                                    }
                                    else
                                    {
                                        footerGroupDict.Add(item.ColumnName, fromCell + ":" + toCell + ",");
                                    }

                                    AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }

                            }
                            collumnCellGroupBody += 1;
                        }
                        rowBody += 1;
                    }
                }
                else
                {
                    foreach (var i in saleInvoiceData)
                    {
                        int collumnCellBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (isMultiCurrencies && item.ColumnName == "Total")
                            {
                                foreach (var subCol in subCols)
                                {
                                    var model = i.CurrencyColumnTotals.FirstOrDefault(s => s.CurrencyCode == subCol);
                                    var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);
                                    var value = cellValue ?? 0;
                                    AddCellValue(ws, rowBody, collumnCellBody, item, value, i.RoundingDigit);
                                    collumnCellBody += 1;
                                }
                            }
                            else
                            {
                                WriteBodySaleReturn(ws, rowBody, collumnCellBody, item, i, count);
                                collumnCellBody += 1;
                            }

                        }
                        rowBody += 1;
                        count += 1;
                    }
                }
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (!input.GroupBy.IsNullOrWhiteSpace())
                            {
                                if (isMultiCurrencies && i.ColumnName == "Total")
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        var colKey = i.ColumnName + "-" + subCol;
                                        int rowFooter = rowTableHeader + 1;// get start row after 
                                        var sumValue = "SUM(" + footerGroupDict[colKey] + ")";
                                        if (i.ColumnType == ColumnType.Number)
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                        }
                                        else
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                        }

                                        footerColNumber++;
                                    }

                                    footerColNumber--;
                                }
                                else
                                {
                                    int rowFooter = rowTableHeader + 1;// get start row after 
                                    var sumValue = "SUM(" + footerGroupDict[i.ColumnName] + ")";
                                    if (i.ColumnType == ColumnType.Number)
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                    }
                                }
                            }
                            else
                            {
                                if (isMultiCurrencies && i.ColumnName == "Total")
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        int rowFooter = rowTableHeader + 1;// get start row after header 
                                        var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                        var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                        if (i.ColumnType == ColumnType.Number)
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                        }
                                        else
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                        }

                                        footerColNumber++;
                                    }

                                    footerColNumber--;
                                }
                                else
                                {
                                    int rowFooter = rowTableHeader + 1;// get start row after header 
                                    var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                    var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                    if (i.ColumnType == ColumnType.Number)
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                    }
                                }

                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"SaleInvoice_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleReturn_Export_Pdf)]
        public async Task<FileDto> ExportPDFSaleReturnReport(GetSaleReturnReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;
            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                            .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                            .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }
            var digit = (await GetCurrentCycleAsync()).RoundingDigit;
            var user = await GetCurrentUserAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();

            var sheetName = report.HeaderTitle;

            var saleInvoices = await GetSaleReturnReport(input);

            var subCols = saleInvoices.Items == null ? null : saleInvoices.Items.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
            var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";
                            if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                            {
                                var index = 0;
                                var subColWidth = Convert.ToInt32(i.ColumnLength / saleInvoices.TotalResults[i.ColumnName].Count());
                                rowHeader = $"<th  colspan='{saleInvoices.TotalResults[i.ColumnName].Count()}' width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";
                                foreach (var subHeader in saleInvoices.TotalResults[i.ColumnName])
                                {
                                    if (index > 0) reportCountColHead++;
                                    multiCurrencyHeader += $"<th style='width: {subColWidth}px;'>{subHeader.Key}</th>";
                                    index++;
                                }
                            }
                            else
                            {
                                rowHeader = $"<th rowspan='2' width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";
                            }
                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                multiCurrencyHeader += isMultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                var groupBy = new List<GetListSaleReturnReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Account":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.AccountId)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.AccountName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Customer":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "JournalNo":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.JournalNo)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.JournalNo).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.Date)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Item":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.ItemId)
                                .Select(t => new GetListSaleReturnReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.ItemCode != null ? x.ItemCode + "-" + x.ItemName : "").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }
                // write body
                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0) //write body have group by
                {
                    var trGroup = "";
                    foreach (var k in groupBy)
                    {
                        trGroup += $"<tr style='page-break-before: auto; page-break-after: auto;'>" +
                                   $"<td style='font-weight: bold;' colspan='{reportCountColHead}'> " + k.KeyName +
                                   $" </td></tr>";
                        foreach (var row in k.Items)
                        {
                            trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                            foreach (var i in viewHeader)
                            {
                                if (i.Visible)
                                {
                                    if (i.ColumnName == "ItemName")
                                    {
                                        trGroup += $"<td>{row.ItemName}</td>";
                                    }
                                    else if (i.ColumnName == "ItemCode")
                                    {
                                        trGroup += $"<td>{row.ItemCode}</td>";
                                    }
                                    else if (i.ColumnName == "JournalNo")
                                    {
                                        trGroup += $"<td>{row.JournalNo}</td>";
                                    }
                                    else if (i.ColumnName == "Account")
                                    {
                                        trGroup += $"<td>{row.AccountCode + " - " + row.AccountName}</td>";
                                    }
                                    else if (i.ColumnName == "Location")
                                    {
                                        trGroup += $"<td>{row.LocationName}</td>";
                                    }
                                    else if (i.ColumnName == "TaxRate")
                                    {

                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TaxRate, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "UnitPrice")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPrice, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "Qty")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Qty, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "Total")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.Total);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "Tax")

                                    {
                                        trGroup += $"<td>{row.TaxName}</td>";
                                    }
                                    else if (i.ColumnName == "Date")
                                    {
                                        trGroup += $"<td>{row.Date.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "Reference")
                                    {
                                        trGroup += $"<td>{row.Reference}</td>";
                                    }
                                    else if (i.ColumnName == "Customer")
                                    {
                                        trGroup += $"<td>{row.CustomerName}</td>";
                                    }
                                    else if (i.ColumnName == "CustomerType")
                                    {
                                        trGroup += $"<td>{row.CustomerType}</td>";
                                    }
                                    else if (i.ColumnName == "SaleType")
                                    {
                                        trGroup += $"<td>{row.SaleType}</td>";
                                    }
                                    else if (i.ColumnName == "User")
                                    {
                                        trGroup += $"<td>{row.User}</td>";
                                    }
                                    else if (i.ColumnName == "NetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeight, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else
                                    {
                                        var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                        if (property != null)
                                        {
                                            trGroup += $"<td>{property.Value}</td>";
                                        }
                                        else
                                        {
                                            trGroup += $"<td></td>";
                                        }
                                    }
                                }
                            }
                            trGroup += "</tr>";
                        }
                        trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                                {
                                    if (i.ColumnName == "Total" && isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = k.Items.SelectMany(s => s.CurrencyColumnTotals.Where(r => r.CurrencyCode == subHeader)).Sum(s => s.Total);
                                            trGroup += $"<td style='font-weight: bold; text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        if (i.ColumnName == "Total")
                                        {
                                            trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.Total), digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                        else if (i.ColumnName == "NetWeight")
                                        {
                                            trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.NetWeight), digit, MidpointRounding.ToEven), digit)}</td>";
                                        }

                                    }
                                }
                                else //none sum
                                {
                                    trGroup += $"<td></td>";
                                }

                            }
                        }
                        trGroup += "</tr>";
                    }
                    contentBody += trGroup;
                }
                else // write body no group by
                {
                    foreach (var row in saleInvoices.Items)
                    {
                        var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "ItemName")
                                {
                                    tr += $"<td>{row.ItemName}</td>";
                                }
                                else if (i.ColumnName == "ItemCode")
                                {
                                    tr += $"<td>{row.ItemCode}</td>";
                                }
                                else if (i.ColumnName == "JournalNo")
                                {
                                    tr += $"<td>{row.JournalNo}</td>";
                                }
                                else if (i.ColumnName == "Account")
                                {
                                    tr += $"<td>{row.AccountCode + " - " + row.AccountName}</td>";
                                }
                                else if (i.ColumnName == "Location")
                                {
                                    tr += $"<td>{row.LocationName}</td>";
                                }
                                else if (i.ColumnName == "TaxRate")
                                {

                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TaxRate, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "UnitPrice")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPrice, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "Qty")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Qty, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "Total")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(r => r.CurrencyCode == subHeader).Sum(s => s.Total);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Total, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "Tax")

                                {
                                    tr += $"<td>{row.TaxName}</td>";
                                }
                                else if (i.ColumnName == "Date")
                                {
                                    tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "Reference")
                                {
                                    tr += $"<td>{row.Reference}</td>";
                                }
                                else if (i.ColumnName == "Customer")
                                {
                                    tr += $"<td>{row.CustomerName}</td>";
                                }
                                else if (i.ColumnName == "CustomerType")
                                {
                                    tr += $"<td>{row.CustomerType}</td>";
                                }
                                else if (i.ColumnName == "SaleType")
                                {
                                    tr += $"<td>{row.SaleType}</td>";
                                }
                                else if (i.ColumnName == "User")
                                {
                                    tr += $"<td>{row.User}</td>";
                                }
                                else if (i.ColumnName == "NetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeight, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else
                                {
                                    var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                    if (property != null)
                                    {
                                        tr += $"<td>{property.Value}</td>";
                                    }
                                    else
                                    {
                                        tr += $"<td></td>";
                                    }
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index == 0)
                            {
                                tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))
                                {
                                    if (saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subCol in subCols)
                                        {
                                            var total = saleInvoices.TotalResults[i.ColumnName].ContainsKey(subCol) ? saleInvoices.TotalResults[i.ColumnName][subCol] : 0;
                                            tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (saleInvoices.TotalResult.ContainsKey(i.ColumnName))
                                    {
                                        tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(saleInvoices.TotalResult[i.ColumnName], digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer
                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", multiCurrencyHeader);

                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);

                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{ReplaceSpecialCharacter(sheetName)}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }

        #endregion



        #region Sale Invoice Detail Report

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleInvoiceDetail)]
        [HttpPost]
        public async Task<PagedResultWithTotalColuumnsDto<GetListSaleInvoiceDetailReportOutput>> GetSaleInvoiceDetailReport(GetListReportSaleInvoiceInput input)
        {
            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
                                               previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var isFilterByAccountCurrency = input.CurrencyFilter != CurrencyFilter.MultiCurrencies;

            var customerUserGroup = GetCustomerGroup(AbpSession.GetUserId());
            var defaultLocationGroups = await GetUserGroupByLocation();

            var paymentQueries = from j in _journalRepository.GetAll()
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .Where(u => u.JournalType == JournalType.ReceivePayment)
                                          .WhereIf(input.FromDate != null && input.ToDate != null, u => u.Date.Date >= input.FromDate.Date && u.Date.Date <= input.ToDate.Date)
                                          .AsNoTracking()

                                 join ji in _journalItemRepository.GetAll()
                                            .Where(s => s.Identifier == null)
                                            .AsNoTracking()
                                 on j.Id equals ji.JournalId
                                 into pa
                                 from a in pa.DefaultIfEmpty()

                                 join rpi in _receivePaymentItemRepository.GetAll()
                                             .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                             .AsNoTracking()
                                 on j.ReceivePaymentId equals rpi.ReceivePaymentId

                                 join rpii in _journalRepository.GetAll()
                                         .Where(s => s.JournalType == JournalType.Invoice || s.JournalType == JournalType.CustomerCredit)
                                         .AsNoTracking()
                                 on new { rpi.InvoiceId, rpi.CustomerCreditId } equals new { rpii.InvoiceId, rpii.CustomerCreditId }

                                 let accountType = a == null || a.Account == null || a.Account.AccountType == null ? "" : a.Account.AccountType.AccountTypeName.Trim()

                                 let _cash = rpi.InvoiceId.HasValue ? rpi.Cash : -rpi.Cash
                                 let _multiCash = rpi.InvoiceId.HasValue ? rpi.MultiCurrencyCash : -rpi.MultiCurrencyCash
                                 let cashAmount = isFilterByAccountCurrency ? _cash : _multiCash

                                 let Cash = accountType == "Cash" ? cashAmount : 0
                                 let Bank = accountType == "Bank" ? cashAmount : 0
                                 let Other = accountType != "Cash" && accountType != "Bank" ? cashAmount : 0

                                 let _credit = rpi.InvoiceId.HasValue ? rpi.Credit : -rpi.Credit
                                 let _multiCredit = rpi.InvoiceId.HasValue ? rpi.MultiCurrencyCredit : -rpi.MultiCurrencyCredit
                                 let Credit = isFilterByAccountCurrency ? _credit : _multiCredit

                                 let _expense = rpi.InvoiceId.HasValue ? rpi.Expense : -rpi.Expense
                                 let _multiExpense = rpi.InvoiceId.HasValue ? rpi.MultiCurrencyExpense : -rpi.MultiCurrencyExpense
                                 let Expense = isFilterByAccountCurrency ? _expense : _multiExpense

                                 select new PaymentDtoOutput
                                 {
                                     Id = rpi.Id,
                                     PaymentId = rpi.ReceivePaymentId,

                                     TransactionId = rpi.PayToId,
                                     PayToInvoiceDate = rpii.Date.Date,
                                     PayToInvoiceNo = rpii.JournalNo,
                                     CustomerId = rpi.CustomerId,
                                     CustomerCode = rpi.Customer.CustomerCode,
                                     CustomerName = rpi.Customer.CustomerName,
                                     CustomerType = rpi.Customer.CustomerType == null ? "" : rpi.Customer.CustomerType.CustomerTypeName,
                                     CustomerTypeId = rpi.Customer.CustomerTypeId,
                                     IsItem = rpi.Invoice != null ? rpi.Invoice.IsItem : rpi.CustomerCredit.IsItem,
                                     Payment = isFilterByAccountCurrency ? (rpi.InvoiceId.HasValue ? rpi.Payment : -rpi.Payment) : (rpi.InvoiceId.HasValue ? rpi.MultiCurrencyPayment : -rpi.MultiCurrencyPayment),
                                     CreationTime = rpi.CreationTime,
                                     CurrencyId = rpii.CurrencyId,
                                     CurrencyCode = rpii.Currency.Code,
                                     MultiCurrencyId = rpii.MultiCurrencyId,
                                     MultiCurrencyCode = rpii.MultiCurrency.Code,
                                     SaleTypeId = rpii.Invoice != null ? rpii.Invoice.TransactionTypeSaleId : null,
                                     SaleTypeName = rpii.Invoice != null && rpii.Invoice.TransactionTypeSale != null ? rpii.Invoice.TransactionTypeSale.TransactionTypeName : "",

                                     Cash = Cash,
                                     Bank = Bank,
                                     Other = Other,
                                     Credit = Credit,
                                     Expense = Expense,
                                     Account = a == null || a.Account == null ? "" : a.Account.AccountName,
                                     AccountType = accountType,
                                 };



            var paymentToOldInvoiceQuery = paymentQueries.Where(s => s.PayToInvoiceDate < input.FromDate.Date);


            var invoiceQueryResult = from ji in _journalItemRepository.GetAll()
                                              .Where(t => t.Identifier != null)
                                              .WhereIf(input.Accounts != null && input.Accounts.Count > 0, u => input.Accounts.Contains(u.AccountId))
                                              .WhereIf(input.AccountTypes != null && input.AccountTypes.Count > 0, u => u.Account != null && input.AccountTypes.Contains(u.Account.AccountTypeId))
                                              .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                             .Where(s => s.Status == TransactionStatus.Publish)
                                             .Where(u => u.JournalType == JournalType.Invoice)
                                             .WhereIf(input.JournalTypes != null && input.JournalTypes.Any(), s => input.JournalTypes.Contains(s.JournalType))
                                             .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                                             .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                             .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                             .WhereIf(input.FromDate != null && input.ToDate != null,
                                                    (u => (u.Date.Date) >= (input.FromDate.Date) && (u.Date.Date) <= (input.ToDate.Date)))
                                             .WhereIf(!input.Filter.IsNullOrEmpty(),
                                                    u => u.JournalNo.ToLower().Contains(input.Filter.ToLower()) ||
                                                         u.Reference.ToLower().Contains(input.Filter.ToLower()) ||
                                                         u.Memo.ToLower().Contains(input.Filter.ToLower()))
                                             .AsNoTracking()
                                     on ji.JournalId equals j.Id

                                     join inv in _invoiceRepository.GetAll()
                                                 .WhereIf(input.SaleTypes != null && input.SaleTypes.Any(), u => u.TransactionTypeSaleId.HasValue && input.SaleTypes.Contains(u.TransactionTypeSaleId.Value))
                                                 .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                                 .AsNoTracking()
                                     on j.InvoiceId equals inv.Id

                                     join invi in _invoiceItemRepository.GetAll()
                                             .AsNoTracking()
                                     on ji.Identifier equals invi.Id

                                     select new GetListSaleInvoiceDetailReportOutput
                                     {
                                         InvoiceId = inv.Id,
                                         Date = j.Date.Date,
                                         ItemId = invi.ItemId,
                                         ItemCode = "",
                                         ItemName = "",
                                         LocationId = j.LocationId.Value,
                                         LocationName = j.Location.LocationName,
                                         Qty = invi.Qty,
                                         TaxId = invi.TaxId,
                                         TaxName = invi.Tax.TaxName,
                                         TaxRate = invi.Tax.TaxRate,
                                         Total = isFilterByAccountCurrency ? invi.Total : invi.MultiCurrencyTotal,
                                         InvoiceTotal = isFilterByAccountCurrency ? inv.Total : inv.MultiCurrencyTotal,
                                         Paid = 0,
                                         Balance = 0,
                                         UnitPrice = isFilterByAccountCurrency ? invi.UnitCost : invi.MultiCurrencyUnitCost,
                                         CustomerId = inv.CustomerId,
                                         CustomerName = inv.Customer.CustomerName,
                                         CustomerType = inv.Customer.CustomerType != null ? inv.Customer.CustomerType.CustomerTypeName : "",
                                         CustomerTypeId = inv.Customer.CustomerTypeId,
                                         JournalNo = j.JournalNo,
                                         Reference = j.Reference,
                                         User = j.CreatorUser.UserName,
                                         CreationTimeIndex = j.CreationTimeIndex,
                                         CreationTime = invi.CreationTime,
                                         RoundingDigit = currentRoundingDigit,
                                         RoundingDigitUnitCost = currentRoundingDigitUnitCost,
                                         SaleType = inv.TransactionTypeSale != null ? inv.TransactionTypeSale.TransactionTypeName : "",
                                         CurrencyId = isFilterByAccountCurrency ? j.CurrencyId : j.MultiCurrencyId,
                                         CurrencyCode = isFilterByAccountCurrency ? j.Currency.Code : j.MultiCurrency.Code,
                                         AccountId = ji.AccountId,
                                         AccountCode = ji.Account.AccountCode,
                                         AccountName = ji.Account.AccountName,
                                         ReceivePayment = 0,
                                         TotalReceive = 0,
                                         IsPayment = false,
                                         IsItem = inv.IsItem,
                                         Description = invi.Description,

                                         PaidCash = 0,
                                         PaidBank = 0,
                                         PaidCredit = 0,
                                         PaidOther = 0,

                                         ReceiveCash = 0,
                                         ReceiveBank = 0,
                                         ReceiveOther = 0,
                                         ReceiveCredit = 0,

                                         TotalReceiveCash = 0,
                                         TotalReceiveBank = 0,
                                         TotalReceiveOther = 0,
                                         TotalReceiveCredit = 0,
                                     };

            var customerCreditQueryResult = from ji in _journalItemRepository.GetAll()
                                                     .Where(t => t.Identifier != null)
                                                     .WhereIf(input.Accounts != null && input.Accounts.Count > 0, u => input.Accounts.Contains(u.AccountId))
                                                     .WhereIf(input.AccountTypes != null && input.AccountTypes.Count > 0, u => u.Account != null && input.AccountTypes.Contains(u.Account.AccountTypeId))
                                                     .AsNoTracking()

                                            join j in _journalRepository.GetAll()
                                                        .Where(s => s.Status == TransactionStatus.Publish)
                                                        .Where(u => u.JournalType == JournalType.CustomerCredit)
                                                        .WhereIf(input.JournalTypes != null && input.JournalTypes.Any(), s => input.JournalTypes.Contains(s.JournalType))
                                                        .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                                                        .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                                        .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                                        .WhereIf(input.FromDate != null && input.ToDate != null,
                                                               (u => (u.Date.Date) >= (input.FromDate.Date) && (u.Date.Date) <= (input.ToDate.Date)))
                                                        .WhereIf(!input.Filter.IsNullOrEmpty(),
                                                               u => u.JournalNo.ToLower().Contains(input.Filter.ToLower()) ||
                                                                    u.Reference.ToLower().Contains(input.Filter.ToLower()) ||
                                                                    u.Memo.ToLower().Contains(input.Filter.ToLower()))
                                                        .AsNoTracking()
                                            on ji.JournalId equals j.Id

                                            join cc in _customerCreditRepository.GetAll()
                                                    .Where(s => input.SaleTypes == null || !input.SaleTypes.Any())
                                                    .WhereIf(input.Customers != null && input.Customers.Count > 0, u => input.Customers.Contains(u.CustomerId))
                                                    .AsNoTracking()
                                            on j.CustomerCreditId equals cc.Id

                                            join cci in _customerCreditItemRepository.GetAll()
                                                        .Where(s => input.SaleTypes == null || !input.SaleTypes.Any())
                                                        .AsNoTracking()
                                            on ji.Identifier equals cci.Id

                                            select new GetListSaleInvoiceDetailReportOutput
                                            {
                                                InvoiceId = cc.Id,
                                                Date = j.Date.Date,
                                                ItemId = cci.ItemId,
                                                ItemCode = "",
                                                ItemName = "",
                                                LocationId = j.LocationId.Value,
                                                LocationName = j.Location.LocationName,
                                                Qty = -cci.Qty,
                                                TaxId = cci.TaxId,
                                                TaxName = cci.Tax.TaxName,
                                                TaxRate = cci.Tax.TaxRate,
                                                Total = isFilterByAccountCurrency ? -cci.Total : -cci.MultiCurrencyTotal,
                                                InvoiceTotal = isFilterByAccountCurrency ? -cc.Total : -cc.MultiCurrencyTotal,
                                                Paid = 0,
                                                Balance = 0,
                                                UnitPrice = isFilterByAccountCurrency ? cci.UnitCost : cci.MultiCurrencyUnitCost,
                                                CustomerId = cc.CustomerId,
                                                CustomerName = cc.Customer.CustomerName,
                                                CustomerType = cc.Customer.CustomerType != null ? cc.Customer.CustomerType.CustomerTypeName : "",
                                                CustomerTypeId = cc.Customer.CustomerTypeId,
                                                JournalNo = j.JournalNo,
                                                Reference = j.Reference,
                                                User = j.CreatorUser.UserName,
                                                CreationTimeIndex = j.CreationTimeIndex,
                                                CreationTime = cci.CreationTime,
                                                RoundingDigit = currentRoundingDigit,
                                                RoundingDigitUnitCost = currentRoundingDigitUnitCost,
                                                SaleType = "",
                                                CurrencyId = isFilterByAccountCurrency ? j.CurrencyId : j.MultiCurrencyId,
                                                CurrencyCode = isFilterByAccountCurrency ? j.Currency.Code : j.MultiCurrency.Code,
                                                AccountId = ji.AccountId,
                                                AccountCode = ji.Account.AccountCode,
                                                AccountName = ji.Account.AccountName,
                                                ReceivePayment = 0,
                                                TotalReceive = 0,
                                                IsPayment = false,
                                                IsItem = cc.IsItem,
                                                Description = ji.Description,

                                                PaidCash = 0,
                                                PaidBank = 0,
                                                PaidCredit = 0,
                                                PaidOther = 0,

                                                ReceiveCash = 0,
                                                ReceiveBank = 0,
                                                ReceiveOther = 0,
                                                ReceiveCredit = 0,

                                                TotalReceiveCash = 0,
                                                TotalReceiveBank = 0,
                                                TotalReceiveOther = 0,
                                                TotalReceiveCredit = 0,
                                            };

            var pyamentToOldInvoiceQueryResult = from ji in _journalItemRepository.GetAll()
                                                         .Where(t => t.Identifier != null)
                                                         .WhereIf(input.Accounts != null && input.Accounts.Count > 0, u => input.Accounts.Contains(u.AccountId))
                                                         .WhereIf(input.AccountTypes != null && input.AccountTypes.Count > 0, u => u.Account != null && input.AccountTypes.Contains(u.Account.AccountTypeId))
                                                         .AsNoTracking()

                                                 join j in _journalRepository.GetAll()
                                                             .Where(s => s.Status == TransactionStatus.Publish)
                                                             .Where(u => u.JournalType == JournalType.ReceivePayment)
                                                             .WhereIf(input.JournalTypes != null && input.JournalTypes.Any(), s => input.JournalTypes.Contains(s.JournalType))
                                                             .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                                                             .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                                                             .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                                             .WhereIf(input.FromDate != null && input.ToDate != null,
                                                                    (u => (u.Date.Date) >= (input.FromDate.Date) && (u.Date.Date) <= (input.ToDate.Date)))
                                                             .WhereIf(!input.Filter.IsNullOrEmpty(),
                                                                    u => u.JournalNo.ToLower().Contains(input.Filter.ToLower()) ||
                                                                         u.Reference.ToLower().Contains(input.Filter.ToLower()) ||
                                                                         u.Memo.ToLower().Contains(input.Filter.ToLower()))
                                                             .AsNoTracking()
                                                 on ji.JournalId equals j.Id


                                                 join rpi in paymentToOldInvoiceQuery
                                                 .WhereIf(input.SaleTypes != null && input.SaleTypes.Any(), u => u.SaleTypeId.HasValue && input.SaleTypes.Contains(u.SaleTypeId.Value))
                                                 on ji.Identifier equals rpi.Id

                                                 select new GetListSaleInvoiceDetailReportOutput
                                                 {
                                                     InvoiceId = rpi.PaymentId,
                                                     Date = j.Date.Date,
                                                     ItemId = null,
                                                     ItemCode = rpi.PayToInvoiceNo,
                                                     ItemName = $"{rpi.PayToInvoiceDate.ToString("yyyy-MM-dd")}/{rpi.PayToInvoiceNo}",
                                                     LocationId = j.LocationId.Value,
                                                     LocationName = j.Location.LocationName,
                                                     Qty = 0,
                                                     TaxId = 0,
                                                     TaxName = "",
                                                     TaxRate = 0,
                                                     Total = 0,
                                                     InvoiceTotal = 0,
                                                     Paid = 0,
                                                     Balance = 0,
                                                     UnitPrice = 0,
                                                     CustomerId = rpi.CustomerId,
                                                     CustomerName = rpi.CustomerName,
                                                     CustomerType = rpi.CustomerType,
                                                     CustomerTypeId = rpi.CustomerTypeId,
                                                     JournalNo = j.JournalNo,
                                                     Reference = j.Reference,
                                                     User = j.CreatorUser.UserName,
                                                     CreationTimeIndex = j.CreationTimeIndex,
                                                     CreationTime = rpi.CreationTime,
                                                     RoundingDigit = currentRoundingDigit,
                                                     RoundingDigitUnitCost = currentRoundingDigitUnitCost,
                                                     SaleType = rpi.SaleTypeName,
                                                     CurrencyId = isFilterByAccountCurrency ? j.CurrencyId : j.MultiCurrencyId,
                                                     CurrencyCode = isFilterByAccountCurrency ? j.Currency.Code : j.MultiCurrency.Code,
                                                     AccountId = ji.AccountId,
                                                     AccountCode = ji.Account.AccountCode,
                                                     AccountName = ji.Account.AccountName,
                                                     ReceivePayment = rpi.Payment,
                                                     TotalReceive = rpi.Payment,
                                                     IsPayment = true,
                                                     IsItem = rpi.IsItem,
                                                     Description = ji.Description,

                                                     PaidCash = 0,
                                                     PaidBank = 0,
                                                     PaidCredit = 0,
                                                     PaidOther = 0,

                                                     ReceiveCash = rpi.Cash,
                                                     ReceiveBank = rpi.Bank,
                                                     ReceiveOther = rpi.Other + rpi.Expense,
                                                     ReceiveCredit = rpi.Credit,

                                                     TotalReceiveCash = rpi.Cash,
                                                     TotalReceiveBank = rpi.Bank,
                                                     TotalReceiveOther = rpi.Other + rpi.Expense,
                                                     TotalReceiveCredit = rpi.Credit,

                                                 };

            var queryResult = invoiceQueryResult.Concat(customerCreditQueryResult).Concat(pyamentToOldInvoiceQueryResult);

            var userGroupItems = await GetUserGroupItems();

            var itemIds = input.Items == null ? null : input.Items.Where(s => s.HasValue).Select(s => s.Value).ToList();
            var itemQuery = GetItemWithProperties(userGroupItems, itemIds, input.PropertyDics);


            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();
            var customerTypes = input.CustomerTypes;
            if (customerTypeMemberIds.Any())
            {
                customerTypes = customerTypeMemberIds.WhereIf(input.CustomerTypes != null && input.CustomerTypes.Any(), s => input.CustomerTypes.Contains(s)).ToList();
            }


            var invoiceQuery = from q in queryResult
                                        .WhereIf(customerTypes != null && customerTypes.Count() > 0, s => s.CustomerTypeId.HasValue && customerTypes.Contains(s.CustomerTypeId.Value))

                               join cg in customerUserGroup
                               on q.CustomerId equals cg.Id

                               join i in itemQuery
                               on q.ItemId equals i.Id
                               into list
                               from item in list.DefaultIfEmpty()
                               where (input.BillTypes == BillType.SelectAll ||
                                     (input.BillTypes == BillType.Item && q.IsItem) ||
                                     (input.BillTypes == BillType.Account && !q.IsItem))
                                     &&
                                     (
                                        (q.IsItem && item != null) ||
                                        (
                                            (!q.IsItem || q.IsPayment) &&
                                            (input.Items == null || input.Items.Count == 0) &&
                                            (input.PropertyDics == null || input.PropertyDics.Count == 0)
                                        )
                                     )

                               let itemCode = q.IsPayment ? q.ItemCode : item != null ? item.ItemCode : q.AccountCode
                               let itemName = q.IsPayment ? q.ItemName : item != null ? item.ItemName : q.AccountName
                               let properties = item == null ? new List<Inventories.Data.ItemPropertySummary>() : item.Properties
                               let netWeight = item == null || item.Properties == null ? 0 : item.Properties
                                               .Where(t => t.IsUnit).Select(t => t.NetWeight * q.Qty).FirstOrDefault()
                               select new GetListSaleInvoiceDetailReportOutput
                               {
                                   InvoiceId = q.InvoiceId,
                                   Date = q.Date,
                                   ItemId = q.ItemId,
                                   ItemCode = itemCode,
                                   ItemName = itemName,
                                   LocationId = q.LocationId,
                                   LocationName = q.LocationName,
                                   Qty = q.Qty,
                                   TaxId = q.TaxId,
                                   TaxName = q.TaxName,
                                   TaxRate = q.TaxRate,
                                   Total = q.Total,
                                   InvoiceTotal = q.InvoiceTotal,
                                   Paid = q.Paid,
                                   Balance = q.Balance,
                                   UnitPrice = q.UnitPrice,
                                   CustomerId = q.CustomerId,
                                   CustomerName = q.CustomerName,
                                   CustomerType = q.CustomerType,
                                   CustomerTypeId = q.CustomerTypeId,
                                   JournalNo = q.JournalNo,
                                   Reference = q.Reference,
                                   User = q.User,
                                   CreationTimeIndex = q.CreationTimeIndex,
                                   CreationTime = q.CreationTime,
                                   RoundingDigit = q.RoundingDigit,
                                   RoundingDigitUnitCost = q.RoundingDigitUnitCost,
                                   SaleType = q.SaleType,
                                   CurrencyId = q.CurrencyId,
                                   CurrencyCode = q.CurrencyCode,
                                   AccountId = q.AccountId,
                                   AccountCode = q.AccountCode,
                                   AccountName = q.AccountName,
                                   ReceivePayment = q.ReceivePayment,
                                   TotalReceive = q.TotalReceive,
                                   IsPayment = q.IsPayment,
                                   IsItem = q.IsItem,
                                   Description = q.Description,

                                   PaidCash = q.PaidCash,
                                   PaidBank = q.PaidBank,
                                   PaidCredit = q.PaidCredit,
                                   PaidOther = q.PaidOther,

                                   ReceiveCash = q.ReceiveCash,
                                   ReceiveBank = q.ReceiveBank,
                                   ReceiveOther = q.ReceiveOther,
                                   ReceiveCredit = q.ReceiveCredit,

                                   TotalReceiveCash = q.TotalReceiveCash,
                                   TotalReceiveBank = q.TotalReceiveBank,
                                   TotalReceiveOther = q.TotalReceiveOther,
                                   TotalReceiveCredit = q.TotalReceiveCredit,
                                   NetWeight = netWeight,
                                   Properties = properties
                               };


            queryResult = invoiceQuery;

            //Query 1
            var currencyColumns = (await queryResult.Select(s => new { s.CurrencyId, s.CurrencyCode }).Distinct().ToListAsync()).OrderBy(r => r.CurrencyCode);


            if (input.GroupBy == "JournalNo")
            {
                var paymentQuery = paymentQueries
                                   .Where(s => s.PayToInvoiceDate >= input.FromDate.Date)
                                   .GroupBy(s => s.TransactionId)
                                   .Select(s => new
                                   {
                                       Id = s.Key,
                                       Payment = s.Sum(r => r.Payment),
                                       Cash = s.Sum(r => r.Cash),
                                       Bank = s.Sum(r => r.Bank),
                                       Credit = s.Sum(r => r.Credit),
                                       Other = s.Sum(r => r.Other + r.Expense),
                                   });

                var invoiceItemQuery = from invi in queryResult

                                       join ip in paymentQuery
                                       on invi.InvoiceId equals ip.Id
                                       into payment
                                       from pay in payment.DefaultIfEmpty()

                                       let totalPaid = pay != null ? pay.Payment : 0
                                       let totalReceiveCash = pay != null ? pay.Cash : 0
                                       let totalReceiveBank = pay != null ? pay.Bank : 0
                                       let totalReceiveCredit = pay != null ? pay.Credit : 0
                                       let totalReceiveOther = pay != null ? pay.Other : 0

                                       select new GetListSaleInvoiceDetailReportOutput
                                       {
                                           InvoiceId = invi.InvoiceId,
                                           Date = invi.Date,
                                           AccountName = invi.AccountName,
                                           AccountId = invi.AccountId,
                                           AccountCode = invi.AccountCode,
                                           ItemId = invi.ItemId,
                                           ItemCode = invi.ItemCode,
                                           ItemName = invi.ItemName,
                                           LocationId = invi.LocationId,
                                           LocationName = invi.LocationName,
                                           Qty = invi.Qty,
                                           TaxId = invi.TaxId,
                                           TaxName = invi.TaxName,
                                           TaxRate = invi.TaxRate,
                                           Total = invi.Total,
                                           UnitPrice = invi.UnitPrice,
                                           CustomerId = invi.CustomerId,
                                           CustomerName = invi.CustomerName,
                                           CustomerType = invi.CustomerType,
                                           Reference = invi.Reference,
                                           JournalNo = invi.JournalNo,
                                           User = invi.User,
                                           CreationTimeIndex = invi.CreationTimeIndex,
                                           CreationTime = invi.CreationTime,
                                           RoundingDigit = invi.RoundingDigit,
                                           RoundingDigitUnitCost = invi.RoundingDigitUnitCost,
                                           SaleType = invi.SaleType,
                                           CurrencyId = invi.CurrencyId,
                                           CurrencyCode = invi.CurrencyCode,
                                           InvoiceTotal = invi.InvoiceTotal,
                                           Paid = totalPaid,
                                           Balance = invi.InvoiceTotal - totalPaid,
                                           ReceivePayment = invi.ReceivePayment,
                                           TotalReceive = invi.IsPayment ? invi.TotalReceive : totalPaid,
                                           IsPayment = invi.IsPayment,
                                           IsItem = invi.IsItem,
                                           Description = invi.Description,

                                           PaidCash = totalReceiveCash,
                                           PaidBank = totalReceiveBank,
                                           PaidCredit = totalReceiveCredit,
                                           PaidOther = totalReceiveOther,

                                           ReceiveCash = invi.ReceiveCash,
                                           ReceiveBank = invi.ReceiveBank,
                                           ReceiveCredit = invi.ReceiveCredit,
                                           ReceiveOther = invi.ReceiveOther,

                                           TotalReceiveCash = invi.IsPayment ? invi.ReceiveCash : totalReceiveCash,
                                           TotalReceiveBank = invi.IsPayment ? invi.ReceiveBank : totalReceiveBank,
                                           TotalReceiveCredit = invi.IsPayment ? invi.ReceiveCredit : totalReceiveCredit,
                                           TotalReceiveOther = invi.IsPayment ? invi.ReceiveOther : totalReceiveOther,
                                           NetWeight = invi.NetWeight,
                                           Properties = invi.Properties
                                       };

                queryResult = invoiceItemQuery;

            }

            var query = from q in queryResult
                        select new GetListSaleInvoiceDetailReportOutput
                        {
                            Date = q.Date,
                            AccountName = q.AccountName,
                            AccountId = q.AccountId,
                            AccountCode = q.AccountCode,
                            ItemId = q.ItemId,

                            ItemCode = q.ItemCode,
                            ItemName = q.ItemName,

                            LocationId = q.LocationId,
                            LocationName = q.LocationName,
                            Qty = q.Qty,
                            TaxId = q.TaxId,
                            TaxName = q.TaxName,
                            TaxRate = q.TaxRate,
                            Total = q.Total,
                            InvoiceTotal = q.InvoiceTotal,
                            Paid = q.Paid,
                            Balance = q.Balance,
                            ReceivePayment = q.ReceivePayment,
                            TotalReceive = q.TotalReceive,
                            IsPayment = q.IsPayment,
                            IsItem = q.IsItem,
                            UnitPrice = q.UnitPrice,
                            CustomerId = q.CustomerId,
                            CustomerName = q.CustomerName,
                            CustomerType = q.CustomerType,
                            Reference = q.Reference,
                            JournalNo = q.JournalNo,
                            InvoiceId = q.InvoiceId,
                            User = q.User,
                            CreationTimeIndex = q.CreationTimeIndex,
                            CreationTime = q.CreationTime,
                            RoundingDigit = currentRoundingDigit,
                            RoundingDigitUnitCost = currentRoundingDigitUnitCost,
                            SaleType = q.SaleType,
                            Properties = q.Properties,
                            NetWeight = q.NetWeight,
                            Description = q.Description,
                            CurrencyColumnTotals = currencyColumns.Select(s => new CurrencyColumnTotal
                            {
                                CurrencyId = s.CurrencyId.Value,
                                CurrencyCode = s.CurrencyCode,
                                Total = s.CurrencyId == q.CurrencyId ? q.Total : 0,
                                Paid = s.CurrencyId == q.CurrencyId ? q.Paid : 0,
                                Balance = s.CurrencyId == q.CurrencyId ? q.Balance : 0,
                                ReceivePayment = s.CurrencyId == q.CurrencyId ? q.ReceivePayment : 0,
                                TotalReceive = s.CurrencyId == q.CurrencyId ? q.TotalReceive : 0,

                                PaidCash = s.CurrencyId == q.CurrencyId ? q.PaidCash : 0,
                                PaidBank = s.CurrencyId == q.CurrencyId ? q.PaidBank : 0,
                                PaidCredit = s.CurrencyId == q.CurrencyId ? q.PaidCredit : 0,
                                PaidOther = s.CurrencyId == q.CurrencyId ? q.PaidOther : 0,

                                ReceiveCash = s.CurrencyId == q.CurrencyId ? q.ReceiveCash : 0,
                                ReceiveBank = s.CurrencyId == q.CurrencyId ? q.ReceiveBank : 0,
                                ReceiveCredit = s.CurrencyId == q.CurrencyId ? q.ReceiveCredit : 0,
                                ReceiveOther = s.CurrencyId == q.CurrencyId ? q.ReceiveOther : 0,

                                TotalReceiveCash = s.CurrencyId == q.CurrencyId ? q.TotalReceiveCash : 0,
                                TotalReceiveBank = s.CurrencyId == q.CurrencyId ? q.TotalReceiveBank : 0,
                                TotalReceiveCredit = s.CurrencyId == q.CurrencyId ? q.TotalReceiveCredit : 0,
                                TotalReceiveOther = s.CurrencyId == q.CurrencyId ? q.TotalReceiveOther : 0,

                            }).ToList(),

                            PaidCash = q.PaidCash,
                            PaidBank = q.PaidBank,
                            PaidCredit = q.PaidCredit,
                            PaidOther = q.PaidOther,

                            ReceiveCash = q.ReceiveCash,
                            ReceiveBank = q.ReceiveBank,
                            ReceiveOther = q.ReceiveOther,
                            ReceiveCredit = q.ReceiveCredit,

                            TotalReceiveCash = q.TotalReceiveCash,
                            TotalReceiveBank = q.TotalReceiveBank,
                            TotalReceiveOther = q.TotalReceiveOther,
                            TotalReceiveCredit = q.TotalReceiveCredit,

                        };



            var resultCount = 0;

            List<SaleSummaryOut> sumQuery = null;

            if (input.IsLoadMore == false)
            {
                //Query 2  
                if (input.ColumnNamesToSum != null)
                {
                    sumQuery = await query.Select(s => new SaleSummaryOut
                    {
                        InvoiceId = s.InvoiceId,
                        JournalNo = s.JournalNo,
                        Total = s.Total,
                        Paid = s.Paid,
                        Balance = s.Balance,
                        CurrencyColumnTotals = s.CurrencyColumnTotals,
                        Qty = s.Qty,
                        ReceivePayment = s.ReceivePayment,
                        TotalReceive = s.TotalReceive,
                        NetWeight = s.NetWeight,

                        PaidCash = s.PaidCash,
                        PaidBank = s.PaidBank,
                        PaidCredit = s.PaidCredit,
                        PaidOther = s.PaidOther,
                        ReceiveCash = s.ReceiveCash,
                        ReceiveBank = s.ReceiveBank,
                        ReceiveCredit = s.ReceiveCredit,
                        ReceiveOther = s.ReceiveOther,
                        TotalReceiveCash = s.TotalReceiveCash,
                        TotalReceiveBank = s.TotalReceiveBank,
                        TotalReceiveCredit = s.TotalReceiveCredit,
                        TotalReceiveOther = s.TotalReceiveOther
                    }).ToListAsync();

                    resultCount = sumQuery.Count();
                }
                else
                {
                    resultCount = await query.CountAsync();
                }
            }
            var sumOfColumns = new Dictionary<string, decimal>();
            var multiCurrencySumOfColumns = new Dictionary<string, Dictionary<string, decimal>>();

            if (resultCount == 0 && !input.IsLoadMore)
            {
                var rs = new PagedResultWithTotalColuumnsDto<GetListSaleInvoiceDetailReportOutput>(resultCount, new List<GetListSaleInvoiceDetailReportOutput>(), multiCurrencySumOfColumns);
                rs.TotalResult = sumOfColumns;
                return rs;
            }

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                var sumPaidBalanceQuery = sumQuery.GroupBy(g => g.JournalNo).Select(s => s.First()).ToList();

                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "NetWeight")
                    {
                        sumOfColumns.Add(col, sumQuery.Sum(u => u.NetWeight));
                    }
                    else if (col == "Qty")
                    {
                        sumOfColumns.Add(col, sumQuery.Sum(u => u.Qty));
                    }
                    else if (col == "Total" || col == "ReceivePayment" || col == "ReceiveCash" || col == "ReceiveBank" || col == "ReceiveCredit" || col == "ReceiveOther")
                    {
                        if (col == "ReceiveCredit")
                        {

                        }
                        if (!isFilterByAccountCurrency)
                        {
                            var sumList = sumQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => col == "Total" ? s.Total : col == "ReceiveCash" ? s.ReceiveCash : col == "ReceiveBank" ? s.ReceiveBank : col == "ReceiveCredit" ? s.ReceiveCredit : col == "ReceiveOther" ? s.ReceiveOther : s.ReceivePayment),
                            }).ToDictionary(u => u.CurrencyCode);

                            var multiSumOfColumns = new Dictionary<string, decimal>();
                            foreach (var c in currencyColumns)
                            {
                                multiSumOfColumns.Add(c.CurrencyCode, groupByCurrencyDict.ContainsKey(c.CurrencyCode) ? groupByCurrencyDict[c.CurrencyCode].Total : 0);
                            }

                            multiCurrencySumOfColumns.Add(col, multiSumOfColumns);
                        }
                        else
                        {
                            sumOfColumns.Add(col, sumQuery.Sum(u => col == "Total" ? u.Total : col == "ReceiveCash" ? u.ReceiveCash : col == "ReceiveBank" ? u.ReceiveBank : col == "ReceiveCredit" ? u.ReceiveCredit : col == "ReceiveOther" ? u.ReceiveOther : u.ReceivePayment));
                        }
                    }
                    else if (col == "TotalReceive" || col == "TotalReceiveCash" || col == "TotalReceiveBank" || col == "TotalReceiveCredit" || col == "TotalReceiveOther")
                    {
                        if (!isFilterByAccountCurrency)
                        {
                            var sumReceivePaymentList = sumQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var receivePaymentGroupByCurrencyDict = sumReceivePaymentList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => col == "TotalReceiveCash" ? s.ReceiveCash : col == "TotalReceiveBank" ? s.ReceiveBank : col == "TotalReceiveCredit" ? s.ReceiveCredit : col == "TotalReceiveOther" ? s.ReceiveOther : s.ReceivePayment),
                            }).ToDictionary(u => u.CurrencyCode);

                            var sumPaidList = sumPaidBalanceQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var paidGroupByCurrencyDict = sumPaidList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => col == "TotalReceiveCash" ? s.PaidCash : col == "TotalReceiveBank" ? s.PaidBank : col == "TotalReceiveCredit" ? s.PaidCredit : col == "TotalReceiveOther" ? s.PaidOther : s.Paid),
                            }).ToDictionary(u => u.CurrencyCode);

                            var multiSumOfColumns = new Dictionary<string, decimal>();
                            foreach (var c in currencyColumns)
                            {
                                var totalReceive = receivePaymentGroupByCurrencyDict.ContainsKey(c.CurrencyCode) ? receivePaymentGroupByCurrencyDict[c.CurrencyCode].Total : 0;
                                var totalPaid = paidGroupByCurrencyDict.ContainsKey(c.CurrencyCode) ? paidGroupByCurrencyDict[c.CurrencyCode].Total : 0;

                                multiSumOfColumns.Add(c.CurrencyCode, totalReceive + totalPaid);
                            }

                            multiCurrencySumOfColumns.Add(col, multiSumOfColumns);
                        }
                        else
                        {
                            var total = sumQuery.Sum(s => col == "TotalReceiveCash" ? s.ReceiveCash : col == "TotalReceiveBank" ? s.ReceiveBank : col == "TotalReceiveCredit" ? s.ReceiveCredit : col == "TotalReceiveOther" ? s.ReceiveOther : s.ReceivePayment) +
                                        sumPaidBalanceQuery.Sum(s => col == "TotalReceiveCash" ? s.PaidCash : col == "TotalReceiveBank" ? s.PaidBank : col == "TotalReceiveCredit" ? s.PaidCredit : col == "TotalReceiveOther" ? s.PaidOther : s.Paid);
                            sumOfColumns.Add(col, total);
                        }
                    }
                    else
                    {
                        if (!isFilterByAccountCurrency)
                        {
                            var sumList = sumPaidBalanceQuery.SelectMany(u => u.CurrencyColumnTotals).ToList();
                            var groupByCurrencyDict = sumList.GroupBy(u => u.CurrencyCode).Select(u => new
                            {
                                CurrencyCode = u.Key,
                                Total = u.Sum(s => col == "Paid" ? s.Paid : col == "PaidCash" ? s.PaidCash : col == "PaidBank" ? s.PaidBank : col == "PaidCredit" ? s.PaidCredit : col == "PaidOther" ? s.PaidOther : s.Balance),
                            }).ToDictionary(u => u.CurrencyCode);

                            var multiSumOfColumns = new Dictionary<string, decimal>();
                            foreach (var c in currencyColumns)
                            {
                                multiSumOfColumns.Add(c.CurrencyCode, groupByCurrencyDict.ContainsKey(c.CurrencyCode) ? groupByCurrencyDict[c.CurrencyCode].Total : 0);
                            }

                            multiCurrencySumOfColumns.Add(col, multiSumOfColumns);
                        }
                        else
                        {
                            sumOfColumns.Add(col, sumPaidBalanceQuery.Sum(u => col == "Paid" ? u.Paid : col == "PaidCash" ? u.PaidCash : col == "PaidBank" ? u.PaidBank : col == "PaidCredit" ? u.PaidCredit : col == "PaidOther" ? u.PaidOther : u.Balance));
                        }
                    }
                }
            }

            switch (input.GroupBy)
            {
                case "Item":
                    query = query.OrderBy(s => s.ItemCode).ThenBy(s => s.CreationTimeIndex).ThenBy(s => s.CreationTime);
                    break;
                case "Date":
                    query = query.OrderBy(s => s.Date).ThenBy(s => s.CreationTimeIndex).ThenBy(s => s.CreationTime);
                    break;
                case "Location":
                    query = query.OrderBy(s => s.LocationId).ThenBy(s => s.CreationTimeIndex).ThenBy(s => s.CreationTime);
                    break;
                case "Customer":
                    query = query.OrderBy(s => s.CustomerId).ThenBy(s => s.CreationTimeIndex).ThenBy(s => s.CreationTime);
                    break;
                case "Account":
                    query = query.OrderBy(s => s.AccountCode).ThenBy(s => s.CreationTimeIndex).ThenBy(s => s.CreationTime);
                    break;
                default:
                    query = query.OrderBy(input.Sorting).ThenBy(s => s.CreationTimeIndex).ThenBy(s => s.CreationTime);
                    break;
            }

            var @entities = new List<GetListSaleInvoiceDetailReportOutput>();
            if (input.UsePagination == true)
            {
                @entities = await query.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await query.ToListAsync();
            }

            var returnResult = new PagedResultWithTotalColuumnsDto<GetListSaleInvoiceDetailReportOutput>(resultCount, @entities, multiCurrencySumOfColumns);
            returnResult.TotalResult = sumOfColumns;

            return returnResult;
        }




        public ReportOutput GetReportTemplateSaleInvoiceDetail()
        {
            var itemPropertyCols = _propertyRepository.GetAll().AsNoTracking()
                             .Where(t => t.IsActive == true)
                             .Select(t => new CollumnOutput
                             {
                                 AllowGroupby = false,
                                 AllowFilter = true,
                                 ColumnName = t.Name,
                                 ColumnLength = 150,
                                 ColumnTitle = t.Name,
                                 ColumnType = ColumnType.ItemProperty,
                                 SortOrder = 11,
                                 Visible = true,
                                 AllowFunction = null,
                                 MoreFunction = null,
                                 IsDisplay = true,
                                 AllowShowHideFilter = true,
                                 ShowHideFilter = true,
                                 DefaultValue = t.Id.ToString(),//to init the value of property
                             });

            var columns = new List<CollumnOutput>() {
                     // start properties with can filter
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Search",
                        ColumnLength = 150,
                        ColumnTitle = "Search",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DateRange",
                        ColumnLength = 150,
                        ColumnTitle = "DateRange",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        DefaultValue = "thisMonth",
                        AllowFunction = null,
                        DisableDefault = false,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "InvoiceType",
                        ColumnLength = 300,
                        ColumnTitle = "InvoiceType",
                        ColumnType = ColumnType.String,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "JournalType",
                        ColumnLength = 300,
                        ColumnTitle = "Journal Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Item",
                        ColumnLength = 300,
                        ColumnTitle = "Item",
                        ColumnType = ColumnType.String,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = false,
                        ColumnName = "Date",
                        ColumnLength = 100,
                        ColumnTitle = "Date",
                        ColumnType = ColumnType.Date,
                        SortOrder = 1,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                     },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = false,
                        ColumnName = "JournalNo",
                        ColumnLength = 120,
                        ColumnTitle = "Journal No",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Reference",
                        ColumnLength = 100,
                        ColumnTitle = "Reference",
                        ColumnType = ColumnType.String,
                        SortOrder = 3,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Customer",
                        ColumnLength = 120,
                        ColumnTitle = "Customer",
                        ColumnType = ColumnType.String,
                        SortOrder = 4,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                       new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "AccountType",
                        ColumnLength = 300,
                        ColumnTitle = "AccountType",
                        ColumnType = ColumnType.String,
                        SortOrder = 5,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Account",
                        ColumnLength = 120,
                        ColumnTitle = "Account",
                        ColumnType = ColumnType.String,
                        SortOrder = 6,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Location",
                        ColumnLength = 120,
                        ColumnTitle = "Location",
                        ColumnType = ColumnType.String,
                        SortOrder = 7,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Tax",
                        ColumnLength = 100,
                        ColumnTitle = "Tax Name",
                        ColumnType = ColumnType.String,
                        SortOrder = 8,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TaxRate",
                        ColumnLength = 80,
                        ColumnTitle = "Tax Rate",
                        ColumnType = ColumnType.Money,
                        SortOrder = 9,
                        Visible = true,
                        //AllowFunction = "Sum",
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ItemCode",
                        ColumnLength = 120,
                        ColumnTitle = "Item Code",
                        ColumnType = ColumnType.String,
                        SortOrder = 10,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ItemName",
                        ColumnLength = 120,
                        ColumnTitle = "Item Name",
                        ColumnType = ColumnType.String,
                        SortOrder = 11,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Description",
                        ColumnLength = 120,
                        ColumnTitle = "Description",
                        ColumnType = ColumnType.String,
                        SortOrder = 12,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "UnitPrice",
                        ColumnLength = 100,
                        ColumnTitle = "Unit Price",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 12,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Qty",
                        ColumnLength = 100,
                        ColumnTitle = "Qty",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 13,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                         AllowFunction = null,
                         MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Total",
                        ColumnLength = 150,
                        ColumnTitle = "Total",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 14,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "PaidCash",
                        ColumnLength = 150,
                        ColumnTitle = "Paid Cash",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 15,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "PaidBank",
                        ColumnLength = 150,
                        ColumnTitle = "Paid Bank",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 15,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                        new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "PaidCredit",
                        ColumnLength = 150,
                        ColumnTitle = "Paid Credit",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 15,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "PaidOther",
                        ColumnLength = 150,
                        ColumnTitle = "Paid Other",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 15,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Balance",
                        ColumnLength = 150,
                        ColumnTitle = "Balance",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 16,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ReceiveCash",
                        ColumnLength = 150,
                        ColumnTitle = "Receive Cash",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 17,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ReceiveBank",
                        ColumnLength = 150,
                        ColumnTitle = "Receive Bank",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 17,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                       new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ReceiveCredit",
                        ColumnLength = 150,
                        ColumnTitle = "Receive Credit",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 17,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "ReceiveOther",
                        ColumnLength = 150,
                        ColumnTitle = "Receive Other",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 17,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalReceiveCash",
                        ColumnLength = 150,
                        ColumnTitle = "Total Receive Cash",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 18,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalReceiveBank",
                        ColumnLength = 150,
                        ColumnTitle = "Total Receive Bank",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 18,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                        new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalReceiveCredit",
                        ColumnLength = 150,
                        ColumnTitle = "Total Receive Credit",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 18,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalReceiveOther",
                        ColumnLength = 150,
                        ColumnTitle = "Total Receive Other",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 18,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "NetWeight",
                        ColumnLength = 150,
                        ColumnTitle = "Net Weight",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 19,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true
                    },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "User",
                        ColumnLength = 100,
                        ColumnTitle = "User",
                        ColumnType = ColumnType.String,
                        SortOrder = 20,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "CustomerType",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 21,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                       new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "SaleType",
                        ColumnLength = 150,
                        ColumnTitle = "SaleType",
                        ColumnType = ColumnType.String,
                        SortOrder = 22,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columns.Concat(itemPropertyCols).ToList(),
                Groupby = "",
                HeaderTitle = "Sale Invoice Detail",
                Sortby = "",
            };

            if (!FeatureChecker.IsEnabled(AppFeatures.AccountingFeature))
            {
                result.ColumnInfo = result.ColumnInfo.Where(s =>
                    s.ColumnName != "Account" &&
                    s.ColumnName != "AccountType").ToList();
            }

            var isMultiCurrency = _multiCurrencyRepository.GetAll().Any();

            if (isMultiCurrency)
            {
                var currency = new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Currency",
                    ColumnLength = 140,
                    ColumnTitle = "Currency",
                    ColumnType = ColumnType.String,
                    SortOrder = 3,
                    Visible = true,
                    IsDisplay = false,
                    DisableDefault = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                };
                result.ColumnInfo.Add(currency);
            }


            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleInvoiceDetail_Export_Excel)]
        public async Task<FileDto> ExportExcelSaleInvoiceDetailReport(GetSaleInvoiceDetailReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var saleInvoiceData = (await GetSaleInvoiceDetailReport(input)).Items;

            if (input.GroupBy == "JournalNo")
            {
                var journalNo = string.Empty;
                saleInvoiceData = saleInvoiceData.Select(s =>
                {
                    var item = s;
                    if (journalNo == item.JournalNo)
                    {
                        item.Paid = 0;
                        item.Balance = 0;

                        item.PaidCash = 0;
                        item.PaidBank = 0;
                        item.PaidCredit = 0;
                        item.PaidOther = 0;

                        if (!item.IsPayment)
                        {
                            item.ReceivePayment = 0;
                            item.TotalReceive = 0;

                            item.ReceiveCash = 0;
                            item.ReceiveBank = 0;
                            item.ReceiveCredit = 0;
                            item.ReceiveOther = 0;

                            item.TotalReceiveCash = 0;
                            item.TotalReceiveBank = 0;
                            item.TotalReceiveCredit = 0;
                            item.TotalReceiveOther = 0;
                        }

                        item.CurrencyColumnTotals = s.CurrencyColumnTotals.Select(m =>
                        {
                            var col = m;
                            col.Paid = 0;
                            col.Balance = 0;

                            col.PaidCash = 0;
                            col.PaidBank = 0;
                            col.PaidCredit = 0;
                            col.PaidOther = 0;

                            if (!item.IsPayment)
                            {
                                col.TotalReceive = 0;
                                col.ReceivePayment = 0;

                                col.TotalReceiveCash = 0;
                                col.TotalReceiveBank = 0;
                                col.TotalReceiveCredit = 0;
                                col.TotalReceiveOther = 0;

                                col.ReceiveCash = 0;
                                col.ReceiveBank = 0;
                                col.ReceiveCredit = 0;
                                col.ReceiveOther = 0;
                            }

                            return col;
                        }).ToList();
                    }
                    journalNo = item.JournalNo;
                    return item;
                }).ToList();
            }

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                var subCols = saleInvoiceData == null ? null : saleInvoiceData.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
                var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString("dd-MM-yyyy");
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    if (isMultiCurrencies)
                    {
                        if (i.ColumnName == "Total" || i.ColumnName == "Paid" || i.ColumnName == "Balance" || i.ColumnName == "ReceivePayment" || i.ColumnName == "TotalReceive" ||
                            i.ColumnName == "PaidCash" || i.ColumnName == "PaidBank" || i.ColumnName == "PaidCredit" || i.ColumnName == "PaidOther" ||
                            i.ColumnName == "ReceiveCash" || i.ColumnName == "ReceiveBank" || i.ColumnName == "ReceiveCredit" || i.ColumnName == "ReceiveOther" ||
                            i.ColumnName == "TotalReceiveCash" || i.ColumnName == "TotalReceiveBank" || i.ColumnName == "TotalReceiveCredit" || i.ColumnName == "TotalReceiveOther")
                        {
                            var colWidth = i.ColumnLength;
                            var subColWidth = i.ColumnLength / subCols.Count();

                            AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                            ws.Column(colHeaderTable).Width = ConvertPixelToInches(colWidth);
                            MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader, colHeaderTable + subCols.Count() - 1, ExcelHorizontalAlignment.Center);

                            foreach (var subCol in subCols)
                            {
                                AddTextToCell(ws, rowTableHeader + 1, colHeaderTable, subCol, true);
                                ws.Column(colHeaderTable).Width = ConvertPixelToInches(subColWidth);
                                colHeaderTable += 1;
                            }
                        }
                        else
                        {
                            AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                            ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                            MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader + 1, colHeaderTable, ExcelHorizontalAlignment.Center);
                            colHeaderTable += 1;
                        }
                    }
                    else
                    {
                        AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                        ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                        colHeaderTable += 1;
                    }

                }

                if (isMultiCurrencies) rowTableHeader += 1;
                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                var groupBy = new List<GetListSaleInvoiceDetailReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Account":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.AccountId)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.AccountName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Customer":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.Date)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString()).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Item":
                            groupBy = saleInvoiceData
                                .GroupBy(t => t.ItemId)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.ItemCode != null ? x.ItemCode + "-" + x.ItemName : "").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "JournalNo":
                            groupBy = saleInvoiceData
                               .GroupBy(t => t.JournalNo)
                               .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                               {
                                   KeyName = t.Select(x => x.JournalNo).FirstOrDefault(),
                                   Items = t.Select(x => x).ToList()
                               })
                               .ToList();
                            break;
                    }
                }
                // write body

                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0)
                {
                    foreach (var k in groupBy)
                    {
                        //key group by name
                        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                        rowBody += 1;
                        count = 1;
                        //list of item
                        foreach (var i in k.Items)
                        {
                            int collumnCellBody = 1;
                            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                            {
                                if ((item.ColumnName == "Total" || item.ColumnName == "Paid" || item.ColumnName == "Balance" || item.ColumnName == "ReceivePayment" || item.ColumnName == "TotalReceive" ||
                                    item.ColumnName == "PaidCash" || item.ColumnName == "PaidBank" || item.ColumnName == "PaidCredit" || item.ColumnName == "PaidOther" ||
                                    item.ColumnName == "ReceiveCash" || item.ColumnName == "ReceiveBank" || item.ColumnName == "ReceiveCredit" || item.ColumnName == "ReceiveOther" ||
                                    item.ColumnName == "TotalReceiveCash" || item.ColumnName == "TotalReceiveBank" || item.ColumnName == "TotalReceiveCredit" || item.ColumnName == "TotalReceiveOther") && isMultiCurrencies)
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        var model = i.CurrencyColumnTotals.FirstOrDefault(s => s.CurrencyCode == subCol);
                                        var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);
                                        var value = cellValue ?? 0;
                                        AddCellValue(ws, rowBody, collumnCellBody, item, value, i.RoundingDigit);
                                        collumnCellBody += 1;
                                    }
                                }
                                else
                                {
                                    WriteBodySaleInvoiceDetail(ws, rowBody, collumnCellBody, item, i, count);
                                    collumnCellBody += 1;
                                }
                            }
                            rowBody += 1;
                            count += 1;
                        }

                        //sub total of group by item
                        int collumnCellGroupBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (item.AllowFunction != null)
                            {
                                if ((item.ColumnName == "Total" || item.ColumnName == "Paid" || item.ColumnName == "Balance" || item.ColumnName == "ReceivePayment" || item.ColumnName == "TotalReceive" ||
                                    item.ColumnName == "PaidCash" || item.ColumnName == "PaidBank" || item.ColumnName == "PaidCredit" || item.ColumnName == "PaidOther" ||
                                    item.ColumnName == "ReceiveCash" || item.ColumnName == "ReceiveBank" || item.ColumnName == "ReceiveCredit" || item.ColumnName == "ReceiveOther" ||
                                    item.ColumnName == "TotalReceiveCash" || item.ColumnName == "TotalReceiveBank" || item.ColumnName == "TotalReceiveCredit" || item.ColumnName == "TotalReceiveOther") && isMultiCurrencies)
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                        var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);

                                        var colKey = item.ColumnName + "-" + subCol;
                                        if (footerGroupDict.ContainsKey(colKey))
                                        {
                                            footerGroupDict[colKey] += fromCell + ":" + toCell + ",";
                                        }
                                        else
                                        {
                                            footerGroupDict.Add(colKey, fromCell + ":" + toCell + ",");
                                        }

                                        AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);

                                        collumnCellGroupBody++;
                                    }

                                    collumnCellGroupBody--;
                                }
                                else
                                {
                                    var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                    var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);

                                    if (footerGroupDict.ContainsKey(item.ColumnName))
                                    {
                                        footerGroupDict[item.ColumnName] += fromCell + ":" + toCell + ",";
                                    }
                                    else
                                    {
                                        footerGroupDict.Add(item.ColumnName, fromCell + ":" + toCell + ",");
                                    }

                                    AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }

                            }
                            collumnCellGroupBody += 1;
                        }
                        rowBody += 1;
                    }
                }
                else
                {
                    foreach (var i in saleInvoiceData)
                    {
                        int collumnCellBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if ((item.ColumnName == "Total" || item.ColumnName == "Paid" || item.ColumnName == "Balance" || item.ColumnName == "ReceivePayment" || item.ColumnName == "TotalReceive" ||
                                    item.ColumnName == "PaidCash" || item.ColumnName == "PaidBank" || item.ColumnName == "PaidCredit" || item.ColumnName == "PaidOther" ||
                                    item.ColumnName == "ReceiveCash" || item.ColumnName == "ReceiveBank" || item.ColumnName == "ReceiveCredit" || item.ColumnName == "ReceiveOther" ||
                                    item.ColumnName == "TotalReceiveCash" || item.ColumnName == "TotalReceiveBank" || item.ColumnName == "TotalReceiveCredit" || item.ColumnName == "TotalReceiveOther") && isMultiCurrencies)
                            {
                                foreach (var subCol in subCols)
                                {
                                    var model = i.CurrencyColumnTotals.FirstOrDefault(s => s.CurrencyCode == subCol);
                                    var cellValue = model.GetType().GetProperty(item.ColumnName)?.GetValue(model, null);
                                    var value = cellValue ?? 0;
                                    AddCellValue(ws, rowBody, collumnCellBody, item, value, i.RoundingDigit);
                                    collumnCellBody += 1;
                                }
                            }
                            else
                            {
                                WriteBodySaleInvoiceDetail(ws, rowBody, collumnCellBody, item, i, count);
                                collumnCellBody += 1;
                            }

                        }
                        rowBody += 1;
                        count += 1;
                    }
                }
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (!input.GroupBy.IsNullOrWhiteSpace())
                            {
                                if ((i.ColumnName == "Total" || i.ColumnName == "Paid" || i.ColumnName == "Balance" || i.ColumnName == "ReceivePayment" || i.ColumnName == "TotalReceive" ||
                                    i.ColumnName == "PaidCash" || i.ColumnName == "PaidBank" || i.ColumnName == "PaidCredit" || i.ColumnName == "PaidOther" ||
                                    i.ColumnName == "ReceiveCash" || i.ColumnName == "ReceiveBank" || i.ColumnName == "ReceiveCredit" || i.ColumnName == "ReceiveOther" ||
                                    i.ColumnName == "TotalReceiveCash" || i.ColumnName == "TotalReceiveBank" || i.ColumnName == "TotalReceiveCredit" || i.ColumnName == "TotalReceiveOther") && isMultiCurrencies)
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        var colKey = i.ColumnName + "-" + subCol;
                                        int rowFooter = rowTableHeader + 1;// get start row after 
                                        var sumValue = "SUM(" + footerGroupDict[colKey] + ")";
                                        if (i.ColumnType == ColumnType.Number)
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                        }
                                        else
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                        }

                                        footerColNumber++;
                                    }

                                    footerColNumber--;
                                }
                                else
                                {
                                    int rowFooter = rowTableHeader + 1;// get start row after 
                                    var sumValue = "SUM(" + footerGroupDict[i.ColumnName] + ")";
                                    if (i.ColumnType == ColumnType.Number)
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                    }
                                }
                            }
                            else
                            {
                                if ((i.ColumnName == "Total" || i.ColumnName == "Paid" || i.ColumnName == "Balance" || i.ColumnName == "ReceivePayment" || i.ColumnName == "TotalReceive" ||
                                    i.ColumnName == "PaidCash" || i.ColumnName == "PaidBank" || i.ColumnName == "PaidCredit" || i.ColumnName == "PaidOther" ||
                                    i.ColumnName == "ReceiveCash" || i.ColumnName == "ReceiveBank" || i.ColumnName == "ReceiveCredit" || i.ColumnName == "ReceiveOther" ||
                                    i.ColumnName == "TotalReceiveCash" || i.ColumnName == "TotalReceiveBank" || i.ColumnName == "TotalReceiveCredit" || i.ColumnName == "TotalReceiveOther") && isMultiCurrencies)
                                {
                                    foreach (var subCol in subCols)
                                    {
                                        int rowFooter = rowTableHeader + 1;// get start row after header 
                                        var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                        var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                        if (i.ColumnType == ColumnType.Number)
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                        }
                                        else
                                        {
                                            AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                        }

                                        footerColNumber++;
                                    }

                                    footerColNumber--;
                                }
                                else
                                {
                                    int rowFooter = rowTableHeader + 1;// get start row after header 
                                    var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                    var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                    if (i.ColumnType == ColumnType.Number)
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                    }
                                }

                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"SaleInvoiceDetail_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleInvoiceDetail_Export_Pdf)]
        public async Task<FileDto> ExportPDFSaleInvoiceDetailReport(GetSaleInvoiceDetailReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;
            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                            .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                            .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }
            var digit = (await GetCurrentCycleAsync()).RoundingDigit;
            var user = await GetCurrentUserAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();

            var sheetName = report.HeaderTitle;

            var saleInvoices = await GetSaleInvoiceDetailReport(input);

            if (input.GroupBy == "JournalNo")
            {
                var journalNo = string.Empty;
                var items = saleInvoices.Items.Select(s =>
                {
                    var item = s;
                    if (journalNo == item.JournalNo)
                    {
                        item.Paid = 0;
                        item.Balance = 0;

                        item.PaidCash = 0;
                        item.PaidBank = 0;
                        item.PaidCredit = 0;
                        item.PaidOther = 0;

                        if (!item.IsPayment)
                        {
                            item.ReceivePayment = 0;
                            item.TotalReceive = 0;

                            item.ReceiveCash = 0;
                            item.ReceiveBank = 0;
                            item.ReceiveCredit = 0;
                            item.ReceiveOther = 0;

                            item.TotalReceiveCash = 0;
                            item.TotalReceiveBank = 0;
                            item.TotalReceiveCredit = 0;
                            item.TotalReceiveOther = 0;
                        }

                        item.CurrencyColumnTotals = s.CurrencyColumnTotals.Select(m =>
                        {
                            var col = m;
                            col.Paid = 0;
                            col.Balance = 0;

                            col.PaidCash = 0;
                            col.PaidBank = 0;
                            col.PaidCredit = 0;
                            col.PaidOther = 0;

                            if (!item.IsPayment)
                            {
                                col.TotalReceive = 0;
                                col.ReceivePayment = 0;

                                col.TotalReceiveCash = 0;
                                col.TotalReceiveBank = 0;
                                col.TotalReceiveCredit = 0;
                                col.TotalReceiveOther = 0;

                                col.ReceiveCash = 0;
                                col.ReceiveBank = 0;
                                col.ReceiveCredit = 0;
                                col.ReceiveOther = 0;
                            }

                            return col;
                        }).ToList();
                    }
                    journalNo = item.JournalNo;
                    return item;
                }).ToList();

                saleInvoices.Items = items;
            }

            var subCols = saleInvoices.Items == null ? null : saleInvoices.Items.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
            var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";
                            if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                            {
                                var index = 0;
                                var subColWidth = Convert.ToInt32(i.ColumnLength / saleInvoices.TotalResults[i.ColumnName].Count());
                                rowHeader = $"<th  colspan='{saleInvoices.TotalResults[i.ColumnName].Count()}' width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";
                                foreach (var subHeader in saleInvoices.TotalResults[i.ColumnName])
                                {
                                    if (index > 0) reportCountColHead++;
                                    multiCurrencyHeader += $"<th style='width: {subColWidth}px;'>{subHeader.Key}</th>";
                                    index++;
                                }
                            }
                            else
                            {
                                rowHeader = $"<th rowspan='2' width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";
                            }
                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                multiCurrencyHeader += isMultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                var groupBy = new List<GetListSaleInvoiceDetailReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Account":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.AccountId)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.AccountName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Customer":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "JournalNo":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.JournalNo)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.JournalNo).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.Date)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Item":
                            groupBy = saleInvoices.Items
                                .GroupBy(t => t.ItemId)
                                .Select(t => new GetListSaleInvoiceDetailReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.ItemCode != null ? x.ItemCode + "-" + x.ItemName : "").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }
                // write body
                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0) //write body have group by
                {
                    var trGroup = "";
                    foreach (var k in groupBy)
                    {
                        trGroup += $"<tr style='page-break-before: auto; page-break-after: auto;'>" +
                                   $"<td style='font-weight: bold;' colspan='{reportCountColHead}'> " + k.KeyName +
                                   $" </td></tr>";
                        foreach (var row in k.Items)
                        {
                            trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                            foreach (var i in viewHeader)
                            {
                                if (i.Visible)
                                {
                                    if (i.ColumnName == "ItemName")
                                    {
                                        trGroup += $"<td>{row.ItemName}</td>";
                                    }
                                    else if (i.ColumnName == "ItemCode")
                                    {
                                        trGroup += $"<td>{row.ItemCode}</td>";
                                    }
                                    else if (i.ColumnName == "JournalNo")
                                    {
                                        trGroup += $"<td>{row.JournalNo}</td>";
                                    }
                                    else if (i.ColumnName == "Account")
                                    {
                                        trGroup += $"<td>{row.AccountCode + " - " + row.AccountName}</td>";
                                    }
                                    else if (i.ColumnName == "Location")
                                    {
                                        trGroup += $"<td>{row.LocationName}</td>";
                                    }
                                    else if (i.ColumnName == "TaxRate")
                                    {

                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TaxRate, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "UnitPrice")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPrice, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "Qty")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Qty, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else if (i.ColumnName == "Total")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.Total);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "Paid" || i.ColumnName == "PaidCash" || i.ColumnName == "PaidBank" || i.ColumnName == "PaidCredit" || i.ColumnName == "PaidOther")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader)
                                                .Sum(s => i.ColumnName == "PaidCash" ? s.PaidCash : i.ColumnName == "PaidBank" ? s.PaidBank : i.ColumnName == "PaidCredit" ? s.PaidCredit : i.ColumnName == "PaidOther" ? s.PaidOther : s.Paid);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            var total = i.ColumnName == "PaidCash" ? row.PaidCash : i.ColumnName == "PaidBank" ? row.PaidBank : i.ColumnName == "PaidCredit" ? row.PaidCredit : i.ColumnName == "PaidOther" ? row.PaidOther : row.Paid;
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "Balance")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.Balance);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Balance, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "ReceivePayment" || i.ColumnName == "ReceiveCash" || i.ColumnName == "ReceiveBank" || i.ColumnName == "ReceiveCredit" || i.ColumnName == "ReceiveOther")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader)
                                                .Sum(s => i.ColumnName == "ReceiveCash" ? s.ReceiveCash : i.ColumnName == "ReceiveBank" ? s.ReceiveBank : i.ColumnName == "ReceiveCredit" ? s.ReceiveCredit : i.ColumnName == "ReceiveOther" ? s.ReceiveOther : s.ReceivePayment);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            var total = i.ColumnName == "ReceiveCash" ? row.ReceiveCash : i.ColumnName == "ReceiveBank" ? row.ReceiveBank : i.ColumnName == "ReceiveCredit" ? row.ReceiveCredit : i.ColumnName == "ReceiveOther" ? row.ReceiveOther : row.ReceivePayment;
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "TotalReceive" || i.ColumnName == "TotalReceiveCash" || i.ColumnName == "TotalReceiveBank" || i.ColumnName == "TotalReceiveCredit" || i.ColumnName == "TotalReceiveOther")
                                    {
                                        if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                        {
                                            foreach (var subHeader in subCols)
                                            {
                                                var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader)
                                                .Sum(s => i.ColumnName == "TotalReceiveCash" ? s.TotalReceiveCash : i.ColumnName == "TotalReceiveBank" ? s.TotalReceiveBank : i.ColumnName == "TotalReceiveCredit" ? s.TotalReceiveCredit : i.ColumnName == "TotalReceiveOther" ? s.TotalReceiveOther : s.TotalReceive);
                                                trGroup += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            var total = i.ColumnName == "TotalReceiveCash" ? row.TotalReceiveCash : i.ColumnName == "TotalReceiveBank" ? row.TotalReceiveBank : i.ColumnName == "TotalReceiveCredit" ? row.TotalReceiveCredit : i.ColumnName == "TotalReceiveOther" ? row.TotalReceiveOther : row.TotalReceive;
                                            trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (i.ColumnName == "Tax")

                                    {
                                        trGroup += $"<td>{row.TaxName}</td>";
                                    }
                                    else if (i.ColumnName == "Date")
                                    {
                                        trGroup += $"<td>{row.Date.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "Reference")
                                    {
                                        trGroup += $"<td>{row.Reference}</td>";
                                    }
                                    else if (i.ColumnName == "Description")
                                    {
                                        trGroup += $"<td>{row.Description}</td>";
                                    }
                                    else if (i.ColumnName == "Customer")
                                    {
                                        trGroup += $"<td>{row.CustomerName}</td>";
                                    }
                                    else if (i.ColumnName == "CustomerType")
                                    {
                                        trGroup += $"<td>{row.CustomerType}</td>";
                                    }
                                    else if (i.ColumnName == "SaleType")
                                    {
                                        trGroup += $"<td>{row.SaleType}</td>";
                                    }
                                    else if (i.ColumnName == "User")
                                    {
                                        trGroup += $"<td>{row.User}</td>";
                                    }
                                    else if (i.ColumnName == "NetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeight, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                    else
                                    {
                                        var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                        if (property != null)
                                        {
                                            trGroup += $"<td>{property.Value}</td>";
                                        }
                                        else
                                        {
                                            trGroup += $"<td></td>";
                                        }
                                    }
                                }
                            }
                            trGroup += "</tr>";
                        }
                        trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                                {
                                    if ((i.ColumnName == "Total" || i.ColumnName == "Paid" || i.ColumnName == "Balance" || i.ColumnName == "ReceivePayment" || i.ColumnName == "TotalReceive" ||
                                         i.ColumnName == "PaidCash" || i.ColumnName == "PaidBank" || i.ColumnName == "PaidCredit" || i.ColumnName == "PaidOther" ||
                                         i.ColumnName == "ReceiveCash" || i.ColumnName == "ReceiveBank" || i.ColumnName == "ReceiveCredit" || i.ColumnName == "ReceiveOther" ||
                                          i.ColumnName == "TotalReceiveCash" || i.ColumnName == "TotalReceiveBank" || i.ColumnName == "TotalReceiveCredit" || i.ColumnName == "TotalReceiveOther")
                                        && isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = k.Items.SelectMany(s => s.CurrencyColumnTotals.Where(r => r.CurrencyCode == subHeader))
                                                        .Sum(s => i.ColumnName == "Total" ? s.Total :
                                                                  i.ColumnName == "Paid" ? s.Paid :
                                                                  i.ColumnName == "PaidCash" ? s.PaidCash :
                                                                  i.ColumnName == "PaidBank" ? s.PaidBank :
                                                                  i.ColumnName == "PaidCredit" ? s.PaidCredit :
                                                                  i.ColumnName == "PaidOther" ? s.PaidOther :
                                                                  i.ColumnName == "Balance" ? s.Balance :
                                                                  i.ColumnName == "ReceivePayment" ? s.ReceivePayment :
                                                                  i.ColumnName == "ReceiveCash" ? s.ReceiveCash :
                                                                  i.ColumnName == "ReceiveBank" ? s.ReceiveBank :
                                                                  i.ColumnName == "ReceiveCredit" ? s.ReceiveCredit :
                                                                  i.ColumnName == "ReceiveOther" ? s.ReceiveOther :
                                                                  i.ColumnName == "TotalReceiveCash" ? s.TotalReceiveCash :
                                                                  i.ColumnName == "TotalReceiveBank" ? s.TotalReceiveBank :
                                                                  i.ColumnName == "TotalReceiveCredit" ? s.TotalReceiveCredit :
                                                                  i.ColumnName == "TotalReceiveOther" ? s.TotalReceiveOther :
                                                                  s.TotalReceive);
                                            trGroup += $"<td style='font-weight: bold; text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        if (i.ColumnName == "Total" || i.ColumnName == "Paid" || i.ColumnName == "Balance" || i.ColumnName == "ReceivePayment" || i.ColumnName == "TotalReceive" ||
                                            i.ColumnName == "PaidCash" || i.ColumnName == "PaidBank" || i.ColumnName == "PaidCredit" || i.ColumnName == "PaidOther" ||
                                            i.ColumnName == "ReceiveCash" || i.ColumnName == "ReceiveBank" || i.ColumnName == "ReceiveCredit" || i.ColumnName == "ReceiveOther" ||
                                            i.ColumnName == "TotalReceiveCash" || i.ColumnName == "TotalReceiveBank" || i.ColumnName == "TotalReceiveCredit" || i.ColumnName == "TotalReceiveOther"
                                        )
                                        {

                                            var total = k.Items.Sum(t => i.ColumnName == "Total" ? t.Total :
                                                                         i.ColumnName == "Paid" ? t.Paid :
                                                                         i.ColumnName == "PaidCash" ? t.PaidCash :
                                                                         i.ColumnName == "PaidBank" ? t.PaidBank :
                                                                         i.ColumnName == "PaidCredit" ? t.PaidCredit :
                                                                         i.ColumnName == "PaidOther" ? t.PaidOther :
                                                                         i.ColumnName == "Balance" ? t.Balance :
                                                                         i.ColumnName == "ReceivePayment" ? t.ReceivePayment :
                                                                         i.ColumnName == "ReceiveCash" ? t.ReceiveCash :
                                                                         i.ColumnName == "ReceiveBank" ? t.ReceiveBank :
                                                                         i.ColumnName == "ReceiveCredit" ? t.ReceiveCredit :
                                                                         i.ColumnName == "ReceiveOther" ? t.ReceiveOther :
                                                                         i.ColumnName == "TotalReceiveCash" ? t.TotalReceiveCash :
                                                                         i.ColumnName == "TotalReceiveBank" ? t.TotalReceiveBank :
                                                                         i.ColumnName == "TotalReceiveCredit" ? t.TotalReceiveCredit :
                                                                         i.ColumnName == "TotalReceiveOther" ? t.TotalReceiveOther :
                                                                         t.TotalReceive);
                                            trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                        else if (i.ColumnName == "NetWeight")
                                        {
                                            trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.NetWeight), digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                        else if (i.ColumnName == "Qty")
                                        {
                                            trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.Qty), digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                }
                                else //none sum
                                {
                                    trGroup += $"<td></td>";
                                }

                            }
                        }
                        trGroup += "</tr>";
                    }
                    contentBody += trGroup;
                }
                else // write body no group by
                {
                    foreach (var row in saleInvoices.Items)
                    {
                        var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "ItemName")
                                {
                                    tr += $"<td>{row.ItemName}</td>";
                                }
                                else if (i.ColumnName == "ItemCode")
                                {
                                    tr += $"<td>{row.ItemCode}</td>";
                                }
                                else if (i.ColumnName == "JournalNo")
                                {
                                    tr += $"<td>{row.JournalNo}</td>";
                                }
                                else if (i.ColumnName == "Account")
                                {
                                    tr += $"<td>{row.AccountCode + " - " + row.AccountName}</td>";
                                }
                                else if (i.ColumnName == "Location")
                                {
                                    tr += $"<td>{row.LocationName}</td>";
                                }
                                else if (i.ColumnName == "TaxRate")
                                {

                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TaxRate, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "UnitPrice")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPrice, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "Qty")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Qty, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else if (i.ColumnName == "Total")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(r => r.CurrencyCode == subHeader).Sum(s => s.Total);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Total, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "Paid" || i.ColumnName == "PaidCash" || i.ColumnName == "PaidBank" || i.ColumnName == "PaidCredit" || i.ColumnName == "PaidOther")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader)
                                            .Sum(s => i.ColumnName == "PaidCash" ? s.PaidCash : i.ColumnName == "PaidBank" ? s.PaidBank : i.ColumnName == "PaidCredit" ? s.PaidCredit : i.ColumnName == "PaidOther" ? s.PaidOther : s.Paid);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        var total = i.ColumnName == "PaidCash" ? row.PaidCash : i.ColumnName == "PaidBank" ? row.PaidBank : i.ColumnName == "PaidCredit" ? row.PaidCredit : i.ColumnName == "PaidOther" ? row.PaidOther : row.Paid;
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "Balance")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader).Sum(s => s.Balance);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Balance, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "ReceivePayment" || i.ColumnName == "ReceiveCash" || i.ColumnName == "ReceiveBank" || i.ColumnName == "ReceiveCredit" || i.ColumnName == "ReceiveOther")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader)
                                            .Sum(s => i.ColumnName == "ReceiveCash" ? s.ReceiveCash : i.ColumnName == "ReceiveBank" ? s.ReceiveBank : i.ColumnName == "ReceiveCredit" ? s.ReceiveCredit : i.ColumnName == "ReceiveOther" ? s.ReceiveOther : s.ReceivePayment);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        var total = i.ColumnName == "ReceiveCash" ? row.ReceiveCash : i.ColumnName == "ReceiveBank" ? row.ReceiveBank : i.ColumnName == "ReceiveCredit" ? row.ReceiveCredit : i.ColumnName == "ReceiveOther" ? row.ReceiveOther : row.ReceivePayment;
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "TotalReceive" || i.ColumnName == "TotalReceiveCash" || i.ColumnName == "TotalReceiveBank" || i.ColumnName == "TotalReceiveCredit" || i.ColumnName == "TotalReceiveOther")
                                {
                                    if (isMultiCurrencies && saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subHeader in subCols)
                                        {
                                            var total = row.CurrencyColumnTotals.Where(s => s.CurrencyCode == subHeader)
                                           .Sum(s => i.ColumnName == "TotalReceiveCash" ? s.TotalReceiveCash : i.ColumnName == "TotalReceiveBank" ? s.TotalReceiveBank : i.ColumnName == "TotalReceiveCredit" ? s.TotalReceiveCredit : i.ColumnName == "TotalReceiveOther" ? s.TotalReceiveOther : s.TotalReceive);
                                            tr += $"<td style='text-align: right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else
                                    {
                                        var total = i.ColumnName == "TotalReceiveCash" ? row.TotalReceiveCash : i.ColumnName == "TotalReceiveBank" ? row.TotalReceiveBank : i.ColumnName == "TotalReceiveCredit" ? row.TotalReceiveCredit : i.ColumnName == "TotalReceiveOther" ? row.TotalReceiveOther : row.TotalReceive;
                                        tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else if (i.ColumnName == "Tax")

                                {
                                    tr += $"<td>{row.TaxName}</td>";
                                }
                                else if (i.ColumnName == "Date")
                                {
                                    tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "Reference")
                                {
                                    tr += $"<td>{row.Reference}</td>";
                                }
                                else if (i.ColumnName == "Description")
                                {
                                    tr += $"<td>{row.Description}</td>";
                                }
                                else if (i.ColumnName == "Customer")
                                {
                                    tr += $"<td>{row.CustomerName}</td>";
                                }
                                else if (i.ColumnName == "CustomerType")
                                {
                                    tr += $"<td>{row.CustomerType}</td>";
                                }
                                else if (i.ColumnName == "SaleType")
                                {
                                    tr += $"<td>{row.SaleType}</td>";
                                }
                                else if (i.ColumnName == "User")
                                {
                                    tr += $"<td>{row.User}</td>";
                                }
                                else if (i.ColumnName == "NetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeight, digit, MidpointRounding.ToEven), digit)}</td>";
                                }
                                else
                                {
                                    var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                    if (property != null)
                                    {
                                        tr += $"<td>{property.Value}</td>";
                                    }
                                    else
                                    {
                                        tr += $"<td></td>";
                                    }
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index == 0)
                            {
                                tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))
                                {
                                    if (saleInvoices.TotalResults.ContainsKey(i.ColumnName))
                                    {
                                        foreach (var subCol in subCols)
                                        {
                                            var total = saleInvoices.TotalResults[i.ColumnName].ContainsKey(subCol) ? saleInvoices.TotalResults[i.ColumnName][subCol] : 0;
                                            tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(total, digit, MidpointRounding.ToEven), digit)}</td>";
                                        }
                                    }
                                    else if (saleInvoices.TotalResult.ContainsKey(i.ColumnName))
                                    {
                                        tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(saleInvoices.TotalResult[i.ColumnName], digit, MidpointRounding.ToEven), digit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer
                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", multiCurrencyHeader);

                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);

                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{ReplaceSpecialCharacter(sheetName)}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }

        #endregion


        #region Cleanup save template

        [UnitOfWork(IsDisabled = true)]
        public async Task CleanupSaveTemplate()
        {

            var _unitOfWorkManager = IocManager.Instance.Resolve<IUnitOfWorkManager>();
            var _reportTemplateRepository = IocManager.Instance.Resolve<ICorarlRepository<ReportTemplate, long>>();
            var _reportColumnTemplateRepository = IocManager.Instance.Resolve<ICorarlRepository<ReportColumnTemplate, Guid>>();
            var _tenantRepository = IocManager.Instance.Resolve<ICorarlRepository<Tenant, int>>();

            var reportColumns = new List<ReportColumnTemplate>();
            var tenantList = new List<Tenant>();

            using (var uow = _unitOfWorkManager.Begin(System.Transactions.TransactionScopeOption.RequiresNew))
            {
                using (_unitOfWorkManager.Current.DisableFilter(AbpDataFilters.MayHaveTenant))
                {
                    reportColumns = await _reportColumnTemplateRepository.GetAll().Include(s => s.ReportTemplate)
                                    .Where(s =>
                                     s.ReportTemplate.ReportType == ReportType.ReportType_SaleInvoice ||
                                     s.ReportTemplate.ReportType == ReportType.ReportType_CustomerAging ||
                                     s.ReportTemplate.ReportType == ReportType.ReportType_CustomerByInvoice
                                     )
                                    .ToListAsync();

                    tenantList = await _tenantRepository.GetAll().ToListAsync();
                }
            }

            var columnToUpdates = new List<ReportColumnTemplate>();

            foreach (var tenant in tenantList)
            {
                var saleInvoiceReportFromTemplateColumns = new List<CollumnOutput>();
                var customerAgingReportFromTemplateColumns = new List<CollumnOutput>();
                var customerByInvoiceReportFromTemplateColumns = new List<CollumnOutput>();

                using (var uow = _unitOfWorkManager.Begin(System.Transactions.TransactionScopeOption.RequiresNew))
                {
                    using (_unitOfWorkManager.Current.SetTenantId(tenant.Id))
                    {
                        saleInvoiceReportFromTemplateColumns = GetReportTemplateSaleInvoice().ColumnInfo.Where(s => s.IsDisplay).ToList();
                        customerAgingReportFromTemplateColumns = GetReportTemplateCustomerAging().ColumnInfo.Where(s => s.IsDisplay).ToList();
                        customerByInvoiceReportFromTemplateColumns = GetReportTemplateCustomerByInvoice().ColumnInfo.Where(s => s.IsDisplay).ToList();
                    }
                }

                var saleInvoiceReportColumns = reportColumns.Where(s => s.TenantId == tenant.Id && s.ReportTemplate.ReportType == ReportType.ReportType_SaleInvoice).ToList();
                var customerAgingReportColumns = reportColumns.Where(s => s.TenantId == tenant.Id && s.ReportTemplate.ReportType == ReportType.ReportType_CustomerAging).ToList();
                var customerByInvoiceReportColumns = reportColumns.Where(s => s.TenantId == tenant.Id && s.ReportTemplate.ReportType == ReportType.ReportType_CustomerByInvoice).ToList();

                foreach (var col in saleInvoiceReportFromTemplateColumns)
                {
                    var updateCols = saleInvoiceReportColumns.Where(s => s.ColumnName == col.ColumnName).ToList();
                    foreach (var updateCol in updateCols)
                    {
                        updateCol.SetIsDisplay(true);
                        columnToUpdates.Add(updateCol);
                    }
                }
                ;

                foreach (var col in customerAgingReportFromTemplateColumns)
                {
                    var updateCols = customerAgingReportColumns.Where(s => s.ColumnName == col.ColumnName).ToList();
                    foreach (var updateCol in updateCols)
                    {
                        updateCol.SetIsDisplay(true);
                        columnToUpdates.Add(updateCol);
                    }
                }
                ;


                foreach (var col in customerByInvoiceReportFromTemplateColumns)
                {
                    var updateCols = customerByInvoiceReportColumns.Where(s => s.ColumnName == col.ColumnName).ToList();
                    foreach (var updateCol in updateCols)
                    {
                        updateCol.SetIsDisplay(true);
                        columnToUpdates.Add(updateCol);
                    }
                }
                ;
            }


            using (var uow = _unitOfWorkManager.Begin(System.Transactions.TransactionScopeOption.RequiresNew))
            {
                using (_unitOfWorkManager.Current.DisableFilter(AbpDataFilters.MayHaveTenant))
                {
                    await _reportColumnTemplateRepository.BulkUpdateAsync(columnToUpdates);
                }

                await uow.CompleteAsync();
            }

        }

        #endregion

        #region Profit by Invoice Report

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_ProfitByInvoice)]
        public async Task<ReportOutput> GetReportTemplateProfitByInvoice()
        {

            var itemPropertyCols = await _propertyRepository.GetAll().AsNoTracking()
                                   .Where(t => t.IsActive == true)
                                   .Select(t => new CollumnOutput
                                   {
                                       AllowGroupby = false,
                                       AllowFilter = true,
                                       ColumnName = t.Name,
                                       ColumnLength = 150,
                                       ColumnTitle = t.Name,
                                       ColumnType = ColumnType.ItemProperty,
                                       SortOrder = 25,
                                       Visible = true,
                                       AllowFunction = null,
                                       MoreFunction = null,
                                       IsDisplay = false,
                                       AllowShowHideFilter = true,
                                       ShowHideFilter = true,
                                       DefaultValue = t.Id.ToString(),//to init the value of property
                                   })
                                   .ToListAsync();

            var columnInfo = new List<CollumnOutput>() {
                    // start properties with can filter
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Search",
                    ColumnLength = 150,
                    ColumnTitle = "Search",
                    ColumnType = ColumnType.Language,
                    SortOrder = 0,
                    Visible = true,
                    AllowFunction = null,
                    MoreFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    IsDisplay = false//no need to show in col check it belong to filter option
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "DateRange",
                    ColumnLength = 150,
                    ColumnTitle = "DateRange",
                    ColumnType = ColumnType.Language,
                    SortOrder = 0,
                    Visible = true,
                    DefaultValue = "thisMonth",
                    AllowFunction = null,
                    DisableDefault = false,
                    MoreFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    IsDisplay = false//no need to show in col check it belong to filter option
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Date",
                    ColumnLength = 150,
                    ColumnTitle = "Date",
                    ColumnType = ColumnType.Date,
                    SortOrder = 1,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput
                {
                    AllowGroupby = true,
                    AllowFilter = false,
                    ColumnName = "InvoiceNo",
                    ColumnLength = 140,
                    ColumnTitle = "Invoice No",
                    ColumnType = ColumnType.String,
                    SortOrder = 2,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Reference",
                    ColumnLength = 140,
                    ColumnTitle = "Reference No",
                    ColumnType = ColumnType.String,
                    SortOrder = 3,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Customer",
                    ColumnLength = 150,
                    ColumnTitle = "Customer",
                    ColumnType = ColumnType.String,
                    SortOrder = 4,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Location",
                    ColumnLength = 120,
                    ColumnTitle = "Location",
                    ColumnType = ColumnType.String,
                    SortOrder = 5,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "DeliveryStatus",
                    ColumnLength = 150,
                    ColumnTitle = "Delivery Status",
                    ColumnType = ColumnType.StatusCode,
                    SortOrder = 6,
                    Visible = false,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Item",
                    ColumnLength = 250,
                    ColumnTitle = "Item",
                    ColumnType = ColumnType.String,
                    SortOrder = 7,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "ItemCode",
                    ColumnLength = 250,
                    ColumnTitle = "Item Code",
                    ColumnType = ColumnType.String,
                    SortOrder = 8,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "ItemName",
                    ColumnLength = 250,
                    ColumnTitle = "Item Name",
                    ColumnType = ColumnType.String,
                    SortOrder = 9,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Memo",
                    ColumnLength = 150,
                    ColumnTitle = "Memo",
                    ColumnType = ColumnType.String,
                    SortOrder = 10,
                    Visible = false,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Description",
                    ColumnLength = 150,
                    ColumnTitle = "Description",
                    ColumnType = ColumnType.String,
                    SortOrder = 10,
                    Visible = false,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Qty",
                    ColumnLength = 120,
                    ColumnTitle = "Qty",
                    ColumnType = ColumnType.Number,
                    SortOrder = 11,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "NetWeight",
                    ColumnLength = 120,
                    ColumnTitle = "Net Weight",
                    ColumnType = ColumnType.Number,
                    SortOrder = 12,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "UnitPrice",
                    ColumnLength = 110,
                    ColumnTitle = "UnitPrice",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 13,
                    Visible = true,
                    IsDisplay = true,
                    AllowFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "UnitCost",
                    ColumnLength = 110,
                    ColumnTitle = "UnitCost",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 14,
                    Visible = true,
                    IsDisplay = true,
                    AllowFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "LinePrice",
                    ColumnLength = 150,
                    ColumnTitle = "Line Price",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 15,
                    Visible = true,
                    AllowFunction = "Sum",
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                    IsDisplay = true
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "LineCost",
                    ColumnLength = 150,
                    ColumnTitle = "Line Cost",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 16,
                    Visible = true,
                    AllowFunction = "Sum",
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                    IsDisplay = true
                },

                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Profit",
                    ColumnLength = 150,
                    ColumnTitle = "Profit",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 17,
                    Visible = true,
                    AllowFunction = "Sum",
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                    IsDisplay = true
                },
                new CollumnOutput
                {
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Percentage",
                    ColumnLength = 150,
                    ColumnTitle = "Percentage",
                    ColumnType = ColumnType.Percentage,
                    SortOrder = 18,
                    Visible = true,
                    AllowFunction = "Sum",
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                    IsDisplay = true
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "User",
                    ColumnLength = 110,
                    ColumnTitle = "User",
                    ColumnType = ColumnType.String,
                    SortOrder = 19,
                    Visible = false,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "CustomerType",
                    ColumnLength = 150,
                    ColumnTitle = "Customer Type",
                    ColumnType = ColumnType.String,
                    SortOrder = 20,
                    Visible = true,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Status",
                    ColumnLength = 150,
                    ColumnTitle = "Status",
                    ColumnType = ColumnType.StatusCode,
                    SortOrder = 21,
                    Visible = false,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
            };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columnInfo.Concat(itemPropertyCols).ToList(),
                Groupby = "InvoiceNo",
                HeaderTitle = "Profit By Invoice Report",
                Sortby = "InvoiceNo",
            };


            return result;
        }


        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_ProfitByInvoice)]
        [HttpPost]
        public async Task<PagedResultWithTotalColuumnsDto<GetListReportProfitByInvoiceOutput>> GetProfitByInvoiceReport(GetListReportProfitByInvoiceInput input)
        {
            var periodCycles = await GetCloseCyleAsync(input.ToDate);
            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();
            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();
            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;



            var defaultLocationGroups = await GetUserGroupByLocation();
            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();

            var invoiceQeury = _journalRepository.GetAll()
                                .Where(s => s.Status == TransactionStatus.Publish)
                                .Where(u => u.JournalType == JournalType.Invoice)
                                .WhereIf(!defaultLocationGroups.IsNullOrEmpty(), u => defaultLocationGroups.Contains(u.LocationId.Value))
                                .WhereIf(!input.Locations.IsNullOrEmpty(), u => input.Locations.Contains(u.LocationId.Value))
                                .WhereIf(!input.Users.IsNullOrEmpty(), u => input.Users.Contains(u.CreatorUserId))
                                .WhereIf(!input.Statuses.IsNullOrEmpty(), s => input.Statuses.Contains(s.Status))
                                .WhereIf(!input.DeliveryStatuses.IsNullOrEmpty(), s => input.DeliveryStatuses.Contains(s.Invoice.ReceivedStatus))
                                .WhereIf(!input.Customers.IsNullOrEmpty(), s => input.Customers.Contains(s.Invoice.CustomerId))
                                .WhereIf(!input.CustomerTypes.IsNullOrEmpty(), s => input.CustomerTypes.Contains(s.Invoice.Customer.CustomerTypeId.Value))
                                .WhereIf(!customerTypeMemberIds.IsNullOrEmpty(), s => customerTypeMemberIds.Contains(s.Invoice.Customer.CustomerTypeId.Value))
                                .WhereIf(input.FromDate != null, u => input.FromDate.Date <= u.Date.Date)
                                .WhereIf(input.ToDate != null, u => u.Date.Date <= input.ToDate.Date)
                                .WhereIf(!input.Filter.IsNullOrEmpty(),
                                    u => u.JournalNo.ToLower().Contains(input.Filter.ToLower()) ||
                                    u.Reference.ToLower().Contains(input.Filter.ToLower()))
                                .AsNoTracking()
                                .Select(s => new
                                {
                                    s.Date,
                                    s.JournalNo,
                                    s.Reference,
                                    s.Invoice.Total,
                                    s.Invoice.CustomerId,
                                    s.Invoice.Customer.CustomerName,
                                    s.Invoice.Customer.CustomerCode,
                                    s.Invoice.ReceivedStatus,
                                    s.Status,
                                    s.InvoiceId,
                                    s.Location.LocationName,
                                    s.LocationId,
                                    s.Memo,
                                    s.CreatorUser.UserName
                                });

            var userGroupItems = await GetUserGroupItems();
            var itemQuery = GetItemWithProperties(userGroupItems, input.Items, input.PropertyDics);

            var iItemQuery = from i in _invoiceItemRepository.GetAll()
                                        .AsNoTracking()
                                        .Where(s => s.ItemId.HasValue)
                                        .WhereIf(!input.Items.IsNullOrEmpty(), s => input.Items.Contains(s.ItemId.Value))
                             join ii in _inventoryTrasactionItemRepository.GetAll().AsNoTracking()
                             on i.ItemIssueItemId equals ii.Id
                             into iis
                             from ii in iis.DefaultIfEmpty()
                             select new ProfitByInvoiceItemDetailOutput
                             {
                                 InvoiceItemId = i.Id,
                                 InvoiceId = i.InvoiceId,
                                 ItemId = i.ItemId.Value,
                                 Qty = i.Qty,
                                 UnitPrice = i.UnitCost,
                                 LinePrice = i.Total,
                                 UnitCost = ii == null ? 0 : ii.UnitCost,
                                 LineCost = ii == null ? 0 : -ii.LineCost,
                                 Profit = ii == null ? i.Total : i.Total + ii.LineCost,
                                 Description = i.Description
                             };

            var invoiceItemQuery = from i in invoiceQeury
                                   join ii in iItemQuery
                                   on i.InvoiceId equals ii.InvoiceId
                                   select new GetListReportProfitByInvoiceOutput
                                   {
                                       InvoiceId = i.InvoiceId.Value,
                                       Date = i.Date,
                                       InvoiceNo = i.JournalNo,
                                       Reference = i.Reference,
                                       CustomerId = i.CustomerId,
                                       CustomerCode = i.CustomerCode,
                                       CustomerName = i.CustomerName,
                                       Memo = i.Memo,
                                       LocationId = i.LocationId,
                                       LocationName = i.LocationName,
                                       User = i.UserName,
                                       Status = i.Status,
                                       DeliveryStatus = i.ReceivedStatus,

                                       InvoiceItemId = ii.InvoiceItemId,
                                       ItemId = ii.ItemId,
                                       Description = ii.Description,
                                       Qty = ii.Qty,
                                       UnitPrice = ii.UnitPrice,
                                       UnitCost = ii.UnitCost,
                                       LinePrice = ii.LinePrice,
                                       LineCost = ii.LineCost,
                                       Profit = ii.Profit,
                                       Percentage = i.Total == 0 ? 0 : Math.Round(ii.LinePrice / i.Total, currentRoundingDigit) * 100,
                                   };

            var query = from ii in invoiceItemQuery
                        join i in itemQuery
                        on ii.ItemId equals i.Id

                        let netWeight = !i.Properties.Any(p => p.IsUnit) ? 0 :
                        i.Properties.Where(t => t.IsUnit).Select(t => t.NetWeight).FirstOrDefault()

                        select new GetListReportProfitByInvoiceOutput
                        {
                            InvoiceId = ii.InvoiceId,
                            Date = ii.Date,
                            InvoiceNo = ii.InvoiceNo,
                            Reference = ii.Reference,
                            CustomerId = ii.CustomerId,
                            CustomerCode = ii.CustomerCode,
                            CustomerName = ii.CustomerName,
                            Memo = ii.Memo,
                            LocationId = ii.LocationId,
                            LocationName = ii.LocationName,
                            User = ii.User,
                            Status = ii.Status,
                            StatusName = ii.Status.ToString(),
                            DeliveryStatus = ii.DeliveryStatus,
                            DeliveryStatusName = ii.DeliveryStatus.ToString(),

                            InvoiceItemId = ii.InvoiceItemId,
                            ItemId = ii.ItemId,
                            ItemCode = i.ItemCode,
                            ItemName = i.ItemName,
                            Properties = i.Properties,
                            Description = ii.Description,
                            Qty = ii.Qty,
                            NetWeight = ii.Qty * netWeight,
                            UnitPrice = ii.UnitPrice,
                            UnitCost = ii.UnitCost,
                            LinePrice = ii.LinePrice,
                            LineCost = ii.LineCost,
                            Profit = ii.Profit,
                            Percentage = ii.Percentage,
                            RoundingDigit = currentRoundingDigit,
                        };


            ProfitByInvoiceColumnSummaryOutput summary = null;
            var resultCount = await query.CountAsync();

            if (resultCount == 0) return new PagedResultWithTotalColuumnsDto<GetListReportProfitByInvoiceOutput>(resultCount, new List<GetListReportProfitByInvoiceOutput>(), new Dictionary<string, decimal>());

            if (input.IsLoadMore == false && input.ColumnNamesToSum != null)
            {
                summary = await query.Select(s => new
                {
                    s.Qty,
                    s.NetWeight,
                    s.LinePrice,
                    s.LineCost,
                    s.Profit
                })
                .GroupBy(s => 1)
                .Select(s => new ProfitByInvoiceColumnSummaryOutput
                {
                    TotalQty = s.Sum(t => t.Qty),
                    TotalNetWeight = s.Sum(t => t.NetWeight),
                    TotalCost = s.Sum(t => t.LineCost),
                    TotalPrice = s.Sum(t => t.LinePrice),
                    TotalProfit = s.Sum(t => t.Profit)
                })
                .FirstOrDefaultAsync();

            }
            var sumOfColumns = new Dictionary<string, decimal>();

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "Qty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalQty);
                    }
                    else if (col == "NetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalNetWeight);
                    }
                    else if (col == "LineCost")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalCost);
                    }
                    else if (col == "LinePrice")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalPrice);
                    }
                    else if (col == "Profit")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalProfit);
                    }
                    else if (col == "Percentage")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalPrice == 0 ? 0 : 100);
                    }
                }
            }


            switch (input.GroupBy)
            {
                case "Date":
                    query = query.OrderBy(s => s.Date);
                    break;
                case "Location":
                    query = query.OrderBy(s => s.LocationName);
                    break;
                case "Customer":
                    query = query.OrderBy(s => s.CustomerName);
                    break;
                case "Item":
                    query = query.OrderBy(s => s.ItemCode);
                    break;
                case "InvoiceNo":
                    query = query.OrderBy(s => s.InvoiceNo);
                    break;
                default:
                    query = query.OrderBy(s => input.Sorting);
                    break;
            }

            var @entities = new List<GetListReportProfitByInvoiceOutput>();
            if (input.UsePagination == true)
            {
                @entities = await query.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await query.ToListAsync();
            }

            var returnResult = new PagedResultWithTotalColuumnsDto<GetListReportProfitByInvoiceOutput>(resultCount, @entities, sumOfColumns);

            return returnResult;

        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_ProfitByInvoice_Export_Excel)]
        public async Task<FileDto> ExportExcelProfitByInvoiceReport(GetProfitByInvoiceReportInput input)
        {

            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var reportResult = await GetProfitByInvoiceReport(input);
            var invoiceData = reportResult.Items;

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                //var subCols = invoiceData == null ? null : invoiceData.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
                //var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString("dd-MM-yyyy");
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                    ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                    colHeaderTable += 1;
                }

                //if (isMultiCurrencies) rowTableHeader += 1;
                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                var groupBy = new List<GetListReportProfitByInvoiceGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = invoiceData
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListReportProfitByInvoiceGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Customer":
                            groupBy = invoiceData
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListReportProfitByInvoiceGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = invoiceData
                                .GroupBy(t => t.Date.Date)
                                .Select(t => new GetListReportProfitByInvoiceGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString()).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Item":
                            groupBy = invoiceData
                                .GroupBy(t => t.ItemCode)
                                .Select(t => new GetListReportProfitByInvoiceGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.ItemCode}-{x.ItemName}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "InvoiceNo":
                            groupBy = invoiceData
                                .GroupBy(t => t.InvoiceNo)
                                .Select(t => new GetListReportProfitByInvoiceGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.InvoiceNo}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }
                // write body

                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0)
                {
                    foreach (var k in groupBy)
                    {
                        //key group by name
                        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                        rowBody += 1;
                        count = 1;
                        //list of item
                        foreach (var i in k.Items)
                        {
                            int collumnCellBody = 1;
                            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                            {

                                WriteBodyProfitByInvoice(ws, rowBody, collumnCellBody, item, i, count);
                                collumnCellBody += 1;
                            }
                            rowBody += 1;
                            count += 1;
                        }

                        //sub total of group by item
                        int collumnCellGroupBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (item.AllowFunction != null)
                            {
                                var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);
                                if (footerGroupDict.ContainsKey(item.ColumnName))
                                {
                                    footerGroupDict[item.ColumnName] += fromCell + ":" + toCell + ",";
                                }
                                else
                                {
                                    footerGroupDict.Add(item.ColumnName, fromCell + ":" + toCell + ",");
                                }

                                AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true, item.ColumnType == ColumnType.Percentage);
                            }
                            collumnCellGroupBody += 1;
                        }
                        rowBody += 1;
                    }
                }
                else
                {
                    foreach (var i in invoiceData)
                    {
                        int collumnCellBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            WriteBodyProfitByInvoice(ws, rowBody, collumnCellBody, item, i, count);
                            collumnCellBody += 1;
                        }
                        rowBody += 1;
                        count += 1;
                    }
                }
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (!input.GroupBy.IsNullOrWhiteSpace())
                            {
                                //sum custom range cell depend on group item
                                int rowFooter = rowTableHeader + 1;// get start row after 
                                var sumValue = "SUM(" + footerGroupDict[i.ColumnName] + ")";
                                if (i.ColumnType == ColumnType.Number || i.ColumnType == ColumnType.RoundingDigit)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                }
                                else if (i.ColumnType == ColumnType.Percentage)
                                {
                                    //AddFormula(ws, footerRow, footerColNumber, sumValue, true, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                }
                            }
                            else
                            {
                                int rowFooter = rowTableHeader + 1;// get start row after header 
                                var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                if (i.ColumnType == ColumnType.Number || i.ColumnType == ColumnType.RoundingDigit)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }
                                else if (i.ColumnType == ColumnType.Percentage)
                                {
                                    //AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                }
                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"Profit_by_Invoice_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }


        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_ProfitByInvoice_Export_Pdf)]
        public async Task<FileDto> ExportPDFProfitByInvoiceReport(GetProfitByInvoiceReportInput input)
        {

            input.UsePagination = false;
            input.IsLoadMore = false;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                        .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                        .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }

            var rounding = await GetCurrentCycleAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            //int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;
            var user = await GetCurrentUserAsync();
            var invoices = await GetProfitByInvoiceReport(input);

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                //var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";

                            rowHeader = $"<th width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";

                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                //multiCurrencyHeader += isMultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                var groupBy = new List<GetListReportProfitByInvoiceGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = invoices.Items
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListReportProfitByInvoiceGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Customer":
                            groupBy = invoices.Items
                                .GroupBy(t => t.CustomerName)
                                .Select(t => new GetListReportProfitByInvoiceGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Date":
                            groupBy = invoices.Items
                                .GroupBy(t => t.Date.Date)
                                .Select(t => new GetListReportProfitByInvoiceGroupByOutput
                                {
                                    KeyName = t.Select(x => x.Date.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Item":
                            groupBy = invoices.Items
                                .GroupBy(t => t.ItemCode)
                                .Select(t => new GetListReportProfitByInvoiceGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.ItemCode}-{x.ItemName}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "InvoiceNo":
                            groupBy = invoices.Items
                                .GroupBy(t => t.InvoiceNo)
                                .Select(t => new GetListReportProfitByInvoiceGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.InvoiceNo}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }

                // write body
                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0) //write body have group by
                {
                    var trGroup = "";
                    foreach (var k in groupBy)
                    {
                        trGroup += $"<tr style='page-break-before: auto; page-break-after: auto;'>" +
                                   $"<td style='font-weight: bold;' colspan='{reportCountColHead}'> " + k.KeyName +
                                   $" </td></tr>";
                        foreach (var row in k.Items)
                        {
                            trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                            foreach (var i in viewHeader)
                            {
                                if (i.Visible)
                                {
                                    if (i.ColumnName == "Location")
                                    {
                                        trGroup += $"<td>{row.LocationName}</td>";
                                    }
                                    else if (i.ColumnName == "Date")
                                    {
                                        trGroup += $"<td>{row.Date.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "InvoiceNo")
                                    {
                                        trGroup += $"<td>{row.InvoiceNo}</td>";
                                    }
                                    else if (i.ColumnName == "Reference")
                                    {
                                        trGroup += $"<td>{row.Reference}</td>";
                                    }
                                    else if (i.ColumnName == "Memo")
                                    {
                                        trGroup += $"<td>{row.Memo}</td>";
                                    }
                                    else if (i.ColumnName == "Description")
                                    {
                                        trGroup += $"<td>{row.Description}</td>";
                                    }
                                    else if (i.ColumnName == "Customer")
                                    {
                                        trGroup += $"<td>{row.CustomerName}</td>";
                                    }
                                    else if (i.ColumnName == "User")
                                    {
                                        trGroup += $"<td>{row.User}</td>";
                                    }
                                    else if (i.ColumnName == "NetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryStatus")
                                    {
                                        trGroup += $"<td>{row.DeliveryStatus.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "Status")
                                    {
                                        trGroup += $"<td>{row.Status.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "ItemCode")
                                    {
                                        trGroup += $"<td>{row.ItemCode}</td>";
                                    }
                                    else if (i.ColumnName == "ItemName")
                                    {
                                        trGroup += $"<td>{row.ItemName}</td>";
                                    }
                                    else if (i.ColumnName == "Qty")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Qty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "UnitPrice")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPrice, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "UnitCost")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitCost, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "LinePrice")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.LinePrice, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "LineCost")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.LineCost, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "Profit")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Profit, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "Percentage")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Percentage, 2, MidpointRounding.ToEven), 2)}%</td>";
                                    }
                                    else
                                    {
                                        var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                        if (property != null)
                                        {
                                            trGroup += $"<td>{property.Value}</td>";
                                        }
                                        else
                                        {
                                            trGroup += $"<td></td>";
                                        }
                                    }
                                }
                            }
                            trGroup += "</tr>";
                        }
                        trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                                {
                                    if (i.ColumnName == "Qty")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.Qty), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "LinePrice")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.LinePrice), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "LineCost")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.LineCost), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "Profit")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.Profit), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "Percentage")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.Percentage), 2, MidpointRounding.ToEven), 2)}%</td>";

                                    }
                                    else if (i.ColumnName == "NetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.NetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    trGroup += $"<td></td>";
                                }

                            }
                        }
                        trGroup += "</tr>";
                    }
                    contentBody += trGroup;
                }
                else // write body no group by
                {
                    foreach (var row in invoices.Items)
                    {
                        var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "Location")
                                {
                                    tr += $"<td>{row.LocationName}</td>";
                                }
                                else if (i.ColumnName == "Date")
                                {
                                    tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "InvoiceNo")
                                {
                                    tr += $"<td>{row.InvoiceNo}</td>";
                                }
                                else if (i.ColumnName == "Reference")
                                {
                                    tr += $"<td>{row.Reference}</td>";
                                }
                                else if (i.ColumnName == "Memo")
                                {
                                    tr += $"<td>{row.Memo}</td>";
                                }
                                else if (i.ColumnName == "Description")
                                {
                                    tr += $"<td>{row.Description}</td>";
                                }
                                else if (i.ColumnName == "Customer")
                                {
                                    tr += $"<td>{row.CustomerName}</td>";
                                }
                                else if (i.ColumnName == "User")
                                {
                                    tr += $"<td>{row.User}</td>";
                                }
                                else if (i.ColumnName == "NetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "DeliveryStatus")
                                {
                                    tr += $"<td>{row.DeliveryStatus.ToString()}</td>";
                                }
                                else if (i.ColumnName == "Status")
                                {
                                    tr += $"<td>{row.Status.ToString()}</td>";
                                }
                                else if (i.ColumnName == "ItemCode")
                                {
                                    tr += $"<td>{row.ItemCode}</td>";
                                }
                                else if (i.ColumnName == "ItemName")
                                {
                                    tr += $"<td>{row.ItemName}</td>";
                                }
                                else if (i.ColumnName == "Qty")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Qty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "UnitPrice")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitPrice, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "UnitCost")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.UnitCost, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "LinePrice")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.LinePrice, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "LineCost")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.LineCost, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "Profit")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Profit, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "Percentage")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Percentage, 2, MidpointRounding.ToEven), 2)}%</td>";
                                }
                                else
                                {
                                    var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                    if (property != null)
                                    {
                                        tr += $"<td>{property.Value}</td>";
                                    }
                                    else
                                    {
                                        tr += $"<td></td>";
                                    }
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index == 0)
                            {
                                tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction) && i.ColumnType != ColumnType.Percentage)
                                {
                                    if (invoices.TotalResult != null && invoices.TotalResult.ContainsKey(i.ColumnName))
                                    {
                                        tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(invoices.TotalResult[i.ColumnName], rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", "");
                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);
                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{sheetName}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }

        #endregion


        #region Delivery Schedule  Detail
        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_DeliverySchedule_Detail)]
        [HttpPost]
        public async Task<PagedResultWithTotalColuumnsDto<GetListReportDeliveryScheduleDetailOutput>> GetDeliveryScheduleDetailReport(GetListReportDeliveryScheduleSummaryInput input)
        {

            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
                                               previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var defaultLocationGroups = await GetUserGroupByLocation();
            var userGroupCustomers = await GetUserGroupCustomers();
            var userGroupItems = await GetUserGroupItems();

            var groupByProperty = false;
            if (!input.GroupBy.IsNullOrWhiteSpace())
            {
                var columns = await GetReportTemplateSaleOrderDetail();
                groupByProperty = columns.ColumnInfo.Any(s => s.ColumnName == input.GroupBy && s.ColumnType == ColumnType.ItemProperty);
            }

            var invoiceItemQuery = from iv in _invoiceItemRepository.GetAll()
                                            .Where(s => s.DeliverySchedulItemId.HasValue)
                                            .AsNoTracking()
                                   join j in _journalRepository.GetAll()
                                      .Where(s => s.InvoiceId.HasValue)
                                      .Where(s => s.Status == TransactionStatus.Publish)
                                      .AsNoTracking()
                                   on iv.InvoiceId equals j.InvoiceId

                                   join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.ItemIssueSaleItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ri.ItemIssueSaleItemId
                                   into r1

                                   join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.CustomerCreditItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                   into r2

                                   let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                   let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                   select new
                                   {
                                       DeliverySchedulItemId = iv.DeliverySchedulItemId,
                                       Qty = iv.Qty,
                                       ReturnQty = rq1 + rq2
                                   };

            var itemIssueItemQuery = from iv in _itemIssueItemRepository.GetAll()
                                             .Where(s => s.DeliverySchedulItemId.HasValue)
                                             .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                          .Where(s => s.ItemIssueId.HasValue)
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .AsNoTracking()
                                     on iv.ItemIssueId equals j.ItemIssueId
                                     join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.ItemIssueSaleItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ri.ItemIssueSaleItemId
                                     into r1

                                     join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.CustomerCreditItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                     into r2

                                     let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                     let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                     select new
                                     {
                                         DeliverySchedulItemId = iv.DeliverySchedulItemId,
                                         Qty = iv.Qty,
                                         ReturnQty = rq1 + rq2
                                     };


            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();

            var customerQuery = GetCustomers(userGroupCustomers, input.Customers, input.CustomerTypes, customerTypeMemberIds);
            var locationQuery = GetLocations(null, input.Locations);
            var userQuery = GetUsers(input.Users);
            var orderQuery = from o in _deliverScheduleRepository.GetAll()
                                       .Include(u => u.DeliveryNo)
                                       .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId))
                                        .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId))
                                        .WhereIf(input.FromDate != null && input.ToDate != null,
                                                (u => (u.InitialDeliveryDate.Date) >= (input.FromDate.Date) && (u.InitialDeliveryDate.Date) <= (input.ToDate.Date)))
                                        .WhereIf(!input.Filter.IsNullOrEmpty(), u =>
                                                u.DeliveryNo.ToLower().Contains(input.Filter.ToLower()) ||
                                                u.Reference.ToLower().Contains(input.Filter.ToLower()))
                                        .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                        .WhereIf(input.Customers != null && input.Customers.Any(), s => input.Customers.Contains(s.CustomerId))
                                        .WhereIf(input.DeliveryStatuses != null && input.DeliveryStatuses.Count > 0, u => input.DeliveryStatuses.Contains(u.ReceiveStatus))
                                        .WhereIf(input.Statuses != null && input.Statuses.Count > 0, u => input.Statuses.Contains(u.Status))
                                        .AsNoTracking()
                                        .Select(o => new
                                        {
                                            Id = o.Id,
                                            OrderNumber = o.SaleOrder.OrderNumber,
                                            OrderRef = o.SaleOrder.Reference,
                                            OrderId = o.SaleOrderId,
                                            DeliveryNo = o.DeliveryNo,
                                            DeliveryRef = o.Reference,
                                            InDate = o.InitialDeliveryDate,
                                            FDate = o.FinalDeliveryDate,
                                            LocationId = o.LocationId,
                                            CustomerId = o.CustomerId,
                                            Memo = o.Memo,
                                            CreatorUserId = o.CreatorUserId,
                                            Reference = o.Reference,
                                            Status = o.Status,
                                            DeliveryStatus = o.ReceiveStatus,
                                        })
                             join c in customerQuery
                             on o.CustomerId equals c.Id
                             join l in locationQuery
                             on o.LocationId equals l.Id
                             join u in userQuery
                             on o.CreatorUserId equals u.Id
                             select new GetListReportDeliveryScheduleSummaryOutput
                             {
                                 Id = o.Id,
                                 OrderNumber = o.OrderNumber,
                                 LocationId = o.LocationId,
                                 CustomerId = o.CustomerId,
                                 Description = o.Memo,
                                 OrderRef = o.OrderRef,
                                 DeliveryStatus = o.DeliveryStatus,
                                 User = u.UserName,
                                 LocationName = l.LocationName,
                                 CustomerName = c.CustomerName,
                                 Status = o.Status,
                                 DeliveryNo = o.DeliveryNo,
                                 DeliveryRef = o.DeliveryRef,
                                 DeliveryStatusName = o.Status.ToString(),
                                 FDate = o.FDate,
                                 InDate = o.InDate,
                                 OrderId = o.OrderId.Value,
                             };

            var itemOrderWithIssue = from oi in _deliverScheduleItemRepository.GetAll()
                                                 .AsNoTracking()
                                                 .Select(oi => new
                                                 {
                                                     DeliveryId = oi.DeliveryScheduleId,
                                                     DeliveryScheduleItemId = oi.Id,
                                                     OrderItemId = oi.SaleOrderItemId,
                                                     ItemId = oi.ItemId,
                                                     DeliveryQty = oi.Qty,
                                                     oi.Description
                                                 })

                                     join bi in invoiceItemQuery
                                     on oi.DeliveryScheduleItemId equals bi.DeliverySchedulItemId
                                     into bItems

                                     join ri in itemIssueItemQuery
                                     on oi.DeliveryScheduleItemId equals ri.DeliverySchedulItemId
                                     into rItems

                                     let bQty = bItems == null || bItems.Count() == 0 ? 0 : bItems.Sum(r => r.Qty - r.ReturnQty)
                                     let rQty = rItems == null || rItems.Count() == 0 ? 0 : rItems.Sum(r => r.Qty - r.ReturnQty)
                                     let receiveQty = bQty + rQty

                                     select new DeliveryScheduleItemDetailOutput
                                     {

                                         ItemId = oi.ItemId,
                                         IssueQty = receiveQty,
                                         Description = oi.Description,
                                         DeliveryId = oi.DeliveryId,
                                         DeliveryQty = oi.DeliveryQty,
                                         DeliveryScheduleItemId = oi.DeliveryScheduleItemId,

                                     };

            var itemQuery = GetItemWithProperties(new List<Guid>(), new List<Guid>(), null);

            var orderItemWithProperty = from oi in itemOrderWithIssue

                                        join i in itemQuery
                                        on oi.ItemId equals i.Id
                                        let netWeight = !i.Properties.Any(p => p.IsUnit) ? 0 : i.Properties.Where(t => t.IsUnit).Select(t => t.NetWeight).FirstOrDefault()
                                        let propertypeGroup = groupByProperty ? i.Properties.Where(t => t.PropertyName == input.GroupBy).Select(t => t.Value).FirstOrDefault() : ""
                                        select new DeliveryScheduleItemDetailOutput
                                        {
                                            DeliveryId = oi.DeliveryId,
                                            DeliveryScheduleItemId = oi.DeliveryScheduleItemId,
                                            ItemId = oi.ItemId,
                                            ItemCode = i.ItemCode,
                                            ItemName = i.ItemName,
                                            DeliveryQty = oi.DeliveryQty,
                                            IssueQty = oi.IssueQty,
                                            NetWeight = netWeight,
                                            Properties = i.Properties,
                                            Description = oi.Description,
                                            PropertyGroup = propertypeGroup
                                        };


            var query = from o in orderQuery
                        join oi in orderItemWithProperty
                        on o.Id equals oi.DeliveryId

                        where (input.Items == null || !input.Items.Any() || input.Items.Contains(oi.ItemId)) &&
                              (input.PropertyDics == null || !input.PropertyDics.Any() ||
                               oi.Properties.Where(ip => input.PropertyDics.Any(v => v.PropertyId == ip.PropertyId) &&
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId) != null &&
                                   (input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds == null ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Count == 0 ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Contains(ip.Id)))
                                .Count() == input.PropertyDics.Count)

                        select new GetListReportDeliveryScheduleDetailOutput
                        {
                            Id = o.Id,
                            FDate = o.FDate,
                            InDate = o.InDate,
                            OrderNumber = o.OrderNumber,
                            OrderReference = o.OrderRef,
                            DeliveryStatus = o.DeliveryStatus,
                            DeliveryStatusName = o.DeliveryStatus.ToString(),
                            Status = o.Status,
                            StatusName = o.Status.ToString(),
                            User = o.User,
                            Memo = o.Description,
                            LocationId = o.LocationId,
                            LocationName = o.LocationName,
                            CustomerId = o.CustomerId,
                            CustomerName = o.CustomerName,
                            Description = oi.Description,
                            ItemId = oi.ItemId,
                            ItemCode = oi.ItemCode,
                            ItemName = oi.ItemName,
                            DeliveryQty = oi.DeliveryQty,
                            IssueQty = oi.IssueQty,
                            QtyBalance = oi.DeliveryQty - oi.IssueQty,
                            DeliveryNetWeight = oi.DeliveryQty * oi.NetWeight,
                            IssueNetWeight = oi.IssueQty * oi.NetWeight,
                            NetWeightBalance = (oi.DeliveryQty - oi.IssueQty) * oi.NetWeight,
                            DeliveryNetWeightInTon = Math.Round(oi.DeliveryQty * oi.NetWeight / 1000, currentRoundingDigit),
                            IssueNetWeightInTon = Math.Round(oi.IssueQty * oi.NetWeight / 1000, currentRoundingDigit),
                            NetWeightBalanceInTon = Math.Round((oi.DeliveryQty - oi.IssueQty) * oi.NetWeight / 1000, currentRoundingDigit),
                            Properties = oi.Properties,
                            RoundingDigit = currentRoundingDigit,
                            DeliveryNo = o.DeliveryNo,
                            DeliveryReference = o.DeliveryRef,
                            DeliveryScheduleItemId = oi.DeliveryScheduleItemId,
                            OrderId = o.OrderId,
                            PropertyGroup = oi.PropertyGroup
                        };


            DeliveryScheduleDetailColumnSummaryOutPut summary = null;
            var resultCount = await query.CountAsync();

            if (resultCount == 0) return new PagedResultWithTotalColuumnsDto<GetListReportDeliveryScheduleDetailOutput>(resultCount, new List<GetListReportDeliveryScheduleDetailOutput>(), new Dictionary<string, decimal>());

            if (input.IsLoadMore == false && input.ColumnNamesToSum != null)
            {
                summary = await query.Select(s => new
                {
                    s.DeliveryQty,
                    s.IssueQty,
                    s.QtyBalance,
                    s.DeliveryNetWeight,
                    s.IssueNetWeight,
                    s.NetWeightBalance,
                    s.DeliveryNetWeightInTon,
                    s.IssueNetWeightInTon,
                    s.NetWeightBalanceInTon,
                })
                .GroupBy(s => 1)
                .Select(s => new DeliveryScheduleDetailColumnSummaryOutPut
                {

                    TotalDeliveryQty = s.Sum(t => t.DeliveryQty),
                    QtyBalance = s.Sum(t => t.QtyBalance),
                    TotalDeliveryNetWeight = s.Sum(t => t.DeliveryNetWeight),
                    TotalIssueNetWeight = s.Sum(t => t.IssueNetWeight),
                    NetWeightBalance = s.Sum(t => t.NetWeightBalance),
                    TotalDeliveryNetWeightInTon = s.Sum(t => t.DeliveryNetWeightInTon),
                    TotalIssueNetWeightInTon = s.Sum(t => t.IssueNetWeightInTon),
                    NetWeightBalanceInTon = s.Sum(t => t.NetWeightBalanceInTon),
                    TotalIssueQty = s.Sum(t => t.IssueQty)
                })
                .FirstOrDefaultAsync();

            }
            var sumOfColumns = new Dictionary<string, decimal>();

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "DeliveryQty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalDeliveryQty);
                    }
                    else if (col == "IssueQty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueQty);
                    }
                    else if (col == "QtyBalance")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.QtyBalance);
                    }
                    else if (col == "DeliveryNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalDeliveryNetWeight);
                    }
                    else if (col == "IssueNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueNetWeight);
                    }
                    else if (col == "NetWeightBalance")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.NetWeightBalance);
                    }
                    else if (col == "DeliveryNetWeightInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalDeliveryNetWeightInTon);
                    }
                    else if (col == "IssueNetWeightInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueNetWeightInTon);
                    }
                    else if (col == "NetWeightBalanceInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.NetWeightBalanceInTon);
                    }
                }
            }


            switch (input.GroupBy)
            {
                case "InDate":
                    query = query.OrderBy(s => s.InDate.Date).ThenBy(s => s.ItemCode);
                    break;
                case "FDate":
                    query = query.OrderBy(s => s.FDate.Date).ThenBy(s => s.ItemCode);
                    break;
                case "Location":
                    query = query.OrderBy(s => s.LocationName).ThenBy(s => s.InDate.Date).ThenBy(s => s.ItemCode);
                    break;
                case "Customer":
                    query = query.OrderBy(s => s.CustomerName).ThenBy(s => s.InDate.Date).ThenBy(s => s.ItemCode);
                    break;
                case "Item":
                    query = query.OrderBy(s => s.ItemCode).ThenBy(s => s.InDate.Date);
                    break;
                case "OrderNumber":
                    query = query.OrderBy(s => s.OrderNumber).ThenBy(s => s.InDate.Date).ThenBy(s => s.ItemCode);
                    break;
                case "DeliveryNo":
                    query = query.OrderBy(s => s.DeliveryNo).ThenBy(s => s.ItemCode);
                    break;
                default:
                    if (groupByProperty)
                    {
                        query = query.OrderBy(s => s.PropertyGroup).ThenBy(s => s.InDate.Date).ThenBy(s => s.ItemCode);
                    }
                    else
                    {
                        query = query.OrderBy(s => s.InDate.Date).ThenBy(s => s.ItemCode);
                    }
                    break;
            }

            var @entities = new List<GetListReportDeliveryScheduleDetailOutput>();
            if (input.UsePagination == true)
            {
                @entities = await query.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await query.ToListAsync();
            }

            var returnResult = new PagedResultWithTotalColuumnsDto<GetListReportDeliveryScheduleDetailOutput>(resultCount, @entities, sumOfColumns);

            return returnResult;
        }
        public async Task<ReportOutput> GetReportTemplateDeliveryScheduleDetail()
        {
            var itemPropertyCols = await _propertyRepository.GetAll().AsNoTracking()
                                    .Where(t => t.IsActive == true)
                                    .Select(t => new CollumnOutput
                                    {
                                        AllowGroupby = true,
                                        AllowFilter = true,
                                        ColumnName = t.Name,
                                        ColumnLength = 150,
                                        ColumnTitle = t.Name,
                                        ColumnType = ColumnType.ItemProperty,
                                        SortOrder = 26,
                                        Visible = true,
                                        AllowFunction = null,
                                        MoreFunction = null,
                                        IsDisplay = true,
                                        AllowShowHideFilter = true,
                                        ShowHideFilter = true,
                                        DefaultValue = t.Id.ToString(),
                                    })
                                    .ToListAsync();

            var columnInfo = new List<CollumnOutput>() {
                // start properties with can filter
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Search",
                    ColumnLength = 150,
                    ColumnTitle = "Search",
                    ColumnType = ColumnType.Language,
                    SortOrder = 0,
                    Visible = true,
                    AllowFunction = null,
                    MoreFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    IsDisplay = false
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "DateRange",
                    ColumnLength = 150,
                    ColumnTitle = "DateRange",
                    ColumnType = ColumnType.Language,
                    SortOrder = 0,
                    Visible = true,
                    DefaultValue = "thisMonth",
                    AllowFunction = null,
                    DisableDefault = false,
                    MoreFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    IsDisplay = false
                },

                new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = false,
                    ColumnName = "InDate",
                    ColumnLength = 150,
                    ColumnTitle = "Initial Delivery Date",
                    ColumnType = ColumnType.Date,
                    SortOrder = 1,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = false,
                    ColumnName = "FDate",
                    ColumnLength = 150,
                    ColumnTitle = "Final Delivery Date",
                    ColumnType = ColumnType.Date,
                    SortOrder = 2,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = false,
                    ColumnName = "DeliveryNo",
                    ColumnLength = 140,
                    ColumnTitle = "Delivery No",
                    ColumnType = ColumnType.String,
                    SortOrder = 3,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "DeliveryRef",
                    ColumnLength = 140,
                    ColumnTitle = "Delivery Ref",
                    ColumnType = ColumnType.String,
                    SortOrder = 4,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },

                new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = false,
                    ColumnName = "OrderNumber",
                    ColumnLength = 140,
                    ColumnTitle = "Order Number",
                    ColumnType = ColumnType.String,
                    SortOrder = 5,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "OrderRef",
                    ColumnLength = 140,
                    ColumnTitle = "Order Ref",
                    ColumnType = ColumnType.String,
                    SortOrder = 6,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                 new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = true,
                    ColumnName = "Location",
                    ColumnLength = 120,
                    ColumnTitle = "Location",
                    ColumnType = ColumnType.String,
                    SortOrder = 7,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Memo",
                    ColumnLength = 140,
                    ColumnTitle = "Memo",
                    ColumnType = ColumnType.String,
                    SortOrder = 8,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },

                new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = true,
                    ColumnName = "Customer",
                    ColumnLength = 150,
                    ColumnTitle = "Customer",
                    ColumnType = ColumnType.String,
                    SortOrder = 9,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = true,
                    AllowFilter = true,
                    ColumnName = "Item",
                    ColumnLength = 250,
                    ColumnTitle = "Item",
                    ColumnType = ColumnType.String,
                    SortOrder = 10,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                 new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "ItemCode",
                    ColumnLength = 250,
                    ColumnTitle = "Item Code",
                    ColumnType = ColumnType.String,
                    SortOrder = 11,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "ItemName",
                    ColumnLength = 250,
                    ColumnTitle = "Item Name",
                    ColumnType = ColumnType.String,
                    SortOrder = 12,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "DeliveryQty",
                    ColumnLength = 120,
                    ColumnTitle = "Delivery Qty",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 13,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueQty",
                    ColumnLength = 120,
                    ColumnTitle = "Issue Qty",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 14,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                 new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "QtyBalance",
                    ColumnLength = 120,
                    ColumnTitle = "QtyBalance",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 15,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "DeliveryNetWeight",
                    ColumnLength = 120,
                    ColumnTitle = "Delivery NetWeight",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 16,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueNetWeight",
                    ColumnLength = 120,
                    ColumnTitle = "Issue NetWeight",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 17,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "NetWeightBalance",
                    ColumnLength = 120,
                    ColumnTitle = "NetWeight Balance",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 18,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                 new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "DeliveryNetWeightInTon",
                    ColumnLength = 120,
                    ColumnTitle = "Delivery NetWeight in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 18,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueNetWeightInTon",
                    ColumnLength = 120,
                    ColumnTitle = "Issue NetWeight in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 20,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "NetWeightBalanceInTon",
                    ColumnLength = 120,
                    ColumnTitle = "NetWeight Balance in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 21,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Description",
                    ColumnLength = 150,
                    ColumnTitle = "Description",
                    ColumnType = ColumnType.String,
                    SortOrder = 22,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "DeliveryStatus",
                    ColumnLength = 150,
                    ColumnTitle = "Delivery Status",
                    ColumnType = ColumnType.StatusCode,
                    SortOrder = 23,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "User",
                    ColumnLength = 110,
                    ColumnTitle = "User",
                    ColumnType = ColumnType.String,
                    SortOrder = 24,
                    Visible = true,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "CustomerType",
                    ColumnLength = 150,
                    ColumnTitle = "Customer Type",
                    ColumnType = ColumnType.String,
                    SortOrder = 25,
                    Visible = true,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Status",
                    ColumnLength = 150,
                    ColumnTitle = "Status",
                    ColumnType = ColumnType.StatusCode,
                    SortOrder = 26,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
            };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columnInfo.Concat(itemPropertyCols).ToList(),
                Groupby = "",
                HeaderTitle = "Delivery Schedule Detail Report",
                Sortby = "",
            };

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_DeliverySchedule_Detail_Export_Excel)]
        public async Task<FileDto> ExportExcelDeliveryScheduleDetailReport(GetDeliveryScheduleSummaryReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var reportResult = await GetDeliveryScheduleDetailReport(input);
            var invoiceData = reportResult.Items;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                       .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                       .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd-MM-yyyy";
            }

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet



                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString(formatDate);
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                    ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                    colHeaderTable += 1;
                }

                //if (isMultiCurrencies) rowTableHeader += 1;
                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                var groupByProperty = false;
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    groupByProperty = report.ColumnInfo.Any(s => s.ColumnName == input.GroupBy && s.ColumnType == ColumnType.ItemProperty);
                }

                var groupBy = new List<GetListReportDeliveryScheduleDetailGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = invoiceData
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Customer":
                            groupBy = invoiceData
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "FDate":
                            groupBy = invoiceData
                                .GroupBy(t => t.FDate.Date)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => x.FDate.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "InDate":
                            groupBy = invoiceData
                                .GroupBy(t => t.InDate.Date)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => x.InDate.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Item":
                            groupBy = invoiceData
                                .GroupBy(t => t.ItemCode)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.ItemCode}-{x.ItemName}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "OrderNumber":
                            groupBy = invoiceData
                                .GroupBy(t => t.OrderNumber)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.OrderNumber}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "DeliveryNo":
                            groupBy = invoiceData
                                .GroupBy(t => t.DeliveryNo)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.DeliveryNo}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        default:
                            if (groupByProperty)
                            {
                                groupBy = invoiceData
                                .GroupBy(t => t.PropertyGroup)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Key,
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            }
                            break;
                    }
                }
                // write body

                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0)
                {
                    foreach (var k in groupBy)
                    {
                        //key group by name
                        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                        rowBody += 1;
                        count = 1;
                        //list of item
                        foreach (var i in k.Items)
                        {
                            int collumnCellBody = 1;
                            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                            {

                                WriteBodyDeliveryScheduleDetail(ws, rowBody, collumnCellBody, item, i, count);
                                collumnCellBody += 1;
                            }
                            rowBody += 1;
                            count += 1;
                        }

                        //sub total of group by item
                        int collumnCellGroupBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (item.AllowFunction != null)
                            {
                                var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);
                                if (footerGroupDict.ContainsKey(item.ColumnName))
                                {
                                    footerGroupDict[item.ColumnName] += fromCell + ":" + toCell + ",";
                                }
                                else
                                {
                                    footerGroupDict.Add(item.ColumnName, fromCell + ":" + toCell + ",");
                                }
                                AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                            }
                            collumnCellGroupBody += 1;
                        }
                        rowBody += 1;
                    }
                }
                else
                {
                    foreach (var i in invoiceData)
                    {
                        int collumnCellBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            WriteBodyDeliveryScheduleDetail(ws, rowBody, collumnCellBody, item, i, count);
                            collumnCellBody += 1;
                        }
                        rowBody += 1;
                        count += 1;
                    }
                }
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (!input.GroupBy.IsNullOrWhiteSpace())
                            {
                                //sum custom range cell depend on group item
                                int rowFooter = rowTableHeader + 1;// get start row after 
                                var sumValue = "SUM(" + footerGroupDict[i.ColumnName] + ")";
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                }
                            }
                            else
                            {
                                int rowFooter = rowTableHeader + 1;// get start row after header 
                                var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }
                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"Delivery_Schedule_Detail_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }
        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_DeliverySchedule_Detail_Export_Pdf)]
        public async Task<FileDto> ExportPDFDeliveryScheduleDetailReport(GetDeliveryScheduleSummaryReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                        .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                        .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }

            var rounding = await GetCurrentCycleAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            //int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;
            var user = await GetCurrentUserAsync();
            var invoices = await GetDeliveryScheduleDetailReport(input);

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                //var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";

                            rowHeader = $"<th width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";

                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                //multiCurrencyHeader += isMultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                var groupByProperty = false;
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    groupByProperty = report.ColumnInfo.Any(s => s.ColumnName == input.GroupBy && s.ColumnType == ColumnType.ItemProperty);
                }

                var groupBy = new List<GetListReportDeliveryScheduleDetailGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = invoices.Items
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Customer":
                            groupBy = invoices.Items
                                .GroupBy(t => t.CustomerName)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "FDate":
                            groupBy = invoices.Items
                                .GroupBy(t => t.FDate.Date)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => x.FDate.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "InDate":
                            groupBy = invoices.Items
                                .GroupBy(t => t.InDate.Date)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => x.InDate.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Item":
                            groupBy = invoices.Items
                                .GroupBy(t => t.ItemCode)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.ItemCode}-{x.ItemName}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "OrderNumber":
                            groupBy = invoices.Items
                                .GroupBy(t => t.OrderNumber)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.OrderNumber}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "DeliveryNo":
                            groupBy = invoices.Items
                                .GroupBy(t => t.DeliveryNo)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Select(x => $"{x.DeliveryNo}").FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        default:
                            if (groupByProperty)
                            {
                                groupBy = invoices.Items
                                .GroupBy(t => t.PropertyGroup)
                                .Select(t => new GetListReportDeliveryScheduleDetailGroupByOutput
                                {
                                    KeyName = t.Key,
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            }
                            break;
                    }
                }

                // write body
                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0) //write body have group by
                {
                    var trGroup = "";
                    foreach (var k in groupBy)
                    {
                        trGroup += $"<tr style='page-break-before: auto; page-break-after: auto;'>" +
                                   $"<td style='font-weight: bold;' colspan='{reportCountColHead}'> " + k.KeyName +
                                   $" </td></tr>";
                        foreach (var row in k.Items)
                        {
                            trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                            foreach (var i in viewHeader)
                            {
                                if (i.Visible)
                                {
                                    if (i.ColumnName == "Location")
                                    {
                                        trGroup += $"<td>{row.LocationName}</td>";
                                    }
                                    else if (i.ColumnName == "InDate")
                                    {
                                        trGroup += $"<td>{row.InDate.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "FDate")
                                    {
                                        trGroup += $"<td>{row.FDate.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryNo")
                                    {
                                        trGroup += $"<td>{row.DeliveryNo}</td>";
                                    }
                                    else if (i.ColumnName == "OrderNumber")
                                    {
                                        trGroup += $"<td>{row.OrderNumber}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryRef")
                                    {
                                        trGroup += $"<td>{row.DeliveryReference}</td>";
                                    }
                                    else if (i.ColumnName == "OrderRef")
                                    {
                                        trGroup += $"<td>{row.OrderReference}</td>";
                                    }
                                    else if (i.ColumnName == "Memo")
                                    {
                                        trGroup += $"<td>{row.Memo}</td>";
                                    }
                                    else if (i.ColumnName == "Description")
                                    {
                                        trGroup += $"<td>{row.Description}</td>";
                                    }
                                    else if (i.ColumnName == "Customer")
                                    {
                                        trGroup += $"<td>{row.CustomerName}</td>";
                                    }
                                    else if (i.ColumnName == "User")
                                    {
                                        trGroup += $"<td>{row.User}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryNetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "IssueNetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "NetWeightBalance")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryNetWeightInTon")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "IssueNetWeightInTon")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "NetWeightBalanceInTon")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalanceInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryStatus")
                                    {
                                        trGroup += $"<td>{row.DeliveryStatus.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "Status")
                                    {
                                        trGroup += $"<td>{row.Status.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "ItemCode")
                                    {
                                        trGroup += $"<td>{row.ItemCode}</td>";
                                    }
                                    else if (i.ColumnName == "ItemName")
                                    {
                                        trGroup += $"<td>{row.ItemName}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryQty")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "IssueQty")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "QtyBalance")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.QtyBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else
                                    {
                                        var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                        if (property != null)
                                        {
                                            trGroup += $"<td>{property.Value}</td>";
                                        }
                                        else
                                        {
                                            trGroup += $"<td></td>";
                                        }
                                    }
                                }
                            }
                            trGroup += "</tr>";
                        }
                        trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                                {
                                    if (i.ColumnName == "DeliveryQty")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.DeliveryQty), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "IssueQty")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.IssueQty), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "QtyBalance")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.QtyBalance), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryNetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.DeliveryNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "IssueNetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.IssueNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "NetWeightBalance")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.NetWeightBalance), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryNetWeightInTon")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.DeliveryNetWeightInTon), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "IssueNetWeightInTon")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.IssueNetWeightInTon), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "NetWeightBalanceInTon")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.NetWeightBalanceInTon), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    trGroup += $"<td></td>";
                                }

                            }
                        }
                        trGroup += "</tr>";
                    }
                    contentBody += trGroup;
                }
                else // write body no group by
                {
                    foreach (var row in invoices.Items)
                    {
                        var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "Location")
                                {
                                    tr += $"<td>{row.LocationName}</td>";
                                }
                                else if (i.ColumnName == "InDate")
                                {
                                    tr += $"<td>{row.InDate.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "FDate")
                                {
                                    tr += $"<td>{row.FDate.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "DeliveryNo")
                                {
                                    tr += $"<td>{row.DeliveryNo}</td>";
                                }
                                else if (i.ColumnName == "OrderNumber")
                                {
                                    tr += $"<td>{row.OrderNumber}</td>";
                                }
                                else if (i.ColumnName == "DeliveryRef")
                                {
                                    tr += $"<td>{row.DeliveryReference}</td>";
                                }
                                else if (i.ColumnName == "OrderRef")
                                {
                                    tr += $"<td>{row.OrderReference}</td>";
                                }
                                else if (i.ColumnName == "Memo")
                                {
                                    tr += $"<td>{row.Memo}</td>";
                                }
                                else if (i.ColumnName == "Description")
                                {
                                    tr += $"<td>{row.Description}</td>";
                                }
                                else if (i.ColumnName == "Customer")
                                {
                                    tr += $"<td>{row.CustomerName}</td>";
                                }
                                else if (i.ColumnName == "User")
                                {
                                    tr += $"<td>{row.User}</td>";
                                }
                                else if (i.ColumnName == "DeliveryNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "IssueNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "NetWeightBalance")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "DeliveryNetWeightInTon")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "IssueNetWeightInTon")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "NetWeightBalanceInTon")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalanceInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "DeliveryStatus")
                                {
                                    tr += $"<td>{row.DeliveryStatus.ToString()}</td>";
                                }
                                else if (i.ColumnName == "Status")
                                {
                                    tr += $"<td>{row.Status.ToString()}</td>";
                                }
                                else if (i.ColumnName == "ItemCode")
                                {
                                    tr += $"<td>{row.ItemCode}</td>";
                                }
                                else if (i.ColumnName == "ItemName")
                                {
                                    tr += $"<td>{row.ItemName}</td>";
                                }
                                else if (i.ColumnName == "DeliveryQty")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "IssueQty")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "QtyBalance")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.QtyBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else
                                {
                                    var property = row.Properties.FirstOrDefault(s => s.PropertyName == i.ColumnName);
                                    if (property != null)
                                    {
                                        tr += $"<td>{property.Value}</td>";
                                    }
                                    else
                                    {
                                        tr += $"<td></td>";
                                    }
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index == 0)
                            {
                                tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))
                                {
                                    if (invoices.TotalResult != null && invoices.TotalResult.ContainsKey(i.ColumnName))
                                    {
                                        tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(invoices.TotalResult[i.ColumnName], rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", "");
                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);
                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{sheetName}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }


        #endregion



        #region Delivery Schedule Rummary Report         

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_DeliverySchedule_Summary)]
        [HttpPost]
        public async Task<PagedResultWithTotalColuumnsDto<GetListReportDeliveryScheduleSummaryOutput>> GetDeliveryScheduleSummaryReport(GetListReportDeliveryScheduleSummaryInput input)
        {

            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
                                               previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var defaultLocationGroups = await GetUserGroupByLocation();
            var userGroupCustomers = await GetUserGroupCustomers();
            var userGroupItems = await GetUserGroupItems();

            var invoiceItemQuery = from iv in _invoiceItemRepository.GetAll()
                                            .Where(s => s.DeliverySchedulItemId.HasValue)
                                            .AsNoTracking()
                                   join j in _journalRepository.GetAll()
                                      .Where(s => s.InvoiceId.HasValue)
                                      .Where(s => s.Status == TransactionStatus.Publish)
                                      .AsNoTracking()
                                   on iv.InvoiceId equals j.InvoiceId

                                   join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.ItemIssueSaleItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ri.ItemIssueSaleItemId
                                   into r1

                                   join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.CustomerCreditItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                   into r2

                                   let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                   let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                   select new
                                   {
                                       DeliverySchedulItemId = iv.DeliverySchedulItemId,
                                       Qty = iv.Qty,
                                       ReturnQty = rq1 + rq2
                                   };

            var itemIssueItemQuery = from iv in _itemIssueItemRepository.GetAll()
                                             .Where(s => s.DeliverySchedulItemId.HasValue)
                                             .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                          .Where(s => s.ItemIssueId.HasValue)
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .AsNoTracking()
                                     on iv.ItemIssueId equals j.ItemIssueId
                                     join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.ItemIssueSaleItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ri.ItemIssueSaleItemId
                                     into r1

                                     join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.CustomerCreditItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                     into r2

                                     let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                     let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                     select new
                                     {
                                         DeliverySchedulItemId = iv.DeliverySchedulItemId,
                                         Qty = iv.Qty,
                                         ReturnQty = rq1 + rq2
                                     };


            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();

            var customerQuery = GetCustomers(userGroupCustomers, input.Customers, input.CustomerTypes, customerTypeMemberIds);
            var locationQuery = GetLocations(null, input.Locations);
            var userQuery = GetUsers(input.Users);


            var orderQuery = from o in _deliverScheduleRepository.GetAll()
                                        .Include(u => u.SaleOrder)
                                        .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId))
                                        .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId))
                                        .WhereIf(input.FromDate != null && input.ToDate != null,
                                                (u => (u.InitialDeliveryDate.Date) >= (input.FromDate.Date) && (u.InitialDeliveryDate.Date) <= (input.ToDate.Date)))
                                        .WhereIf(!input.Filter.IsNullOrEmpty(), u =>
                                                u.DeliveryNo.ToLower().Contains(input.Filter.ToLower()) ||
                                                u.Reference.ToLower().Contains(input.Filter.ToLower()))
                                        .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                                        .WhereIf(input.Customers != null && input.Customers.Any(), s => input.Customers.Contains(s.CustomerId))
                                        .WhereIf(input.DeliveryStatuses != null && input.DeliveryStatuses.Count > 0, u => input.DeliveryStatuses.Contains(u.ReceiveStatus))
                                        .WhereIf(input.Statuses != null && input.Statuses.Count > 0, u => input.Statuses.Contains(u.Status))
                                        .AsNoTracking()
                                        .Select(o => new
                                        {
                                            Id = o.Id,
                                            OrderNumber = o.SaleOrder.OrderNumber,
                                            OrderRef = o.SaleOrder.Reference,
                                            OrderId = o.SaleOrderId,
                                            InDate = o.InitialDeliveryDate,
                                            FDate = o.FinalDeliveryDate,
                                            LocationId = o.LocationId,
                                            CustomerId = o.CustomerId,
                                            Description = o.Memo,
                                            CreatorUserId = o.CreatorUserId,
                                            DeilveryRef = o.Reference,
                                            ReceiveStatus = o.ReceiveStatus,
                                            DeliveryNo = o.DeliveryNo,
                                            o.Status
                                        })
                             join c in customerQuery
                             on o.CustomerId equals c.Id
                             join l in locationQuery
                             on o.LocationId equals l.Id
                             join u in userQuery
                             on o.CreatorUserId equals u.Id
                             select new GetListReportDeliveryScheduleSummaryOutput
                             {
                                 Id = o.Id,
                                 OrderNumber = o.OrderNumber,
                                 FDate = o.FDate,
                                 InDate = o.InDate,
                                 LocationId = o.LocationId,
                                 CustomerId = o.CustomerId,
                                 Description = o.Description,
                                 DeliveryRef = o.DeilveryRef,
                                 DeliveryNo = o.DeliveryNo,
                                 DeliveryStatusName = o.Status.ToString(),
                                 DeliveryStatus = o.ReceiveStatus,
                                 User = u.UserName,
                                 LocationName = l.LocationName,
                                 CustomerName = c.CustomerName,
                                 Status = o.Status,
                                 OrderId = o.OrderId,
                                 OrderRef = o.OrderRef,

                             };

            var itemOrderWithIssue = from oi in _deliverScheduleItemRepository.GetAll()
                                                 .AsNoTracking()
                                                 .Select(oi => new
                                                 {
                                                     DeliveryScheduleId = oi.DeliveryScheduleId,
                                                     DeliveryScheduleItemId = oi.Id,
                                                     ItemId = oi.ItemId,
                                                     DeliveryQty = oi.Qty,
                                                     OrderId = oi.DeliverySchedule.SaleOrderId,
                                                     OrderItemId = oi.SaleOrderItemId,
                                                 })

                                     join bi in invoiceItemQuery
                                     on oi.DeliveryScheduleItemId equals bi.DeliverySchedulItemId
                                     into bItems

                                     join ri in itemIssueItemQuery
                                     on oi.DeliveryScheduleItemId equals ri.DeliverySchedulItemId
                                     into rItems

                                     let bQty = bItems == null || bItems.Count() == 0 ? 0 : bItems.Sum(r => r.Qty - r.ReturnQty)
                                     let rQty = rItems == null || rItems.Count() == 0 ? 0 : rItems.Sum(r => r.Qty - r.ReturnQty)
                                     let receiveQty = bQty + rQty

                                     select new DeliveryScheduleItemSummaryOutput
                                     {
                                         DeliveryId = oi.DeliveryScheduleId,
                                         DeliveryScheduleItemId = oi.DeliveryScheduleItemId,
                                         ItemId = oi.ItemId,
                                         DeliveryQty = oi.DeliveryQty,
                                         IssueQty = receiveQty,
                                         OrderId = oi.OrderId,
                                         OrderItemId = oi.OrderItemId,
                                     };

            var itemQuery = GetItemWithProperties(new List<Guid>(), new List<Guid>(), null);

            var orderItemWithProperty = from oi in itemOrderWithIssue

                                        join i in itemQuery
                                        on oi.ItemId equals i.Id

                                        let netWeight = !i.Properties.Any(p => p.IsUnit) ? 0 : i.Properties.Where(t => t.IsUnit).Select(t => t.NetWeight).FirstOrDefault()

                                        select new DeliveryScheduleItemSummaryOutput
                                        {
                                            OrderId = oi.OrderId,
                                            OrderItemId = oi.OrderItemId,
                                            ItemId = oi.ItemId,
                                            ItemCode = i.ItemCode,
                                            ItemName = i.ItemName,
                                            DeliveryQty = oi.DeliveryQty,
                                            IssueQty = oi.IssueQty,
                                            DeliveryNetWeight = oi.DeliveryQty * netWeight / 1000,
                                            IssueNetWeight = oi.IssueQty * netWeight / 1000,
                                            Properties = i.Properties,
                                            DeliveryId = oi.DeliveryId,
                                            DeliveryScheduleItemId = oi.DeliveryScheduleItemId,
                                        };


            var query = from o in orderQuery
                        join oi in orderItemWithProperty
                        on o.Id equals oi.DeliveryId
                        into items

                        where (input.Items == null || input.Items.Count() == 0 || items.Any(i => input.Items.Contains(i.ItemId))) &&
                               (input.PropertyDics == null || input.PropertyDics.Count() == 0 ||
                               items.Any(p => p.Properties.Where(ip => input.PropertyDics.Any(v => v.PropertyId == ip.PropertyId) &&
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId) != null &&
                                   (input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds == null ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Count == 0 ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Contains(ip.Id)))
                                .Count() == input.PropertyDics.Count)
                               )

                        select new GetListReportDeliveryScheduleSummaryOutput
                        {
                            Id = o.Id,
                            FDate = o.FDate,
                            OrderNumber = o.OrderNumber,
                            DeliveryRef = o.DeliveryRef,
                            DeliveryNo = o.DeliveryNo,
                            InDate = o.InDate,
                            OrderRef = o.OrderRef,
                            OrderId = o.OrderId,
                            DeliveryStatus = o.DeliveryStatus,
                            DeliveryStatusName = o.DeliveryStatus.ToString(),
                            Status = o.Status,
                            StatusName = o.Status.ToString(),
                            User = o.User,
                            Description = o.Description,
                            LocationId = o.LocationId,
                            LocationName = o.LocationName,
                            CustomerId = o.CustomerId,
                            CustomerName = o.CustomerName,
                            TotalDeliveryNetWeight = items.Sum(s => s.DeliveryNetWeight),
                            TotalIssueNetWeight = items.Sum(s => s.IssueNetWeight),
                            TotalRemainingNetWeight = items.Sum(s => s.DeliveryNetWeight - s.IssueNetWeight),
                            RoundingDigit = currentRoundingDigit,
                            Items = items.Select(s => new DeliveryScheduleItemSummaryOutput
                            {
                                ItemId = s.ItemId,
                                ItemCode = s.ItemCode,
                                ItemName = s.ItemName,
                                DeliveryQty = s.DeliveryQty,
                                IssueQty = s.IssueQty,
                                IssueNetWeight = s.IssueNetWeight,
                                DeliveryNetWeight = s.DeliveryNetWeight,
                                Properties = s.Properties
                            }).ToList(),
                        };


            DeliveryScheduleColumnSummaryOutPut summary = null;
            var resultCount = await query.CountAsync();

            if (resultCount == 0) return new PagedResultWithTotalColuumnsDto<GetListReportDeliveryScheduleSummaryOutput>(resultCount, new List<GetListReportDeliveryScheduleSummaryOutput>(), new Dictionary<string, decimal>());

            if (input.IsLoadMore == false && input.ColumnNamesToSum != null)
            {
                summary = await query.Select(s => new
                {
                    s.TotalDeliveryNetWeight,
                    s.TotalIssueNetWeight
                })
                .GroupBy(s => 1)
                .Select(s => new DeliveryScheduleColumnSummaryOutPut
                {
                    TotalDeliveryNetWeight = s.Sum(t => t.TotalDeliveryNetWeight),
                    TotalIssueNetWeight = s.Sum(t => t.TotalIssueNetWeight)
                })
                .FirstOrDefaultAsync();

            }
            var sumOfColumns = new Dictionary<string, decimal>();

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "TotalDeliveryNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalDeliveryNetWeight);
                    }
                    else if (col == "TotalIssueNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueNetWeight);
                    }
                    else if (col == "TotalRemainingNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalDeliveryNetWeight - summary.TotalIssueNetWeight);
                    }
                }
            }
            switch (input.GroupBy)
            {
                case "InDate":
                    query = query.OrderBy(s => s.InDate);
                    break;
                case "FDate":
                    query = query.OrderBy(s => s.FDate);
                    break;
                case "Location":
                    query = query.OrderBy(s => s.LocationName);
                    break;
                case "Customer":
                    query = query.OrderBy(s => s.CustomerName);
                    break;
                case "DeliveryNo":
                    query = query.OrderBy(s => s.DeliveryNo);
                    break;
                case "OrderNumber":
                    query = query.OrderBy(s => s.OrderNumber);
                    break;
                default:
                    query = query.OrderBy(s => input.Sorting);
                    break;
            }

            var @entities = new List<GetListReportDeliveryScheduleSummaryOutput>();
            if (input.UsePagination == true)
            {
                @entities = await query.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await query.ToListAsync();
            }

            var returnResult = new PagedResultWithTotalColuumnsDto<GetListReportDeliveryScheduleSummaryOutput>(resultCount, @entities, sumOfColumns);

            return returnResult;
        }
        public ReportOutput GetReportTemplateDeliveryScheduleSummary()
        {
            var itemPropertyCols = _propertyRepository.GetAll().AsNoTracking()
                            .Where(t => t.IsActive == true)
                            .Select(t => new CollumnOutput
                            {
                                AllowGroupby = false,
                                AllowFilter = true,
                                ColumnName = t.Name,
                                ColumnLength = 150,
                                ColumnTitle = t.Name,
                                ColumnType = ColumnType.ItemProperty,
                                SortOrder = 11,
                                Visible = true,
                                AllowFunction = null,
                                MoreFunction = null,
                                IsDisplay = false,
                                AllowShowHideFilter = true,
                                ShowHideFilter = true,
                                DefaultValue = t.Id.ToString(),//to init the value of property
                            });

            var columnInfo = new List<CollumnOutput>() {

                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Search",
                        ColumnLength = 150,
                        ColumnTitle = "Search",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DateRange",
                        ColumnLength = 150,
                        ColumnTitle = "DateRange",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        DefaultValue = "thisMonth",
                        AllowFunction = null,
                        DisableDefault = false,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },

                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = false,
                        ColumnName = "InDate",
                        ColumnLength = 150,
                        ColumnTitle = "Initial Delivery Date",
                        ColumnType = ColumnType.Date,
                        SortOrder = 1,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                        new CollumnOutput{
                            AllowGroupby = true,
                            AllowFilter = false,
                            ColumnName = "FDate",
                            ColumnLength = 150,
                            ColumnTitle = "Final Delivery Date",
                            ColumnType = ColumnType.Date,
                            SortOrder = 2,
                            Visible = true,
                            AllowFunction = null,
                            IsDisplay = true,
                            AllowShowHideFilter = false,
                            ShowHideFilter = false,
                        },
                       new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = false,
                        ColumnName = "DeliveryNo",
                        ColumnLength = 140,
                        ColumnTitle = "Delivery No",
                        ColumnType = ColumnType.String,
                        SortOrder = 3,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = false,
                        ColumnName = "OrderNumber",
                        ColumnLength = 140,
                        ColumnTitle = "Order Number",
                        ColumnType = ColumnType.String,
                        SortOrder = 4,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Reference",
                        ColumnLength = 140,
                        ColumnTitle = "Reference No",
                        ColumnType = ColumnType.String,
                        SortOrder = 5,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Customer",
                        ColumnLength = 150,
                        ColumnTitle = "Customer",
                        ColumnType = ColumnType.String,
                        SortOrder = 6,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Item",
                        ColumnLength = 250,
                        ColumnTitle = "Item",
                        ColumnType = ColumnType.String,
                        SortOrder = 7,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Qty",
                        ColumnLength = 120,
                        ColumnTitle = "Qty",
                        ColumnType = ColumnType.String,
                        SortOrder = 8,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                        new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "NetWeight",
                        ColumnLength = 120,
                        ColumnTitle = "Net Weight in Ton",
                        ColumnType = ColumnType.String,
                        SortOrder = 9,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = true,
                        AllowFilter = true,
                        ColumnName = "Location",
                        ColumnLength = 120,
                        ColumnTitle = "Location",
                        ColumnType = ColumnType.String,
                        SortOrder = 10,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Description",
                        ColumnLength = 150,
                        ColumnTitle = "Description",
                        ColumnType = ColumnType.String,
                        SortOrder = 11,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DeliveryStatus",
                        ColumnLength = 150,
                        ColumnTitle = "Delivery Status",
                        ColumnType = ColumnType.StatusCode,
                        SortOrder = 12,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },

                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalDeliveryNetWeight",
                        ColumnLength = 150,
                        ColumnTitle = "Total Delivery in Ton",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 13,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalIssueNetWeight",
                        ColumnLength = 150,
                        ColumnTitle = "Total Issue in Ton",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 14,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "TotalRemainingNetWeight",
                        ColumnLength = 150,
                        ColumnTitle = "Total Remaining in Ton",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 15,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "User",
                        ColumnLength = 110,
                        ColumnTitle = "User",
                        ColumnType = ColumnType.String,
                        SortOrder = 16,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "CustomerType",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 16,
                        Visible = true,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Status",
                        ColumnLength = 150,
                        ColumnTitle = "Status",
                        ColumnType = ColumnType.StatusCode,
                        SortOrder = 18,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columnInfo.Concat(itemPropertyCols).ToList(),
                Groupby = "",
                HeaderTitle = "Delivery Schedule Summary Report",
                Sortby = "",
            };

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_DeliverySchedule_Summary_Export_Excel)]
        public async Task<FileDto> ExportExcelDeliveryScheduleSummaryReport(GetDeliveryScheduleSummaryReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var reportResult = await GetDeliveryScheduleSummaryReport(input);
            var invoiceData = reportResult.Items;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                       .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                       .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd-MM-yyyy";
            }

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                //var subCols = invoiceData == null ? null : invoiceData.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
                //var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString(formatDate);
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                    ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                    colHeaderTable += 1;
                }

                //if (isMultiCurrencies) rowTableHeader += 1;
                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                var groupBy = new List<GetListDeliveryScheduleSummaryReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = invoiceData
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "Customer":
                            groupBy = invoiceData
                                .GroupBy(t => t.CustomerId)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "DeliveryNo":
                            groupBy = invoiceData
                                .GroupBy(t => t.DeliveryNo)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "OrderNumber":
                            groupBy = invoiceData
                                .GroupBy(t => t.OrderNumber)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "FDate":
                            groupBy = invoiceData
                                .GroupBy(t => t.FDate.Date)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.FDate.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "InDate":
                            groupBy = invoiceData
                                .GroupBy(t => t.InDate.Date)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.InDate.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                    }
                }
                // write body

                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0)
                {
                    foreach (var k in groupBy)
                    {
                        //key group by name
                        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                        rowBody += 1;
                        count = 1;
                        //list of item
                        foreach (var i in k.Items)
                        {
                            int collumnCellBody = 1;
                            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                            {

                                WriteBodyDeliveryScheduleSummary(ws, rowBody, collumnCellBody, item, i, count);
                                collumnCellBody += 1;
                            }
                            rowBody += 1;
                            count += 1;
                        }

                        //sub total of group by item
                        int collumnCellGroupBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            if (item.AllowFunction != null)
                            {
                                var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                                var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);
                                if (footerGroupDict.ContainsKey(item.ColumnName))
                                {
                                    footerGroupDict[item.ColumnName] += fromCell + ":" + toCell + ",";
                                }
                                else
                                {
                                    footerGroupDict.Add(item.ColumnName, fromCell + ":" + toCell + ",");
                                }
                                AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                            }
                            collumnCellGroupBody += 1;
                        }
                        rowBody += 1;
                    }
                }
                else
                {
                    foreach (var i in invoiceData)
                    {
                        int collumnCellBody = 1;
                        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                        {
                            WriteBodyDeliveryScheduleSummary(ws, rowBody, collumnCellBody, item, i, count);
                            collumnCellBody += 1;
                        }
                        rowBody += 1;
                        count += 1;
                    }
                }
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (!input.GroupBy.IsNullOrWhiteSpace())
                            {
                                //sum custom range cell depend on group item
                                int rowFooter = rowTableHeader + 1;// get start row after 
                                var sumValue = "SUM(" + footerGroupDict[i.ColumnName] + ")";
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, sumValue, true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, sumValue, true);
                                }
                            }
                            else
                            {
                                int rowFooter = rowTableHeader + 1;// get start row after header 
                                var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }
                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"Delivery_Schedule_Summary_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }


        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_DeliverySchedule_Summary_Export_Pdf)]
        public async Task<FileDto> ExportPDFDeliveryScheduleSummaryReport(GetDeliveryScheduleSummaryReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                        .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                        .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }

            var rounding = await GetCurrentCycleAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            //int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;
            var user = await GetCurrentUserAsync();
            var invoices = await GetDeliveryScheduleSummaryReport(input);

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                //var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";

                            rowHeader = $"<th width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";

                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                //multiCurrencyHeader += isMultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                var groupBy = new List<GetListDeliveryScheduleSummaryReportGroupByOutput>();
                //if has groupBy
                if (!input.GroupBy.IsNullOrWhiteSpace())
                {
                    switch (input.GroupBy)
                    {
                        case "Location":
                            groupBy = invoices.Items
                                .GroupBy(t => t.LocationId)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(a => a.LocationName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "Customer":
                            groupBy = invoices.Items
                                .GroupBy(t => t.CustomerName)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.CustomerName).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "FDate":
                            groupBy = invoices.Items
                                .GroupBy(t => t.FDate.Date)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.InDate.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "InDate":
                            groupBy = invoices.Items
                                .GroupBy(t => t.InDate.Date)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.InDate.ToString(formatDate)).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                        case "DeliveryNo":
                            groupBy = invoices.Items
                                .GroupBy(t => t.DeliveryNo)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.DeliveryNo).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;
                        case "OrderNumber":
                            groupBy = invoices.Items
                                .GroupBy(t => t.OrderNumber)
                                .Select(t => new GetListDeliveryScheduleSummaryReportGroupByOutput
                                {
                                    KeyName = t.Select(x => x.OrderNumber).FirstOrDefault(),
                                    Items = t.Select(x => x).ToList()
                                })
                                .ToList();
                            break;

                    }
                }

                // write body
                if (!input.GroupBy.IsNullOrWhiteSpace() && groupBy.Count > 0) //write body have group by
                {
                    var trGroup = "";
                    foreach (var k in groupBy)
                    {
                        trGroup += $"<tr style='page-break-before: auto; page-break-after: auto;'>" +
                                   $"<td style='font-weight: bold;' colspan='{reportCountColHead}'> " + k.KeyName +
                                   $" </td></tr>";
                        foreach (var row in k.Items)
                        {
                            trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                            foreach (var i in viewHeader)
                            {
                                if (i.Visible)
                                {
                                    if (i.ColumnName == "Location")
                                    {
                                        trGroup += $"<td>{row.LocationName}</td>";
                                    }

                                    else if (i.ColumnName == "InDate")
                                    {
                                        trGroup += $"<td>{row.InDate.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "FDate")
                                    {
                                        trGroup += $"<td>{row.FDate.ToString(formatDate)}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryNo")
                                    {
                                        trGroup += $"<td>{row.DeliveryNo}</td>";
                                    }
                                    else if (i.ColumnName == "OrderNumber")
                                    {
                                        trGroup += $"<td>{row.OrderNumber}</td>";
                                    }
                                    else if (i.ColumnName == "Reference")
                                    {
                                        trGroup += $"<td>{row.DeliveryRef}</td>";
                                    }
                                    else if (i.ColumnName == "Description")
                                    {
                                        trGroup += $"<td>{row.Description}</td>";
                                    }
                                    else if (i.ColumnName == "Customer")
                                    {
                                        trGroup += $"<td>{row.CustomerName}</td>";
                                    }
                                    else if (i.ColumnName == "User")
                                    {
                                        trGroup += $"<td>{row.User}</td>";
                                    }
                                    else if (i.ColumnName == "TotalDeliveryNetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalDeliveryNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "TotalIssueNetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalIssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "TotalRemainingNetWeight")
                                    {
                                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalRemainingNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                    else if (i.ColumnName == "DeliveryStatus")
                                    {
                                        trGroup += $"<td>{row.DeliveryStatus.ToString()}</td>";
                                    }
                                    else if (i.ColumnName == "Status")
                                    {
                                        trGroup += $"<td>{row.Status.ToString()}</td>";
                                    }

                                    else if (i.ColumnName == "Item")
                                    {
                                        var itemList = "";
                                        var j = 0;
                                        foreach (var oi in row.Items)
                                        {
                                            if (j > 0) itemList += "<br>";
                                            itemList += $"{oi.ItemName}";
                                            j++;
                                        }
                                        trGroup += $"<td>{itemList}</td>";
                                    }
                                    else if (i.ColumnName == "Qty")
                                    {
                                        var itemList = "";
                                        var j = 0;
                                        foreach (var oi in row.Items)
                                        {
                                            if (j > 0) itemList += "<br>";
                                            itemList += $"{AutoRound(oi.DeliveryQty)} - {AutoRound(oi.IssueQty)} = {AutoRound(oi.DeliveryQty - oi.IssueQty)}";
                                            j++;
                                        }
                                        trGroup += $"<td style='text-align: right'>{itemList}</td>";
                                    }
                                    else if (i.ColumnName == "NetWeight")
                                    {
                                        var itemList = "";
                                        var j = 0;
                                        foreach (var oi in row.Items)
                                        {
                                            if (j > 0) itemList += "<br>";
                                            itemList += $"{AutoRound(oi.DeliveryNetWeight)} - {AutoRound(oi.IssueNetWeight)} = {AutoRound(oi.DeliveryNetWeight - oi.IssueNetWeight)}";
                                            j++;
                                        }
                                        trGroup += $"<td style='text-align: right'>{itemList}</td>";
                                    }
                                    else
                                    {
                                        trGroup += $"<td></td>";
                                    }
                                }
                            }
                            trGroup += "</tr>";
                        }
                        trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                                {

                                    if (i.ColumnName == "TotalDeliveryNetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.TotalDeliveryNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "TotalIssueNetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.TotalIssueNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                    else if (i.ColumnName == "TotalRemainingNetWeight")
                                    {
                                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.TotalDeliveryNetWeight - t.TotalIssueNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                                    }
                                }
                                else //none sum
                                {
                                    trGroup += $"<td></td>";
                                }

                            }
                        }
                        trGroup += "</tr>";
                    }
                    contentBody += trGroup;
                }
                else // write body no group by
                {
                    foreach (var row in invoices.Items)
                    {
                        var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "Location")
                                {
                                    tr += $"<td>{row.LocationName}</td>";
                                }
                                else if (i.ColumnName == "InDate")
                                {
                                    tr += $"<td>{row.InDate.ToString(formatDate)}</td>";
                                }
                                else if (i.ColumnName == "FDate")
                                {
                                    tr += $"<td>{row.FDate.ToString(formatDate)}</td>";
                                }

                                else if (i.ColumnName == "DeliveryNo")
                                {
                                    tr += $"<td>{row.DeliveryNo}</td>";
                                }
                                else if (i.ColumnName == "OrderNumber")
                                {
                                    tr += $"<td>{row.OrderNumber}</td>";
                                }
                                else if (i.ColumnName == "Reference")
                                {
                                    tr += $"<td>{row.DeliveryRef}</td>";
                                }
                                else if (i.ColumnName == "Description")
                                {
                                    tr += $"<td>{row.Description}</td>";
                                }
                                else if (i.ColumnName == "Customer")
                                {
                                    tr += $"<td>{row.CustomerName}</td>";
                                }
                                else if (i.ColumnName == "User")
                                {
                                    tr += $"<td>{row.User}</td>";
                                }
                                else if (i.ColumnName == "TotalDeliveryNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalDeliveryNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "TotalIssueNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalIssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "TotalRemainingNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.TotalRemainingNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "DeliveryStatus")
                                {
                                    tr += $"<td>{row.DeliveryStatus.ToString()}</td>";
                                }
                                else if (i.ColumnName == "Status")
                                {
                                    tr += $"<td>{row.Status.ToString()}</td>";
                                }
                                else if (i.ColumnName == "Item")
                                {
                                    var itemList = "";
                                    var j = 0;
                                    foreach (var oi in row.Items)
                                    {
                                        if (j > 0) itemList += "<br>";
                                        itemList += $"{oi.ItemName}";
                                        j++;
                                    }
                                    tr += $"<td>{itemList}</td>";
                                }
                                else if (i.ColumnName == "Qty")
                                {
                                    var itemList = "";
                                    var j = 0;
                                    foreach (var oi in row.Items)
                                    {
                                        if (j > 0) itemList += "<br>";
                                        itemList += $"{AutoRound(oi.DeliveryQty)} - {AutoRound(oi.IssueQty)} = {AutoRound(oi.DeliveryQty - oi.IssueQty)}";
                                        j++;
                                    }
                                    tr += $"<td style='text-align: right'>{itemList}</td>";
                                }
                                else if (i.ColumnName == "NetWeight")
                                {
                                    var itemList = "";
                                    var j = 0;
                                    foreach (var oi in row.Items)
                                    {
                                        if (j > 0) itemList += "<br>";
                                        itemList += $"{AutoRound(oi.DeliveryNetWeight)} - {AutoRound(oi.IssueNetWeight)} = {AutoRound(oi.DeliveryNetWeight - oi.IssueNetWeight)}";
                                        j++;
                                    }
                                    tr += $"<td style='text-align: right'>{itemList}</td>";
                                }
                                else
                                {
                                    tr += $"<td></td>";
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index == 0)
                            {
                                tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))
                                {
                                    if (invoices.TotalResult != null && invoices.TotalResult.ContainsKey(i.ColumnName))
                                    {
                                        tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(invoices.TotalResult[i.ColumnName], rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", "");
                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);
                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{sheetName}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }

        #endregion


        #region Sale Order by Item Property
        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleOrderByItemProperty)]
        public async Task<ReportOutput> GetReportTemplateSaleOrderByItemProperty()
        {
            var itemPropertyCols = await _propertyRepository.GetAll().AsNoTracking()
                                    .Where(t => t.IsActive == true)
                                    .Select(t => new CollumnOutput
                                    {
                                        AllowGroupby = true,
                                        AllowFilter = true,
                                        ColumnName = t.Name,
                                        ColumnLength = 150,
                                        ColumnTitle = t.Name,
                                        ColumnType = ColumnType.ItemProperty,
                                        SortOrder = 26,
                                        Visible = true,
                                        AllowFunction = null,
                                        MoreFunction = null,
                                        IsDisplay = false,
                                        AllowShowHideFilter = true,
                                        ShowHideFilter = true,
                                        DefaultValue = t.Id.ToString(),//to init the value of property
                                    })
                                    .ToListAsync();

            var columnInfo = new List<CollumnOutput>() {
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "DateRange",
                    ColumnLength = 150,
                    ColumnTitle = "DateRange",
                    ColumnType = ColumnType.Language,
                    SortOrder = 0,
                    Visible = true,
                    DefaultValue = "thisMonth",
                    AllowFunction = null,
                    DisableDefault = false,
                    MoreFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    IsDisplay = false//no need to show in col check it belong to filter option
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "SummaryBy",
                    ColumnLength = 150,
                    ColumnTitle = "Summary By",
                    ColumnType = ColumnType.String,
                    SortOrder = 1,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Location",
                    ColumnLength = 120,
                    ColumnTitle = "Location",
                    ColumnType = ColumnType.String,
                    SortOrder = 4,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Customer",
                    ColumnLength = 150,
                    ColumnTitle = "Customer",
                    ColumnType = ColumnType.String,
                    SortOrder = 6,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Item",
                    ColumnLength = 250,
                    ColumnTitle = "Item",
                    ColumnType = ColumnType.String,
                    SortOrder = 0,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "OrderQty",
                    ColumnLength = 120,
                    ColumnTitle = "Order Qty",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 9,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueQty",
                    ColumnLength = 120,
                    ColumnTitle = "Issue Qty",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 10,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                 new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "QtyBalance",
                    ColumnLength = 120,
                    ColumnTitle = "Qty Balance",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 11,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "OrderNetWeight",
                    ColumnLength = 120,
                    ColumnTitle = "Order NetWeight",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 12,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueNetWeight",
                    ColumnLength = 120,
                    ColumnTitle = "Issue NetWeight",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 13,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "NetWeightBalance",
                    ColumnLength = 120,
                    ColumnTitle = "NetWeight Balance",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 14,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                 new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "OrderNetWeightInTon",
                    ColumnLength = 120,
                    ColumnTitle = "Order NetWeight in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 15,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueNetWeightInTon",
                    ColumnLength = 120,
                    ColumnTitle = "Issue NetWeight in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 16,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "NetWeightBalanceInTon",
                    ColumnLength = 120,
                    ColumnTitle = "NetWeight Balance in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 17,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "Total",
                    ColumnLength = 150,
                    ColumnTitle = "Total",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 21,
                    Visible = true,
                    AllowFunction = "Sum",
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                    IsDisplay = true
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "DeliveryStatus",
                    ColumnLength = 150,
                    ColumnTitle = "Delivery Status",
                    ColumnType = ColumnType.StatusCode,
                    SortOrder = 22,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "User",
                    ColumnLength = 110,
                    ColumnTitle = "User",
                    ColumnType = ColumnType.String,
                    SortOrder = 23,
                    Visible = true,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "CustomerType",
                    ColumnLength = 150,
                    ColumnTitle = "Customer Type",
                    ColumnType = ColumnType.String,
                    SortOrder = 24,
                    Visible = true,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Status",
                    ColumnLength = 150,
                    ColumnTitle = "Status",
                    ColumnType = ColumnType.StatusCode,
                    SortOrder = 25,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
            };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columnInfo.Concat(itemPropertyCols).ToList(),
                Groupby = "",
                HeaderTitle = "Sale Order By Item Property Report",
                Sortby = "",
            };

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleOrderByItemProperty)]
        [HttpPost]
        public async Task<PagedResultWithTotalColuumnsDto<GetListReportSaleOrderByItemPropertyOutput>> GetSaleOrderByItemPropertyReport(GetListReportSaleOrderByItemPropertyInput input)
        {

            if (input.GroupBy.IsNullOrWhiteSpace()) throw new UserFriendlyException(L("PleaseSelect", L("SummaryBy")));

            var find = await _propertyRepository.GetAll().AsNoTracking().AnyAsync(s => s.Name == input.GroupBy);
            if (!find) throw new UserFriendlyException(L("PleaseSelect", L("SummaryBy")));

            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            //var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
            //                                   previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var defaultLocationGroups = await GetUserGroupByLocation();
            var userGroupCustomers = await GetUserGroupCustomers();
            //var userGroupItems = await GetUserGroupItems();

            var invoiceItemQuery = from iv in _invoiceItemRepository.GetAll()
                                            .Where(s => s.OrderItemId.HasValue)
                                            .Where(s => s.ItemIssueItemId.HasValue)
                                            .AsNoTracking()
                                   join j in _journalRepository.GetAll()
                                      .Where(s => s.InvoiceId.HasValue)
                                      .Where(s => s.Status == TransactionStatus.Publish)
                                      .AsNoTracking()
                                   on iv.InvoiceId equals j.InvoiceId

                                   join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.ItemIssueSaleItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ri.ItemIssueSaleItemId
                                   into r1

                                   join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.CustomerCreditItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                   into r2

                                   let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                   let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                   select new
                                   {
                                       OrderItemId = iv.OrderItemId,
                                       Qty = iv.Qty,
                                       ReturnQty = rq1 + rq2
                                   };

            var itemIssueItemQuery = from iv in _itemIssueItemRepository.GetAll()
                                             .Where(s => s.SaleOrderItemId.HasValue)
                                             .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                          .Where(s => s.ItemIssueId.HasValue)
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .AsNoTracking()
                                     on iv.ItemIssueId equals j.ItemIssueId
                                     join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.ItemIssueSaleItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ri.ItemIssueSaleItemId
                                     into r1

                                     join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.CustomerCreditItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                     into r2

                                     let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                     let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                     select new
                                     {
                                         SaleOrderItemId = iv.SaleOrderItemId,
                                         Qty = iv.Qty,
                                         ReturnQty = rq1 + rq2
                                     };

            var dinvoiceItemQuery = from iv in _invoiceItemRepository.GetAll()
                                            .Where(s => s.DeliveryScheduleItem.SaleOrderItemId.HasValue)
                                            .Where(s => s.ItemIssueItemId.HasValue)
                                            .AsNoTracking()
                                   join j in _journalRepository.GetAll()
                                      .Where(s => s.InvoiceId.HasValue)
                                      .Where(s => s.Status == TransactionStatus.Publish)
                                      .AsNoTracking()
                                   on iv.InvoiceId equals j.InvoiceId

                                   join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.ItemIssueSaleItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ri.ItemIssueSaleItemId
                                   into r1

                                   join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.CustomerCreditItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                   into r2

                                   let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                   let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                   select new
                                   {
                                       OrderItemId = iv.DeliveryScheduleItem.SaleOrderItemId,
                                       Qty = iv.Qty,
                                       ReturnQty = rq1 + rq2
                                   };

            var ditemIssueItemQuery = from iv in _itemIssueItemRepository.GetAll()
                                             .Where(s => s.DeliveryScheduleItem.SaleOrderItemId.HasValue)
                                             .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                          .Where(s => s.ItemIssueId.HasValue)
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .AsNoTracking()
                                     on iv.ItemIssueId equals j.ItemIssueId
                                     join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.ItemIssueSaleItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ri.ItemIssueSaleItemId
                                     into r1

                                     join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.CustomerCreditItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                     into r2

                                     let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                     let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                     select new
                                     {
                                         SaleOrderItemId = iv.DeliveryScheduleItem.SaleOrderItemId,
                                         Qty = iv.Qty,
                                         ReturnQty = rq1 + rq2
                                     };

            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();

            var orderQuery = _saleOrderRepository.GetAll()
                            .WhereIf(!customerTypeMemberIds.IsNullOrEmpty(), s => s.Customer.CustomerTypeId.HasValue && customerTypeMemberIds.Contains(s.Customer.CustomerTypeId.Value))
                            .WhereIf(userGroupCustomers != null && userGroupCustomers.Any(), s => userGroupCustomers.Contains(s.CustomerId) || s.Customer.Member == Member.All)
                            .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId.Value))
                            .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId.Value))
                            .WhereIf(input.FromDate != null && input.ToDate != null,
                                    (u => (u.OrderDate.Date) >= (input.FromDate.Date) && (u.OrderDate.Date) <= (input.ToDate.Date)))
                            .WhereIf(!input.Filter.IsNullOrEmpty(), u =>
                                    u.OrderNumber.ToLower().Contains(input.Filter.ToLower()) ||
                                    u.Reference.ToLower().Contains(input.Filter.ToLower()))
                            .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                            .WhereIf(input.Customers != null && input.Customers.Any(), s => input.Customers.Contains(s.CustomerId))
                            .WhereIf(input.DeliveryStatuses != null && input.DeliveryStatuses.Count > 0, u => input.DeliveryStatuses.Contains(u.ReceiveStatus))
                            .WhereIf(input.Statuses != null && input.Statuses.Count > 0, u => input.Statuses.Contains(u.Status))
                            .AsNoTracking()
                            .Select(o => new
                            {
                                o.Id,
                                o.Total
                            });


            var itemOrderWithIssue = from oi in _saleOrderItemRepository.GetAll()
                                                 .AsNoTracking()
                                                 .Select(oi => new
                                                 {
                                                     OrderId = oi.SaleOrderId,
                                                     OrderItemId = oi.Id,
                                                     ItemId = oi.ItemId,
                                                     OrderQty = oi.Qty,
                                                     oi.Total,
                                                 })

                                     join bi in invoiceItemQuery
                                     on oi.OrderItemId equals bi.OrderItemId
                                     into bItems

                                     join ri in itemIssueItemQuery
                                     on oi.OrderItemId equals ri.SaleOrderItemId
                                     into rItems

                                     join dbi in dinvoiceItemQuery
                                     on oi.OrderItemId equals dbi.OrderItemId
                                     into dbItems

                                     join dri in ditemIssueItemQuery
                                     on oi.OrderItemId equals dri.SaleOrderItemId
                                     into drItems

                                     let bQty = bItems == null || bItems.Count() == 0 ? 0 : bItems.Sum(r => r.Qty - r.ReturnQty)
                                     let rQty = rItems == null || rItems.Count() == 0 ? 0 : rItems.Sum(r => r.Qty - r.ReturnQty)
                                     let dbQty = dbItems == null || dbItems.Count() == 0 ? 0 : dbItems.Sum(r => r.Qty - r.ReturnQty)
                                     let drQty = drItems == null || drItems.Count() == 0 ? 0 : drItems.Sum(r => r.Qty - r.ReturnQty)
                                     let receiveQty = bQty + rQty + dbQty + drQty

                                     select new SaleOrderItemByItemPropertyOutput
                                     {
                                         OrderId = oi.OrderId,
                                         OrderItemId = oi.OrderItemId,
                                         ItemId = oi.ItemId,
                                         OrderQty = oi.OrderQty,
                                         IssueQty = receiveQty,
                                         Total = oi.Total,
                                     };

            var itemQuery = GetItemWithProperties(new List<Guid>(), new List<Guid>(), null);

            var orderItemWithProperty = from oi in itemOrderWithIssue

                                        join i in itemQuery
                                        on oi.ItemId equals i.Id

                                        let netWeight = !i.Properties.Any(p => p.IsUnit) ? 0 : i.Properties.Where(t => t.IsUnit).Select(t => t.NetWeight).FirstOrDefault()
                                        let propertypeGroup = i.Properties.Where(t => t.PropertyName == input.GroupBy).Select(t => t.Value).FirstOrDefault()

                                        select new SaleOrderItemByItemPropertyOutput
                                        {
                                            OrderId = oi.OrderId,
                                            OrderItemId = oi.OrderItemId,
                                            ItemId = oi.ItemId,
                                            OrderQty = oi.OrderQty,
                                            IssueQty = oi.IssueQty,
                                            NetWeight = netWeight,
                                            Total = oi.Total,
                                            Properties = i.Properties,
                                            SummaryBy = propertypeGroup
                                        };


            var query = from o in orderQuery
                        join oi in orderItemWithProperty
                        on o.Id equals oi.OrderId

                        where (input.Items == null || !input.Items.Any() || input.Items.Contains(oi.ItemId)) &&
                              (input.PropertyDics == null || !input.PropertyDics.Any() ||
                               oi.Properties.Where(ip => input.PropertyDics.Any(v => v.PropertyId == ip.PropertyId) &&
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId) != null &&
                                   (input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds == null ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Count == 0 ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Contains(ip.Id)))
                                .Count() == input.PropertyDics.Count)

                        select new GetListReportSaleOrderByItemPropertyOutput
                        {
                            OrderQty = oi.OrderQty,
                            IssueQty = oi.IssueQty,
                            QtyBalance = oi.OrderQty - oi.IssueQty,
                            OrderNetWeight = oi.OrderQty * oi.NetWeight,
                            IssueNetWeight = oi.IssueQty * oi.NetWeight,
                            NetWeightBalance = (oi.OrderQty - oi.IssueQty) * oi.NetWeight,
                            OrderNetWeightInTon = Math.Round(oi.OrderQty * oi.NetWeight / 1000, currentRoundingDigit),
                            IssueNetWeightInTon = Math.Round(oi.IssueQty * oi.NetWeight / 1000, currentRoundingDigit),
                            NetWeightBalanceInTon = Math.Round((oi.OrderQty - oi.IssueQty) * oi.NetWeight / 1000, currentRoundingDigit),
                            Total = oi.Total,
                            RoundingDigit = currentRoundingDigit,
                            SummaryBy = oi.SummaryBy
                        };

            var summaryQuery = query
                               .GroupBy(s => s.SummaryBy)
                               .Select(s => new GetListReportSaleOrderByItemPropertyOutput
                               {
                                   OrderQty = s.Sum(t => t.OrderQty),
                                   IssueQty = s.Sum(t => t.IssueQty),
                                   QtyBalance = s.Sum(t => t.QtyBalance),
                                   OrderNetWeight = s.Sum(t => t.OrderNetWeight),
                                   IssueNetWeight = s.Sum(t => t.IssueNetWeight),
                                   NetWeightBalance = s.Sum(t => t.NetWeightBalance),
                                   OrderNetWeightInTon = s.Sum(t => t.OrderNetWeightInTon),
                                   IssueNetWeightInTon = s.Sum(t => t.IssueNetWeightInTon),
                                   NetWeightBalanceInTon = s.Sum(t => t.NetWeightBalanceInTon),
                                   Total = s.Sum(t => t.Total),
                                   RoundingDigit = currentRoundingDigit,
                                   SummaryBy = s.Key
                               })
                               .OrderBy(s => s.SummaryBy);


            SaleOrderByItemPropertyColumnSummaryOutPut summary = null;
            var resultCount = await summaryQuery.CountAsync();

            if (resultCount == 0) return new PagedResultWithTotalColuumnsDto<GetListReportSaleOrderByItemPropertyOutput>(resultCount, new List<GetListReportSaleOrderByItemPropertyOutput>(), new Dictionary<string, decimal>());

            if (input.IsLoadMore == false && input.ColumnNamesToSum != null)
            {
                summary = await summaryQuery
                .GroupBy(s => 1)
                .Select(s => new SaleOrderByItemPropertyColumnSummaryOutPut
                {
                    TotalAmount = s.Sum(t => t.Total),
                    TotalOrderQty = s.Sum(t => t.OrderQty),
                    TotalIssueQty = s.Sum(t => t.IssueQty),
                    QtyBalance = s.Sum(t => t.QtyBalance),
                    TotalOrderNetWeight = s.Sum(t => t.OrderNetWeight),
                    TotalIssueNetWeight = s.Sum(t => t.IssueNetWeight),
                    NetWeightBalance = s.Sum(t => t.NetWeightBalance),
                    TotalOrderNetWeightInTon = s.Sum(t => t.OrderNetWeightInTon),
                    TotalIssueNetWeightInTon = s.Sum(t => t.IssueNetWeightInTon),
                    NetWeightBalanceInTon = s.Sum(t => t.NetWeightBalanceInTon),
                })
                .FirstAsync();

            }
            var sumOfColumns = new Dictionary<string, decimal>();

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "Total")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalAmount);
                    }
                    else if (col == "OrderQty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalOrderQty);
                    }
                    else if (col == "IssueQty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueQty);
                    }
                    else if (col == "QtyBalance")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.QtyBalance);
                    }
                    else if (col == "OrderNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalOrderNetWeight);
                    }
                    else if (col == "IssueNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueNetWeight);
                    }
                    else if (col == "NetWeightBalance")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.NetWeightBalance);
                    }
                    else if (col == "OrderNetWeightInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalOrderNetWeightInTon);
                    }
                    else if (col == "IssueNetWeightInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.TotalIssueNetWeightInTon);
                    }
                    else if (col == "NetWeightBalanceInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.NetWeightBalanceInTon);
                    }
                }
            }

            var @entities = new List<GetListReportSaleOrderByItemPropertyOutput>();
            if (input.UsePagination == true)
            {
                @entities = await summaryQuery.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await summaryQuery.ToListAsync();
            }

            var returnResult = new PagedResultWithTotalColuumnsDto<GetListReportSaleOrderByItemPropertyOutput>(resultCount, @entities, sumOfColumns);

            return returnResult;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleOrderByItemProperty_Export_Excel)]
        public async Task<FileDto> ExportExcelSaleOrderByItemPropertyReport(GetSaleOrderByItemPropertyReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var reportResult = await GetSaleOrderByItemPropertyReport(input);
            var invoiceData = reportResult.Items;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                       .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                       .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd-MM-yyyy";
            }

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                //var subCols = invoiceData == null ? null : invoiceData.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
                //var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString(formatDate);
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                    ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                    colHeaderTable += 1;
                }

                //if (isMultiCurrencies) rowTableHeader += 1;
                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                foreach (var i in invoiceData)
                {
                    int collumnCellBody = 1;
                    foreach (var item in reportCollumnHeader)// map with correct key of properties 
                    {
                        WriteBodySaleOrderByItemProperty(ws, rowBody, collumnCellBody, item, i, count);
                        collumnCellBody += 1;
                    }
                    rowBody += 1;
                    count += 1;
                }

                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            int rowFooter = rowTableHeader + 1;// get start row after header 
                            var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                            var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                            if (i.ColumnType == ColumnType.Number)
                            {
                                AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                            }
                            else
                            {
                                AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"Sale_Order_By_Item_Property_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleOrderByItemProperty_Export_Pdf)]
        public async Task<FileDto> ExportPDFSaleOrderByItemPropertyReport(GetSaleOrderByItemPropertyReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                        .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                        .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }

            var rounding = await GetCurrentCycleAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            //int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;
            var user = await GetCurrentUserAsync();
            var invoices = await GetSaleOrderByItemPropertyReport(input);

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                //var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";

                            rowHeader = $"<th width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";

                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                //multiCurrencyHeader += isMultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body     
                foreach (var row in invoices.Items)
                {
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (i.ColumnName == "SummaryBy")
                            {
                                tr += $"<td>{row.SummaryBy}</td>";
                            }
                            else if (i.ColumnName == "OrderNetWeight")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "IssueNetWeight")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "NetWeightBalance")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "OrderNetWeightInTon")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "IssueNetWeightInTon")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "NetWeightBalanceInTon")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalanceInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "OrderQty")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.OrderQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "IssueQty")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "QtyBalance")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.QtyBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "Total")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Total, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else
                            {
                                tr += $"<td></td>";
                            }
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index == 0)
                            {
                                tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))
                                {
                                    if (invoices.TotalResult != null && invoices.TotalResult.ContainsKey(i.ColumnName))
                                    {
                                        tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(invoices.TotalResult[i.ColumnName], rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", "");
                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);
                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{sheetName}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }
        #endregion


        #region Delivery Schedule by Item Property
        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_DeliveryScheduleByItemProperty)]
        public async Task<ReportOutput> GetReportTemplateDeliveryScheduleByItemProperty()
        {
            var itemPropertyCols = await _propertyRepository.GetAll().AsNoTracking()
                                    .Where(t => t.IsActive == true)
                                    .Select(t => new CollumnOutput
                                    {
                                        AllowGroupby = true,
                                        AllowFilter = true,
                                        ColumnName = t.Name,
                                        ColumnLength = 150,
                                        ColumnTitle = t.Name,
                                        ColumnType = ColumnType.ItemProperty,
                                        SortOrder = 26,
                                        Visible = true,
                                        AllowFunction = null,
                                        MoreFunction = null,
                                        IsDisplay = false,
                                        AllowShowHideFilter = true,
                                        ShowHideFilter = true,
                                        DefaultValue = t.Id.ToString(),//to init the value of property
                                    })
                                    .ToListAsync();

            var columnInfo = new List<CollumnOutput>() {
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "DateRange",
                    ColumnLength = 150,
                    ColumnTitle = "DateRange",
                    ColumnType = ColumnType.Language,
                    SortOrder = 0,
                    Visible = true,
                    DefaultValue = "thisMonth",
                    AllowFunction = null,
                    DisableDefault = false,
                    MoreFunction = null,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    IsDisplay = false//no need to show in col check it belong to filter option
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "SummaryBy",
                    ColumnLength = 150,
                    ColumnTitle = "Summary By",
                    ColumnType = ColumnType.String,
                    SortOrder = 1,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "ViewOption",
                    ColumnLength = 150,
                    ColumnTitle = "View Option",
                    ColumnType = ColumnType.String,
                    SortOrder = 2,
                    Visible = true,
                    IsDisplay = false,
                    DefaultValue = ((int)ViewOption.Standard).ToString(),
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Location",
                    ColumnLength = 120,
                    ColumnTitle = "Location",
                    ColumnType = ColumnType.String,
                    SortOrder = 4,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Customer",
                    ColumnLength = 150,
                    ColumnTitle = "Customer",
                    ColumnType = ColumnType.String,
                    SortOrder = 6,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Item",
                    ColumnLength = 250,
                    ColumnTitle = "Item",
                    ColumnType = ColumnType.String,
                    SortOrder = 0,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "DeliveryQty",
                    ColumnLength = 120,
                    ColumnTitle = "Delivery Qty",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 9,
                    Visible = false,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueQty",
                    ColumnLength = 120,
                    ColumnTitle = "Issue Qty",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 10,
                    Visible = false,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                 new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "QtyBalance",
                    ColumnLength = 120,
                    ColumnTitle = "Qty Balance",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 11,
                    Visible = false,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "DeliveryNetWeight",
                    ColumnLength = 120,
                    ColumnTitle = "Delivery NetWeight",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 12,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueNetWeight",
                    ColumnLength = 120,
                    ColumnTitle = "Issue NetWeight",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 13,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "NetWeightBalance",
                    ColumnLength = 120,
                    ColumnTitle = "NetWeight Balance",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 14,
                    Visible = true,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                 new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "DeliveryNetWeightInTon",
                    ColumnLength = 120,
                    ColumnTitle = "Delivery NetWeight in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 15,
                    Visible = false,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "IssueNetWeightInTon",
                    ColumnLength = 120,
                    ColumnTitle = "Issue NetWeight in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 16,
                    Visible = false,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = false,
                    ColumnName = "NetWeightBalanceInTon",
                    ColumnLength = 120,
                    ColumnTitle = "NetWeight Balance in Ton",
                    ColumnType = ColumnType.RoundingDigit,
                    SortOrder = 17,
                    Visible = false,
                    AllowFunction = "Sum",
                    IsDisplay = true,
                    AllowShowHideFilter = false,
                    ShowHideFilter = false,
                    MoreFunction = new List<MoreFunction>(){
                        new MoreFunction
                        {
                            KeyName = null
                        },
                        new MoreFunction
                        {
                            KeyName = "Sum"
                        }
                    },
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "DeliveryStatus",
                    ColumnLength = 150,
                    ColumnTitle = "Delivery Status",
                    ColumnType = ColumnType.StatusCode,
                    SortOrder = 22,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "User",
                    ColumnLength = 110,
                    ColumnTitle = "User",
                    ColumnType = ColumnType.String,
                    SortOrder = 23,
                    Visible = true,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "CustomerType",
                    ColumnLength = 150,
                    ColumnTitle = "Customer Type",
                    ColumnType = ColumnType.String,
                    SortOrder = 24,
                    Visible = true,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },

                new CollumnOutput{
                    AllowGroupby = false,
                    AllowFilter = true,
                    ColumnName = "Status",
                    ColumnLength = 150,
                    ColumnTitle = "Status",
                    ColumnType = ColumnType.StatusCode,
                    SortOrder = 25,
                    Visible = true,
                    AllowFunction = null,
                    IsDisplay = false,
                    AllowShowHideFilter = true,
                    ShowHideFilter = true,
                },
            };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columnInfo.Concat(itemPropertyCols).ToList(),
                Groupby = "",
                HeaderTitle = "Delivery Schedule By Item Property Report",
                Sortby = "",
            };

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_DeliveryScheduleByItemProperty)]
        [HttpPost]
        public async Task<DeliveryScheduleReportResultOutput> GetDeliveryScheduleByItemPropertyReport(GetListReportDeliveryScheduleByItemPropertyInput input)
        {
            return input.ViewOption == ViewOption.Month ? await GetDeliveryScheduleByItemPropertyReportMonthly(input) : await GetDeliveryScheduleByItemPropertyReportStandard(input);
        }

        private async Task<DeliveryScheduleReportResultOutput> GetDeliveryScheduleByItemPropertyReportStandard(GetListReportDeliveryScheduleByItemPropertyInput input)
        {

            if (input.GroupBy.IsNullOrWhiteSpace()) throw new UserFriendlyException(L("PleaseSelect", L("SummaryBy")));

            var find = await _propertyRepository.GetAll().AsNoTracking().AnyAsync(s => s.Name == input.GroupBy);
            if (!find) throw new UserFriendlyException(L("PleaseSelect", L("SummaryBy")));

            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            //var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
            //                                   previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var defaultLocationGroups = await GetUserGroupByLocation();
            var userGroupCustomers = await GetUserGroupCustomers();
            //var userGroupItems = await GetUserGroupItems();

            var invoiceItemQuery = from iv in _invoiceItemRepository.GetAll()
                                            .Where(s => s.DeliverySchedulItemId.HasValue)
                                            .AsNoTracking()
                                   join j in _journalRepository.GetAll()
                                      .Where(s => s.InvoiceId.HasValue)
                                      .Where(s => s.Status == TransactionStatus.Publish)
                                      .AsNoTracking()
                                   on iv.InvoiceId equals j.InvoiceId

                                   join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.ItemIssueSaleItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ri.ItemIssueSaleItemId
                                   into r1

                                   join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.CustomerCreditItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                   into r2

                                   let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                   let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                   select new
                                   {
                                       DeliverySchedulItemId = iv.DeliverySchedulItemId,
                                       iv.Qty,
                                       ReturnQty = rq1 + rq2
                                   };

            var itemIssueItemQuery = from iv in _itemIssueItemRepository.GetAll()
                                             .Where(s => s.DeliverySchedulItemId.HasValue)
                                             .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                          .Where(s => s.ItemIssueId.HasValue)
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .AsNoTracking()
                                     on iv.ItemIssueId equals j.ItemIssueId
                                     join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.ItemIssueSaleItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ri.ItemIssueSaleItemId
                                     into r1

                                     join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.CustomerCreditItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                     into r2

                                     let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                     let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                     select new
                                     {
                                         DeliveryScheduleItemId = iv.DeliverySchedulItemId,
                                         iv.Qty,
                                         ReturnQty = rq1 + rq2
                                     };


            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();

            var orderQuery = _deliverScheduleRepository.GetAll()
                            .WhereIf(!input.CustomerTypes.IsNullOrEmpty(), s => s.Customer.CustomerTypeId.HasValue && input.CustomerTypes.Contains(s.Customer.CustomerTypeId.Value))
                            .WhereIf(!customerTypeMemberIds.IsNullOrEmpty(), s => s.Customer.CustomerTypeId.HasValue && customerTypeMemberIds.Contains(s.Customer.CustomerTypeId.Value))
                            .WhereIf(userGroupCustomers != null && userGroupCustomers.Any(), s => userGroupCustomers.Contains(s.CustomerId) || s.Customer.Member == Member.All)
                            .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId))
                            .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId))
                            .WhereIf(input.FromDate != null && input.ToDate != null,
                                    (u => (u.InitialDeliveryDate.Date) >= (input.FromDate.Date) && (u.InitialDeliveryDate.Date) <= (input.ToDate.Date)))
                            .WhereIf(!input.Filter.IsNullOrEmpty(), u =>
                                    u.DeliveryNo.ToLower().Contains(input.Filter.ToLower()) ||
                                    u.Reference.ToLower().Contains(input.Filter.ToLower()))
                            .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                            .WhereIf(input.Customers != null && input.Customers.Any(), s => input.Customers.Contains(s.CustomerId))
                            .WhereIf(input.DeliveryStatuses != null && input.DeliveryStatuses.Count > 0, u => input.DeliveryStatuses.Contains(u.ReceiveStatus))
                            .WhereIf(input.Statuses != null && input.Statuses.Count > 0, u => input.Statuses.Contains(u.Status))
                            .AsNoTracking()
                            .Select(o => o.Id);


            var itemOrderWithIssue = from oi in _deliverScheduleItemRepository.GetAll()
                                                 .AsNoTracking()
                                                 .Select(oi => new
                                                 {
                                                     oi.DeliveryScheduleId,
                                                     DeliveryScheduleItemId = oi.Id,
                                                     ItemId = oi.ItemId,
                                                     OrderQty = oi.Qty,
                                                 })

                                     join bi in invoiceItemQuery
                                     on oi.DeliveryScheduleItemId equals bi.DeliverySchedulItemId
                                     into bItems

                                     join ri in itemIssueItemQuery
                                     on oi.DeliveryScheduleItemId equals ri.DeliveryScheduleItemId
                                     into rItems

                                     let bQty = bItems == null || bItems.Count() == 0 ? 0 : bItems.Sum(r => r.Qty - r.ReturnQty)
                                     let rQty = rItems == null || rItems.Count() == 0 ? 0 : rItems.Sum(r => r.Qty - r.ReturnQty)
                                     let receiveQty = bQty + rQty

                                     select new DeliveryScheduleItemByItemPropertyOutput
                                     {
                                         DeliveryScheduleId = oi.DeliveryScheduleId,
                                         DeliverySCheduleItemId = oi.DeliveryScheduleItemId,
                                         ItemId = oi.ItemId,
                                         DeliveryQty = oi.OrderQty,
                                         IssueQty = receiveQty,
                                     };

            var itemQuery = GetItemWithProperties(new List<Guid>(), new List<Guid>(), null);

            var orderItemWithProperty = from oi in itemOrderWithIssue

                                        join i in itemQuery
                                        on oi.ItemId equals i.Id

                                        let netWeight = !i.Properties.Any(p => p.IsUnit) ? 0 : i.Properties.Where(t => t.IsUnit).Select(t => t.NetWeight).FirstOrDefault()
                                        let propertypeGroup = i.Properties.Where(t => t.PropertyName == input.GroupBy).Select(t => t.Value).FirstOrDefault()

                                        select new DeliveryScheduleItemByItemPropertyOutput
                                        {
                                            DeliveryScheduleId = oi.DeliveryScheduleId,
                                            DeliverySCheduleItemId = oi.DeliverySCheduleItemId,
                                            ItemId = oi.ItemId,
                                            DeliveryQty = oi.DeliveryQty,
                                            IssueQty = oi.IssueQty,
                                            NetWeight = netWeight,
                                            Properties = i.Properties,
                                            SummaryBy = propertypeGroup
                                        };


            var query = from o in orderQuery
                        join oi in orderItemWithProperty
                        on o equals oi.DeliveryScheduleId

                        where (input.Items == null || !input.Items.Any() || input.Items.Contains(oi.ItemId)) &&
                              (input.PropertyDics == null || !input.PropertyDics.Any() ||
                               oi.Properties.Where(ip => input.PropertyDics.Any(v => v.PropertyId == ip.PropertyId) &&
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId) != null &&
                                   (input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds == null ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Count == 0 ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Contains(ip.Id)))
                                .Count() == input.PropertyDics.Count)

                        select new GetListReportDeliveryScheduleByItemPropertyOutput
                        {
                            DeliveryQty = oi.DeliveryQty,
                            IssueQty = oi.IssueQty,
                            QtyBalance = oi.DeliveryQty - oi.IssueQty,
                            DeliveryNetWeight = oi.DeliveryQty * oi.NetWeight,
                            IssueNetWeight = oi.IssueQty * oi.NetWeight,
                            NetWeightBalance = (oi.DeliveryQty - oi.IssueQty) * oi.NetWeight,
                            DeliveryNetWeightInTon = Math.Round(oi.DeliveryQty * oi.NetWeight / 1000, currentRoundingDigit),
                            IssueNetWeightInTon = Math.Round(oi.IssueQty * oi.NetWeight / 1000, currentRoundingDigit),
                            NetWeightBalanceInTon = Math.Round((oi.DeliveryQty - oi.IssueQty) * oi.NetWeight / 1000, currentRoundingDigit),
                            RoundingDigit = currentRoundingDigit,
                            SummaryBy = oi.SummaryBy
                        };

            var summaryQuery = query
                               .GroupBy(s => s.SummaryBy)
                               .Select(s => new GetListReportDeliveryScheduleByItemPropertyOutput
                               {
                                   DeliveryQty = s.Sum(t => t.DeliveryQty),
                                   IssueQty = s.Sum(t => t.IssueQty),
                                   QtyBalance = s.Sum(t => t.QtyBalance),
                                   DeliveryNetWeight = s.Sum(t => t.DeliveryNetWeight),
                                   IssueNetWeight = s.Sum(t => t.IssueNetWeight),
                                   NetWeightBalance = s.Sum(t => t.NetWeightBalance),
                                   DeliveryNetWeightInTon = s.Sum(t => t.DeliveryNetWeightInTon),
                                   IssueNetWeightInTon = s.Sum(t => t.IssueNetWeightInTon),
                                   NetWeightBalanceInTon = s.Sum(t => t.NetWeightBalanceInTon),
                                   RoundingDigit = currentRoundingDigit,
                                   SummaryBy = s.Key
                               })
                               .OrderBy(s => s.SummaryBy);


            DeliveryScheduleByItemPropertyColumnSummaryOutPut summary = null;
            var resultCount = await summaryQuery.CountAsync();

            if (resultCount == 0) return new DeliveryScheduleReportResultOutput
            {
                Items = new List<GetListReportDeliveryScheduleByItemPropertyOutput>(),
                TotalResult = new Dictionary<string, decimal>(),
                Months = new List<MonthDto>(),
                MonthlyColumns = new Dictionary<long, DeliveryScheduleMonthlyColoumn>(),
                TotalCount = 0
            };

            if (input.IsLoadMore == false && input.ColumnNamesToSum != null)
            {
                summary = await summaryQuery
                .GroupBy(s => 1)
                .Select(s => new DeliveryScheduleByItemPropertyColumnSummaryOutPut
                {
                    DeliveryQty = s.Sum(t => t.DeliveryQty),
                    IssueQty = s.Sum(t => t.IssueQty),
                    QtyBalance = s.Sum(t => t.QtyBalance),
                    DeliveryNetWeight = s.Sum(t => t.DeliveryNetWeight),
                    IssueNetWeight = s.Sum(t => t.IssueNetWeight),
                    NetWeightBalance = s.Sum(t => t.NetWeightBalance),
                    DeliveryNetWeightInTon = s.Sum(t => t.DeliveryNetWeightInTon),
                    IssueNetWeightInTon = s.Sum(t => t.IssueNetWeightInTon),
                    NetWeightBalanceInTon = s.Sum(t => t.NetWeightBalanceInTon),
                })
                .FirstAsync();

            }
            var sumOfColumns = new Dictionary<string, decimal>();

            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "DeliveryQty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.DeliveryQty);
                    }
                    else if (col == "IssueQty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.IssueQty);
                    }
                    else if (col == "QtyBalance")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.QtyBalance);
                    }
                    else if (col == "DeliveryNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.DeliveryNetWeight);
                    }
                    else if (col == "IssueNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.IssueNetWeight);
                    }
                    else if (col == "NetWeightBalance")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.NetWeightBalance);
                    }
                    else if (col == "DeliveryNetWeightInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.DeliveryNetWeightInTon);
                    }
                    else if (col == "IssueNetWeightInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.IssueNetWeightInTon);
                    }
                    else if (col == "NetWeightBalanceInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.NetWeightBalanceInTon);
                    }
                }
            }

            var @entities = new List<GetListReportDeliveryScheduleByItemPropertyOutput>();
            if (input.UsePagination == true)
            {
                @entities = await summaryQuery.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await summaryQuery.ToListAsync();
            }


            return new DeliveryScheduleReportResultOutput
            {
                Items = entities,
                TotalResult = sumOfColumns,
                Months = new List<MonthDto>(),
                MonthlyColumns = new Dictionary<long, DeliveryScheduleMonthlyColoumn>(),
                TotalCount = resultCount
            };
        }

        private async Task<DeliveryScheduleReportResultOutput> GetDeliveryScheduleByItemPropertyReportMonthly(GetListReportDeliveryScheduleByItemPropertyInput input)
        {

            if (input.GroupBy.IsNullOrWhiteSpace()) throw new UserFriendlyException(L("PleaseSelect", L("SummaryBy")));

            var find = await _propertyRepository.GetAll().AsNoTracking().AnyAsync(s => s.Name == input.GroupBy);
            if (!find) throw new UserFriendlyException(L("PleaseSelect", L("SummaryBy")));

            var isSameYear = input.FromDate.Year == input.ToDate.Year;

            var periodCycles = await GetCloseCyleAsync(input.ToDate);

            var previousCycle = periodCycles.Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                                            .OrderByDescending(u => u.EndDate.Value).FirstOrDefault();

            var currentCycle = periodCycles.Where(u => u.StartDate.Date <= input.ToDate.Date &&
                                                (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                                           .OrderByDescending(u => u.StartDate).FirstOrDefault();

            var currentRoundingDigit = currentCycle != null ? currentCycle.RoundingDigit :
                                       previousCycle != null ? previousCycle.RoundingDigit : 2;

            //var currentRoundingDigitUnitCost = currentCycle != null ? currentCycle.RoundingDigitUnitCost :
            //                                   previousCycle != null ? previousCycle.RoundingDigitUnitCost : 2;

            var defaultLocationGroups = await GetUserGroupByLocation();
            var userGroupCustomers = await GetUserGroupCustomers();
            //var userGroupItems = await GetUserGroupItems();

            var invoiceItemQuery = from iv in _invoiceItemRepository.GetAll()
                                            .Where(s => s.DeliverySchedulItemId.HasValue)
                                            .AsNoTracking()
                                   join j in _journalRepository.GetAll()
                                      .Where(s => s.InvoiceId.HasValue)
                                      .Where(s => s.Status == TransactionStatus.Publish)
                                      .AsNoTracking()
                                   on iv.InvoiceId equals j.InvoiceId

                                   join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.ItemIssueSaleItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ri.ItemIssueSaleItemId
                                   into r1

                                   join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                              .Where(s => s.CustomerCreditItemId.HasValue)
                                              .AsNoTracking()
                                   on iv.ItemIssueItemId equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                   into r2

                                   let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                   let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                   select new
                                   {
                                       DeliverySchedulItemId = iv.DeliverySchedulItemId,
                                       iv.Qty,
                                       ReturnQty = rq1 + rq2
                                   };

            var itemIssueItemQuery = from iv in _itemIssueItemRepository.GetAll()
                                             .Where(s => s.DeliverySchedulItemId.HasValue)
                                             .AsNoTracking()
                                     join j in _journalRepository.GetAll()
                                          .Where(s => s.ItemIssueId.HasValue)
                                          .Where(s => s.Status == TransactionStatus.Publish)
                                          .AsNoTracking()
                                     on iv.ItemIssueId equals j.ItemIssueId
                                     join ri in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.ItemIssueSaleItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ri.ItemIssueSaleItemId
                                     into r1

                                     join ci in _itemReceiptCustomerCreditItemRepository.GetAll()
                                                .Where(s => s.CustomerCreditItemId.HasValue)
                                                .AsNoTracking()
                                     on iv.Id equals ci.CustomerCreditItem.ItemIssueSaleItemId
                                     into r2

                                     let rq1 = r1 == null ? 0 : r1.Sum(s => s.Qty)
                                     let rq2 = r2 == null ? 0 : r2.Sum(s => s.Qty)

                                     select new
                                     {
                                         DeliveryScheduleItemId = iv.DeliverySchedulItemId,
                                         iv.Qty,
                                         ReturnQty = rq1 + rq2
                                     };


            var customerTypeMemberIds = await GetCustomerTypeMembers().Select(s => s.CustomerTypeId).ToListAsync();

            var orderQuery = _deliverScheduleRepository.GetAll()
                            .WhereIf(!input.CustomerTypes.IsNullOrEmpty(), s => s.Customer.CustomerTypeId.HasValue && input.CustomerTypes.Contains(s.Customer.CustomerTypeId.Value))
                            .WhereIf(!customerTypeMemberIds.IsNullOrEmpty(), s => s.Customer.CustomerTypeId.HasValue && customerTypeMemberIds.Contains(s.Customer.CustomerTypeId.Value))
                            .WhereIf(userGroupCustomers != null && userGroupCustomers.Any(), s => userGroupCustomers.Contains(s.CustomerId) || s.Customer.Member == Member.All)
                            .WhereIf(defaultLocationGroups != null && defaultLocationGroups.Count > 0, u => defaultLocationGroups.Contains(u.LocationId))
                            .WhereIf(input.Locations != null && input.Locations.Count > 0, u => input.Locations.Contains(u.LocationId))
                            .WhereIf(input.FromDate != null && input.ToDate != null,
                                    (u => (u.InitialDeliveryDate.Date) >= (input.FromDate.Date) && (u.InitialDeliveryDate.Date) <= (input.ToDate.Date)))
                            .WhereIf(!input.Filter.IsNullOrEmpty(), u =>
                                    u.DeliveryNo.ToLower().Contains(input.Filter.ToLower()) ||
                                    u.Reference.ToLower().Contains(input.Filter.ToLower()))
                            .WhereIf(input.Users != null && input.Users.Count > 0, u => input.Users.Contains(u.CreatorUserId))
                            .WhereIf(input.Customers != null && input.Customers.Any(), s => input.Customers.Contains(s.CustomerId))
                            .WhereIf(input.DeliveryStatuses != null && input.DeliveryStatuses.Count > 0, u => input.DeliveryStatuses.Contains(u.ReceiveStatus))
                            .WhereIf(input.Statuses != null && input.Statuses.Count > 0, u => input.Statuses.Contains(u.Status))
                            .AsNoTracking()
                            .Select(o => new
                            {
                                o.Id,
                                Month = Convert.ToInt32(o.InitialDeliveryDate.ToString("yyyyMM")),
                                MonthName = isSameYear ? o.InitialDeliveryDate.ToString("MMM") : o.InitialDeliveryDate.ToString("MMM-yyyy"),
                            });


            var itemOrderWithIssue = from oi in _deliverScheduleItemRepository.GetAll()
                                                 .AsNoTracking()
                                                 .Select(oi => new
                                                 {
                                                     oi.DeliveryScheduleId,
                                                     DeliveryScheduleItemId = oi.Id,
                                                     ItemId = oi.ItemId,
                                                     OrderQty = oi.Qty,
                                                 })

                                     join bi in invoiceItemQuery
                                     on oi.DeliveryScheduleItemId equals bi.DeliverySchedulItemId
                                     into bItems

                                     join ri in itemIssueItemQuery
                                     on oi.DeliveryScheduleItemId equals ri.DeliveryScheduleItemId
                                     into rItems

                                     let bQty = bItems == null || bItems.Count() == 0 ? 0 : bItems.Sum(r => r.Qty - r.ReturnQty)
                                     let rQty = rItems == null || rItems.Count() == 0 ? 0 : rItems.Sum(r => r.Qty - r.ReturnQty)
                                     let receiveQty = bQty + rQty

                                     select new DeliveryScheduleItemByItemPropertyOutput
                                     {
                                         DeliveryScheduleId = oi.DeliveryScheduleId,
                                         DeliverySCheduleItemId = oi.DeliveryScheduleItemId,
                                         ItemId = oi.ItemId,
                                         DeliveryQty = oi.OrderQty,
                                         IssueQty = receiveQty,
                                     };

            var itemQuery = GetItemWithProperties(new List<Guid>(), new List<Guid>(), null);

            var orderItemWithProperty = from oi in itemOrderWithIssue

                                        join i in itemQuery
                                        on oi.ItemId equals i.Id

                                        let netWeight = !i.Properties.Any(p => p.IsUnit) ? 0 : i.Properties.Where(t => t.IsUnit).Select(t => t.NetWeight).FirstOrDefault()
                                        let propertypeGroup = i.Properties.Where(t => t.PropertyName == input.GroupBy).Select(t => t.Value).FirstOrDefault()

                                        select new DeliveryScheduleItemByItemPropertyOutput
                                        {
                                            DeliveryScheduleId = oi.DeliveryScheduleId,
                                            DeliverySCheduleItemId = oi.DeliverySCheduleItemId,
                                            ItemId = oi.ItemId,
                                            DeliveryQty = oi.DeliveryQty,
                                            IssueQty = oi.IssueQty,
                                            NetWeight = netWeight,
                                            Properties = i.Properties,
                                            SummaryBy = propertypeGroup
                                        };


            var query = from o in orderQuery
                        join oi in orderItemWithProperty
                        on o.Id equals oi.DeliveryScheduleId

                        where (input.Items == null || !input.Items.Any() || input.Items.Contains(oi.ItemId)) &&
                              (input.PropertyDics == null || !input.PropertyDics.Any() ||
                               oi.Properties.Where(ip => input.PropertyDics.Any(v => v.PropertyId == ip.PropertyId) &&
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId) != null &&
                                   (input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds == null ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Count == 0 ||
                                   input.PropertyDics.FirstOrDefault(v => v.PropertyId == ip.PropertyId).PropertyValueIds.Contains(ip.Id)))
                                .Count() == input.PropertyDics.Count)

                        select new GetListReportDeliveryScheduleByItemPropertyOutput
                        {
                            DeliveryQty = oi.DeliveryQty,
                            IssueQty = oi.IssueQty,
                            QtyBalance = oi.DeliveryQty - oi.IssueQty,
                            DeliveryNetWeight = oi.DeliveryQty * oi.NetWeight,
                            IssueNetWeight = oi.IssueQty * oi.NetWeight,
                            NetWeightBalance = (oi.DeliveryQty - oi.IssueQty) * oi.NetWeight,
                            DeliveryNetWeightInTon = Math.Round(oi.DeliveryQty * oi.NetWeight / 1000, currentRoundingDigit),
                            IssueNetWeightInTon = Math.Round(oi.IssueQty * oi.NetWeight / 1000, currentRoundingDigit),
                            NetWeightBalanceInTon = Math.Round((oi.DeliveryQty - oi.IssueQty) * oi.NetWeight / 1000, currentRoundingDigit),
                            RoundingDigit = currentRoundingDigit,
                            SummaryBy = oi.SummaryBy,
                            Month = o.Month,
                            MonthName = o.MonthName
                        };

            var months = await query.Select(s => new { s.Month, s.MonthName }).Distinct().OrderBy(s => s.Month).ToListAsync();
            months.Add(new { Month = 0L, MonthName = L("Total") });

            var summaryQuery = query
                               .GroupBy(s => s.SummaryBy)
                               .Select(s => new GetListReportDeliveryScheduleByItemPropertyOutput
                               {
                                   DeliveryQty = s.Sum(t => t.DeliveryQty),
                                   IssueQty = s.Sum(t => t.IssueQty),
                                   QtyBalance = s.Sum(t => t.QtyBalance),
                                   DeliveryNetWeight = s.Sum(t => t.DeliveryNetWeight),
                                   IssueNetWeight = s.Sum(t => t.IssueNetWeight),
                                   NetWeightBalance = s.Sum(t => t.NetWeightBalance),
                                   DeliveryNetWeightInTon = s.Sum(t => t.DeliveryNetWeightInTon),
                                   IssueNetWeightInTon = s.Sum(t => t.IssueNetWeightInTon),
                                   NetWeightBalanceInTon = s.Sum(t => t.NetWeightBalanceInTon),
                                   RoundingDigit = currentRoundingDigit,
                                   SummaryBy = s.Key,
                                   MonthlyColumns = months.Select(m => new DeliveryScheduleMonthlyColoumn
                                   {
                                       Month = m.Month,
                                       MonthName = m.MonthName,
                                       DeliveryQty = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.DeliveryQty),
                                       IssueQty = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.IssueQty),
                                       QtyBalance = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.QtyBalance),
                                       DeliveryNetWeight = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.DeliveryNetWeight),
                                       IssueNetWeight = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.IssueNetWeight),
                                       NetWeightBalance = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.NetWeightBalance),
                                       DeliveryNetWeightInTon = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.DeliveryNetWeightInTon),
                                       IssueNetWeightInTon = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.IssueNetWeightInTon),
                                       NetWeightBalanceInTon = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.NetWeightBalanceInTon),
                                   }).ToDictionary(k => k.Month, v => v)
                               })
                               .OrderBy(s => s.SummaryBy);


            DeliveryScheduleByItemPropertyColumnSummaryOutPut summary = null;
            var sumOfColumns = new Dictionary<string, decimal>();
            var totalMonthlys = new Dictionary<long, DeliveryScheduleMonthlyColoumn>();
            var resultCount = await summaryQuery.CountAsync();

            if (resultCount == 0) return new DeliveryScheduleReportResultOutput
            {
                Items = new List<GetListReportDeliveryScheduleByItemPropertyOutput>(),
                TotalResult = new Dictionary<string, decimal>(),
                Months = new List<MonthDto>(),
                MonthlyColumns = new Dictionary<long, DeliveryScheduleMonthlyColoumn>(),
                TotalCount = 0
            };

            if (input.IsLoadMore == false && input.ColumnNamesToSum != null)
            {
                summary = await query
                .GroupBy(s => 1)
                .Select(s => new DeliveryScheduleByItemPropertyColumnSummaryOutPut
                {
                    DeliveryQty = s.Sum(t => t.DeliveryQty),
                    IssueQty = s.Sum(t => t.IssueQty),
                    QtyBalance = s.Sum(t => t.QtyBalance),
                    DeliveryNetWeight = s.Sum(t => t.DeliveryNetWeight),
                    IssueNetWeight = s.Sum(t => t.IssueNetWeight),
                    NetWeightBalance = s.Sum(t => t.NetWeightBalance),
                    DeliveryNetWeightInTon = s.Sum(t => t.DeliveryNetWeightInTon),
                    IssueNetWeightInTon = s.Sum(t => t.IssueNetWeightInTon),
                    NetWeightBalanceInTon = s.Sum(t => t.NetWeightBalanceInTon),
                    MonthlyColumns = months.Select(m => new DeliveryScheduleMonthlyColoumn
                    {
                        Month = m.Month,
                        MonthName = m.MonthName,
                        DeliveryQty = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.DeliveryQty),
                        IssueQty = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.IssueQty),
                        QtyBalance = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.QtyBalance),
                        DeliveryNetWeight = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.DeliveryNetWeight),
                        IssueNetWeight = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.IssueNetWeight),
                        NetWeightBalance = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.NetWeightBalance),
                        DeliveryNetWeightInTon = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.DeliveryNetWeightInTon),
                        IssueNetWeightInTon = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.IssueNetWeightInTon),
                        NetWeightBalanceInTon = s.Where(r => m.Month == 0 || r.Month == m.Month).Sum(t => t.NetWeightBalanceInTon),
                    }).ToDictionary(k => k.Month, v => v)
                })
                .FirstAsync();

                totalMonthlys = summary.MonthlyColumns;

                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "DeliveryQty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.DeliveryQty);
                    }
                    else if (col == "IssueQty")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.IssueQty);
                    }
                    else if (col == "QtyBalance")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.QtyBalance);
                    }
                    else if (col == "DeliveryNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.DeliveryNetWeight);
                    }
                    else if (col == "IssueNetWeight")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.IssueNetWeight);
                    }
                    else if (col == "NetWeightBalance")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.NetWeightBalance);
                    }
                    else if (col == "DeliveryNetWeightInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.DeliveryNetWeightInTon);
                    }
                    else if (col == "IssueNetWeightInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.IssueNetWeightInTon);
                    }
                    else if (col == "NetWeightBalanceInTon")
                    {
                        sumOfColumns.Add(col, summary == null ? 0 : summary.NetWeightBalanceInTon);
                    }
                }
            }

            var @entities = new List<GetListReportDeliveryScheduleByItemPropertyOutput>();
            if (input.UsePagination == true)
            {
                @entities = await summaryQuery.PageBy(input).ToListAsync();
            }
            else
            {
                @entities = await summaryQuery.ToListAsync();
            }

            return new DeliveryScheduleReportResultOutput
            {
                Items = entities,
                TotalResult = sumOfColumns,
                Months = months.Select(s => new MonthDto { Month = s.Month, MonthName = s.MonthName }).ToList(),
                MonthlyColumns = totalMonthlys,
                TotalCount = resultCount
            };
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_DeliveryScheduleByItemProperty_Export_Excel)]
        public async Task<FileDto> ExportExcelDeliveryScheduleByItemPropertyReport(GetDeliveryScheduleByItemPropertyReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;

            var reportResult = await GetDeliveryScheduleByItemPropertyReport(input);
            var invoiceData = reportResult.Items;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                       .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                       .Select(t => t.Web).FirstOrDefaultAsync();

            var reportCollumnHeader = report.ColumnInfo
                                      .Where(s => s.Visible)
                                      .Where(s => input.ViewOption == ViewOption.Standard || s.ColumnName == "SummaryBy")
                                      .OrderBy(t => t.SortOrder)
                                      .ToList();

            var subCols = new List<CollumnOutput>();

            if (input.ViewOption != ViewOption.Standard)
            {
                subCols = report.ColumnInfo.Where(s => s.Visible && s.ColumnName != "SummaryBy").OrderBy(t => t.SortOrder).ToList();
                var colIndex = reportCollumnHeader.Max(s => s.SortOrder);

                foreach (var m in reportResult.Months)
                {
                    var col = new CollumnOutput
                    {
                        ColumnName = m.Month.ToString(),
                        ColumnTitle = m.MonthName,
                        ColumnLength = subCols.Sum(t => t.ColumnLength),
                        Visible = true,
                        SortOrder = colIndex++,
                        AllowFunction = "Sum",
                        ColumnType = ColumnType.RoundingDigit,
                    };

                    reportCollumnHeader.Add(col);
                }
            }

            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd-MM-yyyy";
            }

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                //var subCols = invoiceData == null ? null : invoiceData.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
                //var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString(formatDate);
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table

                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    if (i.ColumnName != "SummaryBy")
                    {
                        if (input.ViewOption == ViewOption.Standard)
                        {
                            AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                            ws.Cells[rowTableHeader, colHeaderTable].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                        }
                        else
                        {
                            AddTextToCell(ws, rowTableHeader, colHeaderTable, L(i.ColumnTitle), true);
                            MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader, colHeaderTable + subCols.Count - 1, ExcelHorizontalAlignment.Center);

                            foreach (var sub in subCols)
                            {
                                AddTextToCell(ws, rowTableHeader + 1, colHeaderTable, sub.ColumnTitle, true);
                                ws.Cells[rowTableHeader + 1, colHeaderTable].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                                ws.Column(colHeaderTable).Width = ConvertPixelToInches(sub.ColumnLength);
                                colHeaderTable++;
                            }

                            colHeaderTable--;
                        }
                    }
                    else
                    {
                        AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                        ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);

                        if (input.ViewOption != ViewOption.Standard)
                        {
                            MergeCell(ws, rowTableHeader, colHeaderTable, rowTableHeader + 1, colHeaderTable, ExcelHorizontalAlignment.Left, ExcelVerticalAlignment.Center);
                        }
                    }

                    colHeaderTable++;
                }

                if (input.ViewOption != ViewOption.Standard)
                {
                    rowTableHeader++;
                }

                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                Dictionary<string, string> footerGroupDict = new Dictionary<string, string>();
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                //var groupBy = new List<GetListReportDeliveryScheduleByItemPropertyGroupByOutput>();
                ////if has groupBy
                //if (input.ViewOption == ViewOption.Month)
                //{
                //    groupBy = invoiceData
                //                .GroupBy(t => t.Month)
                //                .Select(t => new GetListReportDeliveryScheduleByItemPropertyGroupByOutput
                //                {
                //                    KeyName = t.Select(a => a.MonthName).FirstOrDefault(),
                //                    Items = t.Select(x => x).ToList()
                //                })
                //                .ToList();
                //}
                // write body

                //if (input.ViewOption == ViewOption.Month && groupBy.Count > 0)
                //{
                //    foreach (var k in groupBy)
                //    {
                //        //key group by name
                //        AddTextToCell(ws, rowBody, 1, k.KeyName, true);
                //        MergeCell(ws, rowBody, 1, rowBody, reportCountColHead, ExcelHorizontalAlignment.Left);
                //        rowBody += 1;
                //        count = 1;
                //        //list of item
                //        foreach (var i in k.Items)
                //        {
                //            int collumnCellBody = 1;
                //            foreach (var item in reportCollumnHeader)// map with correct key of properties 
                //            {

                //                WriteBodyDeliveryScheduleByItemProperty(ws, rowBody, collumnCellBody, item, i, count);
                //                collumnCellBody += 1;
                //            }
                //            rowBody += 1;
                //            count += 1;
                //        }

                //        //sub total of group by item
                //        int collumnCellGroupBody = 1;
                //        foreach (var item in reportCollumnHeader)// map with correct key of properties 
                //        {
                //            if (item.AllowFunction != null)
                //            {
                //                var fromCell = GetAddressName(ws, rowBody - k.Items.Count, collumnCellGroupBody);
                //                var toCell = GetAddressName(ws, rowBody - 1, collumnCellGroupBody);
                //                if (footerGroupDict.ContainsKey(item.month))
                //                {
                //                    footerGroupDict[item.month] += fromCell + ":" + toCell + ",";
                //                }
                //                else
                //                {
                //                    footerGroupDict.Add(item.month, fromCell + ":" + toCell + ",");
                //                }
                //                AddFormula(ws, rowBody, collumnCellGroupBody, "SUM(" + fromCell + ":" + toCell + ")", true);
                //            }
                //            collumnCellGroupBody += 1;
                //        }
                //        rowBody += 1;
                //    }
                //}
                //else
                //{
                foreach (var i in invoiceData)
                {
                    int collumnCellBody = 1;
                    foreach (var item in reportCollumnHeader)// map with correct key of properties 
                    {
                        if (input.ViewOption == ViewOption.Standard || item.ColumnType == ColumnType.String)
                        {
                            WriteBodyDeliveryScheduleByItemProperty(ws, rowBody, collumnCellBody, item, i, count);
                            collumnCellBody += 1;
                        }
                        else
                        {
                            foreach (var sub in subCols)
                            {
                                var month = Int32.Parse(item.ColumnName);
                                var obj = i.MonthlyColumns.ContainsKey(month) ? i.MonthlyColumns[month] : null;
                                var val = obj == null ? 0 : Convert.ToDecimal(obj.GetType().GetProperty(sub.ColumnName).GetValue(obj, null));

                                AddNumberToCell(ws, rowBody, collumnCellBody, val);
                                collumnCellBody++;
                            }
                        }
                    }
                    rowBody += 1;
                    count += 1;
                }
                //}
                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            if (input.ViewOption != ViewOption.Standard)
                            {
                                foreach (var sub in subCols)
                                {
                                    int rowFooter = rowTableHeader + 1;// get start row after header 
                                    var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                    var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                    if (i.ColumnType == ColumnType.Number)
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                    }
                                    else
                                    {
                                        AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                    }
                                    footerColNumber += 1;
                                }

                                footerColNumber--;
                            }
                            else
                            {
                                int rowFooter = rowTableHeader + 1;// get start row after header 
                                var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                                var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                                if (i.ColumnType == ColumnType.Number)
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                                }
                                else
                                {
                                    AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                                }
                            }

                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"Sale_Order_By_Item_Property_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_DeliveryScheduleByItemProperty_Export_Pdf)]
        public async Task<FileDto> ExportPDFDeliveryScheduleByItemPropertyReport(GetDeliveryScheduleByItemPropertyReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                        .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                        .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }

            var rounding = await GetCurrentCycleAsync();
            var report = input.ReportOutput;

            //int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;
            var user = await GetCurrentUserAsync();
            var reportResult = await GetDeliveryScheduleByItemPropertyReport(input);

            var reportCollumnHeader = report.ColumnInfo
                                      .Where(s => s.Visible)
                                      .Where(s => input.ViewOption == ViewOption.Standard || s.ColumnName == "SummaryBy")
                                      .OrderBy(t => t.SortOrder)
                                      .ToList();

            var subCols = new List<CollumnOutput>();

            if (input.ViewOption != ViewOption.Standard)
            {
                subCols = report.ColumnInfo.Where(s => s.Visible && s.ColumnName != "SummaryBy").OrderBy(t => t.SortOrder).ToList();
                var colIndex = reportCollumnHeader.Max(s => s.SortOrder);

                foreach (var m in reportResult.Months)
                {
                    var col = new CollumnOutput
                    {
                        ColumnName = m.Month.ToString(),
                        ColumnTitle = m.MonthName,
                        ColumnLength = 10,// subCols.Sum(t => t.ColumnLength),
                        Visible = true,
                        SortOrder = colIndex++,
                        AllowFunction = "Sum",
                        ColumnType = ColumnType.RoundingDigit,
                    };

                    reportCollumnHeader.Add(col);
                }
            }

            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();


            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;
                var contentSubHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                //var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            if (input.ViewOption == ViewOption.Standard)
                            {
                                contentHeader += $"<th width='{i.ColumnLength}'>{i.ColumnTitle}</th>";
                            }
                            else
                            {
                                if (i.ColumnName == "SummaryBy")
                                {
                                    contentHeader += $"<th width='{i.ColumnLength}' rowspan='2'>{i.ColumnTitle}</th>";
                                }
                                else
                                {
                                    decimal totalSubLength = 0;
                                    var subIndex = 0;
                                    foreach (var sub in subCols)
                                    {
                                        if (documentWidth >= (totalVisibleColsWidth + sub.ColumnLength))
                                        {
                                            contentSubHeader += $"<th width='{sub.ColumnLength}'>{sub.ColumnTitle}</th>";
                                            reportCountColHead += subIndex;
                                            subIndex++;
                                            totalSubLength += sub.ColumnLength;
                                        }
                                        else
                                        {
                                            break;
                                        }
                                    }

                                    i.ColumnLength = totalSubLength;
                                    contentHeader += $"<th width='{i.ColumnLength}' colspan='{subIndex}'>{L(i.ColumnTitle)}</th>";
                                }
                            }

                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                if (!contentSubHeader.IsNullOrEmpty()) contentSubHeader = $"<tr>{contentSubHeader}</tr>";

                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body              

                //var groupBy = new List<GetListReportDeliveryScheduleByItemPropertyGroupByOutput>();
                ////if has groupBy
                //if (input.ViewOption == ViewOption.Month)
                //{
                //    groupBy = reportResult.Items
                //               .GroupBy(t => t.Month)
                //               .Select(t => new GetListReportDeliveryScheduleByItemPropertyGroupByOutput
                //               {
                //                   KeyName = t.Select(a => a.MonthName).FirstOrDefault(),
                //                   Items = t.Select(x => x).ToList()
                //               })
                //               .ToList();
                //}

                //// write body
                //if (input.ViewOption == ViewOption.Month && groupBy.Count > 0) //write body have group by
                //{
                //    var trGroup = "";
                //    foreach (var k in groupBy)
                //    {
                //        trGroup += $"<tr style='page-break-before: auto; page-break-after: auto;'>" +
                //                   $"<td style='font-weight: bold;' colspan='{reportCountColHead}'> " + k.KeyName +
                //                   $" </td></tr>";
                //        foreach (var row in k.Items)
                //        {
                //            trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                //            foreach (var i in viewHeader)
                //            {
                //                if (i.Visible)
                //                {
                //                    if (i.ColumnName == "SummaryBy")
                //                    {
                //                        trGroup += $"<td>{row.SummaryBy}</td>";
                //                    }
                //                    else if (i.ColumnName == "DeliveryNetWeight")
                //                    {
                //                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "IssueNetWeight")
                //                    {
                //                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "NetWeightBalance")
                //                    {
                //                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "DeliveryNetWeightInTon")
                //                    {
                //                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "IssueNetWeightInTon")
                //                    {
                //                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "NetWeightBalanceInTon")
                //                    {
                //                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalanceInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "DeliveryQty")
                //                    {
                //                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "IssueQty")
                //                    {
                //                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "QtyBalance")
                //                    {
                //                        trGroup += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.QtyBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else
                //                    {
                //                        trGroup += $"<td></td>";
                //                    }
                //                }
                //            }
                //            trGroup += "</tr>";
                //        }
                //        trGroup += "<tr style='page-break-before: auto; page-break-after: auto;'>";
                //        foreach (var i in viewHeader)
                //        {
                //            if (i.Visible)
                //            {
                //                if (!string.IsNullOrEmpty(i.AllowFunction))/*listSum.Contains(i.month))*/
                //                {
                //                    if (i.ColumnName == "DeliveryQty")
                //                    {
                //                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.DeliveryQty), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "IssueQty")
                //                    {
                //                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.IssueQty), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "QtyBalance")
                //                    {
                //                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.QtyBalance), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "DeliveryNetWeight")
                //                    {
                //                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.DeliveryNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                //                    }
                //                    else if (i.ColumnName == "IssueNetWeight")
                //                    {
                //                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.IssueNetWeight), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                //                    }
                //                    else if (i.ColumnName == "NetWeightBalance")
                //                    {
                //                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.NetWeightBalance), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                    else if (i.ColumnName == "DeliveryNetWeightInTon")
                //                    {
                //                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.DeliveryNetWeightInTon), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                //                    }
                //                    else if (i.ColumnName == "IssueNetWeightInTon")
                //                    {
                //                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.IssueNetWeightInTon), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";

                //                    }
                //                    else if (i.ColumnName == "NetWeightBalanceInTon")
                //                    {
                //                        trGroup += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(k.Items.Sum(t => t.NetWeightBalanceInTon), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                //                    }
                //                }
                //                else //none sum
                //                {
                //                    trGroup += $"<td></td>";
                //                }

                //            }
                //        }
                //        trGroup += "</tr>";
                //    }
                //    contentBody += trGroup;
                //}

                if (input.ViewOption != ViewOption.Standard)
                {
                    foreach (var row in reportResult.Items)
                    {
                        var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        var index = 0;
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (index < reportCountColHead)
                                {
                                    if (i.ColumnName == "SummaryBy")
                                    {
                                        tr += $"<td>{row.SummaryBy}</td>";
                                    }
                                    else
                                    {
                                        int month = Convert.ToInt32(i.ColumnName);
                                        var obj = row.MonthlyColumns.ContainsKey(month) ? row.MonthlyColumns[month] : null;

                                        foreach (var sub in subCols)
                                        {
                                            var val = obj.GetType().GetProperty(sub.ColumnName).GetValue(obj, null);

                                            if (val != null)
                                            {
                                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(Convert.ToDecimal(val), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                            }
                                            else
                                            {
                                                tr += $"<td></td>";
                                            }
                                        }
                                    }
                                    index++;
                                }

                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }
                else // write body no group by
                {
                    foreach (var row in reportResult.Items)
                    {
                        var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                        foreach (var i in viewHeader)
                        {
                            if (i.Visible)
                            {
                                if (i.ColumnName == "SummaryBy")
                                {
                                    tr += $"<td>{row.SummaryBy}</td>";
                                }
                                else if (i.ColumnName == "DeliveryNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "IssueNetWeight")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "NetWeightBalance")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "DeliveryNetWeightInTon")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "IssueNetWeightInTon")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueNetWeightInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "NetWeightBalanceInTon")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeightBalanceInTon, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "DeliveryQty")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.DeliveryQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "IssueQty")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.IssueQty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else if (i.ColumnName == "QtyBalance")
                                {
                                    tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.QtyBalance, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                }
                                else
                                {
                                    tr += $"<td></td>";
                                }
                            }
                        }
                        tr += "</tr>";
                        contentBody += tr;
                    }
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index < reportCountColHead)
                            {
                                if (index == 0)
                                {
                                    tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                                }
                                else
                                {
                                    if (!string.IsNullOrEmpty(i.AllowFunction))
                                    {
                                        if (input.ViewOption == ViewOption.Standard)
                                        {
                                            if (reportResult.TotalResult != null && reportResult.TotalResult.ContainsKey(i.ColumnName))
                                            {
                                                tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(reportResult.TotalResult[i.ColumnName], rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                            }
                                        }
                                        else
                                        {
                                            int month = Convert.ToInt32(i.ColumnName);
                                            var obj = reportResult.MonthlyColumns.ContainsKey(month) ? reportResult.MonthlyColumns[month] : null;

                                            foreach (var sub in subCols)
                                            {
                                                var val = obj.GetType().GetProperty(sub.ColumnName).GetValue(obj, null);

                                                tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(Convert.ToDecimal(val), rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                                index++;
                                            }
                                            index--;
                                        }
                                    }
                                    else //none sum
                                    {
                                        tr += $"<td></td>";
                                    }
                                }
                            }

                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", contentSubHeader);
                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);
                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{sheetName}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }

        #endregion

        #region "Sale Invoice By Item Property Report"

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleInvoiceByProperty)]
        [HttpPost]
        public async Task<PagedResultWithTotalColuumnsDto<GetListSaleInvoiceByItemPropertyReportOutput>> GetSaleInvoiceByItemPropertyReport(GetListReportSaleInvoiceByItemPropertyInput input)
        {
            // Validate input.GroupBy
            if (string.IsNullOrWhiteSpace(input.GroupBy))
                throw new UserFriendlyException(L("PleaseSelect", L("SummaryBy")));

            var find = await _propertyRepository.GetAll().AsNoTracking()
                .AnyAsync(s => s.Name == input.GroupBy);
            if (!find)
                throw new UserFriendlyException(L("PleaseSelect", L("SummaryBy")));

            // Pre-fetch period cycles and rounding digit
            var periodCycles = await GetCloseCyleAsync(input.ToDate);
            var previousCycle = periodCycles
                .Where(u => u.EndDate != null && u.EndDate.Value.Date <= input.ToDate.Date)
                .OrderByDescending(u => u.EndDate.Value)
                .FirstOrDefault();
            var currentCycle = periodCycles
                .Where(u => u.StartDate.Date <= input.ToDate.Date &&
                            (u.EndDate == null || input.ToDate.Date <= u.EndDate.Value.Date))
                .OrderByDescending(u => u.StartDate)
                .FirstOrDefault();
            var currentRoundingDigit = currentCycle?.RoundingDigit ?? previousCycle?.RoundingDigit ?? 2;

            // Pre-fetch filter data
            var defaultLocationGroups = await GetUserGroupByLocation();
            var userGroupCustomers = await GetUserGroupCustomers();
            var customerTypeMemberIds = await GetCustomerTypeMembers()
                .Select(s => s.CustomerTypeId)
                .ToListAsync();

            // Base query with joins
            var journalQuery = from i in _invoiceRepository.GetAll().AsNoTracking()
                                   .WhereIf(!customerTypeMemberIds.IsNullOrEmpty(), s => s.Customer.CustomerTypeId.HasValue && customerTypeMemberIds.Contains(s.Customer.CustomerTypeId.Value))
                                   .WhereIf(!userGroupCustomers.IsNullOrEmpty(), s => userGroupCustomers.Contains(s.CustomerId) || s.Customer.Member == Member.All)
                                   .WhereIf(!input.Customers.IsNullOrEmpty(), s => input.Customers.Contains(s.CustomerId))
                                   .WhereIf(!input.CustomerTypes.IsNullOrEmpty(), s => input.CustomerTypes.Contains(s.Customer.CustomerTypeId.Value))
                                   .WhereIf(!input.SaleTypes.IsNullOrEmpty(), s => s.TransactionTypeSaleId.HasValue && input.SaleTypes.Contains(s.TransactionTypeSaleId.Value))
                               join j in _journalRepository.GetAll().AsNoTracking()
                                   .Where(s => s.Status == TransactionStatus.Publish && s.JournalType == JournalType.Invoice && s.InvoiceId.HasValue)
                                   .WhereIf(!defaultLocationGroups.IsNullOrEmpty(), u => defaultLocationGroups.Contains(u.LocationId.Value))
                                   .WhereIf(!input.Locations.IsNullOrEmpty(), u => input.Locations.Contains(u.LocationId.Value))
                                   .WhereIf(input.FromDate != null && input.ToDate != null, u => input.FromDate.Date <= u.Date.Date && u.Date.Date <= input.ToDate.Date)
                                   .WhereIf(!input.Filter.IsNullOrEmpty(), u =>
                                       u.JournalNo.ToLower().Contains(input.Filter.ToLower()) ||
                                       u.Reference.ToLower().Contains(input.Filter.ToLower()))
                                   .WhereIf(!input.Users.IsNullOrEmpty(), u => input.Users.Contains(u.CreatorUserId))
                               on i.Id equals j.InvoiceId
                               join ii in _invoiceItemRepository.GetAll().AsNoTracking()
                                   .WhereIf(!input.Items.IsNullOrEmpty(), s => s.ItemId.HasValue && input.Items.Contains(s.ItemId))
                               on i.Id equals ii.InvoiceId
                               select new
                               {
                                   JournalNo = j.JournalNo,
                                   Reference = j.Reference,
                                   Date = j.Date,
                                   Description = j.Memo,
                                   LocationId = j.LocationId.Value,
                                   LocationName = j.Location != null ? j.Location.LocationName : "",
                                   User = j.CreatorUser != null ? j.CreatorUser.UserName : "",
                                   InvoiceId = i.Id,
                                   CustomerId = i.CustomerId,
                                   CustomerName = i.Customer.CustomerName,
                                   CustomerType = i.Customer.CustomerType != null ? i.Customer.CustomerType.CustomerTypeName : "",
                                   CustomerTypeId = i.Customer.CustomerTypeId,
                                   SaleType = i.TransactionTypeSaleId.HasValue ? i.TransactionTypeSale.TransactionTypeName : "",
                                   ItemId = ii.ItemId,
                                   Qty = ii.Qty,
                                   Total = ii.Total
                               };

            // Join with properties for SummaryBy and NetWeight
            var invoiceItemWithProperty = from ii in journalQuery
                                          join p in _itemPropertyRepository.GetAll().AsNoTracking()
                                              .Where(p => p.Property.Name == input.GroupBy)
                                          on ii.ItemId equals p.ItemId into properties
                                          from p in properties.DefaultIfEmpty()
                                          join pu in _itemPropertyRepository.GetAll().AsNoTracking()
                                              .Where(p => p.Property.IsUnit)
                                          on ii.ItemId equals pu.ItemId into unitProperties
                                          from pu in unitProperties.DefaultIfEmpty()
                                          select new GetListSaleInvoiceByItemPropertyReportOutput
                                          {
                                              JournalNo = ii.JournalNo,
                                              Reference = ii.Reference,
                                              Date = ii.Date,
                                              Description = ii.Description,
                                              LocationId = ii.LocationId,
                                              LocationName = ii.LocationName,
                                              User = ii.User,
                                              InvoiceId = ii.InvoiceId,
                                              CustomerId = ii.CustomerId,
                                              CustomerName = ii.CustomerName,
                                              CustomerType = ii.CustomerType,
                                              CustomerTypeId = ii.CustomerTypeId,
                                              SaleType = ii.SaleType,
                                              Qty = ii.Qty,
                                              NetWeight = pu != null ? pu.PropertyValue.NetWeight : 0,
                                              Total = ii.Total,
                                              SummaryBy = p != null ? p.PropertyValue.Value : "",
                                              ItemId = ii.ItemId
                                          };

            // Apply PropertyDics filter
            var filteredQuery = invoiceItemWithProperty;
            if (input.PropertyDics != null && input.PropertyDics.Any())
            {
                filteredQuery = from q in filteredQuery
                                join p in _itemPropertyRepository.GetAll().AsNoTracking()
                                on q.ItemId equals p.ItemId
                                where input.PropertyDics.Any(v => v.PropertyId == p.PropertyId &&
                                      (v.PropertyValueIds == null || v.PropertyValueIds.Count == 0 || v.PropertyValueIds.Contains(p.PropertyValueId)))
                                group q by new
                                {
                                    q.JournalNo,
                                    q.Reference,
                                    q.Date,
                                    q.Description,
                                    q.LocationId,
                                    q.LocationName,
                                    q.User,
                                    q.InvoiceId,
                                    q.CustomerId,
                                    q.CustomerName,
                                    q.CustomerType,
                                    q.CustomerTypeId,
                                    q.SaleType,
                                    q.Qty,
                                    q.NetWeight,
                                    q.Total,
                                    q.SummaryBy,
                                    q.ItemId
                                } into g
                                where g.Count() == input.PropertyDics.Count
                                select new GetListSaleInvoiceByItemPropertyReportOutput
                                {
                                    JournalNo = g.Key.JournalNo,
                                    Reference = g.Key.Reference,
                                    Date = g.Key.Date,
                                    Description = g.Key.Description,
                                    LocationId = g.Key.LocationId,
                                    LocationName = g.Key.LocationName,
                                    User = g.Key.User,
                                    InvoiceId = g.Key.InvoiceId,
                                    CustomerId = g.Key.CustomerId,
                                    CustomerName = g.Key.CustomerName,
                                    CustomerType = g.Key.CustomerType,
                                    CustomerTypeId = g.Key.CustomerTypeId,
                                    SaleType = g.Key.SaleType,
                                    Qty = g.Key.Qty,
                                    NetWeight = g.Key.NetWeight,
                                    Total = g.Key.Total,
                                    SummaryBy = g.Key.SummaryBy,
                                    ItemId = g.Key.ItemId
                                };
            }

            // Group and summarize
            var summaryQuery = filteredQuery
                .GroupBy(s => new
                {
                    Date = s.Date,
                    JournalNo = s.JournalNo,
                    Reference = s.Reference,
                    Description = s.Description,
                    LocationId = s.LocationId,
                    LocationName = s.LocationName,
                    CustomerName = s.CustomerName,
                    CustomerId = s.CustomerId,
                    CustomerType = s.CustomerType,
                    CustomerTypeId = s.CustomerTypeId,
                    SaleType = s.SaleType,
                    User = s.User,
                    SummaryBy = s.SummaryBy
                })
                .Select(s => new GetListSaleInvoiceByItemPropertyReportOutput
                {
                    Date = s.Key.Date,
                    JournalNo = s.Key.JournalNo,
                    Reference = s.Key.Reference,
                    CustomerName = s.Key.CustomerName,
                    CustomerId = s.Key.CustomerId,
                    CustomerType = s.Key.CustomerType,
                    CustomerTypeId = s.Key.CustomerTypeId,
                    SaleType = s.Key.SaleType,
                    User = s.Key.User,
                    LocationId = s.Key.LocationId,
                    LocationName = s.Key.LocationName,
                    Description = s.Key.Description,
                    Qty = s.Sum(t => t.Qty),
                    NetWeight = s.Sum(t => t.Qty * t.NetWeight),
                    Total = s.Sum(t => t.Total),
                    RoundingDigit = currentRoundingDigit,
                    SummaryBy = s.Key.SummaryBy
                })
                .OrderBy(s => s.SummaryBy);

            // Get total count
            var resultCount = await summaryQuery.CountAsync();
            if (resultCount == 0)
                return new PagedResultWithTotalColuumnsDto<GetListSaleInvoiceByItemPropertyReportOutput>(
                    resultCount, new List<GetListSaleInvoiceByItemPropertyReportOutput>(), new Dictionary<string, decimal>());

            // Compute summaries
            SaleInvoiceByItemPropertyColumnSummaryOutPut summary = null;
            if (input.IsLoadMore == false && input.ColumnNamesToSum != null)
            {
                summary = await summaryQuery
                    .GroupBy(s => 1)
                    .Select(s => new SaleInvoiceByItemPropertyColumnSummaryOutPut
                    {
                        TotalAmount = s.Sum(t => t.Total),
                        TotalQty = s.Sum(t => t.Qty),
                        TotalNetWeight = s.Sum(t => t.NetWeight)
                    })
                    .FirstOrDefaultAsync();
            }

            // Build sum of columns
            var sumOfColumns = new Dictionary<string, decimal>();
            if (input.ColumnNamesToSum != null && input.IsLoadMore == false)
            {
                foreach (var col in input.ColumnNamesToSum)
                {
                    if (col == "Total")
                        sumOfColumns.Add(col, summary?.TotalAmount ?? 0);
                    else if (col == "Qty")
                        sumOfColumns.Add(col, summary?.TotalQty ?? 0);
                    else if (col == "NetWeight")
                        sumOfColumns.Add(col, summary?.TotalNetWeight ?? 0);
                }
            }

            // Fetch paginated or full results
            var entities = new List<GetListSaleInvoiceByItemPropertyReportOutput>();
            if (input.UsePagination)
            {
                entities = await summaryQuery.PageBy(input).ToListAsync();
            }
            else
            {
                // Stream results in chunks to avoid memory issues
                int pageSize = 1000;
                int page = 0;
                while (true)
                {
                    var batch = await summaryQuery.Skip(page * pageSize).Take(pageSize).ToListAsync();
                    if (!batch.Any()) break;
                    entities.AddRange(batch);
                    page++;
                }
            }

            return new PagedResultWithTotalColuumnsDto<GetListSaleInvoiceByItemPropertyReportOutput>(resultCount, entities, sumOfColumns);
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleInvoiceByProperty)]
        public async Task<ReportOutput> GetReportTemplateSaleInvoiceByItemProperty()
        {
            var itemPropertyCols = await _propertyRepository.GetAll().AsNoTracking()
                            .Where(t => t.IsActive == true)
                            .Select(t => new CollumnOutput
                            {
                                AllowGroupby = true,
                                AllowFilter = true,
                                ColumnName = t.Name,
                                ColumnLength = 150,
                                ColumnTitle = t.Name,
                                ColumnType = ColumnType.ItemProperty,
                                SortOrder = 11,
                                Visible = true,
                                AllowFunction = null,
                                MoreFunction = null,
                                IsDisplay = false,
                                AllowShowHideFilter = true,
                                ShowHideFilter = true,
                                DefaultValue = t.Id.ToString(),//to init the value of property
                            })
                            .ToListAsync();

            var columns = new List<CollumnOutput>() {
                     // start properties with can filter
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Search",
                        ColumnLength = 150,
                        ColumnTitle = "Search",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "DateRange",
                        ColumnLength = 150,
                        ColumnTitle = "DateRange",
                        ColumnType = ColumnType.Language,
                        SortOrder = 0,
                        Visible = true,
                        DefaultValue = "thisMonth",
                        AllowFunction = null,
                        DisableDefault = false,
                        MoreFunction = null,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        IsDisplay = false//no need to show in col check it belong to filter option
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Item",
                        ColumnLength = 300,
                        ColumnTitle = "Item",
                        ColumnType = ColumnType.String,
                        SortOrder = 0,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = false,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Date",
                        ColumnLength = 100,
                        ColumnTitle = "Date",
                        ColumnType = ColumnType.Date,
                        SortOrder = 1,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                     },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "JournalNo",
                        ColumnLength = 120,
                        ColumnTitle = "Journal No",
                        ColumnType = ColumnType.String,
                        SortOrder = 2,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Reference",
                        ColumnLength = 100,
                        ColumnTitle = "Reference",
                        ColumnType = ColumnType.String,
                        SortOrder = 3,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Customer",
                        ColumnLength = 120,
                        ColumnTitle = "Customer",
                        ColumnType = ColumnType.String,
                        SortOrder = 4,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "Location",
                        ColumnLength = 120,
                        ColumnTitle = "Location",
                        ColumnType = ColumnType.String,
                        SortOrder = 7,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Description",
                        ColumnLength = 120,
                        ColumnTitle = "Description",
                        ColumnType = ColumnType.String,
                        SortOrder = 12,
                        Visible = true,
                        AllowFunction = null,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                    new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "SummaryBy",
                        ColumnLength = 100,
                        ColumnTitle = "SummaryBy",
                        ColumnType = ColumnType.String,
                        SortOrder = 13,
                        Visible = true,
                        AllowFunction = null,
                        DisableDefault = false,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                    },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Qty",
                        ColumnLength = 100,
                        ColumnTitle = "Qty",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 14,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                         AllowFunction = null,
                         MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "Total",
                        ColumnLength = 150,
                        ColumnTitle = "Total",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 15,
                        Visible = true,
                        IsDisplay = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = false,
                        ColumnName = "NetWeight",
                        ColumnLength = 150,
                        ColumnTitle = "Net Weight",
                        ColumnType = ColumnType.RoundingDigit,
                        SortOrder = 19,
                        Visible = true,
                        AllowFunction = "Sum",
                        AllowShowHideFilter = false,
                        ShowHideFilter = false,
                        MoreFunction = new List<MoreFunction>(){
                            new MoreFunction
                            {
                                KeyName = null
                            },
                            new MoreFunction
                            {
                                KeyName = "Sum"
                            }
                        },
                        IsDisplay = true
                    },
                      new CollumnOutput {
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "User",
                        ColumnLength = 100,
                        ColumnTitle = "User",
                        ColumnType = ColumnType.String,
                        SortOrder = 20,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                      },
                      new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "CustomerType",
                        ColumnLength = 150,
                        ColumnTitle = "Customer Type",
                        ColumnType = ColumnType.String,
                        SortOrder = 21,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    },
                       new CollumnOutput{
                        AllowGroupby = false,
                        AllowFilter = true,
                        ColumnName = "SaleType",
                        ColumnLength = 150,
                        ColumnTitle = "SaleType",
                        ColumnType = ColumnType.String,
                        SortOrder = 22,
                        Visible = true,
                        IsDisplay = true,
                        AllowShowHideFilter = true,
                        ShowHideFilter = true,
                    }
                };

            ReportOutput result = new ReportOutput()
            {
                ColumnInfo = columns.Concat(itemPropertyCols).ToList(),
                Groupby = "",
                HeaderTitle = "Sale Invoice By Item Property",
                Sortby = "",
            };


            //if (!FeatureChecker.IsEnabled(AppFeatures.AccountingFeature))
            //{
            //    result.ColumnInfo = result.ColumnInfo.Where(s =>
            //        s.ColumnName != "Account" &&
            //        s.ColumnName != "AccountType").ToList();
            //}


            //var isMultiCurrency = _multiCurrencyRepository.GetAll().Any();

            //if (isMultiCurrency)
            //{
            //    var currency = new CollumnOutput
            //    {
            //        AllowGroupby = false,
            //        AllowFilter = true,
            //        ColumnName = "Currency",
            //        ColumnLength = 140,
            //        ColumnTitle = "Currency",
            //        ColumnType = ColumnType.String,
            //        SortOrder = 3,
            //        Visible = true,
            //        IsDisplay = false,
            //        DisableDefault = false,
            //        AllowShowHideFilter = true,
            //        ShowHideFilter = true,
            //    };
            //    result.ColumnInfo.Add(currency);
            //}


            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleInvoiceByProperty_Export_Excel)]
        public async Task<FileDto> ExportExcelSaleInvoiceByItemPropertyReport(GetSaleInvoiceByItemPropertyReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            // Query get collumn header 
            //var @entity = await _reportTemplateManager.GetAsync(ReportType.ReportType_Outbounce);
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;

            var reportResult = await GetSaleInvoiceByItemPropertyReport(input);
            var invoiceData = reportResult.Items;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                       .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                       .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd-MM-yyyy";
            }

            var result = new FileDto();

            //Creates a blank workbook. Use the using statment, so the package is disposed when we are done.
            using (var p = new ExcelPackage())
            {
                //A workbook must have at least on cell, so lets add one... 
                var ws = p.Workbook.Worksheets.Add(sheetName);
                ws.PrinterSettings.Orientation = eOrientation.Landscape;
                ws.PrinterSettings.FitToPage = true;
                //ws.PrinterSettings.PaperSize = ePaperSize.A3; //set default format paper size 
                ws.Cells.Style.Font.Size = DefaultFontSize; //Default font size for whole sheet
                ws.Cells.Style.Font.Name = DefaultFontName; //Default Font name for whole sheet

                //var subCols = invoiceData == null ? null : invoiceData.First().CurrencyColumnTotals.Select(s => s.CurrencyCode).ToList();
                //var isMultiCurrencies = input.CurrencyFilter == CurrencyFilter.MultiCurrencies && subCols != null && subCols.Count() > 1;

                #region Row 1 Header
                AddTextToCell(ws, 1, 1, sheetName, true);
                MergeCell(ws, 1, 1, 1, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 1


                #region Row 2 Header
                var header = input.ToDate.ToString(formatDate);
                AddTextToCell(ws, 2, 1, header, true);
                MergeCell(ws, 2, 1, 2, reportCountColHead, ExcelHorizontalAlignment.Center);
                #endregion Row 2

                #region Row 3 Header Table
                int rowTableHeader = 3;
                int colHeaderTable = 1;//start from row 1 of spreadsheet
                // write header collumn table
                foreach (var i in reportCollumnHeader)
                {
                    AddTextToCell(ws, rowTableHeader, colHeaderTable, i.ColumnTitle, true);
                    ws.Column(colHeaderTable).Width = ConvertPixelToInches(i.ColumnLength);
                    colHeaderTable += 1;
                }

                //if (isMultiCurrencies) rowTableHeader += 1;
                #endregion Row 3

                #region Row Body 
                // use for check auto dynamic col footer of sum value
                int rowBody = rowTableHeader + 1;//start from row header of spreadsheet
                int count = 1;

                foreach (var i in invoiceData)
                {
                    int collumnCellBody = 1;
                    foreach (var item in reportCollumnHeader)// map with correct key of properties 
                    {
                        WriteBodySaleInvoiceByItemProperty(ws, rowBody, collumnCellBody, item, i, count);
                        collumnCellBody += 1;
                    }
                    rowBody += 1;
                    count += 1;
                }

                #endregion Row Body


                #region Row Footer 
                if (reportHasShowFooterTotal.Count > 0)
                {
                    int footerRow = rowBody;
                    int footerColNumber = 1;
                    AddTextToCell(ws, footerRow, footerColNumber, "TOTAL", true);
                    foreach (var i in reportCollumnHeader)
                    {
                        if (i.AllowFunction != null)
                        {
                            int rowFooter = rowTableHeader + 1;// get start row after header 
                            var fromCell = GetAddressName(ws, rowFooter, footerColNumber);
                            var toCell = GetAddressName(ws, footerRow - 1, footerColNumber);
                            if (i.ColumnType == ColumnType.Number)
                            {
                                AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true, false, true);
                            }
                            else
                            {
                                AddFormula(ws, footerRow, footerColNumber, "SUM(" + fromCell + ":" + toCell + ")", true);
                            }
                        }
                        footerColNumber += 1;
                    }
                }
                #endregion Row Footer


                result.FileName = $"Sale_Invoice_By_Item_Property_Report_{header.Replace(" ", "_").Replace("-", "_")}.xlsx";
                result.FileToken = $"{Guid.NewGuid()}.xlsx";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";

                await _fileStorageManager.UploadTempFile(result.FileToken, p);
            }

            return result;
        }

        [AbpAuthorize(AppPermissions.Pages_Tenant_Report_SaleInvoiceByProperty_Export_Pdf)]
        public async Task<FileDto> ExportPDFSaleInvoiceByItemPropertyReport(GetSaleInvoiceByItemPropertyReportInput input)
        {
            input.UsePagination = false;
            input.IsLoadMore = false;

            var tenant = await GetCurrentTenantAsync();
            var formatDate = await _formatRepository.GetAll()
                        .Where(t => t.Id == tenant.FormatDateId).AsNoTracking()
                        .Select(t => t.Web).FirstOrDefaultAsync();

            if (formatDate.IsNullOrEmpty())
            {
                formatDate = "dd/MM/yyyy";
            }

            var rounding = await GetCurrentCycleAsync();
            var report = input.ReportOutput;
            var reportCollumnHeader = report.ColumnInfo.Where(s => s.Visible).OrderBy(t => t.SortOrder).ToList();
            var reportHasShowFooterTotal = reportCollumnHeader.Where(t => t.AllowFunction != null).ToList();
            //int reportCountColHead = reportCollumnHeader.Count();
            var sheetName = report.HeaderTitle;
            var user = await GetCurrentUserAsync();
            var invoices = await GetSaleInvoiceByItemPropertyReport(input);

            return await Task.Run(async () =>
            {
                var exportHtml = string.Empty;
                var templateHtml = string.Empty;
                FileDto fileDto = new FileDto()
                {
                    SubFolder = null,
                    FileName = "InventoryReportPdf.pdf",
                    FileToken = "InventoryReportPdf.html",
                    FileType = MimeTypeNames.TextHtml
                };
                try
                {
                    templateHtml = await _fileStorageManager.GetTemplate(fileDto.FileToken);//retrive template from path
                    templateHtml = templateHtml.Trim();
                }
                catch (FileNotFoundException)
                {
                    throw new UserFriendlyException("FileNotFound");
                }
                //ToDo: Replace and concat string to be the same what frontend did
                exportHtml = templateHtml;

                var contentBody = string.Empty;
                var contentHeader = string.Empty;

                var viewHeader = reportCollumnHeader.OrderBy(x => x.SortOrder);
                var documentWidth = 1080;
                decimal totalVisibleColsWidth = 0;
                decimal totalTableWidth = 0;
                int reportCountColHead = viewHeader.Where(t => t.Visible == true).Count();
                //var multiCurrencyHeader = isMultiCurrencies ? "<tr>" : "";
                foreach (var i in viewHeader)
                {
                    if (i.Visible)
                    {
                        if (documentWidth >= (totalVisibleColsWidth + i.ColumnLength))
                        {
                            var rowHeader = "";

                            rowHeader = $"<th width='{i.ColumnLength}px'>{i.ColumnTitle}</th>";

                            contentHeader += rowHeader;
                            totalTableWidth += i.ColumnLength;
                        }
                        else
                        {
                            i.Visible = false;
                            reportCountColHead--;
                        }
                        totalVisibleColsWidth += i.ColumnLength;
                    }
                }

                //multiCurrencyHeader += isMultiCurrencies ? $"</tr>" : "";
                exportHtml = exportHtml.Replace("{{tableWidth}}", totalTableWidth.ToString());

                #region Row Body     
                foreach (var row in invoices.Items)
                {
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (i.ColumnName == "SummaryBy")
                            {
                                tr += $"<td>{row.SummaryBy}</td>";
                            }
                            else if (i.ColumnName == "JournalNo")
                            {
                                tr += $"<td>{row.JournalNo}</td>";
                            }
                            else if (i.ColumnName == "Date")
                            {
                                tr += $"<td>{row.Date.ToString(formatDate)}</td>";
                            }
                            else if (i.ColumnName == "Reference")
                            {
                                tr += $"<td>{row.Reference}</td>";
                            }
                            else if (i.ColumnName == "Description")
                            {
                                tr += $"<td>{row.Description}</td>";
                            }
                            else if (i.ColumnName == "Customer")
                            {
                                tr += $"<td>{row.CustomerName}</td>";
                            }
                            else if (i.ColumnName == "CustomerType")
                            {
                                tr += $"<td>{row.CustomerType}</td>";
                            }
                            else if (i.ColumnName == "SaleType")
                            {
                                tr += $"<td>{row.SaleType}</td>";
                            }
                            else if (i.ColumnName == "User")
                            {
                                tr += $"<td>{row.User}</td>";
                            }
                            else if (i.ColumnName == "Location")
                            {
                                tr += $"<td>{row.LocationName}</td>";
                            }
                           
                            else if (i.ColumnName == "NetWeight")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.NetWeight, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "Qty")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Qty, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else if (i.ColumnName == "Total")
                            {
                                tr += $"<td style='text-align: right'>{FormatNumberCurrency(Math.Round(row.Total, rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                            }
                            else
                            {
                                tr += $"<td></td>";
                            }
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Body

                #region Row Footer 

                if (reportHasShowFooterTotal.Count > 0)
                {
                    var index = 0;
                    var tr = "<tr style='page-break-before: auto; page-break-after: auto;'>";
                    foreach (var i in viewHeader)
                    {
                        if (i.Visible)
                        {
                            if (index == 0)
                            {
                                tr += $"<td style='font-weight: bold;text-align:right;'>{L("Total")}</td>";
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(i.AllowFunction))
                                {
                                    if (invoices.TotalResult != null && invoices.TotalResult.ContainsKey(i.ColumnName))
                                    {
                                        tr += $"<td style='font-weight: bold;text-align:right;'>{FormatNumberCurrency(Math.Round(invoices.TotalResult[i.ColumnName], rounding.RoundingDigit, MidpointRounding.ToEven), rounding.RoundingDigit)}</td>";
                                    }
                                }
                                else //none sum
                                {
                                    tr += $"<td></td>";
                                }
                            }
                            index++;
                        }
                    }
                    tr += "</tr>";
                    contentBody += tr;
                }
                #endregion Row Footer

                exportHtml = exportHtml.Replace("{{rowHeader}}", contentHeader);
                exportHtml = exportHtml.Replace("{{rowItem}}", contentBody);
                exportHtml = exportHtml.Replace("{{subHeader}}", "");
                EvoPdf.HtmlToPdfClient.HtmlToPdfConverter htmlToPdfConverter = GetInitPDFOption();
                AddHeaderPDF(htmlToPdfConverter, tenant.Name, sheetName, input.FromDate, input.ToDate, formatDate);
                AddFooterPDF(htmlToPdfConverter, user.FullName, formatDate);
                byte[] outPdfBuffer = htmlToPdfConverter.ConvertHtml(exportHtml, "index.html");
                var tokenName = $"{Guid.NewGuid()}.pdf";
                var result = new FileDto();
                result.FileName = $"{sheetName}.pdf";
                result.FileToken = $"{Guid.NewGuid()}.pdf";
                result.FileUrl = $"{_appFolders.DownloadBaseUrl}?fileName={result.FileName}&fileToken={result.FileToken}";
                result.FileType = MimeTypeNames.ApplicationPdf;

                await _fileStorageManager.UploadTempFile(result.FileToken, outPdfBuffer);
                return result;

            });
        }
        #endregion

    }
}
